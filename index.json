[{"categories":["spring"],"content":"AOP ä¸­ä»£ç†å¯¹è±¡ç”Ÿæˆåï¼Œåœ¨è°ƒç”¨ä»£ç†æ–¹æ³•æ—¶ï¼Œä»¥ JDK åŠ¨æ€ä»£ç†ä¸ºä¾‹ï¼Œæ‰§è¡Œé“¾çš„ç”Ÿæˆã€æ‰§è¡Œé“¾ç«ç‚¬ä¼ é€’å¼çš„è°ƒç”¨æºç è§£æã€‚","date":"2020-12-01","objectID":"/posts/spring/12-aop-proxy-execute-processor/","tags":["springæºç "],"title":"12 AOP æ‰§è¡Œé“¾çš„åˆ›å»ºå’Œæ‰§è¡ŒåŸç†","uri":"/posts/spring/12-aop-proxy-execute-processor/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/12-aop-proxy-execute-processor/:1:0","tags":["springæºç "],"title":"12 AOP æ‰§è¡Œé“¾çš„åˆ›å»ºå’Œæ‰§è¡ŒåŸç†","uri":"/posts/spring/12-aop-proxy-execute-processor/"},{"categories":["spring"],"content":"1 ä¸»æµç¨‹ ä»¥ jdk åŠ¨æ€ä»£ç†ä¸ºä¾‹ï¼Œåœ¨ä»£ç†å¯¹è±¡ç”Ÿæˆåï¼Œä¼šåŠ å…¥åˆ° ioc å®¹å™¨ä¸­ã€‚å½“æœ‰ä»£ç è°ƒç”¨åˆ°å¯¹åº”çš„æ–¹æ³•æ—¶ï¼Œä¼šèµ°åˆ° InvocationHandler çš„ invoke()ã€‚ åœ¨ spring-aop æ¨¡å—ä¸­ï¼ŒjdkåŠ¨æ€ä»£ç†æ˜¯åœ¨ JdkDynamicAopProxy.getProxy() ä¸­ç”Ÿæˆçš„ã€‚åœ¨ç”Ÿæˆä»£ç†å¯¹è±¡æ—¶ï¼ŒProxy.newProxyInstance() ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯ thisï¼ŒJdkDynamicAopProxyæœ¬èº«ä¹Ÿæ˜¯ InvocationHandler çš„å®ç°ç±»ã€‚é‚£ä¹ˆï¼Œåœ¨è°ƒç”¨ä»£ç†å¯¹è±¡æ–¹æ³•æ—¶ï¼Œä¸€å®šä¼šè°ƒç”¨åˆ° JdkDynamicAopProxy.invoke()ã€‚ æ¥åˆ° invoke() æºç ï¼š final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable { public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { MethodInvocation invocation; // å­˜å‚¨åœ¨è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¸­çš„æ–¹æ³•è°ƒç”¨é“¾ä¸­çš„ä¸Šä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚ // æ¯”å¦‚ ä»£ç†A -\u003e ä»£ç†B -\u003e å½“å‰ä»£ç†æ–¹æ³•ã€‚é‚£ä¹ˆæ–¹æ³•å†… oldProxy ä¼šå­˜å‚¨å‰é¢çš„ä»£ç†å¯¹è±¡ã€‚å› ä¸ºåœ¨è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œä¹‹å‰ï¼Œä¼šå°† // ä¸€ä¸ªå…¨å±€çš„ThreadLocalå˜é‡ç½®æ¢ä¸ºå½“å‰çš„ä»£ç†å¯¹è±¡ï¼Œæ—§çš„å€¼éœ€è¦ç¼“å­˜èµ·æ¥ï¼Œç­‰åˆ°å½“å‰æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œå†è®¾ç½®å›åŸå€¼ã€‚ Object oldProxy = null; boolean setProxyContext = false; // ä»ä»£ç†å·¥å‚ä¸­æ‹¿åˆ°TargetSourceå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…è£…äº†è¢«ä»£ç†å®ä¾‹bean TargetSource targetSource = this.advised.targetSource; Object target = null; try { // è¢«ä»£ç†å¯¹è±¡çš„equalsæ–¹æ³•å’ŒhashCodeæ–¹æ³•ä¸è¢«ä»£ç†çš„ï¼Œä¸ä¼šèµ°åˆ‡é¢ï¼Œæ­¤å¤„ä»£ç çœç•¥... Object retVal; // å¦‚æœéœ€è¦æš´éœ²ä»£ç†å¯¹è±¡ï¼ˆåœ¨é…ç½®æ–‡ä»¶æˆ–è€…æ³¨è§£ä¸­å…¨å±€é…ç½®çš„ï¼‰ï¼Œåˆ™å°†å½“å‰ä»£ç†å¯¹è±¡æ”¾å…¥åˆ°ä¸€ä¸ªå…¨å±€çš„ThreadLocalå˜é‡ä¸­ã€‚ if (this.advised.exposeProxy) { oldProxy = AopContext.setCurrentProxy(proxy); setProxyContext = true; } // è¿™ä¸ªtargetå°±æ˜¯è¢«ä»£ç†å®ä¾‹ target = targetSource.getTarget(); Class\u003c?\u003e targetClass = (target != null ? target.getClass() : null); // ä»ä»£ç†å·¥å‚ä¸­æ‹¿è¿‡æ»¤å™¨é“¾ Objectæ˜¯ä¸€ä¸ªMethodInterceptorç±»å‹çš„å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªadviceå¯¹è±¡ï¼Œæˆ–è€…è¯´æ˜¯MethodInterceptor List\u003cObject\u003e chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass); // å¦‚æœè¯¥æ–¹æ³•æ²¡æœ‰æ‰§è¡Œé“¾ï¼Œåˆ™è¯´æ˜è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦è¢«æ‹¦æˆªï¼Œåˆ™ç›´æ¥åå°„è°ƒç”¨ã€‚ // å› ä¸ºæ‰§è¡Œé“¾ä¸è®ºæ˜¯å¦ä¸ºç©ºï¼Œéƒ½ä¼šè¢«ç¼“å­˜åˆ°ä¸€ä¸ªConcurrentHashMapä¸­ï¼Œæ‰§è¡Œåªæœ‰ç¬¬ä¸€æ¬¡ç›¸å¯¹è¾ƒæ…¢ã€‚ if (chain.isEmpty()) { Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args); // è¿™é‡Œè¿”å›äº†method.invoke()æ‰§è¡Œåçš„è¿”å›å€¼ã€‚ retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse); } else { // è¿™é‡Œé¢è°ƒç”¨äº†æ‰§è¡Œé“¾ï¼Œåœ¨æ‰§è¡Œé“¾çš„è°ƒç”¨ä¸­ï¼Œä¼šè¿›è¡Œç«ç‚¬ä¼ é€’ã€‚å…·ä½“æ‰§è¡Œæµç¨‹ï¼Œé‡ç‚¹åœ¨ReflectiveMethodInvocation.proceed()ã€‚ invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain); // åœ¨é€’å½’ç»“æŸåï¼Œè¿™é‡Œæœ€ç»ˆä¹Ÿä¼šè¿”å›å®é™…æ–¹æ³•çš„è¿”å›å€¼ã€‚ç«ç‚¬ä¼ é€’çš„è¿‡ç¨‹ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯é€’å½’ï¼Œåªæ˜¯å°†ReflectiveMethodInvocation // æœ¬èº«å½“åšå‚æ•°ä¸æ–­åœ°å‘ä¸‹ä¼ é€’ã€‚ retVal = invocation.proceed(); } // çœç•¥æ— å…³ä»£ç ... return retVal; }finally { // å•ä¾‹æƒ…å†µä¸‹ï¼ŒtargetSourceç±»å‹æ˜¯SingletonTargetSourceï¼Œè¿™ä¸ªç±»ä¸­çš„releaseTargetæ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œä¸ç”¨çœ‹ã€‚ if (target != null \u0026\u0026 !targetSource.isStatic()) { targetSource.releaseTarget(target); }// å¦‚æœé…ç½®äº†å…è®¸æš´éœ²ä»£ç†å¯¹è±¡ï¼Œåœ¨å‰é¢è®¾ç½®ThreadLocalå˜é‡æ—¶ï¼Œä¼šæŠŠå±€éƒ¨å˜é‡setProxyContextè®¾ç½®ä¸ºtrue if (setProxyContext) { // å°†æ—§çš„ä»£ç†å¯¹è±¡è®¾ç½®åˆ°å½“å‰ä»£ç†å¯¹è±¡ä¸­ï¼Œè¿™é‡Œå’Œæ‰§è¡Œé“¾ç«ç‚¬ä¼ é€’å¼æ— å…³çš„ã€‚ // å¦‚æœå½“å‰ä»£ç†æ–¹æ³•æ˜¯ä»ä¸€ä¸ªä»£ç†å¯¹è±¡æ–¹æ³•å†…è°ƒç”¨è¿‡æ¥çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªThreadLocalå˜é‡ä¸­æ˜¯æœ‰å€¼çš„ï¼Œæ‰§è¡Œå½“å‰ä»£ç†å¯¹è±¡æ–¹æ³•æ—¶ï¼Œ // è®¾ç½®ä¸ºå½“å‰çš„ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œå®Œåï¼Œéœ€è¦é‡æ–°è®¾ç½®å›åŸæ¥çš„ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·æ‰ä¸ä¼šä¹±å¥—ã€‚ // å…¶ç”¨é€”æ˜¯ï¼Œå½“é¡¹ç›®ä¸­é…ç½®å…è®¸æš´éœ²ä»£ç†å¯¹è±¡æ—¶ï¼Œå¯ä»¥é€šè¿‡AopContext.currentProxy() æ¥è·å–åˆ°å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„ä»£ç†å¯¹è±¡ã€‚ // Restore old proxy. AopContext.setCurrentProxy(oldProxy); } } } } ä»¥ä¸Šä»£ç æœ‰ç‚¹é•¿ï¼Œåˆ å»äº†ä¸€äº›éå…³é”®ç‚¹çš„ä»£ç ã€‚ç€é‡çœ‹ä»£ç ä¸­é«˜äº®éƒ¨åˆ†ï¼Œè¿™äº›æ˜¯å…³é”®èŠ‚ç‚¹ã€‚ invoke() çš„ä¸»æµç¨‹ï¼š å¦‚æœå…è®¸æš´éœ²ä»£ç†å¯¹è±¡ï¼Œå°† ThreadLocal ç±»å‹çš„å…¨å±€å˜é‡ currentProxy è®¾ç½®ä¸ºå½“å‰ä»£ç†å¯¹è±¡ï¼Œå°†æ—§çš„ä»£ç†å¯¹è±¡æ”¾åˆ°å±€éƒ¨å˜é‡ oldProxy ä¸­ï¼ŒsetProxyContext è®¾ç½®ä¸º trueã€‚ è·å–é€šçŸ¥æ–¹æ³•æ‰§è¡Œé“¾ã€‚ï¼ˆæ‰§è¡Œé“¾çš„æ„å»ºï¼‰ å¦‚æœæ‰§è¡Œé“¾ä¸ä¸ºç©ºï¼Œå°†å…¶å°è£…åˆ° ReflectiveMethodInvocation ä¸­ï¼Œè°ƒç”¨ proceed()ã€‚ï¼ˆæ‰§è¡Œé“¾é€’å½’è°ƒç”¨çš„ç«ç‚¬ä¼ é€’ï¼‰ å¦‚æœæœ‰å¿…è¦ï¼Œå…¨å±€å˜é‡ currentProxy è¿˜åŸä¸ºè°ƒå…¥å½“å‰æ–¹æ³•æ—¶çš„çŠ¶æ€ã€‚ ç¬¬1ã€4æ¡ç›¸å¯¹ç®€å•ï¼Œä¸»è¦æ˜¯ç¬¬2ã€3æ¡ç›¸å¯¹å¤æ‚äº›ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/12-aop-proxy-execute-processor/:2:0","tags":["springæºç "],"title":"12 AOP æ‰§è¡Œé“¾çš„åˆ›å»ºå’Œæ‰§è¡ŒåŸç†","uri":"/posts/spring/12-aop-proxy-execute-processor/"},{"categories":["spring"],"content":"2 æ‰§è¡Œé“¾çš„æ„å»º æ¥åˆ° getInterceptorsAndDynamicInterceptionAdvice()ï¼š public class AdvisedSupport extends ProxyConfig implements Advised { public List\u003cObject\u003e getInterceptorsAndDynamicInterceptionAdvice(Method method, @Nullable Class\u003c?\u003e targetClass) { MethodCacheKey cacheKey = new MethodCacheKey(method); List\u003cObject\u003e cached = this.methodCache.get(cacheKey); if (cached == null) { // æ ¹æ®Methodæ¥è·å–æ‰§è¡Œé“¾ã€‚å°†è·å–åˆ°çš„æ‰§è¡Œé“¾åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œé”®å€¼æ˜¯æ ¹æ®MethodCacheKeyï¼Œå®é™…ä¸ŠåŒ…è£…çš„å°±æ˜¯Methodå¯¹è±¡ã€‚ cached = this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice( this, method, targetClass); this.methodCache.put(cacheKey, cached); } return cached; } } è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„mapä½œä¸ºç¼“å­˜ï¼Œå› ä¸ºæ‰§è¡Œé“¾çš„æ„å»ºç›¸å¯¹è¿˜æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼ˆç›¸å¯¹ ConcurrentHashMap çš„ get()ï¼‰ï¼Œæ„å»ºå·¥ä½œåªæ‰§è¡Œä¸€æ¬¡ï¼Œåé¢éƒ½æ˜¯ä»ç¼“å­˜ä¸­è·å–ã€‚ å¾€ä¸‹è¿½è¸ªä»£ç ï¼š public class DefaultAdvisorChainFactory implements AdvisorChainFactory, Serializable { @Override public List\u003cObject\u003e getInterceptorsAndDynamicInterceptionAdvice( Advised config, Method method, @Nullable Class\u003c?\u003e targetClass) { AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance(); Advisor[] advisors = config.getAdvisors(); List\u003cObject\u003e interceptorList = new ArrayList\u003c\u003e(advisors.length); Class\u003c?\u003e actualClass = (targetClass != null ? targetClass : method.getDeclaringClass()); Boolean hasIntroductions = null; for (Advisor advisor : advisors) { if (advisor instanceof PointcutAdvisor) { PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor; if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) { MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher(); boolean match; // çœç•¥éƒ¨åˆ†ä»£ç ... match = mm.matches(method, actualClass); if (match) { // TODO é‡ç‚¹ è·å–MethodInterceptoråˆ—è¡¨ã€‚ MethodInterceptor[] interceptors = registry.getInterceptors(advisor); if (mm.isRuntime()) { // Creating a new object instance in the getInterceptors() method // isn't a problem as we normally cache created chains. for (MethodInterceptor interceptor : interceptors) { interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm)); } } else { interceptorList.addAll(Arrays.asList(interceptors)); } } } } // çœç•¥... } return interceptorList; } } ä» Advised ä¸­æ‹¿åˆ° advisorsï¼Œé‡Œé¢åŒ…å«äº†å‰é¢æµç¨‹æœé›†çš„æ‰€æœ‰é€šçŸ¥æ–¹æ³•åŒ…è£…çš„ Advisorï¼Œå¯¹å…¶éå†ï¼Œå¯¹ PointcutAdvisor ç±»å‹çš„æ‰§è¡Œæ–¹æ³•åŒ¹é…ï¼ŒåŒ¹é…ä¸º trueï¼Œè°ƒç”¨ getInterceptors()ï¼Œå°†è·å–åˆ°çš„ MethodInterceptor å°è£…åˆ° list ä¸­ã€‚ ä¸‹æ¬¡å†è°ƒç”¨åˆ°å½“å‰æ–¹æ³•æ—¶ï¼Œä»ç¼“å­˜ä¸­ç›´æ¥è·å–çš„å°±æ˜¯è¿™ä¸ª MethodInterceptor åˆ—è¡¨ã€‚ æ¥åˆ° getInterceptors()ï¼Œçœ‹ä¸€ä¸‹æ˜¯æ€ä¹ˆè·å–çš„ï¼š public class DefaultAdvisorAdapterRegistry implements AdvisorAdapterRegistry, Serializable { public MethodInterceptor[] getInterceptors(Advisor advisor) throws UnknownAdviceTypeException { // ä»Adviceè·å–MethodInterceptorã€‚beforeã€afterReturningçš„å¢å¼ºä¼šè¢«AdvisorAdapteråŒ¹é…åˆ°ã€‚ // å…¶ä»–è‡ªå®šä¹‰çš„å¢å¼ºæ–¹æ³•ï¼Œéƒ½æ˜¯MethodInterceptorç±»å‹ï¼Œè¢«å¼ºè½¬åï¼Œç›´æ¥åŠ å…¥åˆ°interceptorsä¸­ã€‚ List\u003cMethodInterceptor\u003e interceptors = new ArrayList\u003c\u003e(3); Advice advice = advisor.getAdvice(); // å¦‚æœæ˜¯MethodInterceptorï¼Œå°†å…¶æ·»åŠ åˆ°æ‹¦æˆªå™¨é“¾ä¸­ if (advice instanceof MethodInterceptor) { interceptors.add((MethodInterceptor) advice); } // å¦‚æœæœ‰AdviceorAdapteræ”¯æŒå½“å‰adviceï¼Œè¿›è¡Œé€‚é…ï¼Œè·å–interceptorã€‚adapterså˜é‡çš„å€¼ï¼Œæ˜¯åœ¨æ— å‚æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„ã€‚ for (AdvisorAdapter adapter : this.adapters) { if (adapter.supportsAdvice(advice)) { interceptors.add(adapter.getInterceptor(advisor)); } } if (interceptors.isEmpty()) { throw new UnknownAdviceTypeException(advisor.getAdvice()); } return interceptors.toArray(new MethodInterceptor[0]); } } ä¸Šé¢ä»£ç æµç¨‹ï¼š ä» advisor ä¸­è·å– Advice å¯¹è±¡ï¼Œå¦‚æœè¿™ä¸ª Advice æ˜¯ MethodInterceptor ç±»å‹ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ° interceptors ä¸­ éå† adaptersï¼Œå¦‚æœæ”¯æŒå½“å‰ Adviceï¼Œä½¿ç”¨ getInterceptor è·å–å¯¹åº”çš„ MethodInterceptorï¼ˆè‡³äºadapterså­˜å‚¨äº†ä»€ä¹ˆï¼Œåœ¨å“ªé‡Œåˆå§‹åŒ–çš„ï¼Œå‰æ–‡ä¸­æœ‰ï¼‰ã€‚ å°† interceptors è½¬æ¢ä¸ºæ•°ç»„è¿”å›ã€‚ è¿™é‡Œçœ‹ä¸¤ä¸ªå…¸å‹çš„getInterceptorå¾—å®ç°ã€‚ @Before æ³¨è§£çš„é€šçŸ¥æ–¹æ³•ï¼š class MethodBeforeAdviceAdapter implements AdvisorAdapter, Serializable { // æ˜¯å¦æ”¯æŒæŒ‡å®šçš„ Advice @Override public boolean supportsAdvice(Advice advice) { return (advice instanceof MethodBeforeAdvice); } // ä»Advisorä¸­è·å–Adviceï¼Œå¹¶å°è£…åˆ°MethodBeforeAdviceInterceptor @Override public MethodInterceptor getInterceptor(Advisor advisor) { MethodBeforeAdvice advice = (MethodBeforeAdvice) advisor.getAdvice(); return new MethodBeforeAdviceInterceptor(advice); } } @AfterReturning æ³¨è§£çš„é€šçŸ¥æ–¹æ³•ï¼š cl","date":"2020-12-01","objectID":"/posts/spring/12-aop-proxy-execute-processor/:3:0","tags":["springæºç "],"title":"12 AOP æ‰§è¡Œé“¾çš„åˆ›å»ºå’Œæ‰§è¡ŒåŸç†","uri":"/posts/spring/12-aop-proxy-execute-processor/"},{"categories":["spring"],"content":"3 æ‰§è¡Œé“¾é€’å½’è°ƒç”¨çš„ç«ç‚¬ä¼ é€’ æ„å»ºå®Œæ‰§è¡Œé“¾ä¹‹åï¼Œå°±æ˜¯æ‰§è¡Œäº†ã€‚ ä»ä¸»æµç¨‹æºç ä¸­å·²ç»çŸ¥é“ï¼ŒçœŸæ­£çš„æ‰§è¡Œæ˜¯åœ¨ proceed() ä¸­è¿›è¡Œçš„ã€‚ çœ‹ä¸€ä¸‹ proceed() æºç ï¼š public class ReflectiveMethodInvocation implements ProxyMethodInvocation, Cloneable { // å½“å‰æ‰§è¡Œé“¾çš„ç´¢å¼•ï¼Œæ ‡è¯†æ‰§è¡Œåˆ°å“ªä¸€ä¸ªé€šçŸ¥æ–¹æ³•äº†ã€‚ private int currentInterceptorIndex = -1; public Object proceed() throws Throwable { // We start with an index of -1 and increment early. // å¦‚æœæ‰§è¡Œé“¾ä¸­çš„adviceå…¨éƒ¨æ‰§è¡Œå®Œï¼Œåˆ™ç›´æ¥è°ƒç”¨joinPointæ–¹æ³•ï¼Œå°±æ˜¯è¢«ä»£ç†æ–¹æ³•ã€‚ // è¿™é‡Œçš„æˆå‘˜å˜é‡currentInterceptorIndexä¼šè®°å½•ç›®å‰æ‰§è¡Œåˆ°å“ªä¸€ä¸ªå¢å¼ºæ–¹æ³•äº†ã€‚ // æœ€ç»ˆä¸€å®šä¼šè¿”å›ä»£ç†æ–¹æ³•çš„è¿”å›å€¼ï¼Œå› ä¸ºæ²¡æœ‰å…¶ä»–è·¯å¾„è¿”å›äº†ï¼Œå…¶ä»–è·¯å¾„éƒ½æ˜¯é€’å½’è°ƒç”¨ã€‚ if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) { return invokeJoinpoint(); } // æ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ï¼Œè¯´æ˜è¿›å…¥åˆ°äº†å¢å¼ºæ–¹æ³•ï¼Œå½“å‰æ‰§è¡Œçš„ç´¢å¼•+1ï¼Œå½“æ‰§è¡Œåˆ°æœ€åä¸€ä¸ªæ—¶ï¼Œæ­¤å€¼ä¼šä¸æ‰§è¡Œé“¾çš„é•¿åº¦-1ç›¸ç­‰ï¼Œè¿™æ—¶å€™å°±ä¼šè°ƒç”¨è¢«ä»£ç†æ–¹æ³•ã€‚ Object interceptorOrInterceptionAdvice = this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex); // è¿™æ®µä¸ç”¨çœ‹ï¼Œç›´æ¥çœ‹elseé‡Œé¢çš„ä»£ç ã€‚ if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) { // çœç•¥... } else { // è°ƒç”¨MethodInterceptorä¸­çš„invokeæ–¹æ³•,å¹¶å°†è‡ªèº«ä½œä¸ºå‚æ•°å‘ä¸‹ä¼ é€’ï¼Œè¿™é‡Œå°±æ˜¯ä¸ªç«ç‚¬ä¼ é€’çš„è¿‡ç¨‹ã€‚ // It's an interceptor, so we just invoke it: The pointcut will have // been evaluated statically before this object was constructed. return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this); } } } å·²ç»çŸ¥é“ï¼Œæˆ‘ä»¬å®šä¹‰çš„åˆ‡é¢é€šçŸ¥æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œé“¾ä¸­éƒ½è¢«å°è£…ä¸º MethodInterceptor ç±»å‹äº†ã€‚ æ³¨æ„æˆå‘˜å˜é‡ currentInterceptorIndexï¼Œå®ƒæ˜¯ç”¨æ¥æ ‡è¯†æ‰§è¡Œé“¾æ‰§è¡Œåˆ°å“ªä¸ªèŠ‚ç‚¹äº†ã€‚åˆå§‹å€¼æ˜¯-1ï¼Œæ¯è°ƒç”¨ä¸€ä¸ªé€šçŸ¥æ–¹æ³•éƒ½ä¼šè‡ªå¢ï¼Œå½“è¾¾åˆ°æ‰§è¡Œé“¾çš„æœ«å°¾ï¼Œå°±ä¼šé€šè¿‡åå°„æ‰§è¡Œè¢«ä»£ç†æ–¹æ³•ã€‚ æ‰§è¡Œåˆ°ä¸Šé¢æºç æ–¹æ³•æœ«å°¾æ—¶ï¼Œä¼šè°ƒç”¨æ‰§è¡Œé“¾ä¸­ç´¢å¼•ä¸º ++this.currentInterceptorIndex èŠ‚ç‚¹çš„ MethodInterceptorï¼Œæ‰§è¡Œ invoke(this)ï¼Œæ³¨æ„è¿™ä¸ª invoke(this) ä¸­çš„å‚æ•°ï¼Œå°† this ä¼ é€’è¿›å»ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ª MethodInterceptor éƒ½æŒæœ‰äº† ReflectiveMethodInvocationã€‚è€Œè°ƒç”¨æ‰§è¡Œé“¾æ˜¯é€šè¿‡è°ƒç”¨ ReflectiveMethodInvocation.proceed()ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/12-aop-proxy-execute-processor/:4:0","tags":["springæºç "],"title":"12 AOP æ‰§è¡Œé“¾çš„åˆ›å»ºå’Œæ‰§è¡ŒåŸç†","uri":"/posts/spring/12-aop-proxy-execute-processor/"},{"categories":["spring"],"content":"4 æ€»ç»“ æ‰§è¡Œé“¾çš„ç¼“å­˜æ˜¯åœ¨ AdvisedSupport ä¸­å°è£…çš„ï¼Œæˆå‘˜å˜é‡å methodCacheã€‚æ‰§è¡Œé“¾çš„æ„å»ºæ˜¯åœ¨ AdvisorChainFactory çš„å®ç°ç±» DefaultAdvisorChainFactory ä¸­å®Œæˆçš„ï¼ŒAdvisedSupport ä¸­æœ‰æˆå‘˜å˜é‡ advisorChainFactoryã€‚AdvisedSupport è´Ÿè´£ç¼“å­˜å’Œè·å–æ‰§è¡Œé“¾ï¼ŒAdvisorChainFactoryè´Ÿè´£æ„å»ºæ‰§è¡Œé“¾ã€‚ AdvisedSupport ä¸­ç¼“å­˜äº†æ‰€æœ‰çš„ Advisorï¼Œåœ¨è°ƒç”¨ä»£ç†æ–¹æ³•æ—¶ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šè®¡ç®—æœ‰å“ªäº› Advisor åŒ¹é…åˆ°è¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œå°†åŒ¹é…åˆ°çš„ Advisor è·å–åˆ° Adviceï¼Œè½¬æ¢ä¸º MethodInterceptorï¼Œå°è£…åˆ°æ‰§è¡Œé“¾ä¸­ï¼Œå¹¶å°† æ–¹æ³•å-æ‰§è¡Œé“¾ ç¼“å­˜åˆ° methodCache ä¸­ï¼ŒmethodCache æ˜¯ä¸€ä¸ª ConcurrentHashMapï¼ˆå¹¶å‘å®‰å…¨çš„mapï¼‰ã€‚åé¢å†è°ƒç”¨ä¼šä» methodCache ä¸­è·å–ã€‚ è°ƒç”¨ä»£ç†æ–¹æ³•æ—¶ï¼Œç«ç‚¬ä¼ é€’å¼çš„é€’å½’æ‰§è¡Œï¼Œè¿™ä¸ªæ“ä½œå°è£…åœ¨ ReflectiveMethodInvocation ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ ReflectiveMethodInvocation è´Ÿè´£ä»£ç†æ–¹æ³•çš„æ‰§è¡Œã€‚å…¶æ‰§è¡Œé€»è¾‘æ˜¯é€’å½’è°ƒç”¨è‡ªèº«ï¼Œæ¯æ¬¡è°ƒç”¨å–æ‰§è¡Œé“¾ä¸­ä¸‹ä¸€ä¸ªç´¢å¼•çš„é€šçŸ¥æ–¹æ³•ï¼Œå¹¶å°†è‡ªèº«ä½œä¸ºå‚æ•°åœ¨é€šçŸ¥æ–¹æ³•ä¸­ä¼ é€’ï¼Œç›´è‡³æ‰§è¡Œé“¾æœ«å°¾ï¼Œè°ƒç”¨å®Œè¢«ä»£ç†æ–¹æ³•ï¼Œè¿”å›è¢«ä»£ç†æ–¹æ³•æ‰§è¡Œåçš„è¿”å›å€¼ã€‚ ä¹‹æ‰€ä»¥è¿™ä¹ˆåšï¼Œä¹Ÿæ˜¯ä¸ºäº†è§£è€¦ã€‚å……åˆ†ä½“ç°äº†å¼€å‘åŸåˆ™ä¸­çš„å•ä¸€èŒè´£åŸåˆ™ï¼ˆä¸€ä¸ªç±»åªå¹²ä¸€ä»¶äº‹ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ä¸ªåŸåˆ™ï¼Œå…¶ä»–åŸåˆ™éƒ½æ˜¯ä¸ºå…¶å±•å¼€çš„ï¼‰ã€‚ ä½¿ç”¨ currentInterceptorIndex ç´¢å¼•æ¥æ ‡è¯†æ‰§è¡ŒèŠ‚ç‚¹çš„ä½ç½®çš„å¥½å¤„ï¼šä¸ç”¨åœ¨å…·ä½“èŠ‚ç‚¹ä¸­ï¼Œå…³å¿ƒæ‰§è¡Œé“¾å‚æ•°æ˜¯ä»€ä¹ˆã€ä»¥åŠå¦‚ä½•ä¼ é€’çš„ï¼Œå¯ä»¥çœ‹åˆ° ReflectiveMethodInvocation.proceed() æ˜¯ä¸€ä¸ªæ— å‚æ•°çš„æ–¹æ³•ã€‚ è‡³äºä¸ºä»€ä¹ˆåœ¨æ„å»ºæ‰§è¡Œé“¾çš„æ—¶å€™ï¼Œè¦æŠŠæ‰€æœ‰ç±»å‹çš„ Advice éƒ½å°è£…æˆ MethodInterceptor ï¼Ÿè®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸è¿™ä¹ˆåšï¼Œåœ¨ç«ç‚¬ä¼ é€’çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå­˜åœ¨å¤§é‡çš„ if è¯­å¥ï¼Œä¸”ä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸§å¤±æ‰©å±•æ€§ã€‚è¿™ä¹Ÿæ˜¯ç­–ç•¥æ¨¡å¼çš„ä¸€ç§ä½“ç°ï¼Œæ¶ˆé™¤äº†å¤§é‡ if è¯­å¥ï¼Œä¸”ä½¿å¾—ä»£ç å˜å¾—å¯æ‰©å±•ã€‚ è‡³äºæ‰§è¡Œé“¾ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦‚ä½•æ‰§è¡Œï¼Œå¹¶å°† ReflectiveMethodInvocation å‘ä¸‹ä¼ é€’çš„ï¼Œåœ¨åˆ«çš„ç« èŠ‚è¯´æ˜ã€‚ é™„ - æ„Ÿæƒ³ ç›¸è¾ƒäº dubbo æºç  çš„â€˜å‡Œä¹±â€™ï¼ˆå½“ç„¶ï¼Œå®ƒä¿©æ ¹æœ¬ä¸åœ¨ä¸€ä¸ªé‡çº§ï¼‰ï¼Œspring çœŸçš„æ˜¯å°†ä»£ç å†™æˆäº†è‰ºæœ¯ã€‚ä¸æ„§æ˜¯éŸ³ä¹å­¦åšå£«å†™å‡ºçš„ä»£ç ï¼ŒçœŸçš„å¾ˆä¼˜é›…ã€‚ğŸ˜„ é™„ - é€’å½’çš„å®šä¹‰ï¼ˆæ¥æºç™¾åº¦ç™¾ç§‘ï¼‰ ç¨‹åºè°ƒç”¨è‡ªèº«çš„ç¼–ç¨‹æŠ€å·§ç§°ä¸ºé€’å½’ï¼ˆ recursionï¼‰ã€‚é€’å½’åšä¸ºä¸€ç§ç®—æ³•åœ¨ç¨‹åºè®¾è®¡è¯­è¨€ä¸­å¹¿æ³›åº”ç”¨ã€‚ ä¸€ä¸ªè¿‡ç¨‹æˆ–å‡½æ•°åœ¨å…¶å®šä¹‰æˆ–è¯´æ˜ä¸­æœ‰ ç›´æ¥æˆ–é—´æ¥ è°ƒç”¨è‡ªèº«çš„ä¸€ç§æ–¹æ³•ï¼Œå®ƒé€šå¸¸æŠŠä¸€ä¸ªå¤§å‹å¤æ‚çš„é—®é¢˜å±‚å±‚è½¬åŒ–ä¸ºä¸€ä¸ªä¸åŸé—®é¢˜ç›¸ä¼¼çš„è§„æ¨¡è¾ƒå°çš„é—®é¢˜æ¥æ±‚è§£ï¼Œé€’å½’ç­–ç•¥åªéœ€å°‘é‡çš„ç¨‹åºå°±å¯æè¿°å‡ºè§£é¢˜è¿‡ç¨‹æ‰€éœ€è¦çš„å¤šæ¬¡é‡å¤è®¡ç®—ï¼Œå¤§å¤§åœ°å‡å°‘äº†ç¨‹åºçš„ä»£ç é‡ã€‚é€’å½’çš„èƒ½åŠ›åœ¨äºç”¨æœ‰é™çš„è¯­å¥æ¥å®šä¹‰å¯¹è±¡çš„æ— é™é›†åˆã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé€’å½’éœ€è¦æœ‰è¾¹ç•Œæ¡ä»¶ã€é€’å½’å‰è¿›æ®µå’Œé€’å½’è¿”å›æ®µã€‚å½“è¾¹ç•Œæ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œé€’å½’å‰è¿›ï¼›å½“è¾¹ç•Œæ¡ä»¶æ»¡è¶³æ—¶ï¼Œé€’å½’è¿”å›ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/12-aop-proxy-execute-processor/:5:0","tags":["springæºç "],"title":"12 AOP æ‰§è¡Œé“¾çš„åˆ›å»ºå’Œæ‰§è¡ŒåŸç†","uri":"/posts/spring/12-aop-proxy-execute-processor/"},{"categories":["spring"],"content":"AOP ä»£ç†å®ä¾‹çš„åˆ›å»º","date":"2020-12-01","objectID":"/posts/spring/11-aop-proxy-create-processor/","tags":["springæºç "],"title":"11 AOP ä»£ç†å®ä¾‹çš„åˆ›å»º","uri":"/posts/spring/11-aop-proxy-create-processor/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/11-aop-proxy-create-processor/:1:0","tags":["springæºç "],"title":"11 AOP ä»£ç†å®ä¾‹çš„åˆ›å»º","uri":"/posts/spring/11-aop-proxy-create-processor/"},{"categories":["spring"],"content":"1 åˆ›å»ºå®ä¾‹çš„æµç¨‹ åˆ›å»ºä»£ç†å®ä¾‹åœ¨ createProxy() ä¸­è¿›è¡Œã€‚ createProxy() ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„æ–¹æ³•ï¼š buildAdvisors() getProxy() æºç å¦‚ä¸‹ï¼š public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware { protected Object createProxy(Class\u003c?\u003e beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource) { // çœç•¥... // æ³¨æ„è¿™ä¸ªProxyFactoryï¼Œé‡Œé¢å°è£…äº† Advisors ProxyFactory proxyFactory = new ProxyFactory(); proxyFactory.copyFrom(this); // çœç•¥... // TODO é‡ç‚¹ï¼šæ„å»ºå¢å¼ºå¯¹è±¡ï¼Œè¿™é‡Œä¼šåœ¨åŸæœ‰çš„Advisoråˆ—è¡¨ä¸­ï¼Œå¢åŠ å­˜åœ¨çš„MethodInterceptor Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); proxyFactory.addAdvisors(advisors); proxyFactory.setTargetSource(targetSource); customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) { proxyFactory.setPreFiltered(true); } // TODO é‡ç‚¹ï¼šç”Ÿæˆä»£ç†å¯¹è±¡ return proxyFactory.getProxy(getProxyClassLoader()); } } ","date":"2020-12-01","objectID":"/posts/spring/11-aop-proxy-create-processor/:2:0","tags":["springæºç "],"title":"11 AOP ä»£ç†å®ä¾‹çš„åˆ›å»º","uri":"/posts/spring/11-aop-proxy-create-processor/"},{"categories":["spring"],"content":"2 æ„å»ºAdvisor - buildAdvisors æ¥åˆ° buildAdvisors() æºç ï¼š public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware { protected Advisor[] buildAdvisors(@Nullable String beanName, @Nullable Object[] specificInterceptors) { // Handle prototypes correctly... // è·å–å·²æœ‰çš„æ–¹æ³•æ‹¦æˆªå™¨ï¼Œåç§°ï¼Œå¹¶åŒ…è£…æˆAdvisor Advisor[] commonInterceptors = resolveInterceptorNames(); List\u003cObject\u003e allInterceptors = new ArrayList\u003c\u003e(); if (specificInterceptors != null) { allInterceptors.addAll(Arrays.asList(specificInterceptors)); if (commonInterceptors.length \u003e 0) { if (this.applyCommonInterceptorsFirst) { allInterceptors.addAll(0, Arrays.asList(commonInterceptors)); } else { allInterceptors.addAll(Arrays.asList(commonInterceptors)); } } } // çœç•¥éƒ¨åˆ†ä»£ç ... Advisor[] advisors = new Advisor[allInterceptors.size()]; for (int i = 0; i \u003c allInterceptors.size(); i++) { // åœ¨è¿™é‡Œè¿›è¡Œæ„å»ºçš„ï¼Œæœ€ç»ˆï¼Œæ‰€æœ‰çš„é€šçŸ¥æ–¹æ³•éƒ½ä¼šå°è£…æˆAdvisorã€‚ // å®é™…ä¸Šæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„åˆ‡é¢ï¼Œåˆ°è¿™é‡Œæ—¶ï¼Œéƒ½å·²ç»æ˜¯Advisoräº†ï¼Œæ²¡æœ‰åšä»»ä½•å¤„ç†ç›´æ¥è¿”å›äº†ã€‚ // ä¹‹æ‰€ä»¥åœ¨è¿™é‡Œè¦å†è¿›è¡Œå°è£…ï¼Œæ˜¯å› ä¸ºSpringä¸­æ¶‰åŠè¿‡å¤šçš„æ‹¦æˆªå™¨ï¼Œå¢å¼ºå™¨ï¼Œå¢å¼ºæ–¹æ³•ç­‰æ–¹å¼æ¥å¯¹é€»è¾‘è¿›è¡Œå¢å¼ºï¼Œ // æœ‰äº›æƒ…å†µallInterceptorsä¸­å¯èƒ½å­˜åœ¨Adviceå¯¹è±¡ï¼Œæ‰€ä»¥éå¸¸æœ‰å¿…è¦ç»Ÿä¸€å°è£…æˆAdvisor advisors[i] = this.advisorAdapterRegistry.wrap(allInterceptors.get(i)); } return advisors; } } ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œé¦–é€‰è·å–äº†ä¸€ä¸ª Advisor æ•°ç»„ï¼Œç„¶åä¸ä¹‹å‰æœé›†å¥½çš„ Advisor æ•°ç»„è¿›è¡Œåˆå¹¶ã€‚ å¯¹åˆå¹¶åçš„ç»“æœè¿›è¡Œéå†ï¼Œç„¶åè°ƒç”¨ advisorAdapterRegistry.wrap()ï¼Œwrap() æ–¹æ³•çš„ä½œç”¨ï¼Œæºç æ³¨é‡Šä¸­æœ‰è¯¦ç»†è¯´æ˜ã€‚ ç®€å•çœ‹ä¸€ä¸‹ resolveInterceptorNames() çš„è¿‡ç¨‹ï¼š public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware { private Advisor[] resolveInterceptorNames() { BeanFactory bf = this.beanFactory; ConfigurableBeanFactory cbf = (bf instanceof ConfigurableBeanFactory ? (ConfigurableBeanFactory) bf : null); List\u003cAdvisor\u003e advisors = new ArrayList\u003c\u003e(); // è¿™é‡Œä¼šæ ¹æ®interceptorNamesä¸­å­˜å‚¨çš„æ‹¦æˆªå™¨åç§°ï¼Œè·å–åˆ°å¯¹åº”çš„beanå®ä¾‹ï¼Œæœ€ç»ˆåŒ…è£…æˆAdvisorï¼Œæ·»åŠ åˆ°åˆ—è¡¨ä¸­è¿”å›ã€‚ for (String beanName : this.interceptorNames) { if (cbf == null || !cbf.isCurrentlyInCreation(beanName)) { Assert.state(bf != null, \"BeanFactory required for resolving interceptor names\"); Object next = bf.getBean(beanName); advisors.add(this.advisorAdapterRegistry.wrap(next)); } } return advisors.toArray(new Advisor[0]); } } ä»£ç æµç¨‹æ˜¯ï¼šé¦–å…ˆå¯¹ interceptorNames è¿›è¡Œéå†ï¼Œä¾æ¬¡å¯¹å…¶è¿›è¡Œ getBean æ“ä½œï¼Œç„¶åä½¿ç”¨ advisorAdapterRegistry.wrap() å°†å…¶åŒ…è£…æˆ Advisorã€‚ æ¥åˆ° advisorAdapterRegistry.wrap()ï¼š public class DefaultAdvisorAdapterRegistry implements AdvisorAdapterRegistry, Serializable { public Advisor wrap(Object adviceObject) throws UnknownAdviceTypeException { //å¦‚æœè¦å°è£…çš„å¯¹è±¡æœ¬èº«å°±æ˜¯Advisorç±»å‹çš„ï¼Œæ— é¡»åšä»»ä½•å¤„ç† if (adviceObject instanceof Advisor) { return (Advisor) adviceObject; } //å› ä¸ºæ­¤å°è£…åªå¯¹Advisorå’ŒAdviceä¸¤ç§ç±»å‹çš„æ•°æ®æœ‰æ•ˆï¼Œå¦‚æœä¸æ˜¯å°†ä¸èƒ½å°è£… if (!(adviceObject instanceof Advice)) { throw new UnknownAdviceTypeException(adviceObject); } Advice advice = (Advice) adviceObject; if (advice instanceof MethodInterceptor) { //å¦‚æœæ˜¯MethodInterceptorç±»å‹åˆ™ä½¿ç”¨DefaultPointcutrAdvisorå°è£… // So well-known it doesn't even need an adapter. return new DefaultPointcutAdvisor(advice); } // å¦‚æœå­˜åœ¨Advisorç±»å‹çš„é€‚é…å™¨é‚£ä¹ˆä¹ŸåŒæ ·éœ€è¦è¿›è¡Œå°è£… for (AdvisorAdapter adapter : this.adapters) { // Check that it is supported. // @Before,@Afterä½¿ç”¨çš„DefaultPointcutAdvisor if (adapter.supportsAdvice(advice)) { return new DefaultPointcutAdvisor(advice); } } throw new UnknownAdviceTypeException(advice); } } ä¸Šé¢æºç é€»è¾‘æ¯”è¾ƒç®€å•ï¼š é¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„å®ä¾‹æ˜¯å¦ä¸º Advisor å®ç°ç±»ï¼Œå¦‚æœä¸º true ä¸ä½œä»»ä½•å¤„ç†ï¼Œç›´æ¥è¿”å›ã€‚ å¯¹ MethodInterceptor çš„å®ä¾‹ï¼ŒåŒ…è£…æˆ DefaultPointcutAdvisor è¿”å›ã€‚ å¾ªç¯æˆå‘˜ adapters ä¸­é¢„å®šä¹‰çš„æ‰€æœ‰ AdvisorAdapterï¼Œè¿›è¡Œé€‚é…æ“ä½œï¼Œå¦‚æœæœ‰é€‚é…å™¨æ”¯æŒè¿™ä¸ª Adviceï¼Œå°±åŒ…è£…æˆ DefaultPointcutAdvisor è¿”å›ã€‚ å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½æœªå¤„ç†æˆåŠŸï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥è¿™é‡Œä¼ å…¥çš„å¯¹è±¡ä¸€å®šå¾—æ˜¯ä¸€ä¸ª Advice å®ç°ã€‚ å…¶å®æˆ‘ä»¬è‡ªå®šä¹‰çš„åˆ‡é¢ç±»ä¸­çš„é€šçŸ¥å¢å¼ºï¼Œåœ¨è¿™é‡Œéƒ½å·²ç»åŒ…è£…ä¸º Advisoräº†ï¼Œå¤§å¤šæ•°éƒ½æ˜¯èµ°çš„ç›´æ¥è¿”å›ã€‚ å…³äºæˆå‘˜å˜é‡ adaptersï¼Œæ˜¯åœ¨æ— å‚æ„é€ ä¸­åˆå§‹åŒ–çš„: public class DefaultAdvisorAdapterRegistry implements AdvisorAdapterRegistry, Serializable { public DefaultAdvisorAdapterRegistry() { // æ³¨å†Œä¸‰ç§é€‚é…å™¨ã€‚ registerAdvisorAdapter(new MethodBeforeAdviceAdapter()); registerAdvisorAdapter(new AfterReturningAdviceAdapter()); registerAdvisorAdapter(new ThrowsAdviceAdapter()); } } å…³äº MethodInterceptorã€ Adviceã€ AdvisorAdapteræš‚ä¸”è·³è¿‡ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/11-aop-proxy-create-processor/:3:0","tags":["springæºç "],"title":"11 AOP ä»£ç†å®ä¾‹çš„åˆ›å»º","uri":"/posts/spring/11-aop-proxy-create-processor/"},{"categories":["spring"],"content":"3 ç”Ÿæˆä»£ç†å®ä¾‹ - getProxy getProxy() ä¸­åªæœ‰ä¸€è¡Œä»£ç ï¼š public class ProxyFactory extends ProxyCreatorSupport { public Object getProxy(@Nullable ClassLoader classLoader) { //æ ¹æ®ç›®æ ‡å¯¹è±¡æ˜¯å¦æœ‰æ¥å£æ¥åˆ¤æ–­é‡‡ç”¨ä»€ä¹ˆä»£ç†æ–¹å¼ï¼Œcglibä»£ç†è¿˜æ˜¯jdkåŠ¨æ€ä»£ç† return createAopProxy().getProxy(classLoader); } } å…ˆçœ‹ç¬¬ä¸€ä¸ªæ–¹æ³• createAopProxy()ã€‚ æ­¥éª¤ä¸€ï¼ˆæ³¨æ„è°ƒç”¨ä¸‹ä¸€æ­¥æ–¹æ³•çš„å‚æ•°ï¼‰ï¼š public class ProxyCreatorSupport extends AdvisedSupport { protected final synchronized AopProxy createAopProxy() { if (!this.active) { activate(); } return getAopProxyFactory().createAopProxy(this); } } ä»ä¸Šé¢ä»£ç çœ‹å‡ºï¼Œä¼šè°ƒåˆ°å¦ä¸€ä¸ªæ–¹æ³•ï¼Œæ³¨æ„è¿™ä¸ªå‚æ•°ï¼Œä¼ å…¥äº†ä¸€ä¸ª AdvisedSupportï¼Œé‡Œé¢å°è£…äº†é€šçŸ¥æ–¹æ³•ã€åˆ‡ç‚¹ç­‰ä¿¡æ¯ã€‚ æ­¥éª¤äºŒï¼š public class DefaultAopProxyFactory implements AopProxyFactory, Serializable { @Override public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException { if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) { Class\u003c?\u003e targetClass = config.getTargetClass(); // å¦‚æœç›®æ ‡ç±»æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåˆ™ä½¿ç”¨JDKåŠ¨æ€ä»£ç† if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) { return new JdkDynamicAopProxy(config); } // ä½¿ç”¨cglibä»£ç†ã€‚ return new ObjenesisCglibAopProxy(config); } else { return new JdkDynamicAopProxy(config); } } } ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå°† AdvisedSupport å°è£…åˆ°äº†åˆ›å»ºä»£ç†çš„å¯¹è±¡ä¸­ã€‚ æœ‰ä¸¤ç§æƒ…å†µï¼Œå¯èƒ½ä¼šä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€æˆ–è€…ä½¿ç”¨ Cglib å­ç±»ä»£ç†ã€‚æ— è®ºæ˜¯xmlæ–¹å¼è¿˜æ˜¯æ³¨è§£æ–¹å¼é…ç½®ï¼Œæ¿€æ´»ä»£ç†æ—¶éƒ½å¯ä»¥é…ç½®ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å±æ€§ proxyTargetClassï¼Œå¦‚æœä¸é…ç½®ï¼Œé»˜è®¤å€¼æ˜¯ falseã€‚è¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯ï¼šæŒ‡æ˜æ˜¯å¦è¦åˆ›å»ºåŸºäºå­ç±»ï¼ˆCGLIBï¼‰çš„ä»£ç†ï¼Œè€Œä¸æ˜¯åŸºäºJavaæ ‡å‡†æ¥å£çš„ä»£ç†ã€‚ é»˜è®¤æ˜¯ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦‚æœé…ç½®äº† proxyTargetClass=trueï¼Œä¼šé»˜è®¤ä½¿ç”¨ Cglib å­ç±»ä»£ç†ï¼Œä½†å¦‚æœè¢«ä»£ç†çš„ç±»æœ¬èº«æ˜¯æ¥å£çš„è¯ï¼Œä¾ç„¶ä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†ã€‚ ä»¥ä¸Šè§„å¾‹ä»ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸¤ä¸ª if æ¡ä»¶ä¸­åˆ¤æ–­çš„ã€‚ æ¥ç€çœ‹ getProxy()ï¼Œè¿™é‡ŒçœŸæ­£ç”Ÿæˆäº†ä»£ç†å¯¹è±¡ï¼Œä»¥ JDK åŠ¨æ€ä»£ç†ä¸ºä¾‹ï¼ˆcglibä¹Ÿç±»ä¼¼ï¼Œå…¶å®éƒ½æ˜¯å°† Advisor çš„å¿…è¦ä¿¡æ¯å°è£…åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œå°†æ‰§è¡Œè¡Œä¸ºå°è£…åˆ°å¯¹åº”çš„å›è°ƒå‡½æ•°ä¸­ï¼‰ï¼š final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable { public Object getProxy(@Nullable ClassLoader classLoader) { Class\u003c?\u003e[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true); findDefinedEqualsAndHashCodeMethods(proxiedInterfaces); // åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå‚æ•°ä¸­çš„InvocationHandlerä¼ å…¥çš„æ˜¯thisï¼Œé‚£ä¹ˆæœ¬ç±»ä¸­ä¸€å®šæœ‰invoke()ï¼Œåœ¨è°ƒç”¨ä»£ç†ç±»æ–¹æ³•æ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸ªinvoke()ã€‚ return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this); } } æºç ä¸­è°ƒç”¨äº† Proxy.newProxyInstance() ç”Ÿæˆä»£ç†ï¼Œè¿™æ˜¯å…¸å‹çš„ JDK åŠ¨æ€ä»£ç†çš„ç”Ÿæˆæ–¹å¼ã€‚ æ³¨æ„\r\rä»”ç»†çœ‹ Proxy.newProxyInstance(classLoader, proxiedInterfaces, this)ï¼Œè¿™é‡Œç¬¬ä¸‰ä¸ªä¼ è¾“æ˜¯ thisï¼Œé‚£ä¹ˆè¿™ä¸ª this ä¸€å®šå®ç°äº† InvocationHandler æ¥å£ã€å¹¶å®ç°äº† invoke()ã€‚ è®°ä¸€ä¸‹ JdkDynamicAopProxy çš„å£°æ˜ï¼š final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable å¯ä»¥çœ‹åˆ° JdkDynamicAopProxy å®ç°äº† InvocationHandlerã€‚ \r\r åˆ°è¿™é‡Œï¼Œä»£ç†å¯¹è±¡åˆ›å»ºå®Œæˆã€‚ åŠ¨æ€ä»£ç†çš„å…¥å£æ–¹æ³• wrapIfNecessary() åˆ°è¿™é‡Œæ‰§è¡Œå®Œæˆï¼Œä¼šå°†åˆ›å»ºçš„ä»£ç†å¯¹è±¡è¿”å›ã€‚å°†ä»£ç æ‰§è¡Œæµç¨‹å›è½¬åˆ° doCreateBean ä¸­: â€“\u003e wrapIfNecessary() â€“\u003e postProcessAfterInitialization() â€“\u003e applyBeanPostProcessorsAfterInitialization() â€“\u003e applyBeanPostProcessorsAfterInitialization() â€“\u003e initializeBean() â€“\u003e exposedObject = initializeBean(beanName, exposedObject, mbd); å®é™…ä¸Šï¼ŒSpringå¯¹AOPçš„æ”¯æŒï¼Œè¿™ä¸€æ•´å—å„¿ï¼Œéƒ½æ˜¯åŸºäº BeanPostProcessor.applyBeanPostProcessorsAfterInitialization() å®Œæˆçš„ã€‚ å†—é•¿çš„æµç¨‹ï¼Œæœ€ç»ˆå›è½¬åˆ° doCreateBean ä¸­ï¼Œåœ¨éå† BeanPostProcessor å¹¶ä¾æ¬¡è°ƒç”¨ applyBeanPostProcessorsAfterInitialization() æ—¶ï¼Œä¼ å…¥åˆ›å»ºå¥½çš„beanå®ä¾‹ï¼Œè¿”å›ä¸€ä¸ªå®ä¾‹ï¼Œè€ŒAbstractAutoProxyCreatorä¸­å®šä¹‰äº†éª¨æ¶æ–¹æ³•wrapIfNecessary()ï¼Œè¿™é‡Œé¢è¿”å›äº†ä¸€ä¸ªä»£ç†å®ä¾‹ï¼Œç”±æ­¤æ²¿ç€è°ƒç”¨é“¾å‘ä¸Šè¿”å›ï¼Œæœ€ç»ˆgetBean()å¾—åˆ°çš„å°±å¯èƒ½æ˜¯ä¸€ä¸ªä»£ç†å®ä¾‹ã€‚ ä¹‹æ‰€ä»¥è¯´æ˜¯å¯èƒ½ï¼Œå› ä¸ºåé¢çš„æµç¨‹ï¼Œè¿˜æœ‰ä¸€ä¸ª getObjectForBeanInstance() æ‰§è¡Œï¼Œå¦‚æœ bean æ˜¯ FactoryBean ç±»å‹ï¼Œä¼šè¿”å› getObject() ä¸­è¿”å›çš„å®ä¾‹ã€‚æ–‡ç«  å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean ä¸­æœ‰è¯¦ç»†è¯´æ˜ã€‚ ","date":"2020-12-01","objectID":"/posts/spring/11-aop-proxy-create-processor/:4:0","tags":["springæºç "],"title":"11 AOP ä»£ç†å®ä¾‹çš„åˆ›å»º","uri":"/posts/spring/11-aop-proxy-create-processor/"},{"categories":["spring"],"content":"AOP Advisor çš„æœé›†","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:1:0","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"1 ä¸»æµç¨‹ AOPæ˜¯é€šè¿‡ BeanPostProcessor.postProcessAfterInitialization() å®ç°çš„ï¼Œæ¥åˆ° doCreateBean() -\u003e initializeBean()ï¼Œåœ¨åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œä¼šè°ƒç”¨ applyBeanPostProcessorsAfterInitialization()ï¼Œè¿™é‡Œå¾ªç¯è°ƒç”¨äº†æ‰€æœ‰ BeanPostProcessor çš„ postProcessAfterInitialization()ï¼ŒAOP çš„å…¥å£å°±åœ¨å…¶ä¸­çš„ä¸€ä¸ªå®ç°ç±»ï¼Œä¹Ÿæ˜¯ AbstractAutoProxyCreator çš„å­ç±»å®ç°ã€‚ åœ¨ç”Ÿæˆä»£ç†ä¹‹å‰ï¼Œspring ä¼šæ ¹æ®æ‰«æè§„åˆ™ï¼Œæœé›†å®¹å™¨ä¸­æ³¨å†Œçš„æ‰€æœ‰ Advisor å®ä¾‹ã€å¹¶æœé›†é€šçŸ¥æ–¹æ³•ï¼ˆ@Aspect æ³¨è§£çš„ç±»ä¸­çš„@Beforeã€@Aroundç­‰æ³¨è§£æ ‡è¯†çš„æ–¹æ³•ï¼‰ï¼Œå°†å…¶å°è£…æˆ Advisorã€‚ç„¶åé€ä¸ªä¸å½“å‰ bean å®ä¾‹åŒ¹é…ï¼ŒåŒ¹é…åˆ°çš„æ”¾å…¥ä¸€ä¸ªé›†åˆä¸­ã€‚ æ¥åˆ°å…¥å£æ–¹æ³• postProcessAfterInitialization()ï¼Œæºç å¦‚ä¸‹ï¼š public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware { @Override public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) { if (bean != null) { // å¦‚æœæ˜¯FactoryBeanï¼ŒcacheKeyæ˜¯ \u0026+beanNameæ‹¼æ¥è€Œæˆï¼Œå¦‚æœbenaNameä¸ºç©ºï¼Œåˆ™æ˜¯ç±»åç§°ã€‚ Object cacheKey = getCacheKey(bean.getClass(), beanName); if (!this.earlyProxyReferences.contains(cacheKey)) { // TODO å¿…è¦æ—¶åŒ…è£…ç»™å®šçš„beanï¼Œå³æ˜¯å¦æœ‰èµ„æ ¼è¢«ä»£ç†ã€‚ return wrapIfNecessary(bean, beanName, cacheKey); } } return bean; } } å¦‚æœéœ€è¦ç”Ÿæˆä»£ç†ï¼ˆè‡ªå®šä¹‰åˆ‡é¢ã€äº‹åŠ¡ç­‰ï¼‰ï¼Œä¼šè°ƒç”¨ wrapIfNecessary()ã€‚ wrapIfNecessary() æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware { protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) { // çœç•¥æ— å…³ä»£ç ... // TODO é‡ç‚¹ï¼šå¦‚æœæœ‰éœ€è¦å¢å¼ºï¼Œå°±åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œä¼šå¾ªç¯æ­¤ç±»ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰å¢å¼ºåŒ¹é…åˆ°ç±»ä¸­çš„æ–¹æ³•ï¼Œå°±ä¼šå°†å¢å¼ºå¯¹è±¡å°è£…åˆ°listä¸­ã€‚ // Create proxy if we have advice. Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); if (specificInterceptors != DO_NOT_PROXY) { this.advisedBeans.put(cacheKey, Boolean.TRUE); // TODO é‡ç‚¹ï¼šåˆ›å»ºä»£ç†å¯¹è±¡ Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } } æ³¨æ„\r\rä»æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®ç‚¹æœ‰ä¸¤ä¸ªï¼š æœé›†å®¹å™¨ä¸­æ‰€æœ‰åŒ¹é…å½“å‰beançš„é€šçŸ¥æ–¹æ³•ã€‚ï¼ˆå¦‚æœå½“å‰beanä¸­æœ‰æ–¹æ³•è¢« pointCut åŒ¹é…åˆ°ï¼Œå°±æ»¡è¶³æ¡ä»¶ï¼Œå°†å¯¹åº”çš„é€šçŸ¥æ–¹æ³•å°è£…åˆ°æ•°ç»„ä¸­è¿”å›ï¼‰ æ ¹æ®åŒ¹é…çš„é€šçŸ¥æ–¹æ³•åˆ—è¡¨ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ã€‚ï¼ˆè¿™é‡Œä¼šå°†å·²æ’åºçš„é€šçŸ¥æ–¹æ³•åˆ—è¡¨ï¼Œç”Ÿæˆä¸€ä¸ªæ‰§è¡Œé“¾ï¼Œç¼“å­˜èµ·æ¥ï¼Œå½“ä»£ç†å¯¹è±¡æ–¹æ³•è¢«è°ƒç”¨æ—¶è°ƒç”¨å›è°ƒæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šç«ç‚¬ä¼ é€’å¼çš„è°ƒç”¨æ‰§è¡Œé“¾ä¸­çš„é€šçŸ¥æ–¹æ³•ã€‚JDKåŠ¨æ€ä»£ç†å’Œcgliibå°è£…æ–¹å¼å¤§åŒå°å¼‚ï¼Œé€šçŸ¥æ–¹æ³•éƒ½åœ¨å›è°ƒå‡½æ•°æ‰€åœ¨çš„ç±»ä¸­ä½œä¸ºä¸€ä¸ªæˆå‘˜ç¼“å­˜ã€‚ï¼‰ \r\r ","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:2:0","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"2 æœé›†å°è£…Advisor ","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:3:0","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"2.1 æœé›†æµç¨‹ getAdvicesAndAdvisorsForBean() ä¼šè°ƒç”¨åˆ° findEligibleAdvisors()ã€‚æ¥åˆ°è¿™ä¸ªæ–¹æ³•ï¼š public abstract class AbstractAdvisorAutoProxyCreator extends AbstractAutoProxyCreator { protected List\u003cAdvisor\u003e findEligibleAdvisors(Class\u003c?\u003e beanClass, String beanName) { //æŸ¥æ‰¾åˆ°æ‰€æœ‰çš„å¢å¼ºæ–¹æ³•ï¼Œå°è£…æˆAdvisorå¯¹è±¡ã€‚è¿™é‡ŒæŸ¥æ‰¾äº†ä¸¤ç§å¢å¼ºï¼Œä¸€ç§æ˜¯å®ç°äº†Advisorçš„å®ä¾‹ï¼Œä¸€ç§æ˜¯å¸¦æœ‰@Aspectæ³¨è§£çš„beanå®ä¾‹ä¸­å®šä¹‰çš„å¢å¼ºæ–¹æ³•ã€‚ List\u003cAdvisor\u003e candidateAdvisors = findCandidateAdvisors(); // æ ¹æ®æ¯ä¸ªå¢å¼ºä¸­çš„åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè¿›è¡ŒåŒ¹é…ï¼Œç­›é€‰å‡ºåˆé€‚çš„å¢å¼ºå®ä¾‹åˆ—è¡¨ã€‚ List\u003cAdvisor\u003e eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); extendAdvisors(eligibleAdvisors); // å¯¹å¢å¼ºæ–¹æ³•è¿›è¡Œæ’åºï¼Œå¯ä»¥ä¸çœ‹ã€‚ if (!eligibleAdvisors.isEmpty()) { eligibleAdvisors = sortAdvisors(eligibleAdvisors); } return eligibleAdvisors; } } è¿™é‡Œåˆ†ä¸ºäº†ä¸¤æ­¥ï¼š æ”¶é›†åˆ°å®¹å™¨ä¸­æ‰€æœ‰çš„å¢å¼ºæ–¹æ³•ã€å°è£…æˆ Advisorï¼ˆå¦‚æœæœ¬èº«å°±æ˜¯ Advisorï¼Œç›´æ¥è¿”å›ï¼‰ã€‚ ä»è¿™æ‰€æœ‰çš„ Advisor ä¸­ç­›é€‰å‡ºåŒ¹é…å½“å‰ bean çš„ Advisor åˆ—è¡¨ã€‚ ä» AbstractAutoProxyCreatorçš„æ³¨å†Œ å·²ç»çŸ¥é“ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ AnnotationAwareAspectJAutoProxyCreatorã€‚ è¿›å…¥ findCandidateAdvisors()ï¼š public class AnnotationAwareAspectJAutoProxyCreator extends AspectJAwareAdvisorAutoProxyCreator { @Override protected List\u003cAdvisor\u003e findCandidateAdvisors() { // TODO ä»çˆ¶ç±»ä¸­è·å–ï¼Œè¿™é‡Œè·å–äº†æ‰€æœ‰æ³¨å…¥åˆ°å®¹å™¨ä¸­çš„Advisorç±»å‹çš„å®ä¾‹ã€‚äº‹åŠ¡çš„å¢å¼ºå®ä¾‹ï¼Œå°±æ˜¯åœ¨è¿™é‡ŒæŸ¥æ‰¾çš„ã€‚ // Add all the Spring advisors found according to superclass rules. List\u003cAdvisor\u003e advisors = super.findCandidateAdvisors(); // Build Advisors for all AspectJ aspects in the bean factory. if (this.aspectJAdvisorsBuilder != null) { // TODO å°†beanFactoryä¸­ç¼“å­˜çš„æ‰€æœ‰beanå®ä¾‹ï¼Œä¾æ¬¡æ ¡éªŒæ˜¯å¦å¸¦æœ‰@Aspectæ³¨è§£ï¼Œå¦‚æœæœ‰ï¼Œå°†å…¶ä¸­çš„ // å¢å¼ºæ–¹æ³•ã€åˆ‡ç‚¹è¡¨è¾¾å¼ç­‰ä¿¡æ¯ï¼Œå°è£…æˆAdvisorã€‚advisorså˜é‡æœ€ç»ˆå­˜å‚¨äº†æ‰€æœ‰åˆ‡é¢çš„å¢å¼ºæ–¹æ³•å°è£…ã€‚ advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors()); } return advisors; } } çœ‹ä¸Šé¢ä»£ç ï¼Œé¦–å…ˆï¼Œä»çˆ¶ç±»ä¸­æŸ¥æ‰¾ Advisoråˆ—è¡¨ï¼Œç„¶åè°ƒç”¨ buildAspectJAdvisors()ï¼Œå°†ä¸¤è€…ç»“æœèšåˆåˆ°ä¸€ä¸ªåˆ—è¡¨ã€‚ å…ˆçœ‹çˆ¶ç±»ä¸­çš„ä»£ç ï¼š public class BeanFactoryAdvisorRetrievalHelper { public List\u003cAdvisor\u003e findAdvisorBeans() { String[] advisorNames = this.cachedAdvisorBeanNames; if (advisorNames == null) { // ä»å®¹å™¨ä¸­è·å–æ‰€æœ‰çš„Advisorç±»å‹çš„é¢beanåç§° advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors( this.beanFactory, Advisor.class, true, false); this.cachedAdvisorBeanNames = advisorNames; } // çœç•¥éå…³é”®ä»£ç ... List\u003cAdvisor\u003e advisors = new ArrayList\u003c\u003e(); for (String name : advisorNames) { if (isEligibleBean(name)) { // ä»beanFactoryä¸­è·å–æ‰€æœ‰çš„Advisorç±»å‹çš„å®ä¾‹ï¼Œäº‹åŠ¡æ”¯æŒTransactionAttributeSourceAdvisorå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªAdvisorã€‚ advisors.add(this.beanFactory.getBean(name, Advisor.class)); } } return advisors; } } è¿™é‡Œæœé›†äº†å®¹å™¨ä¸­æ‰€æœ‰ Advisor ç±»å‹çš„ beanNameï¼Œå¹¶å°†å…¶ç¼“å­˜ã€‚ç„¶åè°ƒç”¨ getBean()ï¼Œå°†å…¶å®ä¾‹åŒ–ã€‚ï¼ˆäº‹åŠ¡çš„ Advisor å…¶å®å°±æ˜¯åœ¨è¿™é‡Œåˆ›å»ºçš„ï¼‰ å†çœ‹å­ç±»ä¸­çš„ä»£ç  buildAspectJAdvisors()ï¼š public class BeanFactoryAspectJAdvisorsBuilder { public List\u003cAdvisor\u003e buildAspectJAdvisors() { List\u003cString\u003e aspectNames = this.aspectBeanNames; // ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶ä¸ºç©ºï¼Œè¿™é‡Œç”¨åˆ°äº†åŒæ£€ç´¢ if (aspectNames == null) { synchronized (this) { aspectNames = this.aspectBeanNames; if (aspectNames == null) { List\u003cAdvisor\u003e advisors = new ArrayList\u003c\u003e(); aspectNames = new ArrayList\u003c\u003e(); String[] beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors( this.beanFactory, Object.class, true, false); for (String beanName : beanNames) { // å¦‚æœä¸æ˜¯åˆæ ¼çš„beanNameï¼Œåˆ™è·³è¿‡ if (!isEligibleBean(beanName)) { continue; } Class\u003c?\u003e beanType = this.beanFactory.getType(beanName); if (beanType == null) { continue; } // åˆ¤æ–­å½“å‰beanTypeæ˜¯å¦æ˜¯ä¸€ä¸ªåˆ‡é¢ã€‚åˆ¤æ–­ç±»ä¸Šæ˜¯å¦æœ‰@Aspect if (this.advisorFactory.isAspect(beanType)) { aspectNames.add(beanName); // åˆ›å»ºåˆ‡é¢å…ƒæ•°æ®å®ä¾‹ï¼Œé‡Œé¢å°è£…äº†åˆ‡é¢ç±»å‹ï¼Œåˆ‡ç‚¹è¡¨è¾¾å¼ç­‰ä¿¡æ¯ã€‚ AspectMetadata amd = new AspectMetadata(beanType, beanName); // é»˜è®¤å°±æ˜¯SINGLETON if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) { MetadataAwareAspectInstanceFactory factory = new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName); // TODO è·å–Advisorï¼Œè¿™é‡Œå°è£…äº†å½“å‰Aspectç±»ä¸­çš„å¢å¼ºæ–¹æ³•ï¼Œæ¯ä¸ªå¢å¼ºæ–¹æ³•éƒ½ä¼šå°è£…æˆä¸€ä¸ªAdvisorã€‚ List\u003cAdvisor\u003e classAdvisors = this.advisorFactory.getAdvisors(factory); if (this.beanFactory.isSingleton(beanName)) { // å°†Advisoræ”¾å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä»ä¸Šé¢çš„æµç¨‹è·å–æ—¶ï¼Œä¼šå…ˆèµ°ç¼“å­˜ï¼Œç¼“å­˜ä¸­æœ‰ï¼Œå°±ä¸ä¼šéå†æŸ¥æ‰¾äº†ã€‚ // è¿™ä¸ªä»£ç å—ä½¿ç”¨äº†åŒæ£€ç´¢ï¼Œè¿™å—ä»£ç åœ¨springå®¹å™¨å¯åŠ¨æ—¶ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚ this.advisorsCache.put(beanName, classAdvisors); } else { this.aspectFactoryCache.put(beanName, factory); } advisors.addAll(classAdvisors); } // çœç•¥... } } this.aspectBeanNames = aspectNames; return advisors; } } } // çœç•¥... // æ ¹æ®åˆ‡é¢åç§°ï¼Œä»ç¼“å­˜ä¸­è·å–åˆ°","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:3:1","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"2.2 PointCutçš„è·å– å…³äºå¦‚ä½•è·å– PointCut çš„ï¼Œæºç å¦‚ä¸‹ï¼š public class ReflectiveAspectJAdvisorFactory extends AbstractAspectJAdvisorFactory implements Serializable { private AspectJExpressionPointcut getPointcut(Method candidateAdviceMethod, Class\u003c?\u003e candidateAspectClass) { // æ‰¾åˆ°åˆ‡é¢ç›¸å…³æ³¨è§£ï¼Œå¹¶æŠŠæ³¨è§£ä¿¡æ¯è§£æå‡ºæ¥ï¼ŒåŒ…è£…æˆAspectJAnnotation AspectJAnnotation\u003c?\u003e aspectJAnnotation = AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod); if (aspectJAnnotation == null) { return null; } // å°†åˆ‡ç‚¹è¡¨è¾¾å¼å°è£…åˆ°AspectJExpressionPointcutä¸­ã€‚è¿™é‡Œå°è£…äº†åˆ‡ç‚¹è¡¨è¾¾å¼ã€åˆ‡é¢ç±»å‹ç­‰ä¿¡æ¯ã€‚ AspectJExpressionPointcut ajexp = new AspectJExpressionPointcut(candidateAspectClass, new String[0], new Class\u003c?\u003e[0]); ajexp.setExpression(aspectJAnnotation.getPointcutExpression()); if (this.beanFactory != null) { ajexp.setBeanFactory(this.beanFactory); } return ajexp; } } æ¥ç€çœ‹ findAspectJAnnotationOnMethod()ï¼š public abstract class AbstractAspectJAdvisorFactory implements AspectJAdvisorFactory { /** è¿™é‡Œå®šä¹‰äº†åˆ‡é¢ä¸­æ”¯æŒçš„æ³¨è§£ï¼Œå‰ç½®ã€åç½®ã€ç¯ç»•ç­‰é€šçŸ¥ç±»å‹ */ private static final Class\u003c?\u003e[] ASPECTJ_ANNOTATION_CLASSES = new Class\u003c?\u003e[] { Pointcut.class, Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class}; // æ­¥éª¤ä¸€ protected static AspectJAnnotation\u003c?\u003e findAspectJAnnotationOnMethod(Method method) { for (Class\u003c?\u003e clazz : ASPECTJ_ANNOTATION_CLASSES) { // å¾ªç¯å»æ‰¾æ³¨è§£ï¼Œå¹¶æŠŠæ³¨è§£ä¿¡æ¯è§£æå‡ºæ¥ï¼ŒåŒ…è£…æˆAspectJAnnotation AspectJAnnotation\u003c?\u003e foundAnnotation = findAnnotation(method, (Class\u003cAnnotation\u003e) clazz); if (foundAnnotation != null) { return foundAnnotation; } } return null; } // æ­¥éª¤äºŒ private static \u003cA extends Annotation\u003e AspectJAnnotation\u003cA\u003e findAnnotation(Method method, Class\u003cA\u003e toLookFor) { // æ‰¾çš„è§„åˆ™å°±æ˜¯æ‰¾æ³¨è§£çš„çˆ¶æ³¨è§£ï¼Œé€’å½’çš„æ–¹å¼å»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡æ³¨è§£ä¸ºæ­¢ A result = AnnotationUtils.findAnnotation(method, toLookFor); if (result != null) { // æŠŠæ³¨è§£é‡Œé¢å¯¹çš„ä¿¡æ¯è§£æå‡ºæ¥ï¼Œç„¶ååŒ…è£…æˆAspectJAnnotationå¯¹è±¡ return new AspectJAnnotation\u003c\u003e(result); } else { return null; } } } ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒASPECTJ_ANNOTATION_CLASSESæ•°ç»„å¸¸é‡ä¸­ï¼Œé¢„å®šä¹‰äº†æ”¯æŒåˆ‡ç‚¹è¡¨è¾¾å¼çš„æ³¨è§£ã€‚å¦‚æœèƒ½åœ¨å½“å‰æ–¹æ³•ä¸Šæ‰¾åˆ°ä»»ä½•ä¸€ç§ï¼Œå°±å°†è¿™ä¸ªåˆ‡ç‚¹ä¿¡æ¯å°è£…æˆ AspectJAnnotationã€‚ ","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:3:2","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"2.3 Advisorçš„åˆå§‹åŒ– è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé‡ç‚¹ï¼Œnew InstantiationModelAwarePointcutAdvisorImpl ä¸­çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚ æ„é€ å‡½æ•°æºç å¦‚ä¸‹ï¼š final class InstantiationModelAwarePointcutAdvisorImpl implements InstantiationModelAwarePointcutAdvisor, AspectJPrecedenceInformation, Serializable { public InstantiationModelAwarePointcutAdvisorImpl(AspectJExpressionPointcut declaredPointcut, Method aspectJAdviceMethod, AspectJAdvisorFactory aspectJAdvisorFactory, MetadataAwareAspectInstanceFactory aspectInstanceFactory, int declarationOrder, String aspectName) { // åˆ‡ç‚¹ã€åˆ‡é¢åç§°ã€é€šçŸ¥æ–¹æ³•åç§°ã€ç­‰ç­‰ä¸€ç³»åˆ—ä¿¡æ¯çš„å°è£… this.declaredPointcut = declaredPointcut; // çœç•¥... if (aspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) { // çœç•¥... }else { // A singleton aspect. this.pointcut = this.declaredPointcut; this.lazy = false; // TODO é‡ç‚¹ï¼Œå®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œè¿™é‡Œå°è£…äº†å…·ä½“çš„Advice this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut); } } } é‡ç‚¹æ–¹æ³•æ˜¯ instantiateAdvice()ï¼Œè¿™é‡Œå®Œæˆäº† Advice çš„åˆ›å»ºã€‚ ç»§ç»­å‘ä¸‹è·Ÿè¸ªä»£ç ï¼š final class InstantiationModelAwarePointcutAdvisorImpl implements InstantiationModelAwarePointcutAdvisor, AspectJPrecedenceInformation, Serializable { private Advice instantiateAdvice(AspectJExpressionPointcut pointcut) { // TODO é‡ç‚¹getAdvice Advice advice = this.aspectJAdvisorFactory.getAdvice(this.aspectJAdviceMethod, pointcut, this.aspectInstanceFactory, this.declarationOrder, this.aspectName); return (advice != null ? advice : EMPTY_ADVICE); } } æ¥åˆ° getAdvice()ï¼š public class ReflectiveAspectJAdvisorFactory extends AbstractAspectJAdvisorFactory implements Serializable { public Advice getAdvice(Method candidateAdviceMethod, AspectJExpressionPointcut expressionPointcut, MetadataAwareAspectInstanceFactory aspectInstanceFactory, int declarationOrder, String aspectName) { // è·å–åˆ‡é¢ç±» Class\u003c?\u003e candidateAspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass(); validate(candidateAspectClass); // æŸ¥æ‰¾åˆ‡ç‚¹è¡¨è¾¾å¼ã€äº”ç§é€šçŸ¥å¢å¼ºæ³¨è§£ã€‚@Beforeç­‰äº”ç§ã€‚ AspectJAnnotation\u003c?\u003e aspectJAnnotation = AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod); if (aspectJAnnotation == null) { return null; } // çœç•¥éƒ¨åˆ†ä»£ç ... AbstractAspectJAdvice springAdvice; // TODO æ‰§è¡Œåˆ¤æ–­ï¼Œé’ˆå¯¹ä¸åŒç±»å‹çš„é€šçŸ¥ï¼Œå°è£…ä¸åŒç±»å‹çš„Advice // è¿™å‡ ä¸ªAdviceçš„å®ç°ç±»è¦è®°ä¸€ä¸‹ã€‚ä¸»è¦ä»¥æ˜¯å¦å®ç°MethodInterceptoræ¥åŒºåˆ†ï¼Œæœ‰çš„å®ç°äº†ï¼Œæœ‰çš„æ²¡æœ‰ã€‚ switch (aspectJAnnotation.getAnnotationType()) { case AtPointcut: if (logger.isDebugEnabled()) { logger.debug(\"Processing pointcut '\" + candidateAdviceMethod.getName() + \"'\"); } return null; case AtAround: springAdvice = new AspectJAroundAdvice( candidateAdviceMethod, expressionPointcut, aspectInstanceFactory); break; case AtBefore: springAdvice = new AspectJMethodBeforeAdvice( candidateAdviceMethod, expressionPointcut, aspectInstanceFactory); break; case AtAfter: springAdvice = new AspectJAfterAdvice( candidateAdviceMethod, expressionPointcut, aspectInstanceFactory); break; case AtAfterReturning: springAdvice = new AspectJAfterReturningAdvice( candidateAdviceMethod, expressionPointcut, aspectInstanceFactory); AfterReturning afterReturningAnnotation = (AfterReturning) aspectJAnnotation.getAnnotation(); if (StringUtils.hasText(afterReturningAnnotation.returning())) { springAdvice.setReturningName(afterReturningAnnotation.returning()); } break; case AtAfterThrowing: springAdvice = new AspectJAfterThrowingAdvice( candidateAdviceMethod, expressionPointcut, aspectInstanceFactory); AfterThrowing afterThrowingAnnotation = (AfterThrowing) aspectJAnnotation.getAnnotation(); if (StringUtils.hasText(afterThrowingAnnotation.throwing())) { springAdvice.setThrowingName(afterThrowingAnnotation.throwing()); } break; default: throw new UnsupportedOperationException( \"Unsupported advice type on method: \" + candidateAdviceMethod); } // çœç•¥... return springAdvice; } } æ³¨æ„\r\rä¸Šé¢ä»£ç ä¸­ï¼ŒAspectJMethodBeforeAdvice ç­‰å‡ ä¸ªAdviceçš„å®ç°è¦çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œäº”ä¸ª Advice å®ç°ï¼Œéƒ¨åˆ†å®ç°äº†MethodInterceptorã€‚ å®ç°äº†MethodInterceptorçš„ï¼š AspectJAroundAdvice AspectJAfterAdvice AspectJAfterThrowingAdvice æœªå®ç°MethodInterceptorçš„ â€“\u003e ç”Ÿæˆæ‰§è¡Œé“¾æ—¶ä¾èµ–çš„é€‚é…å™¨ï¼š AspectJMethodBeforeAdvice â€“\u003e MethodBeforeAdviceAdapter AspectJAfterReturningAdvice â€“\u003e AfterReturningAdviceAdapter å¦å¤–è¿˜æœ‰ä¸€ä¸ªæœªç”¨åˆ°","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:3:3","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"3 ç­›é€‰å‡ºåŒ¹é…çš„Advisor åœ¨è·å–åˆ°å®¹å™¨ä¸­æ‰€æœ‰çš„é€šçŸ¥æ–¹æ³•å°è£…æˆçš„ Advisor åï¼Œä¼šè°ƒç”¨ findAdvisorsThatCanApply()ï¼Œå°† beanName æ”¾å…¥åˆ°ä¸€ä¸ª ThreadLocal ç±»å‹çš„å˜é‡ä¸­ï¼Œç„¶åè°ƒç”¨ findAdvisorsThatCanApply() çš„é‡è½½æ–¹æ³•ã€‚è°ƒç”¨å®Œæ¯•ä¹‹åï¼Œä¼šå°† ThreadLocal å˜é‡ä¸­çš„ beanNameç½®ç©ºã€‚ findAdvisorsThatCanApply() é‡è½½æ–¹æ³•æºç å¦‚ä¸‹ï¼š public abstract class AopUtils { public static List\u003cAdvisor\u003e findAdvisorsThatCanApply(List\u003cAdvisor\u003e candidateAdvisors, Class\u003c?\u003e clazz) { if (candidateAdvisors.isEmpty()) { return candidateAdvisors; } List\u003cAdvisor\u003e eligibleAdvisors = new ArrayList\u003c\u003e(); // å…ˆå¤„ç†IntroductionAdvisorç±»å‹çš„å¢å¼º for (Advisor candidate : candidateAdvisors) { if (candidate instanceof IntroductionAdvisor \u0026\u0026 canApply(candidate, clazz)) { eligibleAdvisors.add(candidate); } } boolean hasIntroductions = !eligibleAdvisors.isEmpty(); // å†å¤„ç†å…¶ä»–ç±»å‹çš„å¢å¼º for (Advisor candidate : candidateAdvisors) { if (candidate instanceof IntroductionAdvisor) { // already processed continue; } // æˆ‘ä»¬è‡ªå®šä¹‰çš„åˆ‡é¢ï¼Œå°±ä¼šèµ°åˆ°è¿™é‡Œï¼Œä½¿ç”¨å·²ç»å°è£…çš„PointcutAdvisorï¼Œæ ¹æ®åˆ‡ç‚¹è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œå…·ä½“çš„åŒ¹é…è¿‡ç¨‹ï¼Œä¸ç”¨çœ‹ã€‚ if (canApply(candidate, clazz, hasIntroductions)) { eligibleAdvisors.add(candidate); } } return eligibleAdvisors; } } è°ƒç”¨ canApply()ï¼Œè¿™é‡Œè¿›è¡Œäº†åˆ‡ç‚¹è¡¨è¾¾å¼ä¸æ–¹æ³•çš„åŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œå°† Advisor æ”¾å…¥åˆ°é›†åˆä¸­ï¼Œå¦åˆ™å°±è·³è¿‡ã€‚ å½“å°†æ‰€æœ‰çš„ Advisor éå†å®Œæ¯•ï¼Œæœ€ç»ˆåŒ¹é…æˆåŠŸçš„ Advisor ä¼šè¢«ç­›é€‰å‡ºæ¥ï¼Œæ”¾å…¥åˆ°ä¸€ä¸ªæ–°çš„é›†åˆä¸­ï¼Œæœ€ç»ˆç”Ÿæˆçš„æ‰§è¡Œé“¾ä¸­çš„é€šçŸ¥æ–¹æ³•ï¼Œå°±æ¥è‡ªç­›é€‰åçš„ Advisor é›†åˆï¼ˆè¿™ä¸ªé›†åˆåœ¨åˆ›å»ºä»£ç†å‰è¿˜æœ‰ä¸€æ¬¡æ–°å¢æ“ä½œï¼‰ã€‚ çœ‹ canApply()ï¼Œè¿™é‡Œè¿›è¡Œäº†åŒ¹é…ï¼š public abstract class AopUtils { // æ­¥éª¤ä¸€ public static boolean canApply(Advisor advisor, Class\u003c?\u003e targetClass, boolean hasIntroductions) { if (advisor instanceof IntroductionAdvisor) { return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass); } else if (advisor instanceof PointcutAdvisor) { PointcutAdvisor pca = (PointcutAdvisor) advisor; //åˆ‡ç‚¹è¡¨è¾¾å¼åŒ¹é…ã€‚ return canApply(pca.getPointcut(), targetClass, hasIntroductions); } else { // It doesn't have a pointcut so we assume it applies. return true; } } public static boolean canApply(Pointcut pc, Class\u003c?\u003e targetClass, boolean hasIntroductions) { // çœç•¥... // è¿™é‡Œåšäº†åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„åŒ¹é…ï¼ŒåŒ¹é…é€šè¿‡çš„è¿”å›trueï¼Œå…·ä½“çš„åŒ¹é…è¿‡ç¨‹ä¸ç”¨çœ‹ï¼Œä¸æ˜¯é‡ç‚¹ã€‚ for (Class\u003c?\u003e clazz : classes) { Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz); for (Method method : methods) { if (introductionAwareMethodMatcher != null ? introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) : methodMatcher.matches(method, targetClass)) { return true; } } } return false; } } ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒPointcutAdvisor ç±»å‹çš„ï¼Œæœ€ç»ˆä¼šéå†ç±»ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼Œæ ¹æ®åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè¿›è¡Œä¸€ä¸€åŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ ","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:4:0","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"4 æœé›†å®¹å™¨ä¸­æ‰€æœ‰çš„Advisorçš„æµç¨‹ çˆ¶ç±»è°ƒç”¨æµç¨‹ï¼š å­ç±»è°ƒç”¨æµç¨‹ï¼š ","date":"2020-11-30","objectID":"/posts/spring/10-aop-advisor-collect/:5:0","tags":["springæºç "],"title":"10 AOP - Advisorçš„å°è£…ä¸æœé›†","uri":"/posts/spring/10-aop-advisor-collect/"},{"categories":["spring"],"content":"AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œæµç¨‹è§£æ","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/:1:0","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"1 AOPå…¥å£ AOPæ˜¯é€šè¿‡ BeanPostProcessor.postProcessAfterInitialization() å®ç°çš„ï¼Œæ¥åˆ° doCreateBean() -\u003e initializeBean()ï¼Œåœ¨åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œä¼šè°ƒç”¨ applyBeanPostProcessorsAfterInitialization()ï¼Œè¿™é‡Œå¾ªç¯è°ƒç”¨äº†æ‰€æœ‰ BeanPostProcessor çš„ postProcessAfterInitialization()ï¼ŒAOP çš„å…¥å£å°±åœ¨å…¶ä¸­çš„ä¸€ä¸ªå®ç°ç±»ï¼Œä¹Ÿæ˜¯ AbstractAutoProxyCreator çš„å­ç±»å®ç°ã€‚ è¦çœ‹ä»£ç†å¯¹è±¡çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œé¦–å…ˆè¦çœ‹æ”¯æŒè¿™ä¸ªåŠŸèƒ½çš„ç±»ï¼Œæ˜¯åœ¨å“ªé‡Œæ³¨å†Œçš„ï¼Œå®ƒæºè‡ªå“ªé‡Œï¼Ÿ ","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/:2:0","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"2 XMlé…ç½®æ–¹å¼BeanPostProcessorçš„æ³¨å†Œ XMlæ–¹å¼æ³¨å…¥AOPæ”¯æŒçš„BeanPostProcessorï¼Œæ˜¯é€šè¿‡ \u003caop:aspectj-autoproxy/\u003e æ ‡ç­¾æ³¨å…¥çš„ã€‚ æ ¹æ®SPIåŠ è½½è§„åˆ™ï¼Œæ‰¾åˆ° spring-aop æ¨¡å—ä¸‹çš„ META-INF/spring.handlers æ–‡ä»¶ã€‚ å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š http\\://www.springframework.org/schema/aop=org.springframework.aop.config.AopNamespaceHandler æ¥åˆ° AopNamespaceHandler ç±»ï¼Œæºç å¦‚ä¸‹ï¼š public class AopNamespaceHandler extends NamespaceHandlerSupport { public void init() { registerBeanDefinitionParser(\"config\", new ConfigBeanDefinitionParser()); // AspectJAutoProxyBeanDefinitionParseræ ‡ç­¾ \u003caop:aspectj-autoproxy/\u003e çš„æ”¯æŒï¼Œ // åœ¨å…¶ parse() ä¸­æ³¨å†Œäº†AOPçš„å…¥å£ç±» AnnotationAwareAspectJAutoProxyCreatorï¼Œæ˜¯ä¸€ä¸ª BeanPostProcessor registerBeanDefinitionParser(\"aspectj-autoproxy\", new AspectJAutoProxyBeanDefinitionParser()); registerBeanDefinitionDecorator(\"scoped-proxy\", new ScopedProxyBeanDefinitionDecorator()); registerBeanDefinitionParser(\"spring-configured\", new SpringConfiguredBeanDefinitionParser()); } } æˆ‘ä»¬åœ¨ä½¿ç”¨Spring XMLé…ç½®æ–¹å¼ä½¿ç”¨ \u003caop:aspectj-autoproxy/\u003e æ ‡ç­¾æ¿€æ´»ä»£ç†ï¼Œåœ¨ init() ä¸­æ³¨å†Œäº† aspectj-autoproxy å±æ€§çš„è§£æç±»ï¼Œåœ¨è¿™ä¸ªè§£æç±»ä¸­ï¼Œæ³¨å…¥äº† AnnotationAwareAspectJAutoProxyCreator çš„ BeanDefinitionã€‚ æºç å¦‚ä¸‹ï¼š æ­¥éª¤ä¸€ï¼š class AspectJAutoProxyBeanDefinitionParser implements BeanDefinitionParser { public BeanDefinition parse(Element element, ParserContext parserContext) { // å¯¹aspectj-autoproxyå±æ€§çš„æ”¯æŒ AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element); // æ·»åŠ IncludePatterns extendBeanDefinition(element, parserContext); return null; } } æ­¥éª¤äºŒï¼š public abstract class AopNamespaceUtils { public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary( ParserContext parserContext, Element sourceElement) { // è¿™é‡Œæ³¨å†Œäº†AnnotationAwareAspectJAutoProxyCreator BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary( parserContext.getRegistry(), parserContext.extractSource(sourceElement)); useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement); registerComponentIfNecessary(beanDefinition, parserContext); } } æ­¥éª¤ä¸‰ï¼š public abstract class AopConfigUtils { public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary( BeanDefinitionRegistry registry, @Nullable Object source) { // æ³¨å…¥æ­¤ç±» AnnotationAwareAspectJAutoProxyCreatorï¼Œæœ¬è´¨è¿˜æ˜¯ä¸€ä¸ªBeanPostProcessor, // å®ç°äº†BeanPostProcessorçš„å­æ¥å£ï¼šSmartInstantiationAwareBeanPostProcessor return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source); } } å¯ä»¥çœ‹åˆ°ï¼Œæ­¥éª¤ä¸‰ä¸­ï¼Œæœ€å return è¯­å¥åæ³¨å†Œäº† AnnotationAwareAspectJAutoProxyCreatorã€‚ ä¿¡æ¯\r\rå›é¡¾ï¼šBeanPostProcessor æå‰æ³¨å†Œåˆ°IOCå®¹å™¨çš„æµç¨‹ã€‚ åˆ›å»º BeanFactoryï¼Œå®Œæˆæ‰€æœ‰ BeanDefinition çš„æœé›†ã€‚ æ‰§è¡Œ invokeBeanFactoryPostProcessors()ï¼ˆBeanDefinitionçš„åç½®å¤„ç†ï¼‰ã€‚BeanFactoryPostProcessor åŠå­æ¥å£ BeanDefinitionRegistryPostProcessor å®ç°ç±»çš„æ–¹æ³•ã€‚ æ‰§è¡Œ registerBeanPostProcessorsã€‚ä» beanFactory ä¸­è·å–æ‰€æœ‰çš„ BeanPostProcessorï¼Œä¼˜å…ˆè¿›è¡Œ getBean() æ“ä½œï¼Œå®ä¾‹åŒ–ã€‚ \r\r ","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/:3:0","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"3 æ³¨è§£æ–¹å¼BeanPostProcessorçš„æ³¨å†Œ ","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/:4:0","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"3.1 æ³¨è§£æ–¹å¼æ¡ˆä¾‹ å…ˆçœ‹ä¸€ä¸ªæ¡ˆä¾‹ï¼š åˆ‡é¢ç±»ï¼š @Component @Aspect @Slf4j public class CustomAspect { @Pointcut(\"execution(* top.wlz922.aspect.*.*(..))\") public void pointCut(){} @Before(\"pointCut()\") public void before(){ log.info(\"CustomAspect.before execute...\"); } } ä¸šåŠ¡ç±»ï¼š @Component @Slf4j public class Apple { public void showTaste(){ log.info(\"Apple is sour and sweet.\"); } } é…ç½®ç±»ï¼š @Configuration @EnableAspectJAutoProxy @ComponentScan(basePackages = \"top.wlz922\") public class AspectAnoConfiguration { } æµ‹è¯•ç±»ï¼š @Slf4j public class ApplicationContextTest { @Test public void testAnoAop(){ AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(AspectAnoConfiguration.class); Apple apple = context.getBean(Apple.class); apple.showTaste(); } } æ‰§è¡Œç»“æœï¼š 12:23:34.294 [main] INFO top.wlz922.aspect.CustomAspect 16 - CustomAspect.before execute... 12:23:34.325 [main] INFO top.wlz922.aspect.Apple 10 - Apple is sour and sweet. ä»¥ä¸Šæ˜¯ä¸€ä¸ªç®€å•çš„æ³¨è§£æ–¹å¼æ¿€æ´»AOPåŠŸèƒ½çš„æ¡ˆä¾‹ã€‚ ","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/:4:1","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"3.2 AspectJAutoProxyRegistrarçš„æ³¨å†Œ ä¸‹é¢æ¥çœ‹æ³¨è§£æ–¹å¼ï¼Œæ³¨å…¥å¯¹åº”æ”¯æŒçš„ BeanPostProcessor çš„å…¥å£ã€‚ è¿™æ˜¯ @EnableAspectJAutoProxy çš„å£°æ˜ï¼š @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented @Import(AspectJAutoProxyRegistrar.class) public @interface EnableAspectJAutoProxy { boolean proxyTargetClass() default false; boolean exposeProxy() default false; } å¯ä»¥çœ‹åˆ°ï¼Œ@EnableAspectJAutoProxy ä¸Šæœ‰ä¸€ä¸ª @Importï¼Œé‚£ä¹ˆå®ƒåœ¨åˆ›å»º BeanFactoryï¼Œæ‰«ææ³¨å†Œ BeanDefinition æ—¶ï¼Œä¼šæŠŠ AspectJAutoProxyRegistrar ç±»åŒ…è£…ä¸º BeanDefinition æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚ çœ‹ AspectJAutoProxyRegistrar çš„å£°æ˜ï¼š class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar { @Override public void registerBeanDefinitions( AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) { // TODO æ³¨å†Œè‡ªåŠ¨ä»£ç†çš„æ”¯æŒç±»çš„BeanDefinitionåˆ°å®¹å™¨ä¸­ã€‚ AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry); AnnotationAttributes enableAspectJAutoProxy = AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class); // å¦‚æœæ¿€æ´»äº†è‡ªåŠ¨ä»£ç†ï¼Œè¿™é‡Œä¼šè®¾ç½®AnnotationAwareAspectJAutoProxyCreatorçš„BeanDefinitionå¯¹åº”çš„å±æ€§å€¼ if (enableAspectJAutoProxy != null) { if (enableAspectJAutoProxy.getBoolean(\"proxyTargetClass\")) { AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry); } if (enableAspectJAutoProxy.getBoolean(\"exposeProxy\")) { AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry); } } } } æ¥åˆ° registerAspectJAnnotationAutoProxyCreatorIfNecessary()ï¼š public abstract class AopConfigUtils { @Nullable public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary( BeanDefinitionRegistry registry, @Nullable Object source) { // æ³¨å…¥æ­¤ç±» AnnotationAwareAspectJAutoProxyCreatorï¼Œæœ¬è´¨è¿˜æ˜¯ä¸€ä¸ªBeanPostProcessor, // å®ç°äº†BeanPostProcessorçš„å­æ¥å£ï¼šSmartInstantiationAwareBeanPostProcessor return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source); } } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™é‡Œå¯¹ AnnotationAwareAspectJAutoProxyCreator è¿›è¡Œäº†æ³¨å†Œã€‚ å…·ä½“çš„æ³¨å†Œé€»è¾‘æºç ï¼ˆæ³¨æ„å‚æ•°çš„ä¼ é€’ï¼‰ï¼š public abstract class AopConfigUtils { public static final String AUTO_PROXY_CREATOR_BEAN_NAME = \"org.springframework.aop.config.internalAutoProxyCreator\"; private static BeanDefinition registerOrEscalateApcAsRequired( Class\u003c?\u003e cls, BeanDefinitionRegistry registry, @Nullable Object source) { // å‰é¢æ³¨å†Œçš„ç±»æ²¡ç”¨ï¼Œæ³¨å†Œä¸è¿›æ¥ï¼Œè¿™é‡Œä¼šæ ¹æ®ç­‰çº§è¿”å›BeanDefinitionï¼Œæ³¨è§£æ–¹å¼ä¼šè¿”å›AnnotationAwareAspectJAutoProxyCreator if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) { BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME); if (!cls.getName().equals(apcDefinition.getBeanClassName())) { // è¿™é‡Œä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒï¼Œåœ¨æ³¨å†ŒAbstractAdvisorAutoProxyCreatoræ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªä¼˜å…ˆçº§ã€‚ // å¦‚æœè¿™é‡Œå·²ç»æ³¨å†Œè¿‡AbstractAdvisorAutoProxyCreatorï¼Œåœ¨æ­¤æ³¨å†Œçš„æ—¶å€™ï¼Œ // ä¼šä¸ä¹‹å‰çš„æ³¨å†Œçš„è¿›è¡Œä¼˜å…ˆçº§æ¯”è¾ƒï¼Œä¼˜å…ˆçº§é«˜çš„ä¼šè¦†ç›–æ‰ä¼˜å…ˆçº§ä½çš„ã€‚æ³¨è§£çš„ä¼˜å…ˆçº§æœ€é«˜ã€‚ int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName()); int requiredPriority = findPriorityForClass(cls); if (currentPriority \u003c requiredPriority) { apcDefinition.setBeanClassName(cls.getName()); } } return null; } // åˆ›å»ºBeanDefinitionï¼Œå¹¶è®¾ç½®ä¸€äº›å±æ€§ã€‚ RootBeanDefinition beanDefinition = new RootBeanDefinition(cls); beanDefinition.setSource(source); beanDefinition.getPropertyValues().add(\"order\", Ordered.HIGHEST_PRECEDENCE); beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); // æ³¨å†Œåˆ°BeanDefinitionRegistry registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition); return beanDefinition; } } é¦–å…ˆè¿™é‡Œä¼šåˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šåç§°çš„ BeanDefinitionï¼Œå¦‚æœåŒ…å«ï¼Œæ‹¿è¿™æ¬¡å°†è¦æ³¨å†Œçš„ç±»å‹ä¸å·²å­˜åœ¨çš„ç±»å‹è¿›è¡Œä¼˜å…ˆçº§æ¯”å¯¹ï¼Œä»¥ä¼˜å…ˆçº§é«˜çš„ä¸ºå‡†è¿›è¡Œ BeanDefinition çš„æ³¨å†Œã€‚ çœ‹ä¸€ä¸‹è·å–ä¼˜å…ˆçº§çš„ä»£ç ï¼š public abstract class AopConfigUtils { private static final List\u003cClass\u003c?\u003e\u003e APC_PRIORITY_LIST = new ArrayList\u003c\u003e(3); static { // è¿™é‡Œé»˜è®¤åŒ…å«ä¸‰ä¸ªä»£ç†ç”Ÿæˆç±» // Set up the escalation list... APC_PRIORITY_LIST.add(InfrastructureAdvisorAutoProxyCreator.class); APC_PRIORITY_LIST.add(AspectJAwareAdvisorAutoProxyCreator.class); APC_PRIORITY_LIST.add(AnnotationAwareAspectJAutoProxyCreator.class); } private static int findPriorityForClass(@Nullable String className) { for (int i = 0; i \u003c APC_PRIORITY_LIST.size(); i++) { Class\u003c?\u003e clazz = APC_PRIORITY_LIST.get(i); if (clazz.getName().equals(className","date":"2020-11-29","objectID":"/posts/spring/09-aop-support-register/:4:2","tags":["springæºç "],"title":"09 AOP - AbstractAutoProxyCreatorçš„æ³¨å†Œ","uri":"/posts/spring/09-aop-support-register/"},{"categories":["spring"],"content":"è¿™ä¸ª BeanDefinitionRegistryPostProcessor çš„å®ç°ç±» ConfigurationClassPostProcessor å¾ˆé‡è¦ï¼Œæœ‰å¿…è¦å•ç‹¬åˆ—ä¸¾ä¸€ä¸‹ã€‚","date":"2020-11-29","objectID":"/posts/spring/08-configuration-class-post-processor/","tags":["springæºç "],"title":"08 ConfigurationClassPostProcessoræºç è§£æ","uri":"/posts/spring/08-configuration-class-post-processor/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-29","objectID":"/posts/spring/08-configuration-class-post-processor/:1:0","tags":["springæºç "],"title":"08 ConfigurationClassPostProcessoræºç è§£æ","uri":"/posts/spring/08-configuration-class-post-processor/"},{"categories":["spring"],"content":"1 ä¸»æµç¨‹ åœ¨è°ƒç”¨ invokeBeanDefinitionRegistryPostProcessors() æ˜¯ï¼Œä¼šè°ƒç”¨åˆ°è¿™ä¸ªå®ç°ç±»ä¸­ï¼Œæ¥åˆ°æºç ï¼š public class ConfigurationClassPostProcessor implements BeanDefinitionRegistryPostProcessor, PriorityOrdered, ResourceLoaderAware, BeanClassLoaderAware, EnvironmentAware { public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) { List\u003cBeanDefinitionHolder\u003e configCandidates = new ArrayList\u003c\u003e(); // è·å–åˆ°æ‰€æœ‰çš„BeanDefinitionNames String[] candidateNames = registry.getBeanDefinitionNames(); // å¾ªç¯è°ƒç”¨ for (String beanName : candidateNames) { BeanDefinition beanDef = registry.getBeanDefinition(beanName); // çœç•¥æ— å…³ä»£ç ... //æ£€æŸ¥ç»™å®šçš„beanå®šä¹‰æ˜¯å¦é€‚åˆé…ç½®ç±»ï¼ˆæˆ–åœ¨é…ç½®/ç»„ä»¶ç±»ä¸­å£°æ˜çš„åµŒå¥—ç»„ä»¶ç±»ï¼Œä¹Ÿè¦è‡ªåŠ¨æ³¨å†Œï¼‰ï¼Œå¹¶è¿›è¡Œç›¸åº”æ ‡è®°ã€‚ if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) { configCandidates.add(new BeanDefinitionHolder(beanDef, beanName)); } } // çœç•¥æ— å…³ä»£ç ... // Parse each @Configuration class ConfigurationClassParser parser = new ConfigurationClassParser( this.metadataReaderFactory, this.problemReporter, this.environment, this.resourceLoader, this.componentScanBeanNameGenerator, registry); Set\u003cBeanDefinitionHolder\u003e candidates = new LinkedHashSet\u003c\u003e(configCandidates); Set\u003cConfigurationClass\u003e alreadyParsed = new HashSet\u003c\u003e(configCandidates.size()); do { // TODO é‡è¦ç¨‹åº¦ï¼š5 ConfigurationClassParserçš„parseæ–¹æ³•è°ƒç”¨ï¼Œè¿™é‡Œè§£æäº†ä¸€ç³»åˆ—çš„æ³¨è§£ parser.parse(candidates); parser.validate(); Set\u003cConfigurationClass\u003e configClasses = new LinkedHashSet\u003c\u003e(parser.getConfigurationClasses()); configClasses.removeAll(alreadyParsed); // Read the model and create bean definitions based on its content if (this.reader == null) { this.reader = new ConfigurationClassBeanDefinitionReader( registry, this.sourceExtractor, this.resourceLoader, this.environment, this.importBeanNameGenerator, parser.getImportRegistry()); } // è¿™é‡Œè£…è½½äº†BeanDefinition this.reader.loadBeanDefinitions(configClasses); // çœç•¥æ— å…³ä»£ç ... } while (!candidates.isEmpty()); // çœç•¥æ— å…³ä»£ç ... } } åˆ’é‡ç‚¹ï¼ˆä¸Šé¢æºç ä¸­çš„é«˜äº®éƒ¨åˆ†ï¼‰ï¼š æ ¡éªŒæ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œå®Œæˆå¯¹@Configurationã€@Componentã€@ComponentScanã€@Importã€@ImportResourceã€æ–¹æ³•ä¸ŠåŒ…å«@Bean çš„æ”¯æŒã€‚ æ‰§è¡Œ parse()ï¼Œå®Œæˆè§£æã€‚ loadBeanDefinitions()ï¼Œè£…è½½ BeanDefinitionã€‚ ","date":"2020-11-29","objectID":"/posts/spring/08-configuration-class-post-processor/:2:0","tags":["springæºç "],"title":"08 ConfigurationClassPostProcessoræºç è§£æ","uri":"/posts/spring/08-configuration-class-post-processor/"},{"categories":["spring"],"content":"2 å¾ªç¯æ‰€æœ‰benaNameã€æ ¡éªŒbeanæ˜¯å¦ç¬¦åˆ è¿›å…¥ checkConfigurationClassCandidate() æºç ï¼š abstract class ConfigurationClassUtils { public static boolean checkConfigurationClassCandidate( BeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory) { // çœç•¥æ— å…³ä»£ç ... // ç±»ä¸Šæ˜¯å¦åŒ…å«@Configuration if (isFullConfigurationCandidate(metadata)) { beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL); } // ç±»ä¸Šæ˜¯åŒ…å«@Componentã€@ComponentScanã€@Importã€@ImportResourceã€‚æ–¹æ³•ä¸ŠåŒ…å«@Bean else if (isLiteConfigurationCandidate(metadata)) { beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE); } else { return false; } // çœç•¥æ— å…³ä»£ç  return true; } } isFullConfigurationCandidate() æºç ï¼š abstract class ConfigurationClassUtils { public static boolean isFullConfigurationCandidate(AnnotationMetadata metadata) { return metadata.isAnnotated(Configuration.class.getName()); } } isLiteConfigurationCandidate() æºç ï¼š abstract class ConfigurationClassUtils { // æ³¨æ„è¿™ä¸ªæˆå‘˜å˜é‡ï¼ŒåŒ…å«äº†å¯¹ä¸€äº›å†…ç½®æ³¨è§£çš„æ”¯æŒã€‚ private static final Set\u003cString\u003e candidateIndicators = new HashSet\u003c\u003e(8); static { // æ·»åŠ äº†ä¸€ç³»åˆ—æ³¨è§£çš„æ”¯æŒã€‚ candidateIndicators.add(Component.class.getName()); candidateIndicators.add(ComponentScan.class.getName()); candidateIndicators.add(Import.class.getName()); candidateIndicators.add(ImportResource.class.getName()); } public static boolean isLiteConfigurationCandidate(AnnotationMetadata metadata) { // ç±»ä¸Šæ˜¯åŒ…å«@Componentã€@ComponentScanã€@Importã€@ImportResourceã€‚æ–¹æ³•ä¸ŠåŒ…å«@Bean for (String indicator : candidateIndicators) { if (metadata.isAnnotated(indicator)) { return true; } } // @Beançš„æ”¯æŒ return metadata.hasAnnotatedMethods(Bean.class.getName()); } } ","date":"2020-11-29","objectID":"/posts/spring/08-configuration-class-post-processor/:3:0","tags":["springæºç "],"title":"08 ConfigurationClassPostProcessoræºç è§£æ","uri":"/posts/spring/08-configuration-class-post-processor/"},{"categories":["spring"],"content":"3 è§£æ æ¥åˆ° parse() æºç ï¼š class ConfigurationClassParser { public void parse(Set\u003cBeanDefinitionHolder\u003e configCandidates) { for (BeanDefinitionHolder holder : configCandidates) { BeanDefinition bd = holder.getBeanDefinition(); //è¿™æ˜¯å“ªä¸ªåˆ†æ”¯çš„è§£æä¼šèµ°åˆ°åŒä¸€ä¸ªæ–¹æ³•é‡Œ if (bd instanceof AnnotatedBeanDefinition) { //æ‰§è¡Œè§£æ parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName()); } else if (bd instanceof AbstractBeanDefinition \u0026\u0026 ((AbstractBeanDefinition) bd).hasBeanClass()) { //æ‰§è¡Œè§£æ parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName()); } else { // TODO æ‰§è¡Œè§£æï¼Œè®°ç€è¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œåœ¨æ»¡è¶³æ¡ä»¶æ—¶ä¼šè¢«é€’å½’è°ƒç”¨ã€‚ parse(bd.getBeanClassName(), holder.getBeanName()); } } this.deferredImportSelectorHandler.process(); } } å¯¹ä¸åŒç±»å‹çš„ BeanDefinition ä¼šè°ƒç”¨ä¸åŒçš„é‡è½½ parse()ï¼Œå®é™…ä¸Šï¼Œæœ€ç»ˆéƒ½ä¼šè¿›åˆ°è¿™ä¸ªæ–¹æ³•ï¼š class ConfigurationClassParser { protected void processConfigurationClass(ConfigurationClass configClass) throws IOException { // çœç•¥æ— å…³ä»£ç ... // Recursively process the configuration class and its superclass hierarchy. SourceClass sourceClass = asSourceClass(configClass); do { // æ‰§è¡Œè§£æ sourceClass = doProcessConfigurationClass(configClass, sourceClass); } while (sourceClass != null); // è¿™é‡Œå°†é…ç½®ç±»çš„ä¿¡æ¯æ”¾å…¥ç¼“å­˜ä¸­ï¼Œç­‰è§£æå®Œä¹‹åï¼Œä¼šå°†é…ç½®ç±»è¿›è¡ŒLoadBeanDefinitions(); this.configurationClasses.put(configClass, configClass); } } æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨çš„ï¼Œå¦‚æœè¿”å›ä¸ä¸ºç©ºï¼Œå°±ä¸€ç›´æ‰§è¡Œã€‚æ¯æ¬¡ä¼šæ›´æ–°sourceClassçš„å€¼ã€‚ è¿›å…¥ doProcessConfigurationClass()ï¼š class ConfigurationClassParser { protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass) throws IOException { // Componentæ³¨è§£æ”¯æŒ if (configClass.getMetadata().isAnnotated(Component.class.getName())) { // Recursively process any member (nested) classes first processMemberClasses(configClass, sourceClass); } // Process any @PropertySource annotations for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable( sourceClass.getMetadata(), PropertySources.class, org.springframework.context.annotation.PropertySource.class)) { if (this.environment instanceof ConfigurableEnvironment) { processPropertySource(propertySource); } else { logger.info(\"Ignoring @PropertySource annotation on [\" + sourceClass.getMetadata().getClassName() + \"]. Reason: Environment must implement ConfigurableEnvironment\"); } } // @ComponentScanï¼Œ@ComponentScansæ”¯æŒ // Process any @ComponentScan annotations Set\u003cAnnotationAttributes\u003e componentScans = AnnotationConfigUtils.attributesForRepeatable( sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class); if (!componentScans.isEmpty() \u0026\u0026 !this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) { for (AnnotationAttributes componentScan : componentScans) { // ä½¿ç”¨@ComponentScanæ³¨é‡Šé…ç½®ç±»-\u003eç«‹å³æ‰§è¡Œæ‰«æ // The config class is annotated with @ComponentScan -\u003e perform the scan immediately Set\u003cBeanDefinitionHolder\u003e scannedBeanDefinitions = this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName()); // Check the set of scanned definitions for any further config classes and parse recursively if needed for (BeanDefinitionHolder holder : scannedBeanDefinitions) { BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition(); if (bdCand == null) { bdCand = holder.getBeanDefinition(); } // TODO å¦‚æœæ˜¯é…ç½®ç±»ï¼Œåˆ™é€’å½’è°ƒç”¨ConfigurationClassParser.parse() if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) { parse(bdCand.getBeanClassName(), holder.getBeanName()); } } } } // å¤„ç†@Importæ³¨è§£å¯¼å…¥ // Process any @Import annotations processImports(configClass, sourceClass, getImports(sourceClass), true); // å¤„ç†@ImportResourceæ³¨è§£å¯¼å…¥ // Process any @ImportResource annotations AnnotationAttributes importResource = AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class); if (importResource != null) { String[] resources = importResource.getStringArray(\"locations\"); Class\u003c? extends BeanDefinitionReader\u003e readerClass = importResource.getClass(\"reader\"); for (String resource : resources) { String resolvedResource = thi","date":"2020-11-29","objectID":"/posts/spring/08-configuration-class-post-processor/:4:0","tags":["springæºç "],"title":"08 ConfigurationClassPostProcessoræºç è§£æ","uri":"/posts/spring/08-configuration-class-post-processor/"},{"categories":["spring"],"content":"4 è£…è½½BeanDefinition loadBeanDefinitions() æ–¹æ³•å‚æ•°æ˜¯ä¸€ä¸ª ConfigurationClass çš„é›†åˆï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»çš„é›†åˆã€‚ è¿™äº›é…ç½®ç±»æ˜¯åœ¨ä¸Šé¢çš„æµç¨‹ä¸­ï¼Œæ‰«æåŒ…ä¸­çš„ç±»æ—¶ï¼Œæ‰«æåˆ°æœ‰é…ç½®ä¿¡æ¯çš„ç±»ã€‚ æœ€ç»ˆä¼šè¿›è¡Œä»¥ä¸‹è°ƒç”¨ï¼Œåˆä¼šå›åˆ° springioc å®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œè§£ææ ‡ç­¾çš„é‚£æ®µä»£ç ã€‚ å…³é”®æºç ï¼š class ConfigurationClassBeanDefinitionReader { private void loadBeanDefinitionsForConfigurationClass( ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) { // çœç•¥æ— å…³ä»£ç ... // @Importæ³¨è§£ä¸­ï¼Œå¯¼å…¥çš„ç±»ï¼ŒåŒ…è£…ä¸ºBeanDefinitionå¹¶æ³¨å†Œåˆ°å®¹å™¨ã€‚ if (configClass.isImported()) { registerBeanDefinitionForImportedConfigurationClass(configClass); } // @Beanæ³¨è§£çš„æ–¹æ³•ï¼Œå°†å¯¹åº”çš„metadataåŒ…è£…ä¸ºBeanDefinitionå¹¶æ³¨å†Œåˆ°å®¹å™¨ã€‚ // è¿™é‡Œå¹¶æ²¡æœ‰æ‰§è¡Œæ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œæ–¹æ³•æ˜¯åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ã€‚ for (BeanMethod beanMethod : configClass.getBeanMethods()) { loadBeanDefinitionsForBeanMethod(beanMethod); } // åŠ è½½å¯¼å…¥èµ„æº loadBeanDefinitionsFromImportedResources(configClass.getImportedResources()); // è¿™é‡Œæ˜¯åŠ è½½ImportBeanDefinitionRegistraræ¥å£æ³¨å†Œçš„BeanDefinitionï¼Œé€šè¿‡è°ƒç”¨registerBeanDefinitions()æ¥æ³¨å…¥ loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars()); } } ä»æºç æ³¨é‡Šä¸­å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°ï¼ŒloadBeanDefinitions() éƒ½åšäº†é‚£äº›äº‹æƒ…ã€‚ è§£æ@Import å¯¼å…¥çš„ç±»ï¼ŒåŒ…è£…ä¸º BeanDefinition å¹¶æ³¨å†Œåˆ°å®¹å™¨ã€‚ è§£æ @Bean æ³¨è§£çš„æ–¹æ³•ï¼ŒåŒ…è£…æˆ BeanDefinition å¹¶æ³¨å†Œåˆ°å®¹å™¨ã€‚ åŠ è½½å¯¼å…¥èµ„æºçš„BeanDefinitionï¼Œè¿™ä¸ªæ˜¯importæ ‡ç­¾çš„æ”¯æŒã€‚ è°ƒç”¨å®¹å™¨ä¸­å·²æ³¨å†Œçš„ ImportBeanDefinitionRegistrar å®ç°ç±»çš„ registerBeanDefinitions()ã€‚ æŠ€å·§\r\rAOPçš„æ”¯æŒï¼Œå°±æ˜¯é€šè¿‡ ImportBeanDefinitionRegistrar.registerBeanDefinitions() æ³¨å†Œè¿›æ¥çš„ï¼Œå…¶å®ç°ç±»æ˜¯ AspectJAutoProxyRegistrarã€‚\r\r è°ƒç”¨é“¾æµç¨‹å¦‚ä¸‹ï¼š ","date":"2020-11-29","objectID":"/posts/spring/08-configuration-class-post-processor/:5:0","tags":["springæºç "],"title":"08 ConfigurationClassPostProcessoræºç è§£æ","uri":"/posts/spring/08-configuration-class-post-processor/"},{"categories":["spring"],"content":"ä»‹ç»FactoryBeançš„ä½¿ç”¨æ–¹æ³•å’ŒFactoryBeanåœ¨Springä¸­çš„å®ç°åŸç†ï¼Œæ‰§è¡Œæµç¨‹ã€‚","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:1:0","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"1 FactoryBean çš„ä½œç”¨ Spring ä¸­æœ‰ä¸¤ç§ç±»å‹çš„Beanï¼Œä¸€ç§æ˜¯æ™®é€šBeanï¼Œå¦ä¸€ç§æ˜¯å·¥å‚Bean å³ FactoryBeanã€‚FactoryBeanè·Ÿæ™®é€šBeanä¸åŒï¼Œå…¶è¿”å›çš„å¯¹è±¡ä¸æ˜¯æŒ‡å®šç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè€Œæ˜¯è¯¥FactoryBeançš„getObjectæ–¹æ³•æ‰€è¿”å›çš„å¯¹è±¡ã€‚åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡æ˜¯å¦å±äºå•ä¾‹ç”±isSingletonä¸­çš„è¿”å›å†³å®šã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒSpringé€šè¿‡åå°„æœºåˆ¶åˆ©ç”¨çš„classå±æ€§æŒ‡å®šå®ç°ç±»å®ä¾‹åŒ–Beanï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ä¾‹åŒ–Beanè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœæŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œåˆ™éœ€è¦åœ¨ä¸­æä¾›å¤§é‡çš„é…ç½®ä¿¡æ¯ã€‚é…ç½®æ–¹å¼çš„çµæ´»æ€§æ˜¯å—é™çš„ï¼Œè¿™æ—¶é‡‡ç”¨ç¼–ç çš„æ–¹å¼å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆã€‚Springä¸ºæ­¤æä¾›äº†ä¸€ä¸ªorg.springframework.bean.factory.FactoryBeançš„å·¥å‚ç±»æ¥å£ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å®ç°è¯¥æ¥å£å®šåˆ¶å®ä¾‹åŒ–Beançš„é€»è¾‘ã€‚FactoryBeanæ¥å£å¯¹äºSpringæ¡†æ¶æ¥è¯´å ç”¨é‡è¦çš„åœ°ä½ï¼ŒSpringè‡ªèº«å°±æä¾›äº†70å¤šä¸ªFactoryBeançš„å®ç°ã€‚å®ƒä»¬éšè—äº†å®ä¾‹åŒ–ä¸€äº›å¤æ‚Beançš„ç»†èŠ‚ï¼Œç»™ä¸Šå±‚åº”ç”¨å¸¦æ¥äº†ä¾¿åˆ©ã€‚ä»Spring3.0å¼€å§‹ï¼ŒFactoryBeanå¼€å§‹æ”¯æŒæ³›å‹ï¼Œå³æ¥å£å£°æ˜æ”¹ä¸ºFactoryBeançš„å½¢å¼ ä»¥Beanç»“å°¾ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªBeanï¼Œä¸åŒäºæ™®é€šBeançš„æ˜¯ï¼šå®ƒæ˜¯å®ç°äº†FactoryBeanæ¥å£çš„Beanï¼Œæ ¹æ®è¯¥Beançš„IDä»BeanFactoryä¸­è·å–çš„å®é™…ä¸Šæ˜¯FactoryBeançš„getObject()è¿”å›çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯FactoryBeanæœ¬èº«ï¼Œå¦‚æœè¦è·å–FactoryBeanå¯¹è±¡ï¼Œè¯·åœ¨idå‰é¢åŠ ä¸€ä¸ª\u0026ç¬¦å·æ¥è·å–ã€‚ ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:2:0","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"2 FactoryBean æ¥å£çš„å®šä¹‰ ä»¥ä¸‹æ˜¯ Spring ä¸­ FactoryBean æ¥å£çš„å®šä¹‰ï¼š public interface FactoryBean\u003cT\u003e { T getObject() throws Exception; Class\u003c?\u003e getObjectType(); default boolean isSingleton() { return true; } } ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:3:0","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"3 åº”ç”¨åœºæ™¯ FactoryBean é€šå¸¸æ˜¯ç”¨æ¥åˆ›å»ºæ¯”è¾ƒå¤æ‚çš„ beanï¼Œä¸€èˆ¬çš„ bean ç›´æ¥ç”¨ xml é…ç½®å³å¯ï¼Œä½†å¦‚æœä¸€ä¸ª bean çš„åˆ›å»ºè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°å¾ˆå¤šå…¶ä»–çš„ bean å’Œå¤æ‚çš„é€»è¾‘ï¼Œç”¨ xml é…ç½®æ¯”è¾ƒå›°éš¾ï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘ç”¨ FactoryBeanã€‚ å¾ˆå¤šå¼€æºé¡¹ç›®åœ¨é›†æˆ Spring æ—¶éƒ½ä½¿ç”¨åˆ° FactoryBeanï¼Œæ¯”å¦‚ MyBatis3 æä¾› mybatis-spring é¡¹ç›®ä¸­çš„ org.mybatis.spring.SqlSessionFactoryBeanï¼š \u003cbean id=\"sqlSessionFactory\" class=\"org.mybatis.spring.SqlSessionFactoryBean\"\u003e \u003cproperty name=\"dataSource\" ref=\"dataSource\"/\u003e \u003c!-- è‡ªåŠ¨æ‰«æmapping.xmlæ–‡ä»¶ --\u003e \u003cproperty name=\"mapperLocations\" value=\"classpath:mapper/*.xml\"\u003e\u003c/property\u003e \u003c/bean\u003e public class SqlSessionFactoryBean implements FactoryBean\u003cSqlSessionFactory\u003e, InitializingBean, ApplicationListener\u003cApplicationEvent\u003e { // ... public SqlSessionFactory getObject() throws Exception { if (this.sqlSessionFactory == null) { this.afterPropertiesSet(); } return this.sqlSessionFactory; } // ... } ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:4:0","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"4 æºç åˆ†æ ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:5:0","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"4.1 åˆæ¬¡åˆ›å»º AbstractBeanFactory é€šè¿‡ getBean å‘ IOC å®¹å™¨è·å–è¢«ç®¡ç†çš„ Beanã€‚ AbstractBeanFactory.getBean() -\u003e doGetBean()ã€‚ æ¥åˆ° doGetBean()ï¼Œçœ‹ bean ç¬¬ä¸€æ¬¡åˆ›å»ºå®ä¾‹åï¼Œè°ƒç”¨çš„åœ°æ–¹ï¼š public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); if (mbd.isSingleton()) { sharedInstance = getSingleton(beanName, () -\u003e { try { //åˆ›å»ºBeanå®ä¾‹ return createBean(beanName, mbd, args); } catch (BeansException ex) { // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; } }); /* TODO é‡è¦ç¨‹åº¦ 5 å¦‚æœbeanä¸æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameä»¥\u0026å¼€å¤´ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ å¦åˆ™è°ƒç”¨FactoryBeançš„getObject(),ä¸”å°†è¿”å›çš„beanæ›¿æ¢ä¸ºgetObject()çš„è¿”å›å€¼ã€‚ FactoryBeanæ¥å£å¾ˆé‡è¦ï¼Œå…·ä½“åº”ç”¨åœºæ™¯è§FactoryBeanæ¥å£æ³¨é‡Šã€‚ */ bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); } } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ getSingleton() ä¹‹åï¼Œåˆè°ƒç”¨äº† bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd)ï¼Œç»™ bean é‡æ–°èµ‹å€¼ï¼Œè¿™é‡Œbeançš„å®ä¾‹å°±å¯èƒ½è¢«æ”¹å˜äº†ã€‚ å¦‚æœå½“å‰åˆ›å»ºçš„ bean æ˜¯ FactoryBean ç±»å‹çš„ï¼Œè°ƒç”¨ getObjectForBeanInstance() æ—¶ï¼Œæœ€ç»ˆä¼šè¿”å› FactoryBean.getObject() è¿”å›çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆ getBean() è¿”å›çš„æ˜¯è¿™ä¸ª getObject() è·å–åˆ°çš„å®ä¾‹ã€‚ ä»¥ä¸‹æ˜¯ getObjectForBeanInstance() çš„æºç ï¼š public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory { protected Object getObjectForBeanInstance(Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) { String currentlyCreatedBean = this.currentlyCreatedBean.get(); if (currentlyCreatedBean != null) { registerDependentBean(beanName, currentlyCreatedBean); } // ä»çˆ¶ç±»æ–¹æ³•ä¸­è·å– return super.getObjectForBeanInstance(beanInstance, name, beanName, mbd); } } è¿™é‡Œè°ƒç”¨åˆ°äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œç»§ç»­çœ‹çˆ¶ç±»çš„æ–¹æ³•ï¼š public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { protected Object getObjectForBeanInstance( Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) { // ... // å¦‚æœbeanä¸æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameä»¥\u0026å¼€å¤´ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ if (!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) { return beanInstance; } Object object = null; // å¦‚æœBeanDefinitionä¸ºnullï¼Œä»ç¼“å­˜ä¸­è·å–ï¼ŒdoGetBean() ä¸­ä¼ å…¥çš„å°±æ˜¯null // createBeanåè¿›å…¥è¿™é‡Œçš„è¯ï¼Œä¼ å…¥çš„å°±ä¸æ˜¯null if (mbd == null) { object = getCachedObjectForFactoryBean(beanName); } if (object == null) { FactoryBean\u003c?\u003e factory = (FactoryBean\u003c?\u003e) beanInstance; if (mbd == null \u0026\u0026 containsBeanDefinition(beanName)) { mbd = getMergedLocalBeanDefinition(beanName); } boolean synthetic = (mbd != null \u0026\u0026 mbd.isSynthetic()); // è°ƒç”¨FactoryBeançš„getObjectæ–¹æ³• object = getObjectFromFactoryBean(factory, beanName, !synthetic); } return object; } } ä¸Šé¢ä»£ç çš„å°¾éƒ¨ï¼Œè°ƒç”¨åˆ°äº† object = getObjectFromFactoryBean(factory, beanName, !synthetic)ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº† getObject()ã€‚ æºç å¦‚ä¸‹ï¼ˆå…³é”®ç‚¹ - æ³¨æ„æºç ä¸­é«˜äº®éƒ¨åˆ†ï¼‰ï¼š public abstract class FactoryBeanRegistrySupport extends DefaultSingletonBeanRegistry { protected Object getObjectFromFactoryBean(FactoryBean\u003c?\u003e factory, String beanName, boolean shouldPostProcess) { if (factory.isSingleton() \u0026\u0026 containsSingleton(beanName)) { synchronized (getSingletonMutex()) { Object object = this.factoryBeanObjectCache.get(beanName); if (object == null) { // è°ƒç”¨ factory.getObject(); object = doGetObjectFromFactoryBean(factory, beanName); Object alreadyThere = this.factoryBeanObjectCache.get(beanName); if (alreadyThere != null) { object = alreadyThere; } else { if (shouldPostProcess) { if (isSingletonCurrentlyInCreation(beanName)) { // Temporarily return non-post-processed object, not storing it yet.. return object; } beforeSingletonCreation(beanName); try { // è¿™é‡Œè°ƒç”¨äº†BeanPostProcessorçš„åç½®å¤„ç† object = postProcessObjectFromFactoryBean(object, beanName); } catch (Throwable ex) { throw new BeanCreationException(beanName, \"Post-processing of FactoryBean's singleton object failed\", ex); } finally { afterSingletonCreation(beanName); } } // åŠ å…¥åˆ°ç¼“å­˜ï¼Œç¼“å­˜ä½ç½®ï¼šBeanFactoryçš„ factoryBeanO","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:5:1","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"4.2 ç¼“å­˜ä¸­è·å– ä»ä¸Šé¢çš„ä»£ç åˆ†æä¸­å·²ç»çŸ¥é“ï¼Œæœ€ç»ˆè°ƒç”¨äº† getObject() ä¹‹åï¼Œä¼šå°†è¿™ä¸ªå®ä¾‹ç¼“å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œè¿™ä¸ªå˜é‡æ˜¯ factoryBeanObjectCacheã€‚ å›åˆ° doGetBean() ä¸­å¼€å§‹çš„ä»£ç å—ï¼Œå…ˆä»ç¼“å­˜ä¸­è·å–å®ä¾‹ï¼Œå¦‚æœè·å–åˆ°äº†ï¼ŒåŒæ ·ä¼šè°ƒç”¨ getObjectForBeanInstance()ï¼Œåˆ¤æ–­å®ä¾‹æ˜¯å¦æ˜¯ FactoryBean ç±»å‹ã€‚ æºç å¦‚ä¸‹ï¼š Object sharedInstance = getSingleton(beanName); if (sharedInstance != null \u0026\u0026 args == null) { // ... // å¦‚æœbeanä¸æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameä»¥\u0026å¼€å¤´ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ // å¦åˆ™å°†beanå¼ºè½¬ä¸ºFactoryBeanç±»å‹ï¼Œå¹¶è°ƒç”¨getObject()æ–¹æ³•è¿”å›ã€‚ bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); } åœ¨ [06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç† - getSingleton()] ä¸­æœ‰æåˆ°ï¼Œè¿™é‡Œå¯èƒ½è¿”å›ä¸€ä¸ªbeanå®ä¾‹ã€‚å®é™…ä¸Šåœ¨ bean ç¬¬ä¸€æ¬¡åˆ›å»ºåï¼Œåé¢å†è·å–éƒ½æ˜¯ä»ç¼“å­˜ä¸­æ‹¿çš„ã€‚æ‹¿åˆ°äº†ä¹‹åï¼Œç»è¿‡ä¸€äº›å¤„ç†ï¼Œå°±è¿”å›ã€‚è¿™ä¸ªå¤„ç†å°±æ˜¯åˆ¤æ–­ FactoryBean çš„å¤„ç†ã€‚ ä»ä¸Šé¢æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä»ç¼“å­˜ä¸­è·å–åˆ°ï¼Œä¼šè°ƒç”¨ getObjectForBeanInstance() ã€‚å¾ˆæ˜æ˜¾ï¼Œåœ¨ç¬¬ä¸€æ¬¡åˆ›å»º bean å®ä¾‹æ—¶ï¼Œå°±è°ƒç”¨è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä¼šæŠŠåˆ›å»ºçš„ç»“æœç¼“å­˜åˆ° factoryBeanObjectCache å˜é‡ä¸­ï¼Œè¿™é‡Œå°±ç›´æ¥ä» factoryBeanObjectCache å˜é‡ä¸­è·å–çš„å®ä¾‹ã€‚ æœ€ç»ˆï¼Œå¦‚æœè¿™ä¸ª bean æ˜¯ FactoryBean ç±»å‹ï¼Œä¼šè¢«æ›¿æ¢æ‰ã€‚ ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:5:2","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"4.3 è·å–åŸå§‹bean å…³äºè·å–åŸå§‹beançš„æ–¹å¼ï¼Œåœ¨ beanName å‰åŠ ä¸€ä¸ªå‰ç¼€ \u0026ï¼Œå°±å¯ä»¥è·å–åˆ°åŸå§‹ bean å®ä¾‹ã€‚ åœ¨ getObjectForBeanInstance() ä¸­æœ‰è¿™ä¹ˆä¸€æ®µæºç ï¼š public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { protected Object getObjectForBeanInstance(Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) { // å¦‚æœbeanä¸æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameä»¥\u0026å¼€å¤´ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ if (!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) { return beanInstance; } } } çœ‹ä¸€ä¸‹ isFactoryDereference() çš„æºç ï¼š public abstract class BeanFactoryUtils { public static boolean isFactoryDereference(@Nullable String name) { return (name != null \u0026\u0026 name.startsWith(BeanFactory.FACTORY_BEAN_PREFIX)); } } å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ beanNameä»¥ BeanFactory.FACTORY_BEAN_PREFIX å¼€å¤´ï¼Œå°±ä¼šè¿”å›trueã€‚ BeanFactory.FACTORY_BEAN_PREFIX å¸¸é‡çš„å£°æ˜ï¼š public interface BeanFactory { String FACTORY_BEAN_PREFIX = \"\u0026\"; } ç»“åˆä¸Šé¢çš„æºç ï¼Œå¦‚æœ getBean() æ—¶ï¼Œä¼ å…¥çš„ beanName æ˜¯ä»¥ \u0026 å¼€å¤´ï¼Œèµ°åˆ° getObjectForBeanInstance() æ—¶ï¼Œå°±ä¸ä¼šæ‰§è¡Œ FactoryBean çš„é€»è¾‘ï¼Œè€Œæ˜¯ç›´æ¥è¿”å› bean å®ä¾‹ã€‚ ","date":"2020-11-28","objectID":"/posts/spring/07-factory-bean/:5:3","tags":["springæºç "],"title":"07 å¤æ‚å¯¹è±¡çš„æ„å»ºæ–¹å¼ - FactoryBean","uri":"/posts/spring/07-factory-bean/"},{"categories":["spring"],"content":"æœ¬ç« ç€é‡ä»‹ç»äº†springä¸­åœ¨å¤šä¸ªbeanæœ‰ç›¸äº’ä¾èµ–å…³ç³»æ—¶ï¼Œæ˜¯æ€ä¹ˆæ ·è¿›è¡Œä¾èµ–æ³¨å…¥çš„ã€‚","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/:1:0","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"1 ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ– åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œè‚¯å®šå­˜åœ¨è¿™ç§æƒ…å†µï¼šbean A æŸä¸ªæˆå‘˜æ˜¯ bean Bï¼Œbean B ä¸­æŸä¸ªå±æ€§æ˜¯ bean Aã€‚é‚£Aç±»å’ŒBç±»å°±æ˜¯ç›¸äº’ä¾èµ–çš„å…³ç³»ï¼Œä¹Ÿå«å¾ªç¯ä¾èµ–ã€‚ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿™ç§æƒ…å†µ A -\u003e B -\u003e C -\u003e D -\u003e E -\u003e Aã€‚è¿™ç§å…³ç³»ä¹Ÿæ˜¯å¾ªç¯ä¾èµ–ã€‚ ","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/:2:0","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"2 å¾ªç¯ä¾èµ–åœ¨springä¸­çš„å®ç°åŸç† @Service public class CyclicGoodsServiceImpl implements CyclicGoodsService { @Autowired private CyclicOrderService cyclicOrderService; @Override public CyclicOrderService getCyclicOrderService() { return cyclicOrderService; } } ","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/:3:0","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"2.1 æºç åˆ†æ åœ¨è¿™ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸ªç®€å•çš„å¾ªç¯ä¾èµ–ä»£ç æ¡ˆä¾‹ï¼š @Service public class CyclicGoodsServiceImpl implements CyclicGoodsService { @Autowired private CyclicOrderService cyclicOrderService; @Override public CyclicOrderService getCyclicOrderService() { return cyclicOrderService; } } @Service public class CyclicOrderServiceImpl implements CyclicOrderService { @Autowired private CyclicGoodsService cyclicGoodsService; @Override public CyclicGoodsService getCyclicGoodsService() { return cyclicGoodsService; } } @Slf4j public class ApplicationContextTest { @Test public void testCyclicDependence(){ AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(\"top.wlz922.cyclic\"); CyclicGoodsService goodsService = context.getBean(CyclicGoodsService.class); CyclicOrderService orderService = context.getBean(CyclicOrderService.class); log.debug(goodsService.toString()); log.debug(orderService.toString()); } } åªæ˜¯ç®€å•çš„æ‰“å°ä¸€ä¸‹ä¸¤ä¸ªServiceç±»ä¸­å±æ€§çš„å€¼ï¼Œå¾ˆæ˜æ˜¾æ˜¯æ³¨å…¥æˆåŠŸäº†ã€‚ ä»¥ä¸‹æ˜¯æ‰“å°çš„å†…å®¹ï¼š 19:34:42.334 [main] DEBUG top.wlz922.test.context.ApplicationContextTest 36 - top.wlz922.cyclic.CyclicGoodsServiceImpl@7fa98a66 19:34:42.335 [main] DEBUG top.wlz922.test.context.ApplicationContextTest 37 - top.wlz922.cyclic.CyclicOrderServiceImpl@15ff3e9e å‰é¢çš„æ–‡ç« ä¸­å·²ç»åˆ†æè¿‡ï¼Œspringä¸­è·å–beanå®ä¾‹çš„æ–¹æ³•æ˜¯getBean()ã€‚åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¿™äº›æ–¹æ³•ï¼Œå®ä¾‹åŒ–å•ä¾‹beanå®ä¾‹ã€‚ ç›´æ¥æ¥åˆ°doGetBean()ï¼Œçœ‹ä»¥ä¸‹ä»£ç ï¼š public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { protected \u003cT\u003e T doGetBean(final String name, @Nullable final Class\u003cT\u003e requiredType, @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException { //è½¬æ¢beanNameï¼Œè¿™é‡Œä¼ å…¥è¿›æ¥çš„beanNameå¯èƒ½æ˜¯ä»¥\u0026å¼€å¤´çš„ï¼Œè¿™é‡Œä¼šæˆªæ‰\u0026 final String beanName = transformedBeanName(name); Object bean; /* TODO è¿™é‡Œå¤šçº§ç¼“å­˜ç”¨äºè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ æ³¨ï¼šå¾ªç¯ä¾èµ–åªèƒ½æ˜¯å±æ€§è§çš„ä¾èµ–ï¼Œä¸èƒ½æ˜¯æ„é€ å‡½æ•°ä¸­å‚æ•°çš„å¾ªç¯ä¾èµ–ã€‚ ä»ç¼“å­˜ï¼ˆä¸€çº§äºŒçº§ä¸‰çº§ç¼“å­˜ä¾æ¬¡è·å–ï¼Œè·å–åˆ°å°±è¿”å›ï¼‰ä¸­è·å–å•ä¾‹å®ä¾‹ï¼Œå¦‚æœè·å–åˆ°å¹¶ä¸”æ˜¯æ— å‚æ„é€ å‡½æ•°ï¼Œåˆ™å°†beanå˜é‡çš„å€¼èµ‹å€¼ã€‚ */ // Eagerly check singleton cache for manually registered singletons. Object sharedInstance = getSingleton(beanName); if (sharedInstance != null \u0026\u0026 args == null) { // çœç•¥æ— å…³ä»£ç  // å¦‚æœbeanä¸æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameä»¥\u0026å¼€å¤´ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ // å¦åˆ™å°†beanå¼ºè½¬ä¸ºFactoryBeanç±»å‹ï¼Œå¹¶è°ƒç”¨getObject()æ–¹æ³•è¿”å›ã€‚ bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); } // çœç•¥æ— å…³ä»£ç ... return (T) bean; } } å…ˆè·³è¿‡æ— å…³ä»£ç ï¼Œçœ‹å…³é”®ç‚¹ã€‚ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨doGetBean()ä¸­å…ˆè°ƒç”¨äº†getSingleton()ï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸ä¸ºç©ºå°±è°ƒç”¨getObjectForBeanInstance()ï¼Œç»è¿‡ä¸€å®šçš„å¤„ç†ï¼ˆå…ˆä¸è¦å…³å¿ƒå…·ä½“å¤„ç†äº†ä»€ä¹ˆï¼‰ï¼Œè¿”å›è¿™ä¸ªbeanå®ä¾‹ã€‚ å¯ä»¥å…ˆåˆ†æï¼Œä»æ¥æ”¶å˜é‡çš„å˜é‡åsharedInstanceå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªbeanå®ä¾‹ã€‚å…³é”®ç‚¹å°±åœ¨getSingleton()æ–¹æ³•ï¼Œè¿™é‡Œå¯èƒ½ä¼šè·å–åˆ°ä¸€ä¸ªbeanå®ä¾‹ã€‚ ä¸‹é¢æ˜¯ getSingleton() æºç ï¼š public class DefaultSingletonBeanRegistry extends SimpleAliasRegistry implements SingletonBeanRegistry { /** ä¸€çº§ç¼“å­˜ é‡Œé¢å­˜å‚¨çš„æ˜¯beanå®ä¾‹ï¼Œåœ¨beanå®ä¾‹åŒ–å®Œæˆã€ä¾èµ–æ³¨å…¥ã€ä»£ç†ç”Ÿæˆç­‰æµç¨‹å…¨éƒ¨å®Œæˆä¹‹åï¼Œä¼šå­˜å‚¨åˆ°è¿™ä¸ªå®¹å™¨ä¸­ */ /** Cache of singleton objects: bean name to bean instance. */ private final Map\u003cString, Object\u003e singletonObjects = new ConcurrentHashMap\u003c\u003e(256); /** * ä¸‰çº§ç¼“å­˜ï¼Œåœ¨å•ä¾‹beanåˆšåˆšåˆ›å»ºå®Œæˆæ—¶ï¼Œä¼šå°†å…¶å°è£…æˆä¸€ä¸ªObjectFactoryå¯¹è±¡ï¼Œå­˜å‚¨åˆ°è¿™ä¸ªå®¹å™¨ä¸­ã€‚é”®å€¼æ˜¯beanNameã€‚ * ä»æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šæ˜¯æä¾›äº†ä¸€äº›é€šè¿‡BeanPostProcessorè¿›è¡Œçš„æ‰©å±•æ“ä½œã€‚è¿™é‡Œä¸ä¼šæ‰§è¡Œï¼Œåªæ˜¯æŠŠè¿™ä¸ªæ‰©å±•æ“ä½œæµç¨‹å°è£…èµ·æ¥ã€‚ * å®é™…ä¸Šï¼Œè¿™é‡Œå°è£…çš„ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œåœ¨è¿™é‡Œå¯ä»¥é€šè¿‡BeanPostProcessorè¿›è¡Œä¸€äº›æ‰©å±•æ“ä½œï¼Œå…¶èŠ‚ç‚¹æ˜¯beanå®ä¾‹åŒ–ä¹‹åï¼Œ * åœ¨çœŸæ­£getBeanæ—¶ï¼Œä¼šè§¦å‘è°ƒç”¨ã€‚ */ /** Cache of singleton factories: bean name to ObjectFactory. */ private final Map\u003cString, ObjectFactory\u003c?\u003e\u003e singletonFactories = new HashMap\u003c\u003e(16); /** * äºŒçº§ç¼“å­˜ ä»ä¸‰çº§ç¼“å­˜è·å–åï¼Œä¼šå°†beanå®ä¾‹å­˜å‚¨åˆ°äºŒçº§ç¼“å­˜ï¼Œå¹¶ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ã€‚è¿™é‡Œå°è£…äº†ä¸€ä¸ªå‡½æ•°å¼æ¥å£çš„åŒ¿åå®ä¾‹ï¼Œ * ä¾èµ–æ³¨å…¥è¿‡ç¨‹ä¸­é€šè¿‡getBeanæ–¹æ³•è·å–è¿™ä¸ªå®ä¾‹æ—¶ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œä¸€äº›æŒ‡å®šæ“ä½œï¼Œæ¯”å¦‚è¯´aopä»£ç†å¯¹è±¡ç”Ÿæˆï¼Œå°±å¯èƒ½åœ¨è¿™é‡Œè§¦å‘ã€‚ */ /** Cache of early singleton objects: bean name to bean instance. */ private final Map\u003cString, Object\u003e earlySingletonObjects = new HashMap\u003c\u003e(16); protected Object getSingleton(String beanName, boolean allowEarlyReference) { /** * ä»ä¸€çº§ç¼“å­˜ä¸­å–ï¼Œå¦‚æœæœ‰å€¼ï¼Œåˆ™è¿”å›ã€‚å¦åˆ™ä¾æ¬¡æŸ¥æ‰¾äºŒçº§ã€ä¸‰çº§ç¼“å­˜ï¼Œå¦‚æœæœ€ç»ˆä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°å€¼ï¼Œ * åˆ™å°†beanå¯¹è±¡å‡çº§åˆ°äºŒçº§ç¼“å­˜ï¼Œå¹¶æŠŠåŸå€¼ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ã€‚ */ Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null \u0026\u0026 isSingletonCurrentlyInCreation(beanName)) { synchronized (this.singletonObjects) { singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null \u0026\u0026 allowEarlyReference) { ObjectFactory\u003c?\u003e singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) { singletonObject = singletonFactory.ge","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/:3:1","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"2.2 æºç ä¸­è¦æ³¨æ„çš„ç»†èŠ‚ æ³¨æ„\r\ræ„é€ å‡½æ•°ä¸­çš„ä¾èµ–æ³¨å…¥ä¸å¯ä»¥å¾ªç¯ä¾èµ–ï¼Œå¤šä¾‹ä¾èµ–æ³¨å…¥ä¹Ÿä¸å¯ä»¥å¾ªç¯ä¾èµ–ã€‚ æ„é€ å‡½æ•°ä¸å…è®¸å¾ªç¯ä¾èµ–ï¼šå¾ˆå®¹æ˜“æ˜ç™½ï¼Œå¦‚æœæƒ³è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œæ¯”å¦‚è°ƒç”¨å®ƒçš„æ„é€ å‡½æ•°ï¼Œå³ä½¿åå°„è°ƒç”¨ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å¦‚æœAæ„é€ å‡½æ•°ä¾èµ–Bï¼ŒBæ„é€ å‡½æ•°ä¸­ä¾èµ–Aï¼Œé‚£ä¹ˆæ„é€ å‡½æ•°å°±æ— æ³•è°ƒç”¨å®Œæˆï¼Œå¯¹è±¡ä¹Ÿå°±æ— ä»åˆ›å»ºã€‚æ°¸è¿œä¹Ÿæ‹¿ä¸åˆ°æå‰æš´éœ²çš„å¯¹è±¡å¼•ç”¨ã€‚ å¤šä¾‹æƒ…å†µï¼šä¸å…è®¸å¾ªç¯ä¾èµ–ï¼Œç”±äºæ˜¯å¤šä¾‹ï¼Œæ¯æ¬¡getBeanéƒ½ä¼šåˆ›å»ºæ–°çš„å®ä¾‹ï¼Œå‡å¦‚ä»£ç ä¸­å®šä¹‰äº†æœ‰å¾ªç¯ä¾èµ–çš„å±æ€§ï¼Œå¦‚æœè¢«å…è®¸ï¼Œå°±ä¼šé™·å…¥æ­»å¾ªç¯ã€‚ \r\r å¤šä¾‹æƒ…å†µï¼Œå¦‚æœæœ‰å¾ªç¯ä¾èµ–ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæºç å¦‚ä¸‹ï¼š public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { protected \u003cT\u003e T doGetBean(final String name, @Nullable final Class\u003cT\u003e requiredType, @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException { // Fail if we're already creating this bean instance: // We're assumably within a circular reference. // å¤šä¾‹ä¸æ”¯æŒå¾ªç¯å¼•ç”¨ã€‚å¤šä¾‹æ—¶ï¼Œå¦‚æœè¿”å›æŒ‡å®šçš„åŸå‹beanæ˜¯å¦æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ if (isPrototypeCurrentlyInCreation(beanName)) { throw new BeanCurrentlyInCreationException(beanName); } } } æ„é€ å‡½æ•°ä¸­å¦‚æœæœ‰å¾ªç¯ä¾èµ–ï¼Œæºç ConstructorResolverç±»ä¸­æœ‰è¿™æ®µä»£ç ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š try { // çœç•¥æ— å…³ä»£ç ï¼Œå¦‚æœè¿™é‡Œæœ‰æ„é€ å‡½æ•°ä¸­çš„å¾ªç¯ä¾èµ–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ }catch (BeansException ex) { throw new UnsatisfiedDependencyException( mbd.getResourceDescription(), beanName, new InjectionPoint(methodParam), ex); } ","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/:3:2","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"2.3 æµç¨‹æ¢³ç† ä¾‹å¦‚æœ‰Aã€Bä¸¤ä¸ªç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œåˆ†åˆ«å°†å¯¹æ–¹çš„å®ä¾‹æ³¨å…¥åˆ°è‡ªèº«æˆå‘˜ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼ˆå‰æ–‡ä¸­ç±»ä¼¼æ¡ˆä¾‹ï¼‰ï¼š @Service public class A { @Autowired private B b; } @Service public class B { @Autowired private A a; } åˆ†æä¸Šé¢ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼š A ç±»æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–åï¼Œ è®¾ç½®ä¸‰çº§ç¼“å­˜ã€‚ A ç±» populateBean è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œ è¿™é‡Œè§¦å‘äº†å±æ€§ B çš„ getBean æ“ä½œã€‚ B ç±»æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–åï¼Œè®¾ç½®ä¸‰çº§ç¼“å­˜ã€‚ B ç±» populateBean è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œè¿™é‡Œè§¦å‘äº†å±æ€§ A çš„ getBean æ“ä½œ A ç±»ä¹‹å‰æ­£åœ¨å®ä¾‹åŒ–ï¼Œ singletonsCurrentlyInCreation é›†åˆä¸­æœ‰å·²ç»æœ‰è¿™ä¸ª A å®ä¾‹äº†ï¼Œä¸‰çº§ç¼“å­˜é‡Œé¢ä¹Ÿæœ‰äº†ï¼Œæ‰€ä»¥è¿™æ—¶å€™æ˜¯ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°çš„æå‰æš´éœ²çš„ A å®ä¾‹ï¼Œè¯¥å®ä¾‹è¿˜æ²¡æœ‰è¿›è¡Œå±æ€§ B çš„ä¾èµ–æ³¨å…¥ï¼Œå±æ€§ B ä¸ºç©ºã€‚ B ç±»æ‹¿åˆ°äº† A çš„æå‰æš´éœ²å®ä¾‹æ³¨å…¥åˆ°å±æ€§ A ä¸­äº†ã€‚ B ç±»å®ä¾‹åŒ–å·²ç»å®Œæˆï¼ŒB ç±»çš„å®ä¾‹åŒ–æ˜¯ç”± A ç±»å®ä¾‹åŒ–ä¸­å±æ€§ B çš„ä¾èµ–æ³¨å…¥è§¦å‘çš„ getBean æ“ä½œè¿›è¡Œçš„ï¼Œç°åœ¨ B å·²ç»å®ä¾‹åŒ–ï¼Œæ‰€ä»¥ A ç±»ä¸­å±æ€§ B å°±å¯ä»¥å®Œæˆä¾èµ–æ³¨å…¥äº†ï¼Œè¿™æ—¶å€™ A ç±» B å±æ€§å·²ç»æœ‰å€¼äº†ã€‚ B ç±» A å±æ€§æŒ‡å‘çš„å°±æ˜¯ A ç±»å®ä¾‹å †ç©ºé—´ï¼Œæ‰€ä»¥è¿™æ—¶å€™ B ç±» A å±æ€§ä¹Ÿä¼šæœ‰å€¼äº†ã€‚ ","date":"2020-11-27","objectID":"/posts/spring/06-cyclic-dependence/:3:3","tags":["springæºç "],"title":"06 å¾ªç¯ä¾èµ–çš„å®ç°åŸç†","uri":"/posts/spring/06-cyclic-dependence/"},{"categories":["spring"],"content":"è¯¦ç»†è§£è¯»springä¸­beançš„å®ä¾‹åŒ–æµç¨‹ï¼Œç”±äºç¯‡å¹…åŸå› ï¼Œå¾ªç¯ä¾èµ–ã€ä¸€äº›æµç¨‹èŠ‚ç‚¹çš„è¯¦ç»†è§£æåœ¨åç»­æ–‡ç« ä¸­è®¨è®ºã€‚","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:1:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"1 å¸¸è§çš„ApplicationContextå®ç°ç±»ï¼š springå®¹å™¨éƒ½æ˜¯ä»æ„é€ ä¸€ä¸ªApplicationContextå¯¹è±¡å¼€å§‹çš„ï¼Œä»¥ä¸‹æ˜¯springä¸­å¸¸è§çš„ApplicationContextå®ç°ã€‚ å®¹å™¨ï¼šAbstractApplicationContext æŠ½è±¡çˆ¶ç±»ï¼Œæ ¸å¿ƒ(æ¨¡æ¿)æ–¹æ³• refresh()ã€‚ ClassPathXmlApplicationContext - XMLæ–¹å¼å¯åŠ¨ã€‚ AnnotationConfigWebApplicationContext - æ³¨è§£æ–¹å¼å¯åŠ¨ï¼Œå¯¹å±€éƒ¨ä»£ç è¿›è¡Œæµ‹è¯•æ—¶æ¯”è¾ƒå¥½ç”¨ã€‚ AnnotationConfigServletWebServerApplicationContext - SpringBootå¯åŠ¨é»˜è®¤ä½¿ç”¨çš„ä¸Šä¸‹æ–‡ç±»ã€‚ ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:2:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"2 æ ¸å¿ƒæ–¹æ³•refresh() ã€‚ åœ¨springå®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨åˆ°æ ¸å¿ƒæ–¹æ³•refrsh()ã€‚è¿™ä¸ªæ–¹æ³•å®šä¹‰äº†springå®¹å™¨åˆå§‹åŒ–æ ¸å¿ƒæµç¨‹ã€‚åŒ…å«åˆ›å»ºbeanFactoryã€XMLè§£æã€æ³¨è§£æ”¯æŒã€åç½®å¤„ç†å™¨æ³¨å†Œæ‰§è¡Œã€BeanPostProcessoræ³¨å†Œã€Beanå®ä¾‹åŒ–ç­‰èŠ‚ç‚¹ã€‚ ä»¥ä¸‹æ˜¯springä¸­refresh()æºç ï¼š public abstract class AbstractApplicationContext extends DefaultResourceLoader implements ConfigurableApplicationContext { @Override public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { // Prepare this context for refreshing. // ä¸å¤ªé‡è¦ï¼Œé¢„åˆ·æ–°ï¼Œåšä¸€äº›å‡†å¤‡å·¥ä½œã€‚è®°å½•äº†å¯åŠ¨æ—¶é—´æˆ³ï¼Œæ ‡è®°ä¸ºæ´»åŠ¨ï¼Œéå…³é—­çŠ¶æ€ã€‚ prepareRefresh(); /** * TODO é‡ç‚¹ï¼šè§£æxmlé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºbeanFactoryï¼ŒåŒ…è£…BeanDefinition */ // Tell the subclass to refresh the internal bean factory. ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // Prepare the bean factory for use in this context. // æ³¨å†Œä¸€äº›å¯¹äº‹ä»¶ã€ç›‘å¬å™¨ç­‰çš„æ”¯æŒ prepareBeanFactory(beanFactory); // é’©å­æ–¹æ³•ï¼ŒBeanFactoryåˆ›å»ºåï¼Œå¯¹BeanFactoryçš„è‡ªå®šä¹‰æ“ä½œã€‚ // Allows post-processing of the bean factory in context subclasses. postProcessBeanFactory(beanFactory); // TODO é‡ç‚¹ï¼šè¿™é‡Œè°ƒç”¨äº†postProcessBeanDefinitionRegistry(registry);springbootä¸­å¾ˆå¤šæ¿€æ´»è‡ªåŠ¨é…ç½®çš„æ³¨è§£éƒ½æ˜¯é€šè¿‡è¿™é‡Œå¯¼å…¥çš„ã€‚ // Invoke factory processors registered as beans in the context. invokeBeanFactoryPostProcessors(beanFactory); // TODO é‡ç‚¹ï¼šä»beanFactoryä¸­è·å–æ‰€æœ‰çš„BeanPostProcessorï¼Œä¼˜å…ˆè¿›è¡ŒgetBeanæ“ä½œï¼Œå®ä¾‹åŒ– // Register bean processors that intercept bean creation. registerBeanPostProcessors(beanFactory); // å›½é™…åŒ–æ”¯æŒ // Initialize message source for this context. initMessageSource(); // åˆå§‹åŒ–ApplicationEventMulticasterã€‚ å¦‚æœä¸Šä¸‹æ–‡ä¸­æœªå®šä¹‰ï¼Œåˆ™ä½¿ç”¨SimpleApplicationEventMulticasterã€‚ // Initialize event multicaster for this context. initApplicationEventMulticaster(); // é’©å­æ–¹æ³•ï¼ŒspringBootä¸­çš„åµŒå…¥å¼tomcatå°±æ˜¯é€šè¿‡æ­¤æ–¹æ³•å®ç°çš„ // Initialize other special beans in specific context subclasses. onRefresh(); // ç›‘å¬å™¨æ³¨å†Œ // Check for listener beans and register them. registerListeners(); // TODO é‡ç‚¹æ–¹æ³•ï¼šå®Œæˆå®¹å™¨ä¸­beançš„å®ä¾‹åŒ–ï¼ŒåŠä»£ç†çš„ç”Ÿæˆç­‰æ“ä½œã€‚ // Instantiate all remaining (non-lazy-init) singletons. finishBeanFactoryInitialization(beanFactory); // å®Œæˆæ­¤ä¸Šä¸‹æ–‡çš„åˆ·æ–°ï¼Œè°ƒç”¨LifecycleProcessorçš„onRefreshï¼ˆï¼‰æ–¹æ³•å¹¶å‘å¸ƒ // Last step: publish corresponding event. finishRefresh(); // ... çœç•¥æ— å…³ä»£ç  } } } ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:3:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"3 Beanå®ä¾‹åŒ–å…¥å£ï¼ŒgetBean() beanå®ä¾‹åŒ–çš„å…¥å£æ˜¯getBean()ã€‚å¯¹äºå•ä¾‹Beanï¼ˆå®é™…å¼€å‘ä¸­å¤§å¤šæ•°éƒ½æ˜¯å•ä¾‹ï¼‰ï¼Œåœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»refresh()ä¸­ï¼Œè°ƒç”¨åˆ°finishBeanFactoryInitialization()ï¼Œç„¶åè°ƒç”¨åˆ°preInstantiateSingletons()ã€‚ åœ¨preInstantiateSingletons()ä¸­ï¼ˆDefaultListableBeanFactoryç±»ä¸­ï¼‰ï¼Œè°ƒç”¨åˆ°äº†getBean()ï¼Œæºç å¦‚ä¸‹ï¼š public class DefaultListableBeanFactory extends AbstractAutowireCapableBeanFactory implements ConfigurableListableBeanFactory, BeanDefinitionRegistry, Serializable { @Override public void preInstantiateSingletons() throws BeansException { // å®¹å™¨ä¸­æ‰€æœ‰çš„beanNameï¼Œå¾ªç¯ã€å®ä¾‹åŒ– // Iterate over a copy to allow for init methods which in turn register new bean definitions. // While this may not be part of the regular factory bootstrap, it does otherwise work fine. List\u003cString\u003e beanNames = new ArrayList\u003c\u003e(this.beanDefinitionNames); // å¾ªç¯è°ƒç”¨ï¼Œè¿›è¡Œå®ä¾‹åŒ– // Trigger initialization of all non-lazy singleton beans... for (String beanName : beanNames) { RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); // éæŠ½è±¡çš„ã€å•ä¾‹çš„ã€å¹¶ä¸”éæ‡’åŠ è½½çš„ï¼Œæ‰ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶å°±å®ä¾‹åŒ–ã€‚ if (!bd.isAbstract() \u0026\u0026 bd.isSingleton() \u0026\u0026 !bd.isLazyInit()) { if (isFactoryBean(beanName)) { Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); if (bean instanceof FactoryBean) { final FactoryBean\u003c?\u003e factory = (FactoryBean\u003c?\u003e) bean; boolean isEagerInit; if (System.getSecurityManager() != null \u0026\u0026 factory instanceof SmartFactoryBean) { isEagerInit = AccessController.doPrivileged((PrivilegedAction\u003cBoolean\u003e) ((SmartFactoryBean\u003c?\u003e) factory)::isEagerInit, getAccessControlContext()); } else { isEagerInit = (factory instanceof SmartFactoryBean \u0026\u0026 ((SmartFactoryBean\u003c?\u003e) factory).isEagerInit()); } if (isEagerInit) { getBean(beanName); } } } else { getBean(beanName); } } } } } æ³¨æ„\r\rä»ä»¥ä¸Šæºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å·²ç»æœé›†å¥½çš„BeanDefinitioné›†åˆä¸­ï¼Œåªæœ‰éæŠ½è±¡çš„ã€å•ä¾‹çš„ã€å¹¶ä¸”éæ‡’åŠ è½½çš„ï¼Œæ‰ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶å°±å®ä¾‹åŒ–ã€‚\r\r ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:4:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"4 å®ä¾‹åŒ–ä¸»æµç¨‹ æš‚ä¸”å¿½ç•¥æ— å…³ä»£ç ï¼Œä»…å…³æ³¨å•ä¾‹æƒ…å†µä¸‹ï¼Œspringå®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­beançš„å®ä¾‹åŒ–ã€‚ public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { @SuppressWarnings(\"unchecked\") protected \u003cT\u003e T doGetBean(final String name, @Nullable final Class\u003cT\u003e requiredType, @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException { /* TODO é‡è¦ç¨‹åº¦ 5 å•ä¾‹å®ä¾‹ç¬¬ä¸€æ¬¡åˆ›å»ºbeanå…¥å£ï¼Œè¿™é‡Œçš„getSingletonæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†å‚æ•°ä¸­åŒ¿åå¯¹è±¡çš„getObject() åœ¨beanåˆ›å»ºå®Œæˆåï¼Œå°†beanæ”¾å…¥åˆ°ä¸€çº§ç¼“å­˜ï¼Œå¹¶ä»äºŒä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤:addSingleton(beanName, singletonObject); */ // Create bean instance. if (mbd.isSingleton()) { sharedInstance = getSingleton(beanName, () -\u003e { try { //åˆ›å»ºBeanå®ä¾‹ return createBean(beanName, mbd, args); } catch (BeansException ex) { // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; } }); /* TODO é‡è¦ç¨‹åº¦ 5 å¦‚æœbeanä¸æ˜¯FactoryBeanç±»å‹æˆ–è€…beanNameä»¥\u0026å¼€å¤´ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚ å¦åˆ™è°ƒç”¨FactoryBeançš„getObject(),ä¸”å°†è¿”å›çš„beanæ›¿æ¢ä¸ºgetObject()çš„è¿”å›å€¼ã€‚ FactoryBeanæ¥å£å¾ˆé‡è¦ï¼Œå…·ä½“åº”ç”¨åœºæ™¯è§FactoryBeanæ¥å£æ³¨é‡Šã€‚ */ bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); } } } å…¶ä¸­æœ‰ä¸‰ä¸ªå…³é”®çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯getSingleton()ã€å‡½æ•°æ¥å£ï¼ˆObjectFactoryï¼‰ä¸­çš„createBean()ã€ä»¥åŠæœ€åè°ƒç”¨çš„getObjectForBeanInstance()ã€‚ getSingleton()ä¸­è°ƒç”¨åˆ°äº†åŒ¿åå‡½æ•°ä¸­çš„getObject()ï¼Œè¿™ä¸ªgetObjectå°±æ˜¯å¤–å›´æ–¹æ³•ä¸­çš„lambdaè¡¨è¾¾å¼ä¸­çš„æ–¹æ³•ï¼Œè¿™é‡Œé¢è°ƒç”¨äº†createBean()ã€‚ æ¥åˆ°createBean(): public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory { @Override protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException { // ...çœç•¥æ— å…³ä»£ç  // è¿™é‡Œå¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œä¼šè°ƒç”¨ InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()å’Œ // BeanPostProcessor.postProcessAfterInitialization()ï¼Œç›´æ¥è¿”å›ã€‚ // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance. Object bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) { return bean; } // ...çœç•¥æ— å…³ä»£ç  //åˆ›å»ºBeanå®ä¾‹ Object beanInstance = doCreateBean(beanName, mbdToUse, args); if (logger.isTraceEnabled()) { logger.trace(\"Finished creating instance of bean '\" + beanName + \"'\"); } return beanInstance; } } åœ¨createBeanä¸­ï¼ŒdoCreateBean()æ˜¯çœŸæ­£åˆ›å»ºBeanå®ä¾‹çš„æ–¹æ³•ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œspringé¢„ç•™äº†ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œé€šè¿‡å®ç°InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡BeanPostProcessorè¿”å›ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ—¶å€™å°±ä¸ä¼šå†è°ƒç”¨doCreateBeanäº†ã€‚ InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()çš„è°ƒç”¨é€»è¾‘ï¼ˆæºç ä¸­æ–‡æ³¨é‡Šä¸­ï¼Œè¯¦ç»†æè¿°äº†å®ƒçš„è°ƒç”¨è¿‡ç¨‹ï¼‰ï¼š public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory { @Nullable protected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) { Object bean = null; // å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œä¼šåœ¨è¿™é‡Œé€šè¿‡InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()è¿›è¡Œå®ä¾‹åŒ–ã€‚ // å¦‚æœæ­¤æ–¹æ³•æœ€ç»ˆè¿”å›çš„å€¼ä¸ä¸ºç©ºï¼Œåˆ™ä¼šè°ƒç”¨æ‰€æœ‰BeanPostProcessorçš„postProcessAfterInitialization()ï¼Œ // æ ‡è®°æ˜¯å¦å·²ç»æå‰å®ä¾‹åŒ–äº†beanï¼Œç„¶åè¿”å›ã€‚ if (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) { // Make sure bean class is actually resolved at this point. if (!mbd.isSynthetic() \u0026\u0026 hasInstantiationAwareBeanPostProcessors()) { Class\u003c?\u003e targetType = determineTargetType(beanName, mbd); if (targetType != null) { bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName); if (bean != null) { bean = applyBeanPostProcessorsAfterInitialization(bean, beanName); } } } mbd.beforeInstantiationResolved = (bean != null); } return bean; } } åœ¨doCreateBeanä¸­ï¼Œç»å†äº†ä»¥ä¸‹è°ƒç”¨æµç¨‹ã€‚ createBeanInstanceï¼šåˆ›å»ºbeanå®ä¾‹ï¼Œè¿™é‡ŒçœŸæ­£åˆ›å»ºäº†beançš„å®ä¾‹ã€‚ applyMergedBeanDefinitionPostProcessorsï¼šè¿™é‡Œæ˜¯BeanPostProcessorçš„ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œæ·»åŠ äº†PostConstructã€PreDestroyã€Autowiredã€Valueã€Injectæ³¨è§£çš„æ”¯æŒã€‚å®˜æ–¹æ³¨é‡Šæ˜¯ï¼šå°†MergedBeanDefinitionPostProcessorsåº”ç”¨äºæŒ‡å®šçš„beanå®šä¹‰ï¼Œè°ƒç”¨å…¶{@code postProcessMergedBeanDefinition}æ–¹æ³•ã€‚ populateBeanï¼šå®Œæˆäº†ä¾èµ–æ³¨å…¥ã€‚å…¶åŸç†æ˜¯é€šè¿‡è°ƒç”¨InstantiationAwareBeanPostProcessor.postProcessProperties()ï¼ˆspring5.1ç‰ˆæœ¬å¼€å§‹ï¼‰ã€InstantiationAwareBeanPostProcessor.postProcessPropertyValues()ï¼ˆspring5.1ç‰ˆæœ¬ä¹‹å‰ï¼‰ã€‚ä¹Ÿæ˜¯ä¸€ä¸ªBeanPostProcessoræ‰©å±•ç‚¹ã€‚ initializeBeanï¼šåˆå§‹åŒ–beanã€‚beançš„init","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:5:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"5 åˆ›å»ºå®ä¾‹ï¼ŒcreateBeanInstance åœ¨åˆ›å»ºbeanå®ä¾‹ä¸­ï¼Œä¸»è¦ç»å†äº†ä¸€ä¸‹æµç¨‹ï¼š åˆ¤æ–­ï¼Œåªæœ‰publicä¿®é¥°çš„ç±»ï¼Œæ‰å¯ä»¥è¢«åˆ›å»ºï¼Œå¦åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ é€šè¿‡BeanDefinitionä¸­çš„å›è°ƒï¼Œæ¥åˆ›å»ºBeanå®ä¾‹ã€‚ ä½¿ç”¨FactoryMethodæ¥åˆ›å»ºå®ä¾‹ï¼Œfactory-methodæ ‡ç­¾å±æ€§ï¼Œæˆ–è€…@beanæ³¨è§£ã€‚ é‡æ–°åˆ›å»ºç›¸åŒçš„Beanã€‚ é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥å‚æ•°ã€‚ ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°ã€‚ï¼ˆè¿™é‡Œæ˜¯é‡ç‚¹ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ä½¿ç”¨çš„æ— å‚æ„é€ ã€‚ï¼‰ ä»»ä½•ä¸€ä¸ªæµç¨‹æœ‰ç»“æœï¼Œå°±ä¼šç›´æ¥åˆ›å»ºbeançš„å®ä¾‹ï¼Œå¹¶è¿”å›ã€‚ ä»æºç ä¸­å¯ä»¥æ¸…æ™°çš„çœ‹å‡ºä»¥ä¸Šç»“è®ºï¼š public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory { protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) { // Make sure bean class is actually resolved at this point. Class\u003c?\u003e beanClass = resolveBeanClass(mbd, beanName); // åªæœ‰publicä¿®é¥°çš„classæ‰å¯ä»¥è¢«åˆ›å»º if (beanClass != null \u0026\u0026 !Modifier.isPublic(beanClass.getModifiers()) \u0026\u0026 !mbd.isNonPublicAccessAllowed()) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, \"Bean class isn't public, and non-public access not allowed: \" + beanClass.getName()); } // é€šè¿‡BeanDefinitionä¸­çš„å›è°ƒï¼Œæ¥åˆ›å»ºbeanå®ä¾‹ã€‚ä¸€èˆ¬ä¸ä¼šèµ°åˆ°è¿™ä¸ªæ¡ä»¶é‡Œã€‚ Supplier\u003c?\u003e instanceSupplier = mbd.getInstanceSupplier(); if (instanceSupplier != null) { return obtainFromSupplier(instanceSupplier, beanName); } // ä½¿ç”¨FactoryMethodåˆ›å»ºbeanå®ä¾‹ã€‚factory-methodæ ‡ç­¾å±æ€§ï¼Œæˆ–è€…@Beanæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ï¼Œä¼šä»è¿™é‡Œåˆ›å»ºå®ä¾‹ã€‚ if (mbd.getFactoryMethodName() != null) { return instantiateUsingFactoryMethod(beanName, mbd, args); } // é‡æ–°åˆ›å»ºç›¸åŒbeanï¼Œä¼šèµ°åˆ°è¿™é‡Œã€‚ // Shortcut when re-creating the same bean... boolean resolved = false; boolean autowireNecessary = false; if (args == null) { synchronized (mbd.constructorArgumentLock) { if (mbd.resolvedConstructorOrFactoryMethod != null) { resolved = true; autowireNecessary = mbd.constructorArgumentsResolved; } } } if (resolved) { if (autowireNecessary) { return autowireConstructor(beanName, mbd, null, null); } else { return instantiateBean(beanName, mbd); } } // åˆ¤æ–­æ˜¯å¦æ˜¯é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥å‚æ•°ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™é€šè¿‡@Autowiredæ ‡æ³¨çš„æ„é€ å‡½æ•°å®ä¾‹åŒ–ã€‚ // Candidate constructors for autowiring? Constructor\u003c?\u003e[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName); if (ctors != null || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) { return autowireConstructor(beanName, mbd, ctors, args); } // é»˜è®¤æ„é€ çš„é¦–é€‰å‡½æ•° // Preferred constructors for default construction? ctors = mbd.getPreferredConstructors(); if (ctors != null) { return autowireConstructor(beanName, mbd, ctors, null); } // ä½¿ç”¨æ— å‚æ„é€ å®ä¾‹åŒ–beanï¼Œå®é™…å¤§å¤šæ•°beançš„å®ä¾‹åŒ–ï¼Œéƒ½æ˜¯èµ°çš„è¿™ä¸ªæ–¹æ³•ã€‚ // No special handling: simply use no-arg constructor. return instantiateBean(beanName, mbd); } } è®°å½•ä¸€ä¸‹æ— å‚æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹çš„è¿‡ç¨‹ï¼š getInstantiationStrategy()ï¼šè·å–beançš„å®ä¾‹åŒ–ç­–ç•¥å¯¹è±¡ï¼Œé»˜è®¤ä½¿ç”¨çš„CglibSubclassingInstantiationStrategyã€‚ instantiate(mbd, beanName, parent)ï¼šå®ä¾‹åŒ–beanã€‚ instantiate -\u003e BeanUtils.instantiateClass() -\u003e ctor.newInstance()ã€‚åå°„è°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œåˆ›å»ºå¯¹è±¡ã€‚ æºç å¦‚ä¸‹ï¼š public class SimpleInstantiationStrategy implements InstantiationStrategy { // ç¬¬ä¸€æ­¥ @Override public Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) { // Don't override the class with CGLIB if no overrides. if (!bd.hasMethodOverrides()) { // çœç•¥æ— å…³ä»£ç ... // è·å–æ— å‚æ„é€ å‡½æ•° constructorToUse = clazz.getDeclaredConstructor(); bd.resolvedConstructorOrFactoryMethod = constructorToUse; // çœç•¥æ— å…³ä»£ç ... // TODO å®ä¾‹åŒ–bean return BeanUtils.instantiateClass(constructorToUse); } else { // Must generate CGLIB subclass. return instantiateWithMethodInjection(bd, beanName, owner); } } } public abstract class BeanUtils { // ç¬¬äºŒæ­¥ public static \u003cT\u003e T instantiateClass(Constructor\u003cT\u003e ctor, Object... args) throws BeanInstantiationException { Assert.notNull(ctor, \"Constructor must not be null\"); // è®¾ç½®æ„é€ å‡½æ•°setAccessible=true // newInstance:åå°„è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºbeanå¯¹è±¡ã€‚ ReflectionUtils.makeAccessible(ctor); return (KotlinDetector.isKotlinReflectPresent() \u0026\u0026 KotlinDetector.isKotlinType(ctor.getDeclaringClass()) ? KotlinDelegate.instantiateClass(ctor, args) : ctor.newInstance(args)); // çœç•¥æ— å…³ä»£ç ... } } æºç ä¸­æœ€åä¸€è¡Œ ctor.newInstance(args) åˆ›å»ºäº†beanå®ä¾‹ã€‚ç„¶åé€å±‚å‘ä¸Šè¿”å›ã€‚ ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:6:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"6 æ³¨è§£æ”¯æŒï¼ŒapplyMergedBeanDefinitionPostProcessors è¿™é‡Œæ‰§è¡Œäº†MergedBeanDefinitionPostProcessor.postProcessMergedBeanDefinition()æ–¹æ³•ã€‚springä¼šåŠ è½½åœ¨ä¹‹å‰çš„æµç¨‹ä¸­æ³¨å†Œçš„MergedBeanDefinitionPostProcessorï¼ˆBeanPostProcessorçš„å­æ¥å£ï¼‰ï¼Œå¹¶å¯¹å…¶è¿›è¡Œè°ƒç”¨ã€‚æ¯”è¾ƒå…¸å‹çš„ä¸¤ä¸ªç±»ï¼Œå®Œæˆäº†@Autowriedã€@Valueã€@Injectedã€@PostConstructã€@PreDestroyç­‰æ³¨è§£çš„æ”¯æŒ è°ƒç”¨å…¥å£æºç å¦‚ä¸‹ï¼š public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory { protected void applyMergedBeanDefinitionPostProcessors(RootBeanDefinition mbd, Class\u003c?\u003e beanType, String beanName) { for (BeanPostProcessor bp : getBeanPostProcessors()) { if (bp instanceof MergedBeanDefinitionPostProcessor) { MergedBeanDefinitionPostProcessor bdp = (MergedBeanDefinitionPostProcessor) bp; bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName); } } } } ä¸¤ä¸ªæ¯”è¾ƒå…¸å‹çš„å®ç°ï¼šAutowiredAnnotationBeanPostProcessorã€CommonAnnotationBeanPostProcessor ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:7:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"6.1 AutowiredAnnotationBeanPostProcessor AutowiredAnnotationBeanPostProcessorä¸­å­˜å‚¨äº†éœ€è¦@Autowiredæ³¨å…¥çš„ä¸€äº›ä¿¡æ¯æ˜ å°„ã€‚ æ„é€ å‡½æ•°ä¸­æ·»åŠ äº†å¯¹åº”æ³¨è§£çš„æ”¯æŒï¼ŒpostProcessMergedBeanDefinition()ä¸­æŸ¥æ‰¾å¸¦æœ‰Autowiredæ³¨è§£çš„æˆå‘˜çš„å±æ€§ä¿¡æ¯ä¿¡æ¯ï¼Œå¹¶å°†æœé›†ç»“æœå°è£…ç¼“å­˜èµ·æ¥ã€‚ public class AutowiredAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware { /** * åœ¨ä¾èµ–æ³¨å…¥ä¹‹å‰ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æœé›†éœ€è¦ä¾èµ–æ³¨å…¥çš„ç±»çš„ä¿¡æ¯ï¼Œå¹¶å°è£…æˆInjectionMetadataå¯¹è±¡ï¼Œç¼“å­˜åˆ°å½“å‰BeanPostProcessorå®ä¾‹ä¸­ã€‚ * * @param beanDefinition the merged bean definition for the bean * @param beanType the actual type of the managed bean instance * @param beanName the name of the bean */ @Override public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class\u003c?\u003e beanType, String beanName) { // æŸ¥æ‰¾å¸¦æœ‰Autowiredæ³¨è§£çš„æˆå‘˜çš„å±æ€§ä¿¡æ¯ä¿¡æ¯ã€‚ InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null); metadata.checkConfigMembers(beanDefinition); } } æ­¤ç±»å®Œæˆäº†å¯¹@AutoWriedã€@Valueã€@Injectedæ³¨è§£çš„æ”¯æŒã€‚ æ‰§è¡ŒbuildAutowiringMetadataæ–¹æ³•ï¼Œå®Œæˆçš„æ³¨è§£æ”¯æŒï¼Œä¹‹åä¼šæŠŠç»“æœç¼“å­˜åˆ°injectionMetadataCacheå˜é‡ä¸­ã€‚ æ„å»ºå…ƒæ•°æ®çš„è¿‡ç¨‹ï¼š å¾ªç¯ç›®æ ‡Classçš„æ‰€æœ‰å­—æ®µï¼ŒæŸ¥æ‰¾@Autowiredæ³¨è§£ã€‚å¦‚æœæŸ¥æ‰¾åˆ°ï¼Œå°†æ³¨è§£å±æ€§å°è£…æˆAutowiredFieldElementï¼Œå¹¶å°è£…åˆ°ä¸€ä¸ªlistä¸­ã€‚ å¾ªç¯ç›®æ ‡Classçš„æ‰€æœ‰æ–¹æ³•ï¼ŒæŸ¥æ‰¾@Autowiredæ³¨è§£ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œå°†æ³¨è§£å±æ€§å°è£…æˆAutowiredMethodElementï¼Œå¹¶å°è£…åˆ°ä¸€ä¸ªlistä¸­ã€‚ å°†ä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤å¾—åˆ°çš„ç»“æœï¼Œå°è£…ä¸ºInjectionMetadataï¼Œè¿”å›ã€‚å³InjectionMetadataä¸­åŒ…å«äº†éœ€è¦@Autowiredçš„å­—æ®µå’Œæ–¹æ³•ã€‚ public class AutowiredAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware { // æ— å‚æ„é€ å‡½æ•°ä¸­æ·»åŠ äº†å¯¹åº”æ³¨è§£çš„æ”¯æŒ public AutowiredAnnotationBeanPostProcessor() { // åˆå§‹åŒ–autowiredAnnotationTypesï¼Œè¿™é‡Œæ·»åŠ äº†Autowired Value Injectæ³¨è§£çš„æ”¯æŒ this.autowiredAnnotationTypes.add(Autowired.class); this.autowiredAnnotationTypes.add(Value.class); try { this.autowiredAnnotationTypes.add((Class\u003c? extends Annotation\u003e) ClassUtils.forName(\"javax.inject.Inject\", AutowiredAnnotationBeanPostProcessor.class.getClassLoader())); logger.trace(\"JSR-330 'javax.inject.Inject' annotation found and supported for autowiring\"); } catch (ClassNotFoundException ex) { // JSR-330 API not availableï¼šsimply skip. } } private InjectionMetadata buildAutowiringMetadata(final Class\u003c?\u003e clazz) { List\u003cInjectionMetadata.InjectedElement\u003e elements = new ArrayList\u003c\u003e(); Class\u003c?\u003e targetClass = clazz; do { final List\u003cInjectionMetadata.InjectedElement\u003e currElements = new ArrayList\u003c\u003e(); // å¾ªç¯æ‰€æœ‰çš„å­—æ®µï¼Œå¹¶ä»¥æ­¤å­—æ®µä¸ºå‚æ•°ï¼Œæ‰§è¡Œå›è°ƒã€‚ ReflectionUtils.doWithLocalFields(targetClass, field -\u003e { // æŸ¥æ‰¾å½“å‰å¸¦æœ‰autowiredAnnotationTypesä¸­æ”¯æŒçš„æ³¨è§£çš„å­—æ®µã€‚ AnnotationAttributes ann = findAutowiredAnnotation(field); if (ann != null) { if (Modifier.isStatic(field.getModifiers())) { if (logger.isInfoEnabled()) { logger.info(\"Autowired annotation is not supported on static fields: \" + field); } return; } boolean required = determineRequiredStatus(ann); currElements.add(new AutowiredFieldElement(field, required)); } }); // å¾ªç¯æ‰€æœ‰çš„æ–¹æ³•ï¼Œå¹¶ä»¥æ­¤æ–¹æ³•ä¸ºå‚æ•°ï¼Œæ‰§è¡Œå›è°ƒã€‚ ReflectionUtils.doWithLocalMethods(targetClass, method -\u003e { Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method); if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) { return; } // æŸ¥æ‰¾å½“å‰å¸¦æœ‰autowiredAnnotationTypesä¸­æ”¯æŒçš„æ³¨è§£çš„æ–¹æ³•ã€‚ AnnotationAttributes ann = findAutowiredAnnotation(bridgedMethod); if (ann != null \u0026\u0026 method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) { if (Modifier.isStatic(method.getModifiers())) { if (logger.isInfoEnabled()) { logger.info(\"Autowired annotation is not supported on static methods: \" + method); } return; } if (method.getParameterCount() == 0) { if (logger.isInfoEnabled()) { logger.info(\"Autowired annotation should only be used on methods with parameters: \" + method); } } boolean required = determineRequiredStatus(ann); PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz); currElements.add(new AutowiredMethodElement(method, required, pd)); } }); elements.addAll(0, currElements); targetClass = targetClass.getSuperclass(); } while (targetClass != null \u0026\u0026 targetClass != Object.class); return new InjectionMetadata(clazz, elements); } @Nullable private AnnotationA","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:7:1","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"6.2 CommonAnnotationBeanPostProcessor CommonAnnotationBeanPostProcessoræ˜¯InitDestroyAnnotationBeanPostProcessorçš„å­ç±»ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªBeanPostProcessorã€‚è®¾ç½®äº†@PostConstructã€@PreDestroyã€@Resourceæ³¨è§£çš„æ”¯æŒã€‚ æ³¨æ„\r\r ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡ï¼ˆåˆå§‹åŒ–ã€é”€æ¯æ–¹æ³•ï¼‰æ˜¯åœ¨InitDestroyAnnotationBeanPostProcessorå®šä¹‰çš„ã€‚ @PostConstructã€@PreDestroyæ³¨è§£æ”¯æŒæ˜¯åœ¨CommonAnnotationBeanPostProcessorçš„æ— å‚æ„é€ å‡½æ•°ä¸­è®¾ç½®çš„ã€‚ \r\r public class InitDestroyAnnotationBeanPostProcessor implements DestructionAwareBeanPostProcessor, MergedBeanDefinitionPostProcessor, PriorityOrdered, Serializable { @Nullable private Class\u003c? extends Annotation\u003e initAnnotationType; @Nullable private Class\u003c? extends Annotation\u003e destroyAnnotationType; } public class CommonAnnotationBeanPostProcessor extends InitDestroyAnnotationBeanPostProcessor implements InstantiationAwareBeanPostProcessor, BeanFactoryAware, Serializable { public CommonAnnotationBeanPostProcessor() { // è¿™é‡Œè®¾ç½®äº†PostConstructã€PreDestroyæ³¨è§£çš„æ”¯æŒã€‚ setOrder(Ordered.LOWEST_PRECEDENCE); setInitAnnotationType(PostConstruct.class); setDestroyAnnotationType(PreDestroy.class); ignoreResourceType(\"javax.xml.ws.WebServiceContext\"); } } æœé›†æ”¯æŒçš„å…ƒç´ å¹¶å°è£…çš„æµç¨‹ï¼š å…ˆæ‰§è¡Œçˆ¶ç±»çš„æœé›†é€»è¾‘ï¼Œè¿™é‡Œè®¾ç½®äº†@PostConstructã€@PreDestroyæ³¨è§£çš„æ”¯æŒã€‚ æ‰§è¡Œæœ¬ç±»ä¸­çš„æœé›†é€»è¾‘ï¼Œè¿™é‡Œè®¾ç½®äº†@Resourceæ³¨è§£çš„æ”¯æŒã€‚ public class CommonAnnotationBeanPostProcessor extends InitDestroyAnnotationBeanPostProcessor implements InstantiationAwareBeanPostProcessor, BeanFactoryAware, Serializable { @Override public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class\u003c?\u003e beanType, String beanName) { // å…ˆè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼ŒæŸ¥æ‰¾æ”¯æŒçš„å…ƒç´ ï¼Œè¿›è¡Œå°è£… super.postProcessMergedBeanDefinition(beanDefinition, beanType, beanName); // åœ¨è°ƒç”¨æœ¬ç±»ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æŸ¥æ‰¾æ”¯æŒçš„å…ƒç´ ï¼Œè¿›è¡Œå°è£… InjectionMetadata metadata = findResourceMetadata(beanName, beanType, null); metadata.checkConfigMembers(beanDefinition); } } åœ¨çœŸæ­£æ‰§è¡Œæœé›†æ³¨è§£é€»è¾‘ä¹‹å‰ï¼Œæœ‰ä¸€ä¸ªé”çš„ä½¿ç”¨æ–¹å¼ã€‚çˆ¶ç±»å’Œå­ç±»æ­¤æ–¹æ³•ä¸­éƒ½æœ‰ä½“ç°ã€‚å…ˆä¸åŠ é”è·å–ï¼Œå¦‚æœä¸ºç©ºï¼Œå†åŠ é”ï¼Œå°è¯•è·å–ï¼Œå¦‚æœåŠ é”ä¸‹è·å–è¿˜æ˜¯ç©ºï¼Œåˆ™æ‰§è¡Œæœé›†é€»è¾‘ï¼Œæœé›†å®Œä¹‹åä¼šæ”¾å…¥ç¼“å­˜ã€‚ç¼“å­˜çš„mapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚ å¦‚æœæˆ‘ä»¬å­˜å‚¨ä¸€ç»„æ•°æ®ï¼Œè¿™ç»„æ•°æ®åªéœ€è¦å­˜å‚¨ä¸€æ¬¡ï¼Œåé¢å…¨éƒ¨éƒ½æ˜¯getæ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨è¿™ç§éçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼ˆéçº¿ç¨‹å®‰å…¨çš„é›†åˆçš„getæ“ä½œæ€§èƒ½è¿œé«˜äºçº¿ç¨‹å®‰å…¨é›†åˆï¼‰ã€‚åœ¨å­˜å‚¨çš„æ—¶å€™ï¼Œä»¥å…ˆé‡è¯•ï¼Œå†åŠ é”çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚æ›´å¤šå…³äºçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹çš„çŸ¥è¯†æ¨¡å—é‡Œè®°å½•ã€‚ è¿™é‡Œåˆ—ä¸¾ä¸€ä¸ªçˆ¶ç±»ä¸­çš„æ–¹æ³•ï¼š public class InitDestroyAnnotationBeanPostProcessor implements DestructionAwareBeanPostProcessor, MergedBeanDefinitionPostProcessor, PriorityOrdered, Serializable { private LifecycleMetadata findLifecycleMetadata(Class\u003c?\u003e clazz) { if (this.lifecycleMetadataCache == null) { // Happens after deserialization, during destruction... return buildLifecycleMetadata(clazz); } // Quick check on the concurrent map first, with minimal locking. LifecycleMetadata metadata = this.lifecycleMetadataCache.get(clazz); if (metadata == null) { synchronized (this.lifecycleMetadataCache) { metadata = this.lifecycleMetadataCache.get(clazz); if (metadata == null) { // ä¸Šé¢ä»£ç æ˜¯ç¼“å­˜ï¼Œè¿™é‡ŒåŠ é”çš„æŠ€å·§ï¼Œå…ˆæ— é”å°è¯•ï¼Œå°è¯•å¤±è´¥å†åŠ é”ã€‚ // ç»†èŠ‚ï¼šåŠ é”ä¸­éœ€è¦å†æ¬¡å°è¯•è·å–ä¸€æ¬¡ã€‚ metadata = buildLifecycleMetadata(clazz); this.lifecycleMetadataCache.put(clazz, metadata); } return metadata; } } return metadata; } } InitDestroyAnnotationBeanPostProcessorä¸­æœé›†åˆå§‹åŒ–ã€é”€æ¯æ–¹æ³•çš„é€»è¾‘ï¼šæ ¹æ®æˆå‘˜å˜é‡ï¼ˆèµ‹å€¼çš„é€»è¾‘å‰æ–‡ä¸­æœ‰ï¼‰initAnnotationTypeã€destroyAnnotationTypeçš„ç±»å‹ï¼Œå¾ªç¯åˆ¤æ–­æ–¹æ³•ä¸­æ˜¯å¦æœ‰å¯¹åº”æ³¨è§£ï¼Œæœ‰å°±ç¼“å­˜åˆ°å¯¹åº”é›†åˆä¸­ã€‚éå†å®Œæ‰€æœ‰æ–¹æ³•ä¹‹åå°†æœ€ç»ˆçš„ç»“æœå°è£…æˆLifecycleMetadata ä»£ç å¦‚ä¸‹ï¼š public class InitDestroyAnnotationBeanPostProcessor implements DestructionAwareBeanPostProcessor, MergedBeanDefinitionPostProcessor, PriorityOrdered, Serializable { private LifecycleMetadata buildLifecycleMetadata(final Class\u003c?\u003e clazz) { List\u003cLifecycleElement\u003e initMethods = new ArrayList\u003c\u003e(); List\u003cLifecycleElement\u003e destroyMethods = new ArrayList\u003c\u003e(); Class\u003c?\u003e targetClass = clazz; do { final List\u003cLifecycleElement\u003e currInitMethods = new ArrayList\u003c\u003e(); final List\u003cLifecycleElement\u003e currDestroyMethods = new ArrayList\u003c\u003e(); // å¾ªç¯éå†æ‰€æœ‰çš„æ–¹æ³•ï¼ŒæŸ¥æ‰¾åˆå§‹åŒ–ã€é”€æ¯æ–¹æ³•ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°ï¼Œå°±å°è£…ä¸ºLifecycleMetadataè¿”å›ã€‚ ReflectionUtils.doWithLocalMethods(targetClass, method -\u003e { if (this.initAnnotationType != null \u0026\u0026 method.isAnnotationPresent(this.initAnnotationType)) { LifecycleElement element = new LifecycleElement(method); currInitMethods.add(element); if (logger.isTraceEnabled()) { logger.trace(\"Found init method on class [\" + clazz.getName() + \"]: \" + method); } } if (this.destroyAnnotationType != null \u0026\u0026 method.isAnnotationPres","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:7:2","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"7 ä¾èµ–æ³¨å…¥ï¼ŒpopulateBean populateBeançš„ä½œç”¨æ˜¯å®Œæˆbeanå±æ€§çš„ä¾èµ–æ³¨å…¥ã€‚ ä¾èµ–æ³¨å…¥ä¹‹å‰ï¼Œå¦‚æœBeanDefinitionæ˜¯åˆæˆçš„ï¼Œæœ‰InstantiationAwareBeanPostProcessorå®ä¾‹å­˜åœ¨äºiocå®¹å™¨ï¼Œé‚£ä¹ˆå°†ä¼šæ‰§è¡Œå®¹å™¨ä¸­æ‰€æœ‰InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–¹æ³•è¿”å›falseï¼Œåˆ™ç›´æ¥ä¸­æ–­å¹¶è¿”å›ã€‚ä¾èµ–æ³¨å…¥ä¸å†è¿›è¡Œã€‚ï¼ˆå®ƒçš„ç”¨é€”æš‚æ—¶æœªçŸ¥ï¼Œå¦‚æœè¿™é‡Œè¿”å›falseå¯¼è‡´äº†ä¸€äº›é—®é¢˜ï¼Œé‚£ä¹ˆæ’æŸ¥èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ä»»ä½•æç¤ºä¿¡æ¯è¾“å‡ºï¼‰ é€šè¿‡è°ƒç”¨InstantiationAwareBeanPostProcessor.postProcessProperties()å®Œæˆå±æ€§çš„ä¾èµ–æ³¨å…¥ï¼ˆspring5.1ä¹‹å‰çš„ç‰ˆæœ¬è°ƒç”¨çš„postProcessPropertyValues()ï¼‰ã€‚ ç”±äºæ˜¯éå†å®¹å™¨ä¸­æ³¨å†Œçš„BeanPostProcessorï¼Œæ‰¾å‡ºæ˜¯InstantiationAwareBeanPostProcessorç±»å‹çš„ï¼Œè¿™é‡Œä¸åŒçš„æ³¨å…¥æ–¹å¼ä¼šæœ‰ä¸åŒçš„å®ç°ç±»ã€‚ä¸å‰æ–‡ä¸­è¯´æ˜çš„æœé›†ä¾èµ–æ³¨å…¥æœ‰å…³æ³¨è§£çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œå®ç°ç±»ä¹Ÿæ˜¯åŒä¸€ä¸ªã€‚éå†è¿‡ç¨‹ä¸­ä¼šä¸€ä¸ªä¸ªçš„è°ƒç”¨ã€‚ç”±äºè¿™äº›BeanPostProcessorä¸­åœ¨å‰é¢æµç¨‹ä¸­å·²ç»ç¼“å­˜äº†éœ€è¦ä¾èµ–æ³¨å…¥çš„å†…å®¹ã€‚è¿™é‡Œå°±å¯ä»¥æ ¹æ®ç¼“å­˜çš„å†…å®¹è¿›è¡Œè·å–ï¼Œä¾æ¬¡è®¾ç½®å€¼åˆ°å¯¹åº”å±æ€§ä¸­äº†ã€‚ è¿™é‡Œåˆ—ä¸¾å‡ ä¸ªå¸¸è§çš„æ³¨å…¥æµç¨‹ ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:8:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"7.1 AutowiredFieldElement å®ƒæ˜¯å¯¹@Autowiredæ ‡æ³¨åœ¨å­—æ®µä¸Šçš„æ³¨å…¥æ”¯æŒã€‚ åœ¨å‰æ–‡ä¸­postProcessMergedBeanDefinitionæµç¨‹èŠ‚ç‚¹ï¼Œæ·»åŠ @Autowiredæ³¨è§£æ”¯æŒçš„æ—¶å€™ï¼Œå°±æŠŠå¯¹åº”æ•°æ®æ”¾å…¥åˆ°äº†ç¼“å­˜ä¸­ï¼Œæˆå‘˜å˜é‡injectionMetadataCacheå°±æ˜¯å¯¹åº”çš„ç¼“å­˜ã€‚ é¦–å…ˆä¼šè°ƒç”¨findAutowiringMetadata()æ–¹æ³•ï¼Œè·å–å…ƒæ•°æ®ï¼Œè¿™é‡Œç›´æ¥ä»ç¼“å­˜injectionMetadataCacheä¸­æ‹¿çš„ã€‚ public class AutowiredAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware { // è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡ä¸­ï¼Œåœ¨å‰é¢æ‰§è¡ŒpostProcessMergedBeanDefinitionæ—¶ï¼Œå·²ç»ç¼“å­˜äº†éœ€è¦æ³¨å…¥çš„å…ƒæ•°æ®ã€‚ private final Map\u003cString, InjectionMetadata\u003e injectionMetadataCache = new ConcurrentHashMap\u003c\u003e(256); @Override public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) { // æ‰¾åˆ°Autowiringæ³¨è§£æ ‡æ³¨çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶å°è£…ä¸ºInjectionMetadataè¿”å›ã€‚ InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs); // TODO ä¾èµ–æ³¨å…¥çš„å…·ä½“é€»è¾‘ï¼Œé‡ç‚¹çœ‹ metadata.inject(bean, beanName, pvs); // çœç•¥æ— å…³ä»£ç ... return pvs; } } æ¥åˆ°inject()æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œéå†InjectionMetadataä¸­ç¼“å­˜çš„injectedElementsï¼Œç„¶åæ‰§è¡Œæ¯ä¸€ä¸ªInjectedElementçš„inject()æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯@Autowiredæ³¨å…¥çš„æ ¸å¿ƒé€»è¾‘ï¼š public class AutowiredAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware { public void inject(Object target, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable { Collection\u003cInjectedElement\u003e checkedElements = this.checkedElements; Collection\u003cInjectedElement\u003e elementsToIterate = (checkedElements != null ? checkedElements : this.injectedElements); if (!elementsToIterate.isEmpty()) { for (InjectedElement element : elementsToIterate) { // æ‰§è¡Œä¾èµ–æ³¨å…¥ element.inject(target, beanName, pvs); } } } } ä»å‰æ–‡ä¸­å·²ç»çŸ¥é“ï¼Œ@Autowiredçš„æ³¨è§£æœé›†ï¼ŒæŠŠå­—æ®µå’Œæ–¹æ³•åˆ†æˆäº†ä¸¤ç±»æ¥è¿›è¡Œå°è£…ï¼Œåˆ†åˆ«æ˜¯ï¼šAutowiredFieldElementã€AutowiredMethodElementã€‚ å…ˆæ¥åˆ°AutowiredFieldElementçš„inject()æ–¹æ³•ï¼š private class AutowiredFieldElement extends InjectionMetadata.InjectedElement { @Override protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable { // å­—æ®µçš„è‡ªåŠ¨æ³¨å…¥ Field field = (Field) this.member; Object value; if (this.cached) { value = resolvedCachedArgument(beanName, this.cachedFieldValue); } else { DependencyDescriptor desc = new DependencyDescriptor(field, this.required); desc.setContainingClass(bean.getClass()); Set\u003cString\u003e autowiredBeanNames = new LinkedHashSet\u003c\u003e(1); Assert.state(beanFactory != null, \"No BeanFactory available\"); TypeConverter typeConverter = beanFactory.getTypeConverter(); try { // å¤„ç†ä¾èµ–é¡¹ value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter); } catch (BeansException ex) { throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(field), ex); } // çœç•¥æ— å…³ä»£ç ... } // æ‰§è¡Œå­—æ®µèµ‹å€¼é€»è¾‘ã€‚ if (value != null) { ReflectionUtils.makeAccessible(field); field.set(bean, value); } } } è·å–ä¾èµ–å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨é“¾ï¼š |-\u003e resolveDependency |-|-\u003e doResolveDependency |-|-|-\u003e findAutowireCandidates |-|-|-|-\u003e addCandidateEntry |-|-|-|-|-\u003e descriptor.resolveCandidate |-|-|-|-|-|-\u003e beanFactory.getBean æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨åˆ°äº†getBean()æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯ç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†ï¼Œæœ€ç»ˆè°ƒç”¨getBean()æ–¹æ³•ï¼Œè·å–åˆ°ä¾èµ–çš„å¯¹è±¡å®ä¾‹ï¼Œè¿”å›ï¼Œèµ‹å€¼ã€‚ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œæœ€åä½¿ç”¨åå°„field.set()è¿›è¡Œå­—æ®µèµ‹å€¼ã€‚ ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:8:1","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"7.2 AutowiredMethodElement å®ƒæ˜¯å¯¹@Autowiredæ ‡æ³¨åœ¨æ–¹æ³•ä¸Šçš„æ³¨å…¥æ”¯æŒã€‚ é€šè¿‡æ–¹æ³•@Autowiredæ³¨å…¥çš„æµç¨‹æ˜¯ï¼šå…ˆè·å–å‚æ•°åˆ—è¡¨ä¸­ä¾èµ–çš„å®ä¾‹å¯¹è±¡ï¼Œæœ€ç»ˆä¸€å®šæ˜¯ä¼šè°ƒç”¨åˆ°getBean()æ–¹æ³•ã€‚ç„¶åé€šè¿‡åå°„è°ƒç”¨å¯¹åº”æ–¹æ³•ã€‚ æ¥åˆ°AutowiredMethodElement.inject()æ–¹æ³• private class AutowiredMethodElement extends InjectionMetadata.InjectedElement { @Override protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable { if (checkPropertySkipping(pvs)) { return; } Method method = (Method) this.member; Object[] arguments; if (this.cached) { // Shortcut for avoiding synchronization... arguments = resolveCachedArguments(beanName); } else { Class\u003c?\u003e[] paramTypes = method.getParameterTypes(); arguments = new Object[paramTypes.length]; DependencyDescriptor[] descriptors = new DependencyDescriptor[paramTypes.length]; Set\u003cString\u003e autowiredBeans = new LinkedHashSet\u003c\u003e(paramTypes.length); Assert.state(beanFactory != null, \"No BeanFactory available\"); TypeConverter typeConverter = beanFactory.getTypeConverter(); for (int i = 0; i \u003c arguments.length; i++) { MethodParameter methodParam = new MethodParameter(method, i); DependencyDescriptor currDesc = new DependencyDescriptor(methodParam, this.required); currDesc.setContainingClass(bean.getClass()); descriptors[i] = currDesc; try { // è·å–å‚æ•°ä¸­ä¾èµ–çš„å¯¹è±¡ Object arg = beanFactory.resolveDependency(currDesc, beanName, autowiredBeans, typeConverter); if (arg == null \u0026\u0026 !this.required) { arguments = null; break; } arguments[i] = arg; } catch (BeansException ex) { throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(methodParam), ex); } } // çœç•¥æ— å…³ä»£ç ... } if (arguments != null) { try { // åå°„è°ƒç”¨ ReflectionUtils.makeAccessible(method); method.invoke(bean, arguments); } catch (InvocationTargetException ex) { throw ex.getTargetException(); } } } } è·å–ä¾èµ–å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨é“¾ï¼š |-\u003e resolveDependency |-|-\u003e doResolveDependency |-|-|-\u003e findAutowireCandidates |-|-|-|-\u003e addCandidateEntry |-|-|-|-|-\u003e descriptor.resolveCandidate |-|-|-|-|-|-\u003e beanFactory.getBean ä»”ç»†çœ‹ä¸€ä¸‹ï¼Œå…¶å®è·å–ä¾èµ–å¯¹è±¡æœ¬èº«ï¼Œæ˜¯å’Œä½¿ç”¨å­—æ®µæ³¨å…¥çš„è·å–æ–¹å¼ä¸€æ ·çš„ï¼Œè°ƒç”¨çš„æ–¹æ³•æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚ä¸åŒä¹‹å¤„åœ¨äºå¤–å›´æ–¹æ³•ï¼Œå­—æ®µæ³¨å…¥æ—¶åªè·å–ä¸€ä¸ªå®ä¾‹ï¼Œæ–¹æ³•åˆ™å¯èƒ½æ˜¯å¤šä¸ªå®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥æ–¹æ³•è·å–ä¾èµ–å±æ€§æ—¶ï¼Œä»¥éå†çš„æ–¹å¼å»æ‰§è¡Œä»¥ä¸Šæµç¨‹çš„ã€‚ ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:8:2","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"7.3 ResourceElement å®ƒæ˜¯å¯¹@Resourceæ³¨è§£æ ‡æ³¨åœ¨å­—æ®µ/æ–¹æ³•ä¸Šçš„æ³¨å…¥æ”¯æŒã€‚ ä¸ä¸Šé¢æµç¨‹ä¸€æ ·ï¼Œæ¥åˆ°inject()æ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨åˆ°äº†çˆ¶ç±»InjectedElementçš„inject()æ–¹æ³•ï¼š public abstract static class InjectedElement { protected void inject(Object target, @Nullable String requestingBeanName, @Nullable PropertyValues pvs) throws Throwable { if (this.isField) { Field field = (Field) this.member; ReflectionUtils.makeAccessible(field); // å­—æ®µèµ‹å€¼ å…³é”®ç‚¹çœ‹getResourceToInject field.set(target, getResourceToInject(target, requestingBeanName)); } else { if (checkPropertySkipping(pvs)) { return; } try { Method method = (Method) this.member; ReflectionUtils.makeAccessible(method); // æ–¹æ³•èµ‹å€¼ å…³é”®ç‚¹çœ‹getResourceToInject method.invoke(target, getResourceToInject(target, requestingBeanName)); } catch (InvocationTargetException ex) { throw ex.getTargetException(); } } } @Override protected Object getResourceToInject(Object target, @Nullable String requestingBeanName) { return (this.lazyLookup ? buildLazyResourceProxy(this, requestingBeanName) : getResource(this, requestingBeanName)); } } è·å–ä¾èµ–å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨é“¾ï¼š |-\u003e getResourceToInject |-|-\u003e getResource |-|-|-\u003e autowireResource |-|-|-|-\u003e factory.getBean ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:8:3","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"8 AOPã€äº‹åŠ¡æ”¯æŒï¼ŒinitializeBean å¤–å›´æ–¹æ³•èŠ‚ç‚¹ï¼š postProcessBeforeInitialization() beanå®ä¾‹åŒ–ä¹‹åï¼Œåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹å‰è°ƒç”¨ã€‚ invokeInitMethods() beançš„åˆå§‹åŒ–æ–¹æ³•ï¼Œ@PostContructoræ³¨è§£çš„æ–¹æ³•ã€æˆ–è€…é…ç½®æ–‡ä»¶é…ç½®çš„ã€‚ postProcessAfterInitialization() beanå®ä¾‹åŒ–ä¹‹åï¼Œåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹åè°ƒç”¨ï¼Œä¹Ÿæ˜¯AOPçš„å…¥å£ã€‚äº‹åŠ¡çš„å…¥å£ä¸åœ¨è¿™ï¼Œä½†è·Ÿå®ƒæœ‰å…³ï¼Œäº‹åŠ¡çš„Advisorå¯¹è±¡æ˜¯åœ¨è¿™é‡Œå¡«å……åˆ°AOPçš„æ‰§è¡Œé“¾çš„ã€‚ æºç å¦‚ä¸‹ï¼š public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory { protected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) { if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction\u003cObject\u003e) () -\u003e { invokeAwareMethods(beanName, bean); return null; }, getAccessControlContext()); } else { invokeAwareMethods(beanName, bean); } Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) { // BeanPostProcessor.postProcessBeforeInitialization() // é¡¾åæ€ä¹‰ï¼Œåœ¨beanå®ä¾‹åˆ›å»ºå®Œæˆå¹¶ä¾èµ–æ³¨å…¥åï¼Œåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œä¼šæ‰§è¡Œæ­¤æ–¹æ³•ã€‚ // AOPçš„BeanPostProcessorä¹Ÿå®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œåªæ˜¯ç›´æ¥è¿”å›äº†åŸå§‹å¯¹è±¡ã€‚çœŸæ­£å…¥å£åœ¨åç½®å¤„ç†ã€‚ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); } try { // æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ï¼ŒInitializingBeanå®ä¾‹çš„afterPropertiesSetï¼Œæˆ–è€…init-methodæˆ–è€…@PostConstructoræ ‡æ³¨çš„æ–¹æ³• invokeInitMethods(beanName, wrappedBean, mbd); } catch (Throwable ex) { throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, \"Invocation of init method failed\", ex); } if (mbd == null || !mbd.isSynthetic()) { // BeanPostProcessor.postProcessAfterInitialization() // é¡¾åæ€ä¹‰ï¼Œåœ¨beanå®ä¾‹åˆ›å»ºå®Œæˆå¹¶ä¾èµ–æ³¨å…¥åï¼Œåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹åï¼Œä¼šæ‰§è¡Œæ­¤æ–¹æ³•ã€‚ // AOPçš„å…¥å£ï¼Œé€šè¿‡AspectJAwareAdvisorAutoProxyCreatorç”Ÿæˆä»£ç†å¯¹è±¡ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); } return wrappedBean; } } æ³¨æ„\r\rç”±äºç¯‡å¹…åŸå› ï¼Œè¿™é‡ŒåªåšinitializeBean()æ–¹æ³•çš„æ‰§è¡Œæµç¨‹æè¿°ã€‚å…³äºSpringAopæ‰§è¡Œé“¾çš„å°è£…å’ŒåŠ¨æ€ä»£ç†ç”Ÿæˆä»¥åŠæ‰§è¡ŒåŸç†ï¼Œäº‹åŠ¡çš„æ”¯æŒã€äº‹åŠ¡çš„ä¸ƒç§ä¼ æ’­å±æ€§å®ç°åŸç†åŠå…¶è¡¨ç°å½¢å¼ã€‚åœ¨åˆ«çš„æ–‡ç« ä¸­åˆ†æã€‚\r\r ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:9:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":["spring"],"content":"9 ä¸´ç»ˆæ–¹æ³•æ³¨å†Œï¼ŒregisterDisposableBeanIfNecessary beanFactoryä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡disposableBeansï¼Œè¿™æ˜¯ä¸€ä¸ªmapé›†åˆï¼Œé‡Œé¢å°±å°è£…äº†beané”€æ¯å‰éœ€è¦è°ƒç”¨çš„å¯¹è±¡æ˜ å°„ã€‚é”®æ—¶beanNameï¼Œå€¼æ˜¯DisposableBeanAdapter DisposableBeanAdapterä¸­å°è£…äº†destroyMethodä»¥åŠListï¼Œæ²¡é”™ï¼Œæ˜¯ä¸€ä¸ªliståˆ—è¡¨ã€‚å› ä¸ºå¯ä»¥è®¾ç½®å¤šä¸ªé”€æ¯æ–¹æ³•ï¼Œä¸”è®¾ç½®çš„æ–¹å¼ä¹Ÿæ˜¯æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥å®ç°DisposableBeanï¼Œæˆ–è€…æ³¨è§£æ–¹å¼ï¼Œæˆ–è€…åç§°ä¸ºcloseçš„æ— å‚æ•°å…¬å…±æ–¹æ³• bançš„é”€æ¯å‰è°ƒç”¨æ–¹æ³•çš„æ³¨å†Œï¼Œç›¸å¯¹ç®€å•ï¼Œè¿™é‡Œè´´ä¸¤æ®µä»£ç ï¼š public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory { protected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) { AccessControlContext acc = (System.getSecurityManager() != null ? getAccessControlContext() : null); // BeanDefinitionéå¤šä¾‹ï¼Œå¹¶ä¸”éœ€è¦é”€æ¯ã€‚ if (!mbd.isPrototype() \u0026\u0026 requiresDestruction(bean, mbd)) { if (mbd.isSingleton()) { // Register a DisposableBean implementation that performs all destruction // work for the given bean: DestructionAwareBeanPostProcessors, // DisposableBean interface, custom destroy method. // æ³¨å†Œbeançš„é”€æ¯å‰è°ƒç”¨çš„æ–¹æ³• registerDisposableBean(beanName, new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc)); } else { // A bean with a custom scope... Scope scope = this.scopes.get(mbd.getScope()); if (scope == null) { throw new IllegalStateException(\"No Scope registered for scope name '\" + mbd.getScope() + \"'\"); } scope.registerDestructionCallback(beanName, new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc)); } } } } public class DefaultSingletonBeanRegistry extends SimpleAliasRegistry implements SingletonBeanRegistry { public void registerDisposableBean(String beanName, DisposableBean bean) { synchronized (this.disposableBeans) { this.disposableBeans.put(beanName, bean); } } } ","date":"2020-11-26","objectID":"/posts/spring/05-spring-ioc-init/:10:0","tags":["springæºç "],"title":"05 Beanå®ä¾‹åŒ–æ•´ä½“æµç¨‹","uri":"/posts/spring/05-spring-ioc-init/"},{"categories":null,"content":"ç•™è¨€æ¿ï¼Œç•™è¨€ç»™æˆ‘","date":"2020-11-25","objectID":"/message-board/","tags":null,"title":"ç•™è¨€æ¿","uri":"/message-board/"},{"categories":null,"content":"aaaccdd ç•™è¨€ç»™æˆ‘â†“","date":"2020-11-25","objectID":"/message-board/:0:0","tags":null,"title":"ç•™è¨€æ¿","uri":"/message-board/"},{"categories":["spring"],"content":"springå®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œåœ¨åˆ›å»ºBeanFactoryã€æœé›†BeanDefinitionã€å®ä¾‹åŒ–å¹¶è°ƒç”¨BeanFactoryPostProcessorä¹‹åï¼Œä¼šå¯¹BeanPostProcessorè¿›è¡Œæ³¨å†Œã€‚","date":"2020-11-24","objectID":"/posts/spring/04-registry-of-bean-post-processor/","tags":["springæºç "],"title":"04 BeanPostProcessorçš„æ³¨å†Œ","uri":"/posts/spring/04-registry-of-bean-post-processor/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-24","objectID":"/posts/spring/04-registry-of-bean-post-processor/:1:0","tags":["springæºç "],"title":"04 BeanPostProcessorçš„æ³¨å†Œ","uri":"/posts/spring/04-registry-of-bean-post-processor/"},{"categories":["spring"],"content":"1 BeanPostProcessorçš„ä½œç”¨ BeanPostProcessoræ˜¯å¯¹SpringIOCå®¹å™¨ä¸­beanå®ä¾‹åŒ–çš„ä¸€äº›æ‰©å±•ï¼Œåœ¨beanå®ä¾‹åŒ–çš„å…³é”®èŠ‚ç‚¹è¿›è¡Œäº†ä¸€äº›æ’æ¡©ã€‚ çœŸæ­£å®ä¾‹åŒ–beançš„æ–¹æ³•æ˜¯beanFactory.getBean()æ–¹æ³•ã€‚è€Œåœ¨beanå®ä¾‹åŒ–ä¹‹å‰ã€å®ä¾‹åŒ–ä¹‹åã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹å‰ã€åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œä¹‹åç­‰èŠ‚ç‚¹è¿›è¡Œä¸€äº›é’©å­å›è°ƒã€‚BeanPostProcessorçš„ä½œç”¨å°±ä½“ç°äºæ­¤ã€‚ BeanPostProcessoræ¥å£åªæä¾›åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œå‰ã€åçš„èŠ‚ç‚¹æ“ä½œã€‚å…¶ä½™æ“ä½œåœ¨å®ƒçš„å­æ¥å£ä¸­å®šä¹‰ã€‚ ","date":"2020-11-24","objectID":"/posts/spring/04-registry-of-bean-post-processor/:2:0","tags":["springæºç "],"title":"04 BeanPostProcessorçš„æ³¨å†Œ","uri":"/posts/spring/04-registry-of-bean-post-processor/"},{"categories":["spring"],"content":"2 BeanPostProcessorçš„ä½“ç³»ç»“æ„ BeanPostProcessoråŠå…¶å…³é”®å­æ¥å£çš„æ–¹æ³•å®šä¹‰-UMLå›¾\"\rBeanPostProcessoråŠå…¶å…³é”®å­æ¥å£çš„æ–¹æ³•å®šä¹‰-UMLå›¾\r ä¸Šå›¾è¯¦ç»†æ³¨é‡Šäº†BeanPostProcessoråŠå…¶å­æ¥å£æ¯ä¸ªæ–¹æ³•çš„ä½œç”¨èŠ‚ç‚¹ï¼Œä»BeanPostProcessoræ¥å£ç»§æ‰¿ä½“ç³»å¯ä»¥çœ‹å‡ºï¼ŒBeanPostProcessorè´¯ç©¿æ•´ä¸ªSpringå®¹å™¨ä¸­Beançš„å®ä¾‹åŒ–æµç¨‹ã€‚å¯ä»¥è¯´ï¼Œåœ¨Springå®¹å™¨ä¸­ï¼Œä»»ä½•ä¸€ä¸ªBeançš„å®ä¾‹åŒ–ï¼Œåœ¨å…¶å…³é”®èŠ‚ç‚¹ï¼Œéƒ½æœ‰BeanPostProcessorçš„å­˜åœ¨ã€‚ç”šè‡³å¯ä»¥è¯´å®ƒæ˜¯SpringIOCå®¹å™¨ç»„æˆéƒ¨åˆ†ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç±»ã€‚ ","date":"2020-11-24","objectID":"/posts/spring/04-registry-of-bean-post-processor/:3:0","tags":["springæºç "],"title":"04 BeanPostProcessorçš„æ³¨å†Œ","uri":"/posts/spring/04-registry-of-bean-post-processor/"},{"categories":["spring"],"content":"3 BeanPostProcessorçš„æ³¨å†Œæµç¨‹ ä»¥ä¸‹æ˜¯springä¸­BeanPostProcessorçš„æºç ï¼š final class PostProcessorRegistrationDelegate { public static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) { // ä»beanDefinitionNamesä¸­è·å–æ‰€æœ‰BeanPostProcessorç±»å‹çš„beanNameã€‚ String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false); // è¿™é‡Œä¹‹æ‰€ä»¥è¦+1ï¼Œå› ä¸ºåœ¨è¿™ä¸ªæ–¹æ³•çš„ç»“å°¾å¤„ï¼Œå•ç‹¬æ³¨å†Œäº†ä¸€ä¸ªBeanPostProcessorï¼šApplicationListenerDetector // Register BeanPostProcessorChecker that logs an info message when // a bean is created during BeanPostProcessor instantiation, i.e. when // a bean is not eligible for getting processed by all BeanPostProcessors. int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length; beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount)); // Separate between BeanPostProcessors that implement PriorityOrdered, // Ordered, and the rest. // å®ç°äº†PriorityOrderedæ¥å£çš„ã€‚ List\u003cBeanPostProcessor\u003e priorityOrderedPostProcessors = new ArrayList\u003c\u003e(); // MergedBeanDefinitionPostProcessorç±»å‹çš„ã€‚ List\u003cBeanPostProcessor\u003e internalPostProcessors = new ArrayList\u003c\u003e(); // å®ç°äº†Orderedæ¥å£çš„ã€‚ List\u003cString\u003e orderedPostProcessorNames = new ArrayList\u003c\u003e(); // æ²¡æœ‰å®ç°æ’åºæ¥å£çš„ã€‚ List\u003cString\u003e nonOrderedPostProcessorNames = new ArrayList\u003c\u003e(); // å¯¹ä»¥ä¸Šå››ç§æƒ…å†µè¿›è¡Œåˆ†åˆ«å¤„ç†ã€‚ for (String ppName : postProcessorNames) { if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) { BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) { internalPostProcessors.add(pp); } } else if (beanFactory.isTypeMatch(ppName, Ordered.class)) { orderedPostProcessorNames.add(ppName); } else { nonOrderedPostProcessorNames.add(ppName); } } // æ³¨å†ŒBeanPostProcessors // First, register the BeanPostProcessors that implement PriorityOrdered. sortPostProcessors(priorityOrderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors); // æ³¨å†Œå®ç°äº†Orderedæ¥å£çš„BeanPostProcessorã€‚ // Next, register the BeanPostProcessors that implement Ordered. List\u003cBeanPostProcessor\u003e orderedPostProcessors = new ArrayList\u003c\u003e(); for (String ppName : orderedPostProcessorNames) { BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); orderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) { internalPostProcessors.add(pp); } } sortPostProcessors(orderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, orderedPostProcessors); // æ³¨å†Œæ²¡æœ‰å®ç°æ¥å£çš„BeanPostProcessor // Now, register all regular BeanPostProcessors. List\u003cBeanPostProcessor\u003e nonOrderedPostProcessors = new ArrayList\u003c\u003e(); for (String ppName : nonOrderedPostProcessorNames) { BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); nonOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) { internalPostProcessors.add(pp); } } registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors); // Finally, re-register all internal BeanPostProcessors. sortPostProcessors(internalPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, internalPostProcessors); // Re-register post-processor for detecting inner beans as ApplicationListeners, // moving it to the end of the processor chain (for picking up proxies etc). beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext)); } } ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒBeanPostProcessorçš„æ³¨å†Œæµç¨‹å’ŒBeanFactoryPostProcessorçš„æ³¨å†Œæµç¨‹ç±»ä¼¼ã€‚è·å–åˆ°BeanFactoryä¸­å­˜å‚¨çš„BeanPostProcessorç±»å‹çš„beanNameï¼Œç„¶åå¯¹å®ç°äº†ä¸åŒæ’åºæ¥å£çš„ç±»ã€åŠæ²¡æœ‰å®ç°æ’åºæ¥å£çš„ç±»åˆ†åˆ«è¿›è¡ŒgetBean()æ“ä½œã€æ’åºå’Œæ³¨å†Œã€‚ springä¼šåœ¨ä¸åŒçš„æµç¨‹èŠ‚ç‚¹æ‰§è¡ŒBeanPostProcessoråŠå…¶å­æ¥å£å¯¹åº”çš„æ–¹æ³•ã€‚å…·ä½“çš„å®ç°ç±»åœ¨åé¢çš„springå®¹å™¨beançš„å®ä¾‹åŒ–ç›¸å…³æ–‡ç« æè¿°ã€‚ ","date":"2020-11-24","objectID":"/posts/spring/04-registry-of-bean-post-processor/:4:0","tags":["springæºç "],"title":"04 BeanPostProcessorçš„æ³¨å†Œ","uri":"/posts/spring/04-registry-of-bean-post-processor/"},{"categories":["spring"],"content":"spring iocå®¹å™¨åˆå§‹åŒ–æ—¶ï¼Œé¦–å…ˆåˆ›å»ºBeanFactoryå¯¹è±¡ï¼Œæœé›†BeanDefinitionï¼Œåœ¨å®Œæˆä¹‹åï¼Œä¼šä¼˜å…ˆå…ˆå®ä¾‹åŒ–BeanDefinitionRegistryPostProcessorå’ŒBeanFactoryPostProcessorï¼Œå¹¶è°ƒç”¨postProcessBeanDefinitionRegistry()ã€postProcessBeanFactory()æ–¹æ³•","date":"2020-11-24","objectID":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/","tags":["springæºç "],"title":"03 BeanFactoryPostProcessorçš„æ³¨å†Œä¸æ‰§è¡Œ","uri":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ","date":"2020-11-24","objectID":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/:1:0","tags":["springæºç "],"title":"03 BeanFactoryPostProcessorçš„æ³¨å†Œä¸æ‰§è¡Œ","uri":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/"},{"categories":["spring"],"content":"1 BeanFactoryPostProcessor BeanFactoryPostProcessorä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•postProcessBeanFactoryï¼Œå®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ï¼Œä¼šä¼˜å…ˆäºå…¶ä»–å¸¸è§„çš„ç±»å®ä¾‹åŒ–ï¼Œå¹¶è°ƒç”¨postProcessBeanFactoryæ–¹æ³•ã€‚ @FunctionalInterface public interface BeanFactoryPostProcessor { void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException; } ","date":"2020-11-24","objectID":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/:2:0","tags":["springæºç "],"title":"03 BeanFactoryPostProcessorçš„æ³¨å†Œä¸æ‰§è¡Œ","uri":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/"},{"categories":["spring"],"content":"2 BeanDefinitionRegistryPostProcessor BeanDefinitionRegistryPostProcessoræ˜¯BeanFactoryPostProcessorçš„å­æ¥å£ï¼ŒåŒæ ·çš„ï¼Œå®ƒä¼šä¼˜å…ˆä¸å…¶ä»–å¸¸è§„çš„ç±»ï¼Œæå‰å®ä¾‹åŒ–ã€åŠ å…¥åˆ°IOCå®¹å™¨ï¼Œå¹¶ä¼šè°ƒç”¨postProcessBeanDefinitionRegistry()æ–¹æ³•ï¼Œå†è°ƒç”¨postProcessBeanFactory()æ–¹æ³•ã€‚ public interface BeanDefinitionRegistryPostProcessor extends BeanFactoryPostProcessor { void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException; } ","date":"2020-11-24","objectID":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/:3:0","tags":["springæºç "],"title":"03 BeanFactoryPostProcessorçš„æ³¨å†Œä¸æ‰§è¡Œ","uri":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/"},{"categories":["spring"],"content":"3 è°ƒç”¨é€»è¾‘ é¦–å…ˆæœé›†ä»BeanFactoryä¸­åå»æ‰€æœ‰BeanDefinitionRegistryPostProcessorç±»å‹çš„beanNameã€‚ ç­›é€‰å‡ºå®ç°äº†PriorityOrderedæ¥å£çš„ï¼ˆç­›é€‰è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨getBean()æ–¹æ³•ï¼‰ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ’åºï¼Œç„¶åè¿›è¡Œéå†è°ƒç”¨postProcessBeanDefinitionRegistry()ã€‚ ç­›é€‰å‡ºå®ç°äº†Orderedæ¥å£çš„ï¼ŒåŒä¸Šï¼Œè¿›è¡ŒgetBean()ï¼Œå¹¶æ’åºï¼Œç„¶åè¿›è¡Œéå†è°ƒç”¨postProcessBeanDefinitionRegistry()ã€‚ å¯¹æ²¡æœ‰å®ç°PriorityOrderedæ¥å£ä¸”æ²¡æœ‰å®ç°Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorè¿›è¡Œæ’åºã€è°ƒç”¨postProcessBeanDefinitionRegistry()ã€‚ ä¸Šé¢çš„æ¯ä¸€æ­¥è°ƒç”¨postProcessBeanDefinitionRegistry()ä¹‹å‰ï¼Œä¼šå°†å…¶å®åŠ›ç¼“å­˜åˆ°ä¸€ä¸ªåä¸ºregistryProcessorsçš„Listé›†åˆä¸­ï¼Œåœ¨ä»¥ä¸Šæ­¥éª¤æ‰§è¡Œå®Œï¼Œä¼šè°ƒç”¨BeanDefinitionRegistryPostProcessor.postProcessBeanFactory()æ–¹æ³• å¯¹æ²¡æœ‰å®ç°BeanDefinitionRegistryPostProcessorä½†å®ç°äº†BeanFactoryPostProcessorçš„ç±»è¿›è¡Œæœé›†ã€‚ åˆ†åˆ«ç­›é€‰å‡ºå®ç°äº†PriorityOrderedæ¥å£ã€Orderedæ¥å£ã€æ²¡æœ‰å®ç°æ¥å£çš„ç±»ï¼Œå¯¹å…¶è¿›è¡Œæ’åºã€getBean()æ“ä½œï¼Œè°ƒç”¨postProcessBeanFactory()æ–¹æ³•ã€‚ ä»æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°æ‰§è¡Œæµç¨‹ã€‚æºç é€»è¾‘å¦‚ä¸‹ï¼š final class PostProcessorRegistrationDelegate { public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List\u003cBeanFactoryPostProcessor\u003e beanFactoryPostProcessors) { // è¿™é‡Œå­˜å‚¨äº†å·²ç»è°ƒç”¨è¿‡çš„BeanFactoryPostProcessorã€‚ // BeanDefinitionRegistryPostProcessoræ˜¯BeanFactoryPostProcessorçš„å­æ¥å£ã€‚ // å…ˆè°ƒç”¨BeanDefinitionRegistryPostProcessorçš„æ–¹æ³•ï¼Œç„¶åæ˜¯BeanFactoryPostProcessor // Invoke BeanDefinitionRegistryPostProcessors first, if any. Set\u003cString\u003e processedBeans = new HashSet\u003c\u003e(); if (beanFactory instanceof BeanDefinitionRegistry) { BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; // è¿™é‡Œé¢è£…çš„æ˜¯å®ç°äº†BeanFactoryPostProcessoræ¥å£çš„ã€‚ List\u003cBeanFactoryPostProcessor\u003e regularPostProcessors = new ArrayList\u003c\u003e(); // è¿™é‡Œé¢è£…çš„æ˜¯å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£çš„ã€‚ List\u003cBeanDefinitionRegistryPostProcessor\u003e registryProcessors = new ArrayList\u003c\u003e(); // å¯¹å‚æ•°ä¸­ä¼ å…¥çš„beanFactoryPostProcessorsä¼˜å…ˆæ‰§è¡ŒBeanDefinitionRegistryPostProcessorçš„æ–¹æ³•ï¼Œç„¶åæ·»åŠ åˆ°registryProcessorsä¸­ã€‚ for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) { if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) { BeanDefinitionRegistryPostProcessor registryProcessor = (BeanDefinitionRegistryPostProcessor) postProcessor; registryProcessor.postProcessBeanDefinitionRegistry(registry); registryProcessors.add(registryProcessor); } else { regularPostProcessors.add(postProcessor); } } // è®°å½•å½“å‰æ³¨å†Œçš„BeanDefinitionRegistryPostProcessor // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the bean factory post-processors apply to them! // Separate between BeanDefinitionRegistryPostProcessors that implement // PriorityOrdered, Ordered, and the rest. List\u003cBeanDefinitionRegistryPostProcessor\u003e currentRegistryProcessors = new ArrayList\u003c\u003e(); // ä»beanFactoryä¸­çš„beanDefinitionNamesä¸­è·å–æ‰€æœ‰çš„beanNameã€‚å°†å®ç°äº†PriorityOrderedæ¥å£éƒ¨åˆ†ï¼Œæ”¾åˆ°å¤„ç†è¿‡çš„beanå®¹å™¨ä¸­ã€‚ // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered. String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) { if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) { // è¿™é‡Œè¿›è¡Œäº†getBeanæ“ä½œã€‚ç±»çš„å®ä¾‹åŒ–å°±æ˜¯é€šè¿‡æ­¤æ–¹æ³•è¿›è¡Œã€‚ currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); } } // å¯¹ä¸Šé¢æœé›†åˆ°çš„BeanDefinitionRegistryPostProcessorè¿›è¡Œæ’åºã€æ‰§è¡ŒBeanDefinitionRegistryPostProcessorçš„æ–¹æ³• sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); currentRegistryProcessors.clear(); // æœé›†å®ç°äº†Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorï¼Œæ‰§è¡ŒåŒä¸Šçš„é€»è¾‘ã€‚ // Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered. postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) { if (!processedBeans.contains(ppName) \u0026\u0026 beanFactory.isTypeMatch(ppName, Ordered.class)) { currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); } }// æ’åºã€æ‰§è¡ŒpostProcessBeanDefinitionRegistry()æ–¹æ³• sortPostProcessors(current","date":"2020-11-24","objectID":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/:4:0","tags":["springæºç "],"title":"03 BeanFactoryPostProcessorçš„æ³¨å†Œä¸æ‰§è¡Œ","uri":"/posts/spring/03-bean-factory-post-processor-registry-and-execute/"},{"categories":["spring"],"content":"è®°å½•springæ ‡ç­¾è§£æä¸­ï¼Œå¯¹æ ‡ç­¾å±æ€§è§£æçš„å‡ ä¸ªå…¸å‹BeanDefinitionParserå®ç°ã€‚","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ æœ¬æ–‡æ˜¯å¯¹ Springç¨‹åºå…¥å£å’ŒXMLè§£æ çš„çŸ¥è¯†ç‚¹æ‰©å±•ï¼Œè¯¦ç»†è§£æå…¶ä¸­æåˆ°çš„BeanDefinitionParserçš„ä½œç”¨ï¼Œä»¥åŠä¸€äº›å…¸å‹çš„XMLæ–¹å¼è§£æçš„å®ç°ç±»ã€‚ ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:1:0","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"1 BeanDefinitionParseræ¥å£çš„å®šä¹‰ public interface BeanDefinitionParser { @Nullable BeanDefinition parse(Element element, ParserContext parserContext); } å¯ä»¥çœ‹åˆ°ï¼ŒBeanDefinitionParseråªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œè´Ÿè´£BeanDefinitaionçš„è§£æã€‚å‚æ•°æœ‰èŠ‚ç‚¹å…ƒç´ ã€è§£æä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ åœ¨Springä¸­æœ‰å¾ˆå¤šå†…ç½®çš„BeanDefinitionParserå®ç°ç±»ï¼ˆä¹‹æ‰€ä»¥è¯´å†…ç½®ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯å¯ä»¥æ‰©å±•çš„ï¼‰ï¼ŒåŒ…æ‹¬XMLæ–¹å¼è§£æã€æ³¨è§£æ–¹å¼è§£æç­‰ã€‚ æ³¨æ„\r\rParserContextä¸­å°è£…äº†BeanDefinitionRegistryå¯¹è±¡ï¼Œç”¨äºBeanDefinitionçš„æ³¨å†Œã€‚\r\r å…³äºæ­¤ç±»çš„å®ä¾‹ä»å“ªé‡Œæ³¨å†Œã€parseæ–¹æ³•ä»å“ªé‡Œè°ƒå…¥è¿›æ¥çš„ï¼Œ Springç¨‹åºå…¥å£å’ŒXMLè§£æ ä¸­æœ‰ç»“å°¾å¤„æœ‰è¯¦ç»†è¯´æ˜ã€‚ ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:2:0","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"2 ComponentScanBeanDefinitionParserå®ç°æµç¨‹è§£æ ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:3:0","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"2.1 ComponentScanBeanDefinitionParserä¸­çš„å±æ€§ ComponentScanBeanDefinitionParseræ˜¯BeanDefinitionParserçš„ä¸€ä¸ªå®ç°ï¼Œç”¨äºè§£æ\u003ccontext:component-scan/\u003eæ ‡ç­¾çš„å±æ€§ã€‚ è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€äº›å¸¸é‡ï¼Œè¿™äº›å¸¸é‡æ˜¯\u003ccontext:component-scan/\u003eä¸­æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„å±æ€§ã€‚æ¯”å¦‚æœ€å¸¸ç”¨åˆ°çš„base-packageå±æ€§ã€‚ å‰é¢æœ‰æåˆ°ï¼Œparseæ–¹æ³•çš„å‚æ•°ä¸­æœ‰Elementã€‚åœ¨è§£æElementæ—¶ï¼Œä¼šå¯¹Elementçš„å¤šä¸ªå±æ€§è¿›è¡Œè¯†åˆ«åŠå¤„ç†ã€‚è¿™äº›å¸¸é‡çš„ä½œç”¨å°±åœ¨äºæ­¤ï¼Œç”¨æ¥åŒºåˆ†Elementçš„ä¸åŒå±æ€§ï¼Œå¹¶åšç‰¹å®šçš„å¤„ç†ã€‚ ä»¥ä¸‹æ˜¯ComponentScanBeanDefinitionParserä¸­å®šä¹‰çš„å¸¸é‡ï¼š public class ComponentScanBeanDefinitionParser implements BeanDefinitionParser { private static final String BASE_PACKAGE_ATTRIBUTE = \"base-package\"; private static final String RESOURCE_PATTERN_ATTRIBUTE = \"resource-pattern\"; private static final String USE_DEFAULT_FILTERS_ATTRIBUTE = \"use-default-filters\"; private static final String ANNOTATION_CONFIG_ATTRIBUTE = \"annotation-config\"; private static final String NAME_GENERATOR_ATTRIBUTE = \"name-generator\"; private static final String SCOPE_RESOLVER_ATTRIBUTE = \"scope-resolver\"; private static final String SCOPED_PROXY_ATTRIBUTE = \"scoped-proxy\"; private static final String EXCLUDE_FILTER_ELEMENT = \"exclude-filter\"; private static final String INCLUDE_FILTER_ELEMENT = \"include-filter\"; private static final String FILTER_TYPE_ATTRIBUTE = \"type\"; private static final String FILTER_EXPRESSION_ATTRIBUTE = \"expression\"; } ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:3:1","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"2.2 ä¸»æµç¨‹æ–¹æ³•parse() æ­¥éª¤ï¼š è·å–åˆ°æ ‡ç­¾ä¸­base-packageå±æ€§çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯å¿…é¡»çš„ã€‚ï¼ˆå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸ä¿¡æ¯At least one base package must be specifiedï¼‰ã€‚ åˆ›å»ºæ‰«æå™¨ï¼šClassPathBeanDefinitionScannerï¼ˆmybatisä¸­çš„æ‰«æå™¨å°±æ˜¯ç»§æ‰¿äº†å®ƒï¼‰ è°ƒç”¨æ ¸å¿ƒæ–¹æ³•doScanï¼ˆè¿™é‡Œè§£æå¹¶æ³¨å†Œäº†BeanDefinitionï¼‰ æ³¨å†Œç»„ä»¶registerComponentsï¼ˆClassPathBeanDefinitionScannerä¸­ï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå¯ä»¥ä¸çœ‹ï¼ŒBeanDefinitionçš„æ³¨å†Œåœ¨doScanä¸­åšäº†ï¼‰ public class ComponentScanBeanDefinitionParser implements BeanDefinitionParser { public BeanDefinition parse(Element element, ParserContext parserContext) { // è·å–base-packageå±æ€§ String basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE); basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage); String[] basePackages = StringUtils.tokenizeToStringArray(basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS); // Actually scan for bean definitions and register them. ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element); // TODO é‡ç‚¹ï¼šè¿™é‡Œæ‰§è¡Œäº†å…·ä½“çš„è§£æé€»è¾‘ã€‚ Set\u003cBeanDefinitionHolder\u003e beanDefinitions = scanner.doScan(basePackages); registerComponents(parserContext.getReaderContext(), beanDefinitions, element); return null; } } ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:3:2","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"2.3 configureScanner() ä»ä»¥ä¸‹æºç å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆè®¾ç½®æ˜¯å¦ä½¿ç”¨é»˜è®¤è¿‡æ»¤å™¨ï¼Œç„¶ååˆ›å»ºæ‰«æå™¨ComponentScanBeanDefinitionParserï¼Œä¹‹åå¯¹å…¶ä»–å±æ€§è¿›è¡Œä¸€äº›è®¾ç½®ã€‚ï¼ˆå…³æ³¨æºç ä¸­å…³é”®ç‚¹å°±å¥½ï¼Œä¸ç„¶ä¼šè¶Šé™·è¶Šæ·±ï¼‰ public class ComponentScanBeanDefinitionParser implements BeanDefinitionParser { protected ClassPathBeanDefinitionScanner configureScanner(ParserContext parserContext, Element element) { // è§£æé…ç½®çš„å±æ€§ï¼Œuse-default-filterså¦‚æœæœªå®šä¹‰ï¼Œé»˜è®¤ä¸ºtrue boolean useDefaultFilters = true; if (element.hasAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE)) { useDefaultFilters = Boolean.valueOf(element.getAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE)); } // åˆ›å»ºæ‰«æå™¨ï¼Œå…¶å®mybatisä¸­çš„æ‰«æåŸç†å°±æ¥è‡ªäºæ­¤ï¼Œmybatisä¸­çš„ClassPathMapperScannerç»§æ‰¿äº†ClassPathBeanDefinitionScanner // Delegate bean definition registration to scanner class. ClassPathBeanDefinitionScanner scanner = createScanner(parserContext.getReaderContext(), useDefaultFilters); // ä¸‹é¢çš„ä»£ç æ˜¯å¯¹æ ‡ç­¾ä¸­å…¶ä»–å±æ€§çš„ä¸€äº›è®¾ç½®ï¼Œå…¶å®å°±æ˜¯æŠŠæ ‡ç­¾åŠå…¶å±æ€§ä»¥javaç±»çš„æè¿°å½¢å¼ä½“ç°ã€‚ scanner.setBeanDefinitionDefaults(parserContext.getDelegate().getBeanDefinitionDefaults()); scanner.setAutowireCandidatePatterns(parserContext.getDelegate().getAutowireCandidatePatterns()); if (element.hasAttribute(RESOURCE_PATTERN_ATTRIBUTE)) { scanner.setResourcePattern(element.getAttribute(RESOURCE_PATTERN_ATTRIBUTE)); } try { parseBeanNameGenerator(element, scanner); } catch (Exception ex) { parserContext.getReaderContext().error(ex.getMessage(), parserContext.extractSource(element), ex.getCause()); } try { parseScope(element, scanner); } catch (Exception ex) { parserContext.getReaderContext().error(ex.getMessage(), parserContext.extractSource(element), ex.getCause()); } parseTypeFilters(element, scanner, parserContext); return scanner; } } ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:3:3","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"2.4 æ ¸å¿ƒæ–¹æ³•doScan() æ‰«æå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ç±»ï¼Œå¹¶å°è£…æˆBeanDefinition å¾ªç¯æ‰«æåˆ°çš„BeanDefinitioné›†åˆï¼Œä¾æ¬¡æ‰§è¡Œæ“ä½œã€‚ è§£æ@Scopeæ³¨è§£ å¯¹ä¸åŒç±»å‹çš„BeanDefinitionåšä¸åŒå¤„ç†ï¼Œ@Lazyã€@DependOnç­‰æ³¨è§£ä¿¡æ¯å°è£…å°±æ˜¯åœ¨è¿™é‡Œè®¾ç½®çš„ã€‚ æ ¡éªŒæ˜¯å¦æ˜¯éœ€è¦å®ä¾‹åŒ–çš„BeanDefinitionï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™å°†BeanDefinitionåŒ…è£…æˆBeanDefinitionHolderï¼ˆè¿™ä¸ªç±»é‡Œå°è£…äº†å®ä¾‹åç§°ã€åˆ«åä¿¡æ¯ï¼‰ æºç å¦‚ä¸‹ï¼š public class ComponentScanBeanDefinitionParser implements BeanDefinitionParser { protected Set\u003cBeanDefinitionHolder\u003e doScan(String... basePackages) { Assert.notEmpty(basePackages, \"At least one base package must be specified\"); // ç”¨æ¥è£…æ‰€æœ‰æ‰«æåˆ°çš„ç±»çš„BeanDefinitionå¯¹è±¡ã€‚ Set\u003cBeanDefinitionHolder\u003e beanDefinitions = new LinkedHashSet\u003c\u003e(); for (String basePackage : basePackages) { // TODO é‡ç‚¹çœ‹ï¼šæŸ¥æ‰¾å€™é€‰ç»„ä»¶ï¼Œå°è£…æˆBeanDefinitionã€‚ Set\u003cBeanDefinition\u003e candidates = findCandidateComponents(basePackage); for (BeanDefinition candidate : candidates) { // è·å–åˆ°ScopeMetadataï¼Œå¦‚æœç±»ä¸­æœ‰@Scopeæ³¨è§£ï¼Œåˆ™ä¼šå°†å€¼å°è£…åˆ°è¿™ä¸ªå®ä¾‹ä¸­ã€‚ç„¶åè®¾ç½®åˆ°BeanDefinitionä¸­ã€‚ ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate); candidate.setScope(scopeMetadata.getScopeName()); String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry); // å¯¹ä¸åŒç±»å‹çš„BeanDefinitionåšä¸åŒçš„å¤„ç†ã€‚ if (candidate instanceof AbstractBeanDefinition) { postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName); } // å¯¹ä¸åŒç±»å‹çš„BeanDefinitionåšä¸åŒçš„å¤„ç†ï¼Œ@Lazyã€@DependOnç­‰æ³¨è§£ä¿¡æ¯å°è£…å°±æ˜¯åœ¨è¿™é‡Œè®¾ç½®çš„ã€‚ if (candidate instanceof AnnotatedBeanDefinition) { // ä¸€äº›æ³¨è§£ä¿¡æ¯çš„å°è£… AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate); } // æ ¡éªŒæ˜¯å¦æ˜¯éœ€è¦å®ä¾‹åŒ–çš„BeanDefinitionï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™å°†BeanDefinitionåŒ…è£…æˆBeanDefinitionHolderï¼ˆè¿™ä¸ªç±»é‡Œå°è£…äº†å®ä¾‹åç§°ã€åˆ«åä¿¡æ¯ï¼‰ if (checkCandidate(beanName, candidate)) { BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName); definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry); beanDefinitions.add(definitionHolder); // æ³¨å†ŒBeanDefinition registerBeanDefinition(definitionHolder, this.registry); } } } return beanDefinitions; } } ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:3:4","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"2.5 findCandidateComponentsåŸç†è§£æ æœ€ç»ˆä¼šæ‰§è¡Œåˆ°scanCandidateComponents()æ–¹æ³•ã€‚ä»ä¸‹é¢æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯æ ¹æ®\u003ccontext:component-scan/\u003eæ ‡ç­¾é…ç½®çš„base-packageæ¥æ‰«æå¯¹åº”è·¯å¾„ä¸‹çš„æ–‡ä»¶è¾“å…¥æµï¼Œè¯»å–ç±»æ–‡ä»¶ä¿¡æ¯ã€‚è¿›è€Œæ‹¿åˆ°Classå¯¹è±¡ï¼Œå°è£…æˆBeanDefinitionå¯¹è±¡ã€‚ç„¶åå‘ä¸Šè¿”å›ï¼Œç›´åˆ°æ³¨å†Œåˆ°BeanDefinitionRegistryä¸­ã€‚ public class ComponentScanBeanDefinitionParser implements BeanDefinitionParser { private Set\u003cBeanDefinition\u003e scanCandidateComponents(String basePackage) { Set\u003cBeanDefinition\u003e candidates = new LinkedHashSet\u003c\u003e(); try { //æ ¹æ®è·¯å¾„æ‰«æ String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + resolveBasePackage(basePackage) + '/' + this.resourcePattern; // è·å–æŒ‡å®šåŒ…ä¸‹åŒ¹é…åˆ°çš„æ‰€æœ‰çš„èµ„æºå¯¹è±¡ã€‚é‡Œé¢å°è£…äº†InputStreamï¼Œç”¨æ¥è¯»å–ç±»æ–‡ä»¶ã€‚ Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath); boolean traceEnabled = logger.isTraceEnabled(); boolean debugEnabled = logger.isDebugEnabled(); for (Resource resource : resources) { if (traceEnabled) { logger.trace(\"Scanning \" + resource); } if (resource.isReadable()) { try { // å°è£…æˆScannedGenericBeanDefinitionï¼Œè¿™é‡Œå°è£…äº†åŒ…ä¸‹æ‰€æœ‰çš„ç±»ä¿¡æ¯ MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource); if (isCandidateComponent(metadataReader)) { // åˆ›å»ºBeanDefinitionå¯¹è±¡ï¼Œå°† ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader); sbd.setResource(resource); sbd.setSource(resource); // åˆ¤æ–­æ˜¯å¦æ˜¯å€™é€‰ç»„ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ·»åŠ BeanDefinitionå¯¹è±¡ if (isCandidateComponent(sbd)) { if (debugEnabled) { logger.debug(\"Identified candidate component class: \" + resource); } candidates.add(sbd); } else { if (debugEnabled) { logger.debug(\"Ignored because not a concrete top-level class: \" + resource); } } } else { if (traceEnabled) { logger.trace(\"Ignored because not matching any filter: \" + resource); } } } catch (Throwable ex) { throw new BeanDefinitionStoreException( \"Failed to read candidate component class: \" + resource, ex); } } else { if (traceEnabled) { logger.trace(\"Ignored because not readable: \" + resource); } } } } catch (IOException ex) { throw new BeanDefinitionStoreException(\"I/O failure during classpath scanning\", ex); } return candidates; } } ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:3:5","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"3 AspectJAutoProxyBeanDefinitionParser AspectJAutoProxyBeanDefinitionParseræ˜¯å¯¹aopæ ‡ç­¾çš„aop:aspectj-autoproxy/çš„æ”¯æŒ æºç ï¼š class AspectJAutoProxyBeanDefinitionParser implements BeanDefinitionParser { @Override @Nullable public BeanDefinition parse(Element element, ParserContext parserContext) { // å¯¹aspectj-autoproxyå±æ€§çš„æ”¯æŒ AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element); // æ·»åŠ IncludePatterns extendBeanDefinition(element, parserContext); return null; } } ä¼šèµ°åˆ°è¿™é‡Œï¼š public abstract class AopConfigUtils { @Nullable public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary( BeanDefinitionRegistry registry, @Nullable Object source) { // æ³¨å…¥æ­¤ç±» AnnotationAwareAspectJAutoProxyCreatorï¼Œæœ¬è´¨è¿˜æ˜¯ä¸€ä¸ªBeanPostProcessor, // å®ç°äº†BeanPostProcessorçš„å­æ¥å£ï¼šSmartInstantiationAwareBeanPostProcessor return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source); } } AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary()æ–¹æ³•ä¸­ï¼Œæ³¨å†Œäº†AnnotationAwareAspectJAutoProxyCreatorçš„æ”¯æŒï¼Œè¿™ä¸ªç±»ä¼šåœ¨AOPçŸ¥è¯†ç‚¹ä¸­è¯¦ç»†é˜è¿°ã€‚ ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:4:0","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"4 AnnotationConfigBeanDefinitionParser åœ¨å…¶æºç  parse() ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ã€‚ public class AnnotationConfigBeanDefinitionParser implements BeanDefinitionParser { public BeanDefinition parse(Element element, ParserContext parserContext) { Object source = parserContext.extractSource(element); // TODO é‡ç‚¹çœ‹ä¸‹ï¼Œé€»è¾‘ç›¸å¯¹ç®€å•ï¼Œæ³¨å†Œä¸€äº›å†…ç½®æ³¨è§£è§£ææ”¯æŒ Set\u003cBeanDefinitionHolder\u003e processorDefinitions = AnnotationConfigUtils.registerAnnotationConfigProcessors(parserContext.getRegistry(), source); // çœç•¥... return null; } } è¿›å…¥ registerAnnotationConfigProcessors()ï¼š public abstract class AnnotationConfigUtils { public static Set\u003cBeanDefinitionHolder\u003e registerAnnotationConfigProcessors( BeanDefinitionRegistry registry, @Nullable Object source) { // ApplicationContextæ˜¯å®ç°äº†BeanDefinitionRegistryçš„ï¼Œè¿™é‡Œå°†ApplicationContextè¿›è¡Œå¼ºè½¬ã€‚ DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry); // çœç•¥... Set\u003cBeanDefinitionHolder\u003e beanDefs = new LinkedHashSet\u003c\u003e(8); // ConfigurationClassPostProcessoræ³¨å†Œï¼Œæ”¯æŒæ³¨è§£@Configuration if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) { // è¿™é‡Œæ³¨å…¥äº†ä¸€ä¸ªBeanFactoryPostProcessor RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); } // AutowiredAnnotationBeanPostProcessoræ³¨å†Œï¼Œæ”¯æŒ@Autowired if (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) { RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)); } // çœç•¥... return beanDefs; } } å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ³¨å†Œäº† ConfigurationClassPostProcessor å’Œ AutowiredAnnotationBeanPostProcessorã€‚ è¿™äº›éƒ½æ˜¯å†…ç½®çš„ BeanDefinitionPostProcessor å®ç°ç±»ï¼Œå¯¹åº”æ³¨è§£éƒ½æ˜¯å¸¸ç”¨çš„ï¼Œæœ‰å¿…è¦çœ‹ä¸€ä¸‹ã€‚ ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:5:0","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"5 æ€»ç»“ springå¯¹XMLçš„è§£æï¼Œå°±æ˜¯é€šè¿‡NameSpaceHandlerä¸­æ³¨å†Œçš„BeanDefinitionParserè¿›è¡Œå¤„ç†çš„ã€‚é€šè¿‡SPIçš„æ–¹å¼ï¼Œå¾ˆå®¹æ˜“å¯¹æ ‡ç­¾è§£æåŠŸèƒ½è¿›è¡Œæ‰©å±•ã€‚ æŠ€å·§\r\rå…¶ä»–çš„è§£æç±»ï¼Œæ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„ã€‚ é¦–å…ˆæ ¹æ®æ ‡ç­¾åç§°æ‰¾åˆ°NamespaceUriï¼Œæ ¹æ®SPIåŠ è½½æ–¹å¼ï¼Œåˆ°å¯¹åº”æ¨¡å—META-INF/spring.handlersæ–‡ä»¶ä¸­æŸ¥æ‰¾å¯¹åº”çš„NamespaceHandlerå®ç°ç±»ï¼› ç„¶ååœ¨å®ç°ç±»ä¸­çš„initæ–¹æ³•ä¸­ï¼Œæ‰¾åˆ°æ ‡ç­¾å±æ€§å¯¹åº”çš„BeanDefinitionParserå®ç°ç±»ï¼› æœ€åï¼Œè¿›å…¥å®ç°ç±»çš„parseæ–¹æ³•ï¼Œè¯»æºç å³å¯ã€‚ç»“åˆæ–­ç‚¹è°ƒè¯•ï¼Œå¾ˆå®¹æ˜“è¯»æ‡‚ã€‚ \r\r ä¸‡äº‹å¼€å¤´éš¾ï¼Œspringæºç ä¹Ÿä¸€æ ·ã€‚åˆšå¼€å§‹ç¡®å®æŒºéš¾ç†è§£çš„ï¼Œç†æ¸…äº†è„‰ç»œåï¼Œå†è¯»èµ·æ¥å°±ç›¸å¯¹ç®€å•å¾ˆå¤šã€‚ ","date":"2020-11-23","objectID":"/posts/spring/02-spring-tag-parse-bean-definition-parser/:6:0","tags":["springæºç "],"title":"02 Springæ ‡ç­¾è§£æ-BeanDefinitionParser","uri":"/posts/spring/02-spring-tag-parse-bean-definition-parser/"},{"categories":["spring"],"content":"Springæºç çš„ç¨‹åºå…¥å£ï¼Œå’ŒXMLè§£æçš„æºç æµç¨‹ã€‚","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"å‰è¨€ springæºç ç³»åˆ—æ–‡ç« ï¼Œç¤ºä¾‹ä»£ç çš„ä¸­æ–‡æ³¨é‡Šï¼Œå‡æ˜¯ copy è‡ª https://gitee.com/wlizhi/spring-framework ã€‚ é“¾æ¥ä¸­æºç æ˜¯ä½œè€…ä» github ä¸‹è½½ï¼Œå¹¶ä»¥è‡ªèº«ç†è§£å¯¹æ ¸å¿ƒæµç¨‹åŠä¸»è¦èŠ‚ç‚¹åšäº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šã€‚å¯ä¸‹è½½ã€ç»“åˆ Spring ç³»åˆ—æ–‡ç« é˜…è¯»æºç ã€‚ç‚¹æ­¤æŸ¥çœ‹ åŸç‰ˆspringæºç  ã€‚ æœ¬æ–‡å…è®¸éå•†ä¸šæ€§è½¬è½½ï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€… Wlizhi åŠé“¾æ¥ https://wlizhi.cc ã€‚ ç”¨ jackå¤§ä½¬ çš„è¯æ¥æ¦‚æ‹¬ï¼Œä¸ºä»€ä¹ˆè¦å­¦ä¹ Springæºç ï¼Ÿ æé«˜è‡ªå·±çš„å†™ä»£ç èƒ½åŠ› ä»å…¨å±€è€ƒè™‘å¦‚ä½•ä½¿ä»£ç å˜å¾—çµæ´»å¯æ‰©å±• Springé‡æ–°å®šä¹‰äº†Java Springæºç æ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ å¦‚æœæƒ³æˆä¸ºçœŸæ­£çš„é«˜æ‰‹ï¼ŒSpringæºç å¿…é¡»æ”»å…‹ï¼Œä¸æ˜¯å±è¨€è€¸å¬çš„ Springæºç è¯»æ‡‚ï¼Œå…¶ä»–å¾ˆå¤šåŸºäºSpringçš„æ¡†æ¶æºç å¾ˆå®¹æ˜“ç†è§£ã€‚ç›¸åï¼Œä»¥Springä¸ºåŸºç¡€çš„æ¡†æ¶ã€ç»„ä»¶ï¼Œä¸æ‡‚Springå‹æ ¹æ²¡æ³•è¯»å…¶æºç ã€‚ å­¦ä¹ æºç çš„æ–¹å¼ï¼šä¸»æŠ“è„‰ç»œï¼Œåçœ‹ç»†èŠ‚ã€‚ï¼ˆç†Ÿç»ƒä½¿ç”¨çš„å‰æä¸‹å†çœ‹æºç ï¼‰ ç‰¹åˆ«æ„Ÿè°¢ï¼šSpringæºç ä¸­çš„è°ƒç”¨é“¾è·¯ã€çºµæ·±éƒ½æ˜¯æ¯”è¾ƒé•¿çš„ï¼Œæˆ‘ä¸ªäººè¯»äº†å¾ˆä¹…ã€‚è®¸å¤šæºç éš¾ç‚¹çš„ç†è§£å¾—ç›Šäº jackå¤§ä½¬ çš„è®²è§£ï¼Œæ„Ÿè°¢å¤§ä½¬çš„æˆä¸šè§£æƒ‘ã€‚ ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:1:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"1 Springçš„å†å² 2002å¹´10æœˆ,Rod Johnsonå‘å¸ƒã€ŠExpert One-on-One J2EEè®¾è®¡å’Œå¼€å‘ã€‹ä¸€ä¹¦ 2004å¹´3æœˆï¼ŒSpring1.0å‘å¸ƒ 2006å¹´10 æœˆï¼ŒSpring2.0å‘å¸ƒ 2009å¹´12æœˆï¼ŒSpring3.0å‘å¸ƒ 2013å¹´12æœˆï¼Œå‘å¸ƒSpring4.0 2017å¹´9æœˆï¼ŒSpring5.0å‘å¸ƒ ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:2:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"2 è¯»æºç å‰çš„å‡†å¤‡ JDK1.8ç‰ˆæœ¬ spring 5.1.3.RELEASEç‰ˆæœ¬ è¡¥ä¸€ä¸‹Lambdaè¡¨è¾¾å¼çš„çŸ¥è¯† å®‰è£…é…ç½®gradle ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:3:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"3 Springæºç ä¸‹è½½ git clone --branch v5.1.3.RELEASE https://gitee.com/wanglizhi00/spring-framework ï¼ˆæ­¤é“¾æ¥çš„Springæºç ï¼Œæ ¸å¿ƒæµç¨‹ã€è¦æ³¨æ„çš„ç‚¹æˆ‘éƒ½åšäº†ä¸­æ–‡æ³¨é‡Šï¼Œéå¸¸è¯¦ç»†ã€‚å¦‚æœä½ çš„ç½‘ç»œè¶³å¤Ÿå¥½ï¼Œä¹Ÿå¯ä»¥åˆ° github ä¸‹è½½ åŸç‰ˆspringæºç  ï¼‰ gradleä¸‹è½½ï¼Œgradleè¦JDK8çš„ç‰ˆæœ¬ åˆ°ä¸‹è½½çš„springæºç è·¯å¾„æ‰§è¡Œgradleå‘½ä»¤ï¼Œgradlew :spring-oxm:compileTestJava ç”¨ideaæ‰“å¼€springæºç å·¥ç¨‹ã€‚ï¼ˆåœ¨ideaä¸­å®‰è£…æ’ä»¶kotlinï¼Œé‡å¯ideaï¼Œè·ŸIDEAç‰ˆæœ¬æœ‰å…³è¾ƒæ–°ç‰ˆæœ¬ä¸ç”¨å®‰è£…ï¼‰ æŠŠç¼–è¯‘å¥½çš„æºç å¯¼å…¥åˆ°å·¥ç¨‹ä¸­ springå·¥ç¨‹å¦‚ä½•æ­å»ºè¿™é‡Œä¸åšä»‹ç»ï¼Œå¦‚ä½•å°†downä¸‹æ¥çš„æºç å¯¼å…¥åˆ°è‡ªå·±çš„springå·¥ç¨‹ä¾èµ–åº“ï¼Œ æˆ‘çš„Gitee-Springæºç æ³¨é‡Š ä¸­æœ‰è¯¦ç»†çš„ä»‹ç» ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:4:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"4 å…¥å£æ–¹æ³• å®¹å™¨ï¼šAbstractApplicationContext æŠ½è±¡çˆ¶ç±»ï¼Œæ ¸å¿ƒæ–¹æ³• refresh()ã€‚ ClassPathXmlApplicationContext XMLæ–¹å¼å¯åŠ¨ã€‚ AnnotationConfigWebApplicationContext æ³¨è§£æ–¹å¼å¯åŠ¨ï¼Œå¯¹å±€éƒ¨ä»£ç è¿›è¡Œæµ‹è¯•æ—¶æ¯”è¾ƒå¥½ç”¨ã€‚ AnnotationConfigServletWebServerApplicationContext SpringBootå¯åŠ¨é»˜è®¤ä½¿ç”¨çš„ä¸Šä¸‹æ–‡ç±»ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œspringå®¹å™¨çš„å¯åŠ¨æ˜¯é€šè¿‡æ„é€ ApplicationContextçš„ä¸€ä¸ªå®ä¾‹å¼€å§‹çš„ã€‚ä»¥ClassPathXmlApplicationContextä¸ºä¾‹ã€‚ ClassPathXmlApplicationContext UMLå›¾ClassPathXmlApplicationContext UMLå›¾ \"\rClassPathXmlApplicationContext UMLå›¾\r ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:5:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"5 Xmlè§£ææµç¨‹æ¦‚è§ˆ é¦–å…ˆè¿›å…¥springå®¹å™¨å¯åŠ¨çš„æ ¸å¿ƒæ–¹æ³•ï¼šrefresh() ï¼Œåˆ›å»ºBeanFactoryå¯¹è±¡ obtainFreshBeanFactory() åˆ›å»ºXmlBeanDefinitionReaderå¯¹è±¡ é€šè¿‡Readerå¯¹è±¡åŠ è½½é…ç½®æ–‡ä»¶ æ ¹æ®åŠ è½½çš„é…ç½®æ–‡ä»¶æŠŠé…ç½®æ–‡ä»¶å°è£…æˆdocumentå¯¹è±¡ åˆ›å»ºBeanDefinitionDocumentReaderå¯¹è±¡ï¼ŒDocumentReaderè´Ÿè´£å¯¹documentå¯¹è±¡è§£æ parseDefaultElement(ele, delegate);è´Ÿè´£å¸¸è§„æ ‡ç­¾è§£æ delegate.parseCustomElement(ele);è´Ÿè´£è‡ªå®šä¹‰æ ‡ç­¾è§£æ æœ€ç»ˆè§£æçš„æ ‡ç­¾å°è£…æˆBeanDefinitionå¹¶ç¼“å­˜åˆ°å®¹å™¨ä¸­ ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:6:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"6 åˆ›å»ºXmlBeanDefinitionReaderå¯¹è±¡ public abstract class AbstractXmlApplicationContext extends AbstractRefreshableConfigApplicationContext { @Override protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException { // Create a new XmlBeanDefinitionReader for the given BeanFactory. // åˆ›å»ºBeanDefinitionReader XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // Configure the bean definition reader with this context's // resource loading environment. beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // Allow a subclass to provide custom initialization of the reader, // then proceed with actually loading the bean definitions. initBeanDefinitionReader(beanDefinitionReader); // TODO å…³é”®ç‚¹ï¼šåŠ è½½BeanDefinition loadBeanDefinitions(beanDefinitionReader); } } åœ¨loadBeanDefinitionsæ–¹æ³•çš„ç¬¬ä¸€è¡Œï¼Œåˆ›å»ºäº†XmlBeanDefinitionReaderå¯¹è±¡ã€‚è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯è¯»å–BeanDefinitionï¼Œå¹¶å°†XMLæ–‡æ¡£çš„è¯»å–å§”æ‰˜ç»™BeanDefinitionDocumentReaderã€‚ ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:7:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"7 åˆ›å»ºBeanDefinitionDocumentReaderå¯¹è±¡ æ¥åˆ°loadBeanDefinitions(beanDefinitionReader);è¿™é‡Œå°†è¦è¯»å–çš„xmlè·¯å¾„ä¼ é€’è¿›æ¥ï¼Œå¾ªç¯xmlè·¯å¾„ï¼Œä¾æ¬¡è¿›è¡Œè§£æã€‚ æ³¨ï¼šçœ‹æ³¨é‡Šä¸­çš„å…³é”®ç‚¹ public abstract class AbstractBeanDefinitionReader implements BeanDefinitionReader, EnvironmentCapable { // é¦–å…ˆè¿›å…¥è¿™ä¸ªæ–¹æ³• @Override public int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException { Assert.notNull(locations, \"Location array must not be null\"); int count = 0; // ä¸€æ¬¡è§£æé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„Beanã€‚ for (String location : locations) { count += loadBeanDefinitions(location); } return count; } } è·¯å¾„æœ€ç»ˆä¼šè¢«å°è£…ä¸ºIinputSourceå¯¹è±¡ï¼Œä½¿ç”¨å§”æ‰˜æ¨¡å¼ï¼Œäº¤ç»™BeanDefinitionDocumentReaderå¤„ç† public class XmlBeanDefinitionReader extends AbstractBeanDefinitionReader { // ç¬¬ä¸€æ­¥ï¼šå…¥å£ protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException { try { // è§£æxmlé…ç½®æ–‡ä»¶ï¼Œè·å–åˆ°Documentå¯¹è±¡ Document doc = doLoadDocument(inputSource, resource); // è§£æã€æ³¨å†ŒBeanDefinition int count = registerBeanDefinitions(doc, resource); if (logger.isDebugEnabled()) { logger.debug(\"Loaded \" + count + \" bean definitions from \" + resource); } return count; //æ­¤å¤„åˆ†åˆ«æ•è·äº†å¾ˆå¤šç§å¼‚å¸¸ï¼Œçœç•¥äº†ã€‚ } catch (Exception ex) { throw ex; } } // ç¬¬äºŒæ­¥ åˆ›å»ºBeanDefinitionDocumentReaderï¼Œå§”æ‰˜ç»™BeanDefinitionDocumentReaderè¿›è¡Œè§£æå·¥ä½œã€‚ public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException { // å§”æ‰˜æ¨¡å¼ï¼Œå°†Documentçš„è§£æåŠBeanDefinitionçš„æ³¨å†Œäº¤ç»™BeanDefinitionDocumentReader // è¿™é‡Œä½¿ç”¨çš„DefaultBeanDefinitionDocumentReaderè¿›è¡Œè§£æ BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); // TODO å…³é”®ç‚¹ï¼šè§£æxmlã€æ³¨å†ŒBeanDefinition documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore; } } ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:8:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"8 æ ‡ç­¾è§£æå…¥å£ åœ¨è§£ææ ‡ç­¾ä¹‹å‰ã€å’Œä¹‹åï¼Œåˆ†åˆ«æœ‰ä¸€ä¸ªé’©å­æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªé’©å­æ–¹æ³•åˆ†åˆ«æ˜¯ è§£æxmlå¹¶æ³¨å†ŒBeanDefinition ä¹‹å‰å’Œä¹‹åçš„æ‰©å±•æ–¹æ³•ï¼ŒClassPathXmlApplicationContextä¸­ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä½“éƒ½æ˜¯ç©ºçš„ã€‚ public class DefaultBeanDefinitionDocumentReader implements BeanDefinitionDocumentReader { // ç¬¬ä¸€æ­¥ protected void doRegisterBeanDefinitions(Element root) { // Any nested \u003cbeans\u003e elements will cause recursion in this method. In // order to propagate and preserve \u003cbeans\u003e default-* attributes correctly, // keep track of the current (parent) delegate, which may be null. Create // the new (child) delegate with a reference to the parent for fallback purposes, // then ultimately reset this.delegate back to its original (parent) reference. // this behavior emulates a stack of delegates without actually necessitating one. BeanDefinitionParserDelegate parent = this.delegate; // BeanDefinitionParserDelegateä¸­å°è£…äº†é¢„å®šä¹‰çš„å¾ˆå¤šæ ‡ç­¾å±æ€§ this.delegate = createDelegate(getReaderContext(), root, parent); // æ ¹æ ‡ç­¾è§£æ NameSpaceï¼šhttp://www.springframework.org/schema/beans if (this.delegate.isDefaultNamespace(root)) { String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE); if (StringUtils.hasText(profileSpec)) { String[] specifiedProfiles = StringUtils.tokenizeToStringArray( profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS); // We cannot use Profiles.of(...) since profile expressions are not supported // in XML config. See SPR-12458 for details. if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) { if (logger.isDebugEnabled()) { logger.debug(\"Skipped XML bean definition file due to specified profiles [\" + profileSpec + \"] not matching: \" + getReaderContext().getResource()); } return; } } } // é’©å­æ–¹æ³•ï¼Œè§£æxmlæ³¨å†ŒBeanDefinitionä¹‹å‰è°ƒç”¨ï¼Œå¯ä»¥ä¸çœ‹ preProcessXml(root); // TODO è§£æxmlï¼Œæ³¨å†ŒBeanDefinition parseBeanDefinitions(root, this.delegate); // é’©å­æ–¹æ³•ï¼Œè§£æxmlæ³¨å†ŒBeanDefinitionä¹‹åè°ƒç”¨ï¼Œå¯ä»¥ä¸çœ‹ postProcessXml(root); this.delegate = parent; } // ç¬¬äºŒæ­¥ protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) { // Springæ ¹æ ‡ç­¾ï¼ŒNameSpaceï¼šhttp://www.springframework.org/schema/beans // è¿™é‡Œå¾ªç¯documentä¸­çš„å…ƒç´ ï¼Œè¿›è¡Œè§£æé»˜è®¤æ ‡ç­¾åŠè‡ªå®šä¹‰æ ‡ç­¾ String tagName = root.getTagName(); if (delegate.isDefaultNamespace(root)) { NodeList nl = root.getChildNodes(); for (int i = 0; i \u003c nl.getLength(); i++) { Node node = nl.item(i); if (node instanceof Element) { Element ele = (Element) node; if (delegate.isDefaultNamespace(ele)) { logger.debug(\"delegate.isDefaultNamespace(root):true,è§£æé»˜è®¤æ ‡ç­¾ \" + tagName); // TODO å…³é”®ç‚¹ï¼šè§£æé»˜è®¤æ ‡ç­¾ parseDefaultElement(ele, delegate); } else { logger.debug(\"delegate.isDefaultNamespace(root):true,è§£æè‡ªå®šä¹‰æ ‡ç­¾ \" + tagName); // TODO å…³é”®ç‚¹ï¼šè§£æè‡ªå®šä¹‰æ ‡ç­¾ delegate.parseCustomElement(ele); } } } } else { logger.debug(\"delegate.isDefaultNamespace(root):false,è§£æè‡ªå®šä¹‰æ ‡ç­¾ \" + tagName); // TODO å…³é”®ç‚¹ï¼šè§£æè‡ªå®šä¹‰æ ‡ç­¾ delegate.parseCustomElement(root); } } } ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:9:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"9 è§£æé»˜è®¤æ ‡ç­¾ æ ¹æ®xmlèŠ‚ç‚¹çš„åç§°ï¼Œå¯¹æ¯”ä»£ç ä¸­å®šä¹‰çš„æ ‡ç­¾åç§°ã€‚è·³è½¬åˆ°å¯¹åº”çš„è§£ææ–¹æ³• ä»¥beanæ ‡ç­¾ä¸ºä¾‹ï¼Œæœ€ç»ˆèµ°åˆ°BeanDefinitionParserDelegate.parseBeanDefinitionElement()æ–¹æ³• public class DefaultBeanDefinitionDocumentReader implements BeanDefinitionDocumentReader { // ç¬¬ä¸€æ­¥ è¿›å…¥æ ‡ç­¾è§£ææ–¹æ³• private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) { // importæ ‡ç­¾è§£æ if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) { importBeanDefinitionResource(ele); } // aliasæ ‡ç­¾è§£æ else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) { processAliasRegistration(ele); } // TODO é‡ç‚¹çœ‹ï¼šbeanæ ‡ç­¾è§£æ else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) { processBeanDefinition(ele, delegate); } // beansæ ‡ç­¾è§£æ else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) { // recurse doRegisterBeanDefinitions(ele); } } // ç¬¬äºŒæ­¥ è¿›å…¥beanæ ‡ç­¾è§£ææ–¹æ³• protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) { // TODO é‡ç‚¹ï¼šè·å–åˆ°BeanDefinitionHolderï¼Œå†…éƒ¨å°è£…äº†BeanDefinition BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) { // å¦‚æœå¿…è¦ï¼Œè£…é¥°BeanDefinitionï¼Œè¿™é‡Œç”¨åˆ°äº†è£…é¥°æ¨¡å¼ bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try { // Register the final decorated instance. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); } catch (BeanDefinitionStoreException ex) { getReaderContext().error(\"Failed to register bean definition with name '\" + bdHolder.getBeanName() + \"'\", ele, ex); } // Send registration event. getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); } } } è§£æå’Œå°è£…BeanDefinitionï¼Œè¿™é‡Œè§£æäº†beanæ ‡ç­¾ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œå°†è¿™äº›å±æ€§å€¼å°è£…æˆBeanDefinitionå¯¹è±¡ã€‚æœ€ç»ˆä¼šè¢«æ³¨å†Œåˆ°BeanDefinitionRegistryä¸­ã€‚ BeanDefinitionRegistryä½œä¸ºspringå®¹å™¨ä¸­BeanFactoryçš„å…¨å±€æˆå‘˜å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€ç»ˆå¾—åˆ°çš„BeanDefinitionè´¯ç©¿æ•´ä¸ªspringå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒæ˜¯å¯¹springå®¹å™¨ä¸­æ‰€æœ‰å°†è¦å®ä¾‹åŒ–çš„beanä¿¡æ¯çš„æè¿°ã€‚ public class BeanDefinitionParserDelegate { @Nullable public AbstractBeanDefinition parseBeanDefinitionElement( Element ele, String beanName, @Nullable BeanDefinition containingBean) { this.parseState.push(new BeanEntry(beanName)); // beanæ ‡ç­¾ä¸­çš„classå±æ€§ String className = null; if (ele.hasAttribute(CLASS_ATTRIBUTE)) { className = ele.getAttribute(CLASS_ATTRIBUTE).trim(); } // beanæ ‡ç­¾ä¸­çš„parentå±æ€§ String parent = null; if (ele.hasAttribute(PARENT_ATTRIBUTE)) { parent = ele.getAttribute(PARENT_ATTRIBUTE); } try { // TODO é‡ç‚¹ï¼šåˆ›å»ºBeanDefinitionï¼Œè®¾ç½®parentã€beanClassã€beanClassNameå±æ€§ã€‚ // beanæ ‡ç­¾çš„beanå‡å®šä¹‰ä¸ºï¼šGenericBeanDefinition AbstractBeanDefinition bd = createBeanDefinition(className, parent); // TODO é‡ç‚¹ï¼šè§£æelementå¹¶è®¾ç½®BeanDefinitionä¸­çš„å±æ€§å€¼ parseBeanDefinitionAttributes(ele, beanName, containingBean, bd); bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT)); // è§£æmetaæ ‡ç­¾ã€lookupOverrideå­æ ‡ç­¾ã€replaceMethodå­æ ‡ç­¾ parseMetaElements(ele, bd); parseLookupOverrideSubElements(ele, bd.getMethodOverrides()); parseReplacedMethodSubElements(ele, bd.getMethodOverrides()); // è§£ææ„é€ å‡½æ•°å‚æ•°ã€propertyå‚æ•°ã€qualifierå‚æ•° parseConstructorArgElements(ele, bd); parsePropertyElements(ele, bd); parseQualifierElements(ele, bd); bd.setResource(this.readerContext.getResource()); bd.setSource(extractSource(ele)); return bd; } catch (ClassNotFoundException ex) { error(\"Bean class [\" + className + \"] not found\", ele, ex); } catch (NoClassDefFoundError err) { error(\"Class that bean class [\" + className + \"] depends on not found\", ele, err); } catch (Throwable ex) { error(\"Unexpected failure during bean definition parsing\", ele, ex); } finally { this.parseState.pop(); } return null; } } ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:10:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"10 è§£æè‡ªå®šä¹‰æ ‡ç­¾ SPIæ–¹å¼è·å–åŠ è½½æ‰€æœ‰çš„namespaceUriï¼ˆSPIè¿™é‡Œä¸è¿›è¡Œè®¨è®ºï¼‰ï¼Œé€šè¿‡å½“å‰æ ‡ç­¾å®šä¹‰çš„namespaceUriï¼Œè·å–åˆ°åˆå§‹åŒ–åï¼ˆinit()ï¼‰çš„å¤„ç†ç±»ã€‚ç„¶åè°ƒç”¨å¤„ç†ç±»çš„parseæ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­ï¼Œå®Œæˆäº†æ ‡ç­¾å±æ€§çš„è§£æå’ŒBeanDefinitionæ³¨å†Œ åœ¨resolveæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†NamespaceHandlerçš„initæ–¹æ³•ï¼Œinitæ–¹æ³•ä¸­æ³¨å†Œäº†æ ‡ç­¾å±æ€§çš„å¤„ç†ç±»ã€‚ è¿™äº›å¤„ç†ç±»éƒ½æ˜¯BeanDefinitionParserçš„å®ç°ï¼Œåœ¨BeanDefinitionParserä¸­ï¼Œä»…æœ‰ä¸€ä¸ªparseæ–¹æ³•ï¼Œç”¨æ¥è§£æç‰¹å®šçš„æ ‡ç­¾å±æ€§ã€‚ public class BeanDefinitionParserDelegate { @Nullable public BeanDefinition parseCustomElement(Element ele, @Nullable BeanDefinition containingBd) { // SPIæ–¹å¼è·å–namespaceUri String namespaceUri = getNamespaceURI(ele); if (namespaceUri == null) { return null; } // è·å–NamespaceHandlerï¼Œè¿™é‡Œé¢è°ƒç”¨äº†NamespaceHandlerçš„initæ–¹æ³• NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler == null) { error(\"Unable to locate Spring NamespaceHandler for XML schema namespace [\" + namespaceUri + \"]\", ele); return null; } return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd)); } } NamespaceHandlerï¼Œæ˜¯æ ¹æ®å¯¹åº”æ¨¡å—ä¸­çš„META-INF/spring.handlersä¸­å®šä¹‰çš„æ˜ å°„å…³ç³»è¿›è¡Œè·å–çš„ï¼ˆSPIæ–¹å¼è·å–ï¼‰ã€‚æ˜ å°„å…³ç³»NamespaceUri=NamespaceHandler ä»¥ä¸‹æ˜¯spring-contextä¸­å®šä¹‰çš„å¤„ç†æ˜ å°„ï¼ˆspring-context/META-INF/spring.handlersï¼‰ http\\://www.springframework.org/schema/context=org.springframework.context.config.ContextNamespaceHandler http\\://www.springframework.org/schema/jee=org.springframework.ejb.config.JeeNamespaceHandler http\\://www.springframework.org/schema/lang=org.springframework.scripting.config.LangNamespaceHandler http\\://www.springframework.org/schema/task=org.springframework.scheduling.config.TaskNamespaceHandler http\\://www.springframework.org/schema/cache=org.springframework.cache.config.CacheNamespaceHandler resolveæ–¹æ³•è·å–äº†å¤„ç†ç±»å¯¹è±¡ï¼Œæ¯ä¸ªå¤„ç†ç±»å®ä¾‹åŒ–ä¹‹åéƒ½ä¼šæ”¾å…¥ç¼“å­˜handlerMappingsï¼Œä¸‹æ¬¡è·å–ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ã€‚handlerMappingsçš„é”®æ—¶NamespaceUriï¼Œå€¼åˆå§‹æ˜¯å¯¹åº”å¤„ç†ç±»çš„ClassNameï¼Œå®ä¾‹åŒ–ä¹‹åä¼šæ›¿æ¢ä¸ºè¯¥ç±»çš„å®ä¾‹å¯¹è±¡ã€‚ public class DefaultNamespaceHandlerResolver implements NamespaceHandlerResolver { @Override @Nullable public NamespaceHandler resolve(String namespaceUri) { // ä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º Map\u003cString, Object\u003e handlerMappings = getHandlerMappings(); Object handlerOrClassName = handlerMappings.get(namespaceUri); if (handlerOrClassName == null) { return null; } else if (handlerOrClassName instanceof NamespaceHandler) { return (NamespaceHandler) handlerOrClassName; } else { String className = (String) handlerOrClassName; try { // åŠ è½½Class Class\u003c?\u003e handlerClass = ClassUtils.forName(className, this.classLoader); if (!NamespaceHandler.class.isAssignableFrom(handlerClass)) { throw new FatalBeanException(\"Class [\" + className + \"] for namespace [\" + namespaceUri + \"] does not implement the [\" + NamespaceHandler.class.getName() + \"] interface\"); } // TODO é‡ç‚¹ï¼šå®ä¾‹åŒ–NamespaceHandlerï¼Œè°ƒç”¨initæ–¹æ³•ï¼Œæ”¾å…¥ç¼“å­˜ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰æ ‡ç­¾éƒ½è¦æä¾›å¯¹åº”çš„NamespaceHandler // spring.handleræ–‡ä»¶ä¸­å®šä¹‰äº†å¾ˆå¤šå†…ç½®çš„NamespaceHandlerï¼Œé€šè¿‡SPIçš„æ–¹å¼åŠ è½½ã€å®ä¾‹åŒ– NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass); namespaceHandler.init(); handlerMappings.put(namespaceUri, namespaceHandler); return namespaceHandler; } catch (ClassNotFoundException ex) { throw new FatalBeanException(\"Could not find NamespaceHandler class [\" + className + \"] for namespace [\" + namespaceUri + \"]\", ex); } catch (LinkageError err) { throw new FatalBeanException(\"Unresolvable class definition for NamespaceHandler class [\" + className + \"] for namespace [\" + namespaceUri + \"]\", err); } } } } æ¯ä¸ªè‡ªå®šä¹‰æ ‡ç­¾éƒ½æœ‰è‡ªå·±çš„NamespaceHandlerå®ç°ã€‚ NamespaceHandlerå®ç°ç±»\"\rNamespaceHandlerå®ç°ç±»\r ä»¥contextæ ‡ç­¾ä¸ºä¾‹ï¼Œæ³¨å†Œä¸åŒæ ‡ç­¾å±æ€§å¯¹åº”çš„å¤„ç†ç±»ã€‚ public class ContextNamespaceHandler extends NamespaceHandlerSupport { @Override public void init() { // æ³¨å†Œå„ç§æ ‡ç­¾å±æ€§çš„è§£æç±» registerBeanDefinitionParser(\"property-placeholder\", new PropertyPlaceholderBeanDefinitionParser()); registerBeanDefinitionParser(\"property-override\", new PropertyOverrideBeanDefinitionParser()); registerBeanDefinitionParser(\"annotation-config\", new AnnotationConfigBeanDefinitionParser()); registerBeanDefinitionParser(\"component-scan\", new ComponentScanBeanDefinitionParser()); registerBeanDefinitionParser(\"load-time-weaver\", new LoadTimeWeaverBeanDefinitionParser()); registerBeanDefinitionPa","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:11:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["spring"],"content":"11 æ€»ç»“ Springè§£æXMLï¼Œç»•äº†è¿™ä¹ˆå¤§ä¸€åœˆã€‚å…¶ç›®çš„å°±æ˜¯æŠŠXMLä¸­é…ç½®çš„å„ç§æ ‡ç­¾æŒ‰ç…§æ ‡ç­¾æœ¬èº«å®šä¹‰çš„è§£ææ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå°†å¤„ç†çš„ç»“æœå°è£…æˆBeanDefinitionå¯¹è±¡ï¼Œå¹¶æ³¨å…¥åˆ°BeanFactoryçš„æˆå‘˜å˜é‡BeanDefinitionRegistryä¸­ã€‚ è¿™æ˜¯Springå®¹å™¨ä»¥XMLæ–¹å¼åˆå§‹åŒ–çš„ç¬¬ä¸€æ­¥ã€‚å…¶å®æ— è®ºæ˜¯XMLè§£ææ–¹å¼ï¼Œè¿˜æ˜¯æ³¨è§£æ–¹å¼ï¼ŒåŸºæœ¬æ€æƒ³éƒ½æ˜¯ä¸€æ ·çš„ã€‚Springå®¹å™¨åœ¨åˆ›å»ºä»»ä½•å®ä¾‹å‰ï¼Œéƒ½ä¼šå…ˆæœé›†è¿™ä¸ªå°†è¦åˆ›å»ºå®ä¾‹çš„ä¸€äº›å¿…è¦ä¿¡æ¯ï¼Œç„¶åå¯¹è¿™äº›ä¿¡æ¯æ ¹æ®ä¸€äº›æ‰©å±•æ¥å£ä¸­æä¾›çš„æ–¹æ³•ï¼ˆæ¨¡æ¿è®¾è®¡æ¨¡å¼ï¼‰ï¼Œè¿›è¡Œå¤„ç†ã€‚ è¿™äº›å¤„ç†æœ‰ä¸€äº›æ˜¯Springå†…ç½®çš„ï¼Œå¯èƒ½ä¹Ÿæœ‰ä½¿ç”¨è€…è‡ªå®šä¹‰çš„ã€‚å…·ä½“çš„å¤„ç†æ–¹å¼ï¼Œåœ¨åé¢çš„ç« èŠ‚ä½“ç°ã€‚ ","date":"2020-11-22","objectID":"/posts/spring/01-spring-main-xml-parse/:12:0","tags":["springæºç "],"title":"01 Springç¨‹åºå…¥å£å’ŒXMLè§£æ","uri":"/posts/spring/01-spring-main-xml-parse/"},{"categories":["æ–‡æ¡£"],"content":"æœ¬ç« è®°å½•ä¸€äº›åšå®¢çš„é“¾æ¥ï¼Œç»å¸¸ç™¾åº¦çš„ä¸€äº›å†…å®¹ï¼Œä»¥é“¾æ¥çš„æ–¹å¼è®°å½•åœ¨è¿™é‡Œï¼Œä½¿ç”¨ç«™å†…æœç´¢å¼•æ“æ–¹ä¾¿æŸ¥æ‰¾ã€‚ ","date":"2020-11-21","objectID":"/posts/docs/other-blog-link/:0:0","tags":["é“¾æ¥"],"title":"å…¶ä»– - è½¬è½½","uri":"/posts/docs/other-blog-link/"},{"categories":["æ–‡æ¡£"],"content":"linuxç›¸å…³ shellè„šæœ¬åŸºç¡€ï¼šRunoob.com linuxå¸¸ç”¨å‘½ä»¤å¤§å…¨ linux æŸ¥çœ‹æ—¥å¿—çš„å‡ ç§åŸºæœ¬æ“ä½œ Centos7ï¼šsshå…å¯†ç™»å½•è®¾ç½® Centos7 minimalå®‰è£…åçš„ä¸€äº›é…ç½®(è§£å†³ifconfigã€vimç­‰not foundé—®é¢˜) æ·±å…¥ç†è§£VMwareè™šæ‹Ÿæœºç½‘ç»œé€šä¿¡åŸç† ","date":"2020-11-21","objectID":"/posts/docs/other-blog-link/:0:1","tags":["é“¾æ¥"],"title":"å…¶ä»– - è½¬è½½","uri":"/posts/docs/other-blog-link/"},{"categories":["æ–‡æ¡£"],"content":"æ¡†æ¶ Springäº‹åŠ¡ä¼ æ’­è¡Œä¸ºè¯¦è§£ Springboot å•å…ƒæµ‹è¯•è¯¦è§£ ","date":"2020-11-21","objectID":"/posts/docs/other-blog-link/:0:2","tags":["é“¾æ¥"],"title":"å…¶ä»– - è½¬è½½","uri":"/posts/docs/other-blog-link/"},{"categories":["æ–‡æ¡£"],"content":"å·¥å…· Gitå‘½ä»¤å¤§å…¨ è§£å†³GitHubæ¯æ¬¡pushæ—¶éƒ½æç¤ºè¾“å…¥ç”¨æˆ·åå’Œå¯†ç çš„é—®é¢˜ VMWareä½¿ç”¨æ–‡æ¡£ VMwareå®‰è£…Centos7è¶…è¯¦ç»†è¿‡ç¨‹ï¼ˆå›¾æ–‡ï¼‰ vi/vim å‘½ä»¤ä½¿ç”¨è¯¦è§£ ","date":"2020-11-21","objectID":"/posts/docs/other-blog-link/:0:3","tags":["é“¾æ¥"],"title":"å…¶ä»– - è½¬è½½","uri":"/posts/docs/other-blog-link/"},{"categories":["ç”Ÿæ´»"],"content":"å›å¿† å…­å¹´å‰çš„ä¸€ä¸ªLOLè§†é¢‘ï¼Œå½“åˆä¹Ÿæ˜¯å®é”¤çš„ç”µç«ç²‰é¢ã€‚2015å¹´å¤å¤©ä¹Ÿæ˜¯æ‹¿è¿™ä¸ªè‹±é›„æ‰“äº†ä¸€ä¸ªæœˆæ’ä½ï¼Œç½‘ä¸€åŒºä¸€è·¯ä»ç™½é“¶æ‰“åˆ°é’»äºŒï¼Œæ’è¡Œæ¦œ3000å¤šåï¼ˆæ®è¯´è¿™åŒºå½“æ—¶æ´»è·ƒç”¨æˆ·å¤§æ¦‚50ä¸‡ï¼‰ï¼Œä¹‹åä¾¿ä¸æ€ä¹ˆç©å„¿äº†ã€‚ \r","date":"2020-11-21","objectID":"/posts/life/memory-lol/:0:1","tags":["LOL"],"title":"Memory LOL","uri":"/posts/life/memory-lol/"},{"categories":["ç”Ÿæ´»"],"content":"emmâ€¦é‚£å¹´å¤å¤© ","date":"2020-11-21","objectID":"/posts/life/memory-lol/:0:2","tags":["LOL"],"title":"Memory LOL","uri":"/posts/life/memory-lol/"},{"categories":["æŠ˜è…¾"],"content":"å…³äºç«™å†…æœç´¢ï¼Œè¯•ç”¨ä¸¤å¤©lunråï¼Œè¿˜æ˜¯å†³å®šæ¢æˆalgoliaï¼Œalgoliaæœ¬èº«æ€§èƒ½æ›´é«˜ã€ä¹Ÿæ›´åŠ èŠ‚çœæµé‡ã€‚","date":"2020-11-21","objectID":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/","tags":["åšå®¢","hugo"],"title":"ä¸¤å¤©å - è¿˜æ˜¯å†³å®šå°†æœç´¢æ›´æ¢ä¸ºalgolia","uri":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/"},{"categories":["æŠ˜è…¾"],"content":"åŸç”± åšå®¢æ­å»ºå¥½ä¹‹åï¼Œè¿˜ç®—æ»¡æ„ã€‚è¯•ç”¨è¿‡ç¨‹ä¸­ï¼Œå¶ç„¶å‘ç°é¡µé¢è·³è½¬æ—¶æ¯æ¬¡éƒ½ä¼šè¯·æ±‚å‡ ä¸ªlunrç›¸å…³æ”¯æŒçš„jsæ–‡ä»¶ï¼Œæœç´¢æ—¶ï¼Œåˆä¼šä¸‹è½½index.jsæ–‡ä»¶ã€‚ å¯¹lunræ”¯æŒçš„æ–‡ä»¶ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼›index.jså°±æ˜¯æ–‡æ¡£ç´¢å¼•å†…å®¹äº†ï¼Œè¿™ä¸ªæ–‡ä»¶å’Œç½‘ç«™å†…å®¹æ•°é‡æˆæ­£æ¯”ã€‚ç›®å‰æ–‡ç« åªæœ‰åå¤šç¯‡ï¼Œindex.jsæ–‡ä»¶å°±æœ‰70kbã€‚ éšç€æ–‡ç« çš„å‘å¸ƒï¼Œindex.jsä¼šä¸æ–­å¢å¤§ï¼Œä¸”æ¯æ¬¡ç‚¹å‡»æœç´¢æ¡†è¿›è¡Œæœç´¢ï¼Œéƒ½ä¼šä¸‹è½½æ­¤æ–‡ä»¶ã€‚å†…å®¹ä¸å¤šçš„æƒ…å†µä¸‹ï¼Œé€Ÿåº¦ç›¸è¾ƒäºalgoliaæ›´å¿«ã€‚ï¼ˆç½‘ç»œåŸå› ï¼Œå³ä½¿é€‰æ‹©å®˜æ–¹æœ€è¿‘çš„æ•°æ®ä¸­å¿ƒï¼Œè¿˜æ˜¯ç•¥å¡ï¼‰ ä¸€ç•ªæ€ç´¢åï¼Œå†³å®šå°†lunræ¢æˆalgoliaï¼ˆè™½ç„¶å› ç½‘ç»œåŸå› ï¼Œç›®å‰lunræ›´å¿«ï¼‰ï¼ŒåŸå› ï¼šå¹¶éæ¯æ¬¡åŠ è½½é¡µé¢éƒ½éœ€è¦æœç´¢æ”¯æŒï¼Œè€Œä½¿ç”¨lunræ€»æ˜¯ä¼šä¸‹è½½æœç´¢ç›¸å…³æ”¯æŒæ–‡ä»¶ï¼Œalgoliaå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚ ","date":"2020-11-21","objectID":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/:0:1","tags":["åšå®¢","hugo"],"title":"ä¸¤å¤©å - è¿˜æ˜¯å†³å®šå°†æœç´¢æ›´æ¢ä¸ºalgolia","uri":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/"},{"categories":["æŠ˜è…¾"],"content":"lunrå’Œalgoliaçš„åŒºåˆ« lunræ¯æ¬¡æœç´¢å‰ã€éƒ½ä¼šè¯·æ±‚å¯¹lunræ”¯æŒçš„jsæ–‡ä»¶ã€åŠå°†è¦åˆ†æçš„ç´¢å¼•æ–‡æ¡£ï¼ˆindex.jsonï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœç´¢åŠŸèƒ½æœ¬èº«åŠå°†è¦æœç´¢çš„å…¨éƒ¨ç½‘ç«™æ•°æ®ç´¢å¼•ï¼Œéƒ½æ˜¯ä¸€æ¬¡æ€§å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œåœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸Šè¿è¡Œçš„ã€‚è¿™ç§æ–¹å¼å¤ªè¿‡ç®€å•ç²—æš´ã€‚ algoliaåˆ™æ˜¯å°†ç´¢å¼•åˆ†æä»»åŠ¡äº¤ç»™ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ï¼ˆalgoliaå®˜æ–¹çš„ï¼‰ï¼Œéœ€è¦åˆ†æçš„ç´¢å¼•æ–‡æ¡£ï¼Œæå‰ä¸Šä¼ åˆ°algoliaæœåŠ¡å™¨ï¼Œæœç´¢æ—¶ï¼Œå®¢æˆ·ç«¯ä»…å‘é€æœç´¢çš„å…³é”®å­—ã€èº«ä»½æ ¡éªŒçš„ä¸€äº›ä¿¡æ¯ã€‚algoliaåˆ†ææœ¬åœ°ç´¢å¼•æ–‡ä»¶ï¼Œå¤„ç†å®Œæˆåå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ç›¸å¯¹lunrï¼Œalgoliaå°‘äº†å‘å®¢æˆ·ç«¯å‘é€æœç´¢å¼•æ“åŠŸèƒ½æ–‡ä»¶ï¼ˆå› ä¸ºæœç´¢åœ¨æœåŠ¡å™¨åšäº†ï¼Œæœç´¢åŠŸèƒ½æœ¬èº«å¯ä»¥åšçš„æ›´å¼ºå¤§ï¼‰ã€åŠç´¢å¼•æ–‡ä»¶ã€‚ä»…ä»…æ˜¯æœç´¢å…³é”®å­—ã€å’Œå¤„ç†ç»“æœçš„ä¼ è¾“ï¼Œå°±çœäº†å¾ˆå¤§ä¸€ç¬”ç½‘ç»œå¼€é”€ï¼Œè¿™ä¹Ÿæ˜¯å®ƒçš„é«˜æ•ˆä¹‹å¤„ã€‚ algoliaæ¯”lunrå¤šäº†ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ã€‚ä¸€èˆ¬å…¬å¸é‡Œé¡¹ç›®åšæœç´¢ï¼Œæœç´¢å¼•æ“æœåŠ¡å™¨å’Œä¸šåŠ¡æœåŠ¡å™¨æ˜¯é€šè¿‡å†…ç½‘é“¾æ¥ï¼Œç½‘ç»œå»¶è¿Ÿå¾ˆä½å¾ˆä½ã€‚ä½¿ç”¨algoliaçš„å”¯ä¸€ç—›ç‚¹å°±åœ¨è¿™äº†ï¼Œå³ä½¿é€‰æ‹©algoliaåœ¨å›½å†…çš„æ•°æ®ä¸­å¿ƒï¼ˆé¦™æ¸¯ï¼‰ï¼Œä¹Ÿè¿˜æ˜¯æœ‰ç‚¹å»¶è¿Ÿçš„ã€‚ ","date":"2020-11-21","objectID":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/:0:2","tags":["åšå®¢","hugo"],"title":"ä¸¤å¤©å - è¿˜æ˜¯å†³å®šå°†æœç´¢æ›´æ¢ä¸ºalgolia","uri":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/"},{"categories":["æŠ˜è…¾"],"content":"ä½¿ç”¨algolia algoliaä½¿ç”¨è¿˜æ˜¯å¾ˆç®€å•çš„ï¼ŒAlgoliaå®˜ç½‘ æ³¨å†Œè´¦å· -\u003e åˆ›å»ºåº”ç”¨ -\u003e åˆ›å»ºindices -\u003e ä¸Šä¼ ç´¢å¼•æ–‡ä»¶ã€‚ hugoé¡¹ç›®ä¸­ï¼Œé…ç½®ä¸€äº›å¿…è¦ä¿¡æ¯ï¼ˆå‰æä¸»é¢˜æ”¯æŒalgoliaæœç´¢ï¼‰ã€‚åˆ†åˆ«æ˜¯Algoliaä¸­åˆ›å»ºçš„indexåç§°ã€appIdã€searchKeyã€‚ ","date":"2020-11-21","objectID":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/:0:3","tags":["åšå®¢","hugo"],"title":"ä¸¤å¤©å - è¿˜æ˜¯å†³å®šå°†æœç´¢æ›´æ¢ä¸ºalgolia","uri":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/"},{"categories":["æŠ˜è…¾"],"content":"è‡ªåŠ¨æ›´æ–°index æ¯æ¬¡å‘å¸ƒæ–°å†…å®¹ï¼Œå¦‚æœæ‰‹åŠ¨ä¸Šä¼ ç´¢å¼•æ–‡ä»¶åˆ°algoliaï¼Œæ˜¯ç›¸å½“éº»çƒ¦çš„ã€‚ Algolia Atomic æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ ","date":"2020-11-21","objectID":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/:0:4","tags":["åšå®¢","hugo"],"title":"ä¸¤å¤©å - è¿˜æ˜¯å†³å®šå°†æœç´¢æ›´æ¢ä¸ºalgolia","uri":"/posts/experience/replace-the-search-with-algolia-at-two-days-later/"},{"categories":["æŠ˜è…¾"],"content":"å‰è¨€ æ­å»ºè¿‡ç¨‹æœ‰äº›æ³¢æŠ˜ï¼Œå¥½åœ¨æ€»ç®—å®Œæˆäº†ã€‚ç›®å‰åšå®¢é‡‡ç”¨hugoçš„ä¸»é¢˜ã€‚ä¸å¾—ä¸è¯´ï¼Œhugoä½¿ç”¨èµ·æ¥ç›¸è¾ƒäºjekyllç®€å•äº†è®¸å¤šï¼Œé™¤äº†ä¸»é¢˜ç”Ÿæ€æ²¡æœ‰jekyllçš„ä¸°å¯Œï¼Œåˆ«çš„æ²¡æ¯›ç—…ã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:1","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"èµ·å›  ä¸Šå‘¨å¬Jackå¤§ä½¬çš„è¯¾ï¼Œç¿»äº†æŸä½åŒå­¦åšå®¢ ï¼ˆå¶è‰¯è¾°å­¦ä¹ ç¬”è®°ï¼‰ï¼Œé™¡ç„¶çœ¼å‰ä¸€äº®ï¼ŒåŸæ¥ç¬”è®°è¿˜å¯ä»¥è¿™ä¹ˆç©å„¿ã€‚ å…¶å®å‡ å¹´å‰æˆ‘å°±æœ‰æ„æ­å»ºä¸ªäººåšå®¢ï¼Œä¸€ç›´æ²¡è½å®çš„åŸå› ï¼šç¡®å®æœ‰äº›å¿™ï¼Œå¶å°”é—²ä¸‹æ¥æ—¶åˆå»å­¦ä¹ æ–°çš„çŸ¥è¯†ï¼Œè‡ªå·±å†™åšå®¢ç³»ç»Ÿçš„è¯ï¼Œå¤ªè€—æ—¶é—´ã€ç²¾åŠ›ï¼ˆä½œä¸ºä¸€ä¸ªjavaç¨‹åºå‘˜ï¼Œå‰ç«¯èƒ½åŠ›æœ‰é™ï¼Œä½ æ‡‚å¾—ã€‚ï¼‰ï¼Œä¼šçš„ä¸€å †åç«¯æŠ€æœ¯ï¼Œè¿™é‡Œæ¯«æ— ç”¨æ­¦ä¹‹åœ°ã€‚æ—¶è‡³ä»Šæ—¥è¿™ä¸ªè®¡åˆ’å·²ç»è¿Ÿæ»äº†ä¸‰å¹´å¤šã€‚ å¾ˆå¤šäº‘ç¬”è®°ä¹Ÿæœ‰åˆ†äº«åŠŸèƒ½ï¼Œç”šè‡³ä¸€é”®å‘å¸ƒåšå®¢åŠŸèƒ½ã€‚æ¯”å¦‚æœ‰é“äº‘ç¬”è®°ã€å°è±¡ç¬”è®°ã€èš‚èšç¬”è®°ç­‰ï¼Œéƒ½æœ‰ç”¨è¿‡ã€‚çœ‹äº†è¿™ä½åŒå­¦çš„ç¬”è®°ï¼ˆåšå®¢ï¼‰åï¼Œå›æƒ³è‡ªå·±ç”¨äº‘ç¬”è®°çš„æ–¹å¼ï¼Œå†³å®šè¿˜æ˜¯ç ”ç©¶ä¸€ä¸‹åšå®¢ç³»ç»Ÿã€‚ä¸€ä¸ªå­˜å‚¨ç§å¯†æ–‡æ¡£ï¼Œä¸€ä¸ªå‘å¸ƒå…¬å¼€æ–‡æ¡£ã€‚ Jackå¤§ä½¬åšå®¢ä¼ é€é—¨ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:2","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"ç™¾åº¦ - è´§æ¯”ä¸‰å®¶ ç›´æ¥å†™é™æ€é¡µé¢å¾—ä¸å¿å¤±ã€‚é¡µé¢+åç«¯æ–¹å¼å®ç°åšå®¢ã€ç®¡ç†ç­‰åŠŸèƒ½ï¼Œå¤ªé‡ï¼Œä¸”å‰ç«¯èƒ½åŠ›æœ‰é™ã€‚æ— è®ºå¦‚ä½•ï¼Œæœ€ç»ˆå†…å®¹è¿˜æ˜¯è¦é™æ€é¡µé¢ï¼Œé™¤éä½ ä¸æƒ³è¢«æœç´¢å¼•æ“æ‰’åˆ°ã€‚ é¦–å…ˆç™¾åº¦æœç´¢é™æ€é¡µé¢ç”Ÿæˆå™¨ï¼Œå¾ˆå¤šæµè¡Œçš„ï¼Œä¸æ™“å¾—å…ˆå…¥æ‰‹ç ”ç©¶å“ªä¸ªï¼Œå¯¹æ¯”äº†è®¸å¤šå¸–å­ï¼Œå†³å®šå…ˆçœ‹çœ‹jekyllã€‚ç„¶ååœ¨ jekyllä¸»é¢˜ç½‘ç«™ é€‰æ‹©äº†å‡ ä¸ªä¸»é¢˜ã€‚ ä¸€èˆ¬ä¸»é¢˜ç½‘ç«™ä¸­çš„ä¸»é¢˜éƒ½æœ‰demoï¼Œå…ˆçœ‹demoæ•ˆæœã€‚ åˆ°githubä»“åº“ï¼Œforkåˆ°è‡ªå·±çš„ä»“åº“ã€‚ æ ¹æ®README.mdæ–‡æ¡£çš„ä»‹ç»ï¼Œå°†ä»£ç æ‹‰å–åˆ°æœ¬åœ°ï¼Œç”¨IDEæ‰“å¼€ã€‚ï¼ˆæˆ‘ä½¿ç”¨çš„IDEAï¼Œæ¯•ç«Ÿåšåç«¯çš„â€¦ï¼‰ æ ¹æ®ä½¿ç”¨æ–‡æ¡£ï¼ˆå¾ˆå¤šä¸»é¢˜å…¶å®åªæœ‰ä¸€ä¸ªæ–‡ä»¶ä»‹ç»ï¼Œä¸æ˜¯ç‰¹åˆ«è¯¦ç»†ï¼Œéœ€è¦è‡ªå·±æ‘¸ç´¢ï¼‰ä¿®æ”¹é…ç½®ã€‚ å°è¯•äº†å‡ ä¸ªä¸»é¢˜åï¼Œå¤§å¤šåŠŸèƒ½éƒ½æ­£å¸¸ï¼Œä¸ªåˆ«åœ°æ–¹æœ‰é—®é¢˜ï¼Œæœ¬åœ°å¾ˆéš¾è°ƒè¯•ã€‚ï¼ˆä¾èµ–rubyã€nodejsç­‰ç¯å¢ƒï¼Œä½œä¸ºjavaç¨‹åºå‘˜ï¼Œå¯¹è¿™ç©æ„å„¿è®¤çŸ¥ä½çš„å¯æ€œï¼‰ å°è¯•äº†å‡ ä¸ªä¸»é¢˜åï¼Œæ„Ÿè§‰è¿˜å‡‘åˆï¼Œå°†ä¿®æ”¹å¥½çš„ä¸»é¢˜æ¨é€åˆ°githubåï¼Œé€šè¿‡gitPagesæ‰˜ç®¡ã€‚èƒ½è®¿é—®ï¼Œé¾Ÿé€Ÿã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:3","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"é€‰æ‹© - Hugo ä¹‹åç¿»çœ‹ç½‘ä¸Šçš„åšå®¢æ—¶ï¼Œçœ‹åˆ°æœ‰äººè¯´ä½¿ç”¨çš„hugoï¼Œäºæ˜¯ç‚¹è¿›å»æœäº†ä¸€é€šã€‚é€‰æ‹©äº†å‡ ä¸ªä¸»é¢˜ï¼ŒæŒ¨ä¸ªè¯•ã€‚è¿™é‡Œè¯´ä¸‹æˆ‘ä½¿ç”¨çš„æ„Ÿå—ï¼š jekyllä¼˜ç‚¹ï¼šä¸»é¢˜æ›´ä¸°å¯Œï¼Œé€‰æ‹©æ€§æ›´å¤šã€‚ jekyllç¼ºç‚¹ï¼šä½¿ç”¨å®åœ¨å¤ªå¤æ‚ï¼Œæ„å»ºé€Ÿåº¦ç€å®æ…¢äº†äº›ã€‚ hugoä¼˜ç‚¹ï¼šä½¿ç”¨çœŸçš„ç®€å•ï¼Œæ¯”jekyllç®€å•å¤ªå¤šäº†ã€‚æ„å»ºé€Ÿåº¦çœŸçš„å¿«ï¼Œæ¯”jekyllå¿«å¾ˆå¤šå¾ˆå¤šå€ã€‚ï¼ˆç›®å‰æ²¡å¤ªå¤šå†…å®¹ï¼Œæ„å»ºåå¤§æ¦‚100å¤šä¸ªé™æ€ æ–‡ä»¶ï¼Œæ„å»ºéœ€è¦500mså·¦å³ï¼‰ hugoç¼ºç‚¹ï¼šä¸»é¢˜æ²¡jekyllé€‰æ‹©æ€§é‚£ä¹ˆå¤šï¼Œä¹Ÿè¿˜å¯ä»¥ã€‚å®˜ç½‘ä¸Šæœ‰äº›ä¸»é¢˜ç›¸å¯¹ç®€é™‹ã€‚ï¼ˆæ³¨ï¼šä¸æ˜¯ç®€çº¦ï¼Œæ˜¯ç®€é™‹ï¼‰ ä½¿ç”¨jekyllæ—¶ï¼Œçœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå–œæ¬¢çš„ä¸»é¢˜ThemePersephoneï¼Œåªæ˜¯æäº†åŠå¤©ï¼Œgitpagesæ‰˜ç®¡çš„ä»£ç æ˜¯å¯ä»¥è®¿é—®äº†ï¼Œæœ¬åœ°ç¯å¢ƒå´å§‹ç»ˆå¼„ä¸å¥½ï¼ˆrubyçš„é—®é¢˜ï¼Œä¸‹è½½äº†æœ€æ–°ç‰ˆæœ¬ä¸è¡Œã€‚å‡†å¤‡æ¢ä¸ªç‰ˆæœ¬çš„å®‰è£…åŒ…ï¼Œæ­»æ´»ä¸‹è½½ä¸äº†ï¼Œå®˜ç½‘è¢«å¢™çš„å‰å®³ï¼‰ï¼Œåªå¥½æ”¾å¼ƒã€‚ä¹‹ååœ¨HugoThemesä¸‹è½½ä¸»é¢˜ï¼Œè¯•ç”¨ã€‚åªéœ€è¦ä¸‹è½½ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•ä¾èµ–ã€‚æ²¡æœ‰å¯¹æ¯”å°±æ²¡æœ‰ä¼¤å®³ï¼Œæœ€ç»ˆé€‰æ‹©Hugo ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:4","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"æ­å»º ä¸¤æ¬¾ä¸»é¢˜ hugo-theme-hello-friend-ng å’Œ loveit ï¼Œæœ€ç»ˆé€‰æ‹©loveitè¿™æ¬¾ä¸»é¢˜ï¼ŒåŸå› æ˜¯ï¼Œæ–‡æ¡£è¶…çº§è¯¦ç»†ï¼ŒåŠŸèƒ½è¶³å¤Ÿä¸°å¯Œã€‚æ”¯æŒæœç´¢å¼•æ“ï¼ˆä¸¤æ¬¾ï¼‰ã€è¯„è®ºç³»ç»Ÿã€shortcodeã€emojiç­‰ã€‚è¯¥æœ‰çš„åŠŸèƒ½åŸºæœ¬éƒ½æ”¯æŒï¼Œå”¯ä¸€ä¸æ»¡çš„æ˜¯md textå—çš„èƒŒæ™¯è‰²ã€å­—ä½“é¢œè‰²æœ‰ç‚¹ä¸‘ã€‚æœ‰ç©ºå†ç ”ç©¶ç»™æ¢ä¸ªè‰²ã€‚ æœç´¢å¼•æ“æ”¯æŒä¸¤ç§ï¼š lunr: ç®€å•, æ— éœ€åŒæ­¥ index.json, æ²¡æœ‰ contentLength çš„é™åˆ¶, ä½†å ç”¨å¸¦å®½å¤§ä¸”æ€§èƒ½ä½ (ç‰¹åˆ«æ˜¯ä¸­æ–‡éœ€è¦ä¸€ä¸ªè¾ƒå¤§çš„åˆ†è¯ä¾èµ–åº“) algolia: é«˜æ€§èƒ½å¹¶ä¸”å ç”¨å¸¦å®½ä½, ä½†éœ€è¦åŒæ­¥ index.json ä¸”æœ‰ contentLength çš„é™åˆ¶ æš‚æ—¶é€‰æ‹©lunrï¼ŒåŸå› ç®€å•ï¼Œç°åœ¨çš„è®¿é—®é‡æ¥çœ‹ï¼Œç¼ºç‚¹å¯ä»¥å¿½ç•¥ï¼ˆå¥½å§â€¦ä¸¤å¤©å-å†³å®šå°†æœç´¢æ›´æ¢ä¸ºAlogialï¼‰ã€‚ è¯„è®ºç³»ç»Ÿç•¥æœ‰ç‚¹éº»çƒ¦ï¼Œæ”¯æŒ6ç§è¯„è®ºç³»ç»Ÿï¼ˆdisqusã€gitalkã€valineã€facebookã€telegram commentsã€commentoã€utterancesï¼‰ï¼ŒæŒ¨ä¸ªæ‰“å¼€ï¼Œæ‰“å¼€valineå®˜ç½‘é€Ÿåº¦è¾ƒå¿«ï¼Œæœ€ç»ˆé€‰æ‹©è¿™ä¸ªï¼Œä¸ä¸ºåˆ«çš„ï¼Œå®˜ç½‘æ‰“å¼€é€Ÿåº¦çš„å°è±¡åˆ†ã€‚ è¯„è®ºæœ¬èº«é…ç½®ç›¸å¯¹ç®€å•ï¼Œæ ¹æ®æç¤ºæ¥å°±è¡Œã€‚é‚®ä»¶æé†’åŠŸèƒ½ç•¥éº»çƒ¦ç‚¹ï¼Œvalineä»v1.4.0ç‰ˆæœ¬åï¼Œä¸å†æ”¯æŒé‚®ä»¶æé†’åŠŸèƒ½ã€‚åªèƒ½ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹é‚®ä»¶æé†’ã€‚å…³äºè¿™ä¸ªï¼Œgithubä¸Šå¾ˆå¤šå¼€æºé¡¹ç›®ã€‚æˆ‘é€‰æ‹©çš„ Valine-Admin ï¼Œéƒ¨ç½²åˆ°LeanCloudåˆ›å»ºçš„åº”ç”¨ä¸­ã€‚éƒ¨ç½²åéœ€è¦é…ç½®ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œä¸»è¦æ˜¯é‚®ä»¶å‘é€çš„æœåŠ¡å™¨ã€è´¦å·ã€æˆæƒç ã€è‡ªå·±ç½‘ç«™urlç­‰ã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:5","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"è¿ç§» - é˜¿é‡Œäº‘ å›¾ç‰‡èµ„æºä½¿ç”¨é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨OSSï¼Œé™æ€é¡µé¢è¿ç§»åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ã€‚ GitPagesæ‰˜ç®¡æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦æœ‰ç‚¹æ…¢ï¼Œè¿˜ç®—èƒ½æ¥å—å§ã€‚æœåŠ¡å™¨æœ‰ã€åŸŸåæœ‰ï¼ˆæ—§çš„åŸŸåä¸å¤ªå–œæ¬¢ï¼Œæ–°åŸŸåå¤‡æ¡ˆå®Œæˆè¿˜å¾—å‡ å¤©ï¼‰ï¼Œæœ€ç»ˆå†³å®šè¿ç§»åˆ°é˜¿é‡Œäº‘ã€‚éƒ¨ç½²ï¼šæœåŠ¡å™¨å®‰è£…docker -\u003e dockerå®‰è£…nginx -\u003e å®‰è£…git -\u003e å°†hugoç”Ÿæˆçš„htmlæ–‡ä»¶æ‹‰å–åˆ°nginxè·¯ç”±çš„ç›®å½•ä¸‹ï¼Œéƒ¨ç½²å®Œæˆã€‚ è¿ç§»åˆ°é˜¿é‡Œäº‘åçš„æ„Ÿå—ï¼šä¸å¡äº†ï¼Œemmâ€¦ä¸æ»‘ã€‚å—¯ï¼Œä¹Ÿæ”¶è´¹äº†ã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:6","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"è‡ªåŠ¨éƒ¨ç½² ä½¿ç”¨Githubçš„WebHooksï¼ŒæœåŠ¡å™¨å†™ä¸€ä¸ªè„šæœ¬å³å¯ã€‚ æµç¨‹å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­ï¼šå½“pushä»£ç åˆ°githubæ—¶ï¼Œè§¦å‘å›è°ƒæ¥å£ã€‚åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²ä¸€ä¸ªwebé¡¹ç›®ï¼ˆæˆ‘ä½¿ç”¨çš„springbootï¼‰ï¼Œæš´éœ²ä¸€ä¸ªæ¥å£ä¾›webhooksè°ƒç”¨ã€‚æ¥å£å†…å®¹æ˜¯å¼‚æ­¥æ–¹å¼ï¼ˆä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼‰æ‰§è¡Œshellè„šæœ¬ï¼Œå®Œæˆè‡ªåŠ¨éƒ¨ç½²ã€‚ æ›´è½»é‡çš„æ–¹å¼ï¼Œæ‰‹å†™ä»£ç ï¼Œä½¿ç”¨socketæ¥æ”¶è¯·æ±‚ï¼Œæ‰§è¡Œè„šæœ¬æ›´åŠ é«˜æ•ˆã€‚httpæ¥å£æ–¹å¼å†™èµ·æ¥æ¯”è¾ƒå¿«ï¼Œåå¤šåˆ†é’Ÿå®Œäº‹ã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:7","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"åŸŸåå¤‡æ¡ˆ wlz922.topæ˜¯æˆ‘ä¸€ç›´ä½¿ç”¨çš„åŸŸåï¼ŒåŸŸåå¤‡æ¡ˆç›¸å¯¹éº»çƒ¦ï¼Œæ€è™‘å†ä¸‰è¿˜æ˜¯å†³å®šå†æ³¨å†Œä¸€ä¸ªã€‚ æ–°åŸŸåwlizhi.ccå®¡æ ¸ä¼°è®¡è¿˜å¾—å‡ å¤©ã€‚ å¤‡æ¡ˆæµç¨‹æœ‰ç‚¹éº»çƒ¦ï¼Œå‘¨æœŸæ˜¯æ¯”è¾ƒé•¿çš„ï¼ˆåˆ°åŸŸåæœåŠ¡å•†æ³¨å†Œ -\u003e é˜¿é‡Œäº‘åˆå®¡ -\u003e é€šç®¡å±€å®¡æ ¸ï¼‰ã€‚ é¦–å…ˆæ³¨å†ŒåŸŸåï¼Œæ³¨å†Œåæ˜¯ä¸èƒ½ç›´æ¥å¤‡æ¡ˆçš„ï¼Œè¦ç­‰1-3å¤©ã€‚ç„¶åç”³è¯·å¤‡æ¡ˆï¼Œå¡«ä¸€äº›å¿…é¡»çš„èµ„æ–™ã€‚é˜¿é‡Œäº‘å…³äºå¤‡æ¡ˆç›¸å…³èµ„æ–™å¤ªå¤šï¼Œæ²¡çœ‹ï¼Œç›´æ¥æŒ‰ç…§æµç¨‹æç¤ºå¡«å†™èµ„æ–™ã€‚ä¹‹ååˆå®¡é©³å›ä¸€æ¬¡ï¼ˆéªŒè¯èµ„æ–™ä¸è§„èŒƒï¼‰ï¼ŒæŒ‰è¦æ±‚é‡æ–°ä¸Šä¼ èµ„æ–™ï¼Œåˆå®¡é€šè¿‡ï¼Œç­‰å¾…ç®¡å±€å®¡æ ¸ã€‚ æœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜ï¼ŒåŸŸåå¤‡æ¡ˆæ—¶ï¼Œè§£æçš„ç½‘ç«™é¦–é¡µå¿…é¡»å’Œèµ„æ–™å¡«å†™çš„å†…å®¹ä¸€è‡´ï¼Œé¡µè„šå¿…é¡»æœ‰å¤‡æ¡ˆå·é“¾æ¥åˆ° å·¥ä¿¡éƒ¨åŸŸåå¤‡æ¡ˆç®¡ç† ç½‘ç«™ï¼ˆæˆ‘ä¸Šä¸ªåŸŸåå¤‡æ¡ˆæ—¶è®©å¡«çš„ä¸æ˜¯è¿™ä¸ªç½‘å€ï¼Œæä¸æ‡‚ï¼‰ã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:8","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["æŠ˜è…¾"],"content":"æœ€å çœ‹jekyllã€hugoæ–‡æ¡£ã€é€‰ä¸»é¢˜ã€è¯»ä¸»é¢˜åŠä¸»é¢˜æ”¯æŒå„ç§æ’ä»¶æ–‡æ¡£ã€è¿ç§»è‡³é˜¿é‡Œäº‘ã€‚å†æ—¶å››å¤©ï¼Œåšå®¢ä¸»é¢˜åŸºæœ¬é€‰å®šï¼ˆä¸»é¢˜é€‰äº†ä¸¤å¤©å¤šï¼Œæ¢äº†äº”å…­ä¸ªã€‚å¼ºè¿«ç—‡ï¼Œæ€»æƒ³æ‰¾ä¸ªæ›´å¥½çš„ï¼‰ã€æ­å»ºå®Œæˆã€‚æ²¡äº‹è¿˜æ˜¯è¦ç ”ç©¶ä¸€ä¸‹hugoï¼ŒæŠ˜è…¾å·²æˆæœ¬èƒ½ã€‚ ","date":"2020-11-19","objectID":"/posts/experience/my-blog-building-process/:0:9","tags":["åšå®¢","hugo"],"title":"æˆ‘çš„åšå®¢æ­å»ºå†ç¨‹","uri":"/posts/experience/my-blog-building-process/"},{"categories":["ç³»ç»Ÿ"],"content":"linux åŸºç¡€æ¦‚å¿µã€æ–‡ä»¶ç³»ç»Ÿç»„æˆã€å¸¸ç”¨å‘½ä»¤ã€åº”ç”¨å®‰è£… - å¸è½½","date":"2020-11-18","objectID":"/posts/linux/linux-basics/","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"å‰è¨€ å¯¹ Peter å¤§ä½¬çš„ç¦»çº¿ç¬”è®°çš„è½¬è½½ï¼Œç”±äºæ–‡æ¡£æ˜¯ç¦»çº¿çš„ï¼Œæ²¡æœ‰é“¾æ¥ã€‚ æ­¤æ–‡å¯ä»¥ä½œä¸ºæ¡Œæ¡ˆæ–‡æ¡£ä¿ç•™ï¼Œä¸€äº›ä¸å¸¸ç”¨å‘½ä»¤å¿˜è®°æ—¶ï¼Œå¯åšæŸ¥è¯¢ä½¿ç”¨ã€‚ ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:1:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"1. åŸºç¡€ä»‹ç» Linux æ˜¯ä¸€å¥—å…è´¹ä½¿ç”¨å’Œè‡ªç”±ä¼ æ’­çš„ç±» Unix æ“ä½œç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªåŸºäº POSIX å’Œ UNIX çš„å¤šç”¨æˆ·ã€å¤šä»»åŠ¡ã€æ”¯æŒå¤šçº¿ç¨‹å’Œå¤š CPU çš„æ“ä½œç³»ç»Ÿã€‚ ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:2:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"å‘è¡Œçš„linuxç‰ˆæœ¬ Linux çš„å‘è¡Œç‰ˆè¯´ç®€å•ç‚¹å°±æ˜¯å°† Linux å†…æ ¸ä¸åº”ç”¨è½¯ä»¶åšä¸€ä¸ªæ‰“åŒ…ã€‚å¸‚é¢ä¸Šè¾ƒçŸ¥åçš„å‘è¡Œç‰ˆæœ‰ï¼šUbuntuã€RedHatã€CentOSã€Debianã€Fedoraã€SuSEã€OpenSUSEã€Arch Linuxã€SolusOS linuxå„ä¸ªç‰ˆæœ¬\"\rlinuxå„ä¸ªç‰ˆæœ¬\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:2:1","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"ç³»ç»Ÿç›®å½•ç»“æ„ linuxç›®å½•ç»“æ„\"\rlinuxç›®å½•ç»“æ„\r ç³»ç»Ÿå¯åŠ¨å¿…é¡»ï¼š ä¿¡æ¯\r\r /bootï¼šå­˜æ”¾çš„å¯åŠ¨Linux æ—¶ä½¿ç”¨çš„å†…æ ¸æ–‡ä»¶ï¼ŒåŒ…æ‹¬è¿æ¥æ–‡ä»¶ä»¥åŠé•œåƒæ–‡ä»¶ã€‚ /etcï¼šå­˜æ”¾æ‰€æœ‰çš„ç³»ç»Ÿéœ€è¦çš„é…ç½®æ–‡ä»¶å’Œå­ç›®å½•åˆ—è¡¨ï¼Œæ›´æ”¹ç›®å½•ä¸‹çš„æ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿä¸èƒ½å¯åŠ¨ã€‚ /libï¼šå­˜æ”¾åŸºæœ¬ä»£ç åº“ï¼ˆæ¯”å¦‚c++åº“ï¼‰ï¼Œå…¶ä½œç”¨ç±»ä¼¼äºWindowsé‡Œçš„DLLæ–‡ä»¶ã€‚å‡ ä¹æ‰€æœ‰çš„åº”ç”¨ç¨‹åºéƒ½éœ€è¦ç”¨åˆ°è¿™äº›å…±äº«åº“ã€‚ /sysï¼š è¿™æ˜¯linux2.6å†…æ ¸çš„ä¸€ä¸ªå¾ˆå¤§çš„å˜åŒ–ã€‚è¯¥ç›®å½•ä¸‹å®‰è£…äº†2.6å†…æ ¸ä¸­æ–°å‡ºç°çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ sysfs ã€‚sysfsæ–‡ä»¶ç³»ç»Ÿé›†æˆäº†ä¸‹é¢3ç§æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ï¼šé’ˆå¯¹è¿›ç¨‹ä¿¡æ¯çš„procæ–‡ä»¶ç³»ç»Ÿã€é’ˆå¯¹è®¾å¤‡çš„devfsæ–‡ä»¶ç³»ç»Ÿä»¥åŠé’ˆå¯¹ä¼ªç»ˆç«¯çš„devptsæ–‡ä»¶ç³»ç»Ÿã€‚è¯¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å†…æ ¸è®¾å¤‡æ ‘çš„ä¸€ä¸ªç›´è§‚åæ˜ ã€‚å½“ä¸€ä¸ªå†…æ ¸å¯¹è±¡è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œå¯¹åº”çš„æ–‡ä»¶å’Œç›®å½•ä¹Ÿåœ¨å†…æ ¸å¯¹è±¡å­ç³»ç»Ÿä¸­ \r\r æŒ‡ä»¤é›†åˆï¼š ä¿¡æ¯\r\r /binï¼šå­˜æ”¾ç€æœ€å¸¸ç”¨çš„ç¨‹åºå’ŒæŒ‡ä»¤ /sbinï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜èƒ½ä½¿ç”¨çš„ç¨‹åºå’ŒæŒ‡ä»¤ã€‚ \r\r å¤–éƒ¨æ–‡ä»¶ç®¡ç†ï¼š ä¿¡æ¯\r\r /dev ï¼šDevice(è®¾å¤‡)çš„ç¼©å†™, å­˜æ”¾çš„æ˜¯Linuxçš„å¤–éƒ¨è®¾å¤‡ã€‚æ³¨æ„ï¼šåœ¨Linuxä¸­è®¿é—®è®¾å¤‡å’Œè®¿é—®æ–‡ä»¶çš„æ–¹å¼æ˜¯ç›¸åŒçš„ã€‚ /mediaï¼šç±»windowsçš„å…¶ä»–è®¾å¤‡ï¼Œä¾‹å¦‚Uç›˜ã€å…‰é©±ç­‰ç­‰ï¼Œè¯†åˆ«ålinuxä¼šæŠŠè®¾å¤‡æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚ /mntï¼šä¸´æ—¶æŒ‚è½½åˆ«çš„æ–‡ä»¶ç³»ç»Ÿçš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…‰é©±æŒ‚è½½åœ¨/mnt/ä¸Šï¼Œç„¶åè¿›å…¥è¯¥ç›®å½•å°±å¯ä»¥æŸ¥çœ‹å…‰é©±é‡Œçš„å†…å®¹äº†ã€‚ \r\r ä¸´æ—¶æ–‡ä»¶ ä¿¡æ¯\r\r /runï¼šæ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼Œå­˜å‚¨ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„ä¿¡æ¯ã€‚å½“ç³»ç»Ÿé‡å¯æ—¶ï¼Œè¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶åº”è¯¥è¢«åˆ æ‰æˆ–æ¸…é™¤ã€‚å¦‚æœä½ çš„ç³»ç»Ÿä¸Šæœ‰ /var/run ç›®å½•ï¼Œåº”è¯¥è®©å®ƒæŒ‡å‘ runã€‚ /lost+foundï¼šä¸€èˆ¬æƒ…å†µä¸‹ä¸ºç©ºçš„ï¼Œç³»ç»Ÿéæ³•å…³æœºåï¼Œè¿™é‡Œå°±å­˜æ”¾ä¸€äº›æ–‡ä»¶ã€‚ /tmpï¼šè¿™ä¸ªç›®å½•æ˜¯ç”¨æ¥å­˜æ”¾ä¸€äº›ä¸´æ—¶æ–‡ä»¶çš„ã€‚ \r\r è´¦æˆ·ï¼š ä¿¡æ¯\r\r /rootï¼šç³»ç»Ÿç®¡ç†å‘˜çš„ç”¨æˆ·ä¸»ç›®å½•ã€‚ /homeï¼šç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œä»¥ç”¨æˆ·çš„è´¦å·å‘½åçš„ã€‚ /usrï¼šç”¨æˆ·çš„å¾ˆå¤šåº”ç”¨ç¨‹åºå’Œæ–‡ä»¶éƒ½æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œç±»ä¼¼äºwindowsä¸‹çš„program filesç›®å½•ã€‚ /usr/binï¼šç³»ç»Ÿç”¨æˆ·ä½¿ç”¨çš„åº”ç”¨ç¨‹åºä¸æŒ‡ä»¤ã€‚ /usr/sbinï¼šè¶…çº§ç”¨æˆ·ä½¿ç”¨çš„æ¯”è¾ƒé«˜çº§çš„ç®¡ç†ç¨‹åºå’Œç³»ç»Ÿå®ˆæŠ¤ç¨‹åºã€‚ /usr/srcï¼šå†…æ ¸æºä»£ç é»˜è®¤çš„æ”¾ç½®ç›®å½•ã€‚ \r\r è¿è¡Œè¿‡ç¨‹ä¸­è¦ç”¨ï¼š ä¿¡æ¯\r\r /varï¼šå­˜æ”¾ç»å¸¸ä¿®æ”¹çš„æ•°æ®ï¼Œæ¯”å¦‚ç¨‹åºè¿è¡Œçš„æ—¥å¿—æ–‡ä»¶ï¼ˆ/var/log ç›®å½•ä¸‹ï¼‰ã€‚ /procï¼šç®¡ç†å†…å­˜ç©ºé—´ï¼è™šæ‹Ÿçš„ç›®å½•ï¼Œæ˜¯ç³»ç»Ÿå†…å­˜çš„æ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®è¿™ä¸ªç›®å½•æ¥ï¼Œè·å–ç³»ç»Ÿä¿¡æ¯ã€‚è¿™ä¸ªç›®å½•çš„å†…å®¹ä¸åœ¨ç¡¬ç›˜ä¸Šè€Œæ˜¯åœ¨å†…å­˜é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹é‡Œé¢çš„æŸäº›æ–‡ä»¶æ¥åšä¿®æ”¹ã€‚ \r\r æ‰©å±•ç”¨çš„ï¼š ä¿¡æ¯\r\r /optï¼šé»˜è®¤æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬å®‰è£…é¢å¤–è½¯ä»¶å¯ä»¥æ”¾åœ¨è¿™ä¸ªé‡Œé¢ã€‚ /srvï¼šå­˜æ”¾æœåŠ¡å¯åŠ¨åéœ€è¦æå–çš„æ•°æ®ï¼ˆä¸ç”¨æœåŠ¡å™¨å°±æ˜¯ç©ºï¼‰ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:2:2","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"linuxåŸºç¡€å‘½ä»¤ shutdown ä¼šç»™ç³»ç»Ÿè®¡åˆ’ä¸€ä¸ªæ—¶é—´å…³æœºã€‚å®ƒå¯ä»¥è¢«ç”¨äºåœæ­¢ã€å…³æœºã€é‡å¯æœºå™¨ã€‚shutdown ä¼šç»™ç³»ç»Ÿè®¡åˆ’ä¸€ä¸ªæ—¶é—´å…³æœºã€‚å®ƒå¯ä»¥è¢«ç”¨äºåœæ­¢ã€å…³æœºã€é‡å¯æœºå™¨ã€‚ ä¿¡æ¯\r\r# shutdown -P now ### å…³é—­æœºå™¨ # shutdown -H now ### åœæ­¢æœºå™¨ # shutdown -r 09:35 ### åœ¨ 09:35am é‡å¯æœºå™¨\r\r è¦å–æ¶ˆå³å°†è¿›è¡Œçš„å…³æœºï¼Œåªè¦è¾“å…¥å‘½ä»¤ï¼š # shutdown -c halt å‘½ä»¤é€šçŸ¥ç¡¬ä»¶æ¥åœæ­¢æ‰€æœ‰çš„ CPU åŠŸèƒ½ï¼Œä½†æ˜¯ä»ç„¶ä¿æŒé€šç”µã€‚ä½ å¯ä»¥ç”¨å®ƒä½¿ç³»ç»Ÿå¤„äºä½å±‚ç»´æŠ¤çŠ¶æ€ã€‚æ³¨æ„åœ¨æœ‰äº›æƒ…å†µä¼šå®ƒä¼šå®Œå…¨å…³é—­ç³»ç»Ÿã€‚ ä¿¡æ¯\r\r# halt ### åœæ­¢æœºå™¨ # halt -p ### å…³é—­æœºå™¨ # halt â€“reboot ### é‡å¯æœºå™¨\r\r poweroff ä¼šå‘é€ä¸€ä¸ª ACPI ä¿¡å·æ¥é€šçŸ¥ç³»ç»Ÿå…³æœºã€‚ ä¿¡æ¯\r\r# poweroff ### å…³é—­æœºå™¨ # poweroff â€“halt ### åœæ­¢æœºå™¨ # poweroff â€“reboot ### é‡å¯æœºå™¨\r\r reboot å‘½ä»¤ reboot é€šçŸ¥ç³»ç»Ÿé‡å¯ã€‚ ä¿¡æ¯\r\r# reboot ### é‡å¯æœºå™¨ # reboot â€“halt ### åœæ­¢æœºå™¨ # reboot -p ### å…³é—­æœºå™¨\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:2:3","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"2. linuxç”¨æˆ·/ç”¨æˆ·ç»„ Linuxç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤šç”¨æˆ·å¤šä»»åŠ¡çš„åˆ†æ—¶æ“ä½œç³»ç»Ÿï¼Œä»»ä½•ä¸€ä¸ªè¦ä½¿ç”¨ç³»ç»Ÿèµ„æºçš„ç”¨æˆ·ï¼Œéƒ½å¿…é¡»é¦–å…ˆå‘ç³»ç»Ÿç®¡ç†å‘˜ç”³è¯·ä¸€ä¸ªè´¦å·ï¼Œç„¶åä»¥è¿™ä¸ªè´¦å·çš„èº«ä»½è¿›å…¥ç³»ç»Ÿã€‚ ç”¨æˆ·è´¦å·çš„ç®¡ç†å·¥ä½œä¸»è¦æ¶‰åŠåˆ°ç”¨æˆ·è´¦å·çš„æ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤ã€‚ ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"å¢åŠ ä¸€ä¸ªç”¨æˆ·ç»„ ä¿¡æ¯\r\rgroupadd é€‰é¡¹ ç”¨æˆ·ç»„ å¯ä»¥ä½¿ç”¨çš„é€‰é¡¹æœ‰ï¼š -g GID æŒ‡å®šæ–°ç”¨æˆ·ç»„çš„ç»„æ ‡è¯†å·ï¼ˆGIDï¼‰ã€‚ -o ä¸€èˆ¬ä¸-gé€‰é¡¹åŒæ—¶ä½¿ç”¨ï¼Œè¡¨ç¤ºæ–°ç”¨æˆ·ç»„çš„GIDå¯ä»¥ä¸ç³»ç»Ÿå·²æœ‰ç”¨æˆ·ç»„çš„GIDç›¸åŒã€‚ ä¾‹1ï¼š # groupadd group1 ##æ­¤å‘½ä»¤å‘ç³»ç»Ÿä¸­å¢åŠ äº†ä¸€ä¸ªæ–°ç»„group1 ä¾‹2ï¼š # groupadd -g 1003 group2 ##æ­¤å‘½ä»¤å‘ç³»ç»Ÿä¸­å¢åŠ äº†ä¸€ä¸ªæ–°ç»„group2ï¼ŒåŒæ—¶æŒ‡å®šæ–°ç»„çš„ç»„æ ‡è¯†å·æ˜¯1003 \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:1","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"åˆ é™¤ä¸€ä¸ªç”¨æˆ·ç»„ ä¿¡æ¯\r\rgroupdel ç”¨æˆ·ç»„ ä¾‹ï¼š# groupdel group1 ##æ­¤å‘½ä»¤ä»ç³»ç»Ÿä¸­åˆ é™¤ç»„group1ã€‚ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:2","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"ä¿®æ”¹ç”¨æˆ·ç»„çš„å±æ€§ ä¿¡æ¯\r\rgroupmod é€‰é¡¹ ç”¨æˆ·ç»„ å¸¸ç”¨çš„é€‰é¡¹æœ‰ï¼š -g GID ä¸ºç”¨æˆ·ç»„æŒ‡å®šæ–°çš„ç»„æ ‡è¯†å·ã€‚ -o ä¸-gé€‰é¡¹åŒæ—¶ä½¿ç”¨ï¼Œç”¨æˆ·ç»„çš„æ–°GIDå¯ä»¥ä¸ç³»ç»Ÿå·²æœ‰ç”¨æˆ·ç»„çš„GIDç›¸åŒã€‚ -n æ–°ç”¨æˆ·ç»„ å°†ç”¨æˆ·ç»„çš„åå­—æ”¹ä¸ºæ–°åå­— ä¾‹1ï¼š # groupmod â€“g 10000 -n group3 group2 ##æ­¤å‘½ä»¤å°†ç»„group2çš„æ ‡è¯†å·æ”¹ä¸º10000ï¼Œç»„åä¿®æ”¹ä¸ºgroup3ã€‚ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:3","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"æ·»åŠ ç”¨æˆ·è´¦å· ä¿¡æ¯\r\rå‚æ•°è¯´æ˜ï¼š é€‰é¡¹: -c comment æŒ‡å®šä¸€æ®µæ³¨é‡Šæ€§æè¿°ã€‚ -d ç›®å½• æŒ‡å®šç”¨æˆ·ä¸»ç›®å½•ï¼Œå¦‚æœæ­¤ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åŒæ—¶ä½¿ç”¨-mé€‰é¡¹ï¼Œå¯ä»¥åˆ›å»ºä¸»ç›®å½•ã€‚ -g ç”¨æˆ·ç»„ æŒ‡å®šç”¨æˆ·æ‰€å±çš„ç”¨æˆ·ç»„ã€‚ -G ç”¨æˆ·ç»„ï¼Œç”¨æˆ·ç»„ æŒ‡å®šç”¨æˆ·æ‰€å±çš„é™„åŠ ç»„ã€‚ -s Shellæ–‡ä»¶ æŒ‡å®šç”¨æˆ·çš„ç™»å½•Shellã€‚ -u ç”¨æˆ·å· æŒ‡å®šç”¨æˆ·çš„ç”¨æˆ·å·ï¼Œå¦‚æœåŒæ—¶æœ‰-oé€‰é¡¹ï¼Œåˆ™å¯ä»¥é‡å¤ä½¿ç”¨å…¶ä»–ç”¨æˆ·çš„æ ‡è¯†å·ã€‚ ç”¨æˆ·å: æŒ‡å®šæ–°è´¦å·çš„ç™»å½•åã€‚ useradd é€‰é¡¹ ç”¨æˆ·å ä¾‹1ï¼š # useradd â€“d /usr/peter -m peter ##åˆ›å»ºç”¨æˆ·peterï¼Œå…¶ä¸­-då’Œ-mé€‰é¡¹ç”¨æ¥ä¸ºç™»å½•åpeteräº§ç”Ÿä¸€ä¸ªä¸»ç›®å½•/usr/peterã€‚ ä¾‹2ï¼š # useradd -s /bin/sh -g group1 â€“G group2,root peter2 ##æ–°å»ºç”¨æˆ·peter2ï¼Œç™»å½•Shellæ˜¯ /bin/shï¼Œå±äºgroup1ï¼Œåˆå±äºgroup2å’Œrootã€‚ è¿™é‡Œå¯èƒ½æ–°å»ºç»„ï¼š#groupadd group1åŠgroupadd group2 å¢åŠ ç”¨æˆ·è´¦å·å°±æ˜¯åœ¨/etc/passwdæ–‡ä»¶ä¸­ä¸ºæ–°ç”¨æˆ·å¢åŠ ä¸€æ¡è®°å½•ï¼ŒåŒæ—¶æ›´æ–°å…¶ä»–ç³»ç»Ÿæ–‡ä»¶å¦‚/etc/shadow, /etc/groupç­‰ã€‚ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:4","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"åˆ é™¤è´¦å· ä¿¡æ¯\r\r userdel é€‰é¡¹ ç”¨æˆ·å å¸¸ç”¨çš„é€‰é¡¹æ˜¯ -rï¼Œå®ƒçš„ä½œç”¨æ˜¯æŠŠç”¨æˆ·çš„ä¸»ç›®å½•ä¸€èµ·åˆ é™¤ã€‚ ä¾‹å¦‚ï¼š # userdel -r peter2 ##åˆ é™¤ç”¨æˆ·peter2ï¼ˆä¸»è¦æ˜¯/etc/passwd, /etc/shadow, /etc/groupç­‰ï¼‰çš„è®°å½•ï¼ŒåŒæ—¶åˆ é™¤ç”¨æˆ·çš„ä¸»ç›®å½•ã€‚ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:5","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"ä¿®æ”¹è´¦å· ä¿¡æ¯\r\rusermod é€‰é¡¹ ç”¨æˆ·å å¸¸ç”¨çš„é€‰é¡¹åŒ…æ‹¬-c, -d, -m, -g, -G, -s, -uä»¥åŠ-oç­‰ï¼Œè¿™äº›é€‰é¡¹çš„æ„ä¹‰ä¸useraddå‘½ä»¤ä¸­çš„é€‰é¡¹ä¸€æ ·ï¼Œå¯ä»¥ä¸ºç”¨æˆ·æŒ‡å®šæ–°çš„èµ„æºå€¼ã€‚ ä¾‹å¦‚ï¼š # usermod -s /bin/sh -d /home/p â€“g group2 peter ##å°†ç”¨æˆ·peterçš„ç™»å½•Shellä¿®æ”¹ä¸ºshï¼Œä¸»ç›®å½•æ”¹ä¸º/home/pï¼Œç”¨æˆ·ç»„æ”¹ä¸ºgroup2ã€‚ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:6","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"ç”¨æˆ·å£ä»¤çš„ç®¡ç† ç”¨æˆ·è´¦å·åˆšåˆ›å»ºæ—¶æ²¡æœ‰å£ä»¤ï¼Œä½†æ˜¯è¢«ç³»ç»Ÿé”å®šï¼Œæ— æ³•ä½¿ç”¨ï¼Œå¿…é¡»ä¸ºå…¶æŒ‡å®šå£ä»¤åæ‰å¯ä»¥ä½¿ç”¨ï¼Œå³ä½¿æ˜¯æŒ‡å®šç©ºå£ä»¤ã€‚ ä¿¡æ¯\r\rpasswd é€‰é¡¹ ç”¨æˆ·å å¯ä½¿ç”¨çš„é€‰é¡¹ï¼š -l é”å®šå£ä»¤ï¼Œå³ç¦ç”¨è´¦å·ã€‚ -u å£ä»¤è§£é”ã€‚ -d ä½¿è´¦å·æ— å£ä»¤ã€‚ -f å¼ºè¿«ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¿®æ”¹å£ä»¤ã€‚\r\r å¦‚æœé»˜è®¤ç”¨æˆ·åï¼Œåˆ™ä¿®æ”¹å½“å‰ç”¨æˆ·çš„å£ä»¤ã€‚ä¾‹å¦‚ï¼Œå‡è®¾å½“å‰ç”¨æˆ·æ˜¯peterï¼Œåˆ™ä¸‹é¢çš„å‘½ä»¤ä¿®æ”¹è¯¥ç”¨æˆ·è‡ªå·±çš„å£ä»¤ï¼š ä¿¡æ¯\r\r$ passwd Old password:****** New password:******* Re-enter new password:*******\r\r å¦‚æœæ˜¯è¶…çº§ç”¨æˆ·ï¼Œå¯ä»¥ç”¨ä¸‹åˆ—å½¢å¼æŒ‡å®šä»»ä½•ç”¨æˆ·çš„å£ä»¤ï¼š ä¿¡æ¯\r\r# passwd peter New password:******* Re-enter new password:*******\r\r ä¸ºç”¨æˆ·æŒ‡å®šç©ºå£ä»¤æ—¶ï¼Œæ‰§è¡Œä¸‹åˆ—å½¢å¼çš„å‘½ä»¤ï¼š# passwd -d peter passwdå‘½ä»¤è¿˜å¯ä»¥ç”¨-l(lock)é€‰é¡¹é”å®šæŸä¸€ç”¨æˆ·ï¼Œä½¿å…¶ä¸èƒ½ç™»å½•ï¼Œä¾‹å¦‚ï¼š# passwd -l peter ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:7","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"åˆ‡æ¢ç”¨æˆ·ç»„ ä¿¡æ¯\r\r$ newgrp root è¿™æ¡å‘½ä»¤å°†å½“å‰ç”¨æˆ·åˆ‡æ¢åˆ°rootç”¨æˆ·ç»„ï¼Œå‰ææ¡ä»¶æ˜¯rootç”¨æˆ·ç»„ç¡®å®æ˜¯è¯¥ç”¨æˆ·çš„ä¸»ç»„æˆ–é™„åŠ ç»„ã€‚ç±»ä¼¼äºç”¨æˆ·è´¦å·çš„ç®¡ç†ï¼Œç”¨æˆ·ç»„çš„ç®¡ç†ä¹Ÿå¯ä»¥é€šè¿‡é›†æˆçš„ç³»ç»Ÿç®¡ç†å·¥å…·æ¥å®Œæˆã€‚\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:8","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"ä¸ç”¨æˆ·è´¦å·æœ‰å…³çš„ç³»ç»Ÿæ–‡ä»¶ ä¸ç”¨æˆ·å’Œç”¨æˆ·ç»„ç›¸å…³çš„ä¿¡æ¯éƒ½å­˜æ”¾åœ¨ä¸€äº›ç³»ç»Ÿæ–‡ä»¶ä¸­ï¼Œè¿™äº›æ–‡ä»¶åŒ…æ‹¬/etc/passwd, /etc/shadow, /etc/groupç­‰ /etc/passwdæ–‡ä»¶ Linuxç³»ç»Ÿä¸­çš„æ¯ä¸ªç”¨æˆ·éƒ½åœ¨/etc/passwdæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªå¯¹åº”çš„è®°å½•è¡Œï¼Œå®ƒè®°å½•äº†è¿™ä¸ªç”¨æˆ·çš„ä¸€äº›åŸºæœ¬å±æ€§ã€‚ ä¿¡æ¯\r\rä¾‹å­ï¼š ï¼ƒ cat /etc/passwd root:x:0:0:Superuser:/: daemon:x:1:1:System daemons:/etc: bin:x:2:2:Owner of system commands:/bin: sys:x:3:3:Owner of system files:/usr/sys: adm:x:4:4:System accounting:/usr/adm: uucp:x:5:5:UUCP administrator:/usr/lib/uucp: auth:x:7:21:Authentication administrator:/tcb/files/auth: cron:x:9:16:Cron daemon:/usr/spool/cron: listen:x:37:4:Network daemon:/usr/net/nls: lp:x:71:18:Printer administrator:/usr/spool/lp: \r\r æ¯ä¸€è¡Œè®°å½•å¯¹åº”ç€ä¸€ä¸ªç”¨æˆ·ï¼ˆå…¶ä¸­bin/sys/adm/uucp/lp/nobodyæ˜¯ä¼ªç”¨æˆ·ï¼‰ï¼Œæ¯è¡Œè®°å½•åˆè¢«å†’å·(:)åˆ†éš”ä¸º7ä¸ªå­—æ®µï¼Œå…¶æ ¼å¼å’Œå…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š ç”¨æˆ·å:å£ä»¤:ç”¨æˆ·æ ‡è¯†å·:ç»„æ ‡è¯†å·:æ³¨é‡Šæ€§æè¿°:ä¸»ç›®å½•:ç™»å½•Shell /etc/groupæ–‡ä»¶ ç”¨æˆ·ç»„çš„æ‰€æœ‰ä¿¡æ¯éƒ½å­˜æ”¾åœ¨/etc/groupæ–‡ä»¶ä¸­ã€‚ ä¿¡æ¯\r\rroot::0:root bin::2:root,bin sys::3:root,uucp adm::4:root,adm daemon::5:root,daemon lp::7:root,lp users::20:root,sam\r\r æ­¤æ–‡ä»¶çš„æ ¼å¼ç±»ä¼¼äº/etc/passwdæ–‡ä»¶ï¼Œç”±å†’å·(:)éš”å¼€è‹¥å¹²ä¸ªå­—æ®µï¼Œè¿™äº›å­—æ®µæœ‰ï¼š ç»„å:å£ä»¤:ç»„æ ‡è¯†å·:ç»„å†…ç”¨æˆ·åˆ—è¡¨ ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:3:9","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"3. æ–‡ä»¶ä¸ç›®å½• ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:4:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"æ–‡ä»¶åŸºæœ¬å±æ€§ 1. æ–‡ä»¶çš„å±æ€§æ¦‚è²Œ Lighthouse (image)\"\rLighthouse (image)\r ä¿¡æ¯\r\rç¬¬ä¸€ä¸ªå­—ç¬¦ï¼šä»£è¡¨è¿™ä¸ªæ–‡ä»¶çš„ç±»å‹ï¼Œæ˜¯ç›®å½•ã€æ–‡ä»¶ï¼Œè¿˜æ˜¯ä¸€ä¸ªé“¾æ¥ç­‰ç­‰ [ d ] ç›®å½• [ - ] æ–‡ä»¶ [ l ] é“¾æ¥æ–‡æ¡£(link file) [ b ] å¯ä¾›å‚¨å­˜çš„æ¥å£è®¾å¤‡(å¯éšæœºå­˜å–è£…ç½®) [ c ] ä¸²è¡Œç«¯å£è®¾å¤‡ï¼Œä¾‹å¦‚é”®ç›˜ã€é¼ æ ‡(ä¸€æ¬¡æ€§è¯»å–è£…ç½®) æ¥ä¸‹æ¥çš„å­—ç¬¦ï¼šä»¥ä¸‰ä¸ªä¸€ç»„åˆ†æˆä¸‰ç»„ï¼Œç”¨ rã€wã€x ä¸‰ä¸ªå‚æ•°çš„ç»„åˆè¡¨ç¤ºï¼Œä½ç½®ä¸ä¼šæ”¹å˜ [ r ] ä»£è¡¨å¯è¯»(read) [ w ] ä»£è¡¨å¯å†™(write) [ x ] ä»£è¡¨å¯æ‰§è¡Œ(execute) [ - ] æ²¡æœ‰æƒé™\r\r 2. æ–‡ä»¶çš„å±ä¸»ä¸å±ç»„ æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒéƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„æ‰€æœ‰è€…ï¼Œä¹Ÿå°±æ˜¯å¯¹è¯¥æ–‡ä»¶å…·æœ‰æ‰€æœ‰æƒçš„ç”¨æˆ·ã€‚ åŒæ—¶ï¼Œåœ¨Linuxç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ˜¯æŒ‰ç»„åˆ†ç±»çš„ï¼Œä¸€ä¸ªç”¨æˆ·å±äºä¸€ä¸ªæˆ–å¤šä¸ªç»„ã€‚ æ–‡ä»¶æ‰€æœ‰è€…ä»¥å¤–çš„ç”¨æˆ·åˆå¯ä»¥åˆ†ä¸ºæ–‡ä»¶æ‰€æœ‰è€…çš„åŒç»„ç”¨æˆ·å’Œå…¶ä»–ç”¨æˆ·ã€‚ å› æ­¤ï¼ŒLinuxç³»ç»ŸæŒ‰æ–‡ä»¶æ‰€æœ‰è€…ã€æ–‡ä»¶æ‰€æœ‰è€…åŒç»„ç”¨æˆ·å’Œå…¶ä»–ç”¨æˆ·æ¥è§„å®šäº†ä¸åŒçš„æ–‡ä»¶è®¿é—®æƒé™ã€‚ chgrpï¼šæ›´æ”¹æ–‡ä»¶å±ç»„ ä¿¡æ¯\r\rchgrp [-R] å±ç»„å æ–‡ä»¶å å‚æ•°é€‰é¡¹ -Rï¼šé€’å½’æ›´æ”¹æ–‡ä»¶å±ç»„ï¼Œå°±æ˜¯åœ¨æ›´æ”¹æŸä¸ªç›®å½•æ–‡ä»¶çš„å±ç»„æ—¶ï¼Œå¦‚æœåŠ ä¸Š-Rçš„å‚æ•°ï¼Œé‚£ä¹ˆè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶çš„å±ç»„éƒ½ä¼šæ›´æ”¹ã€‚\r\r chownï¼šæ›´æ”¹æ–‡ä»¶å±ä¸»ï¼Œä¹Ÿå¯ä»¥åŒæ—¶æ›´æ”¹æ–‡ä»¶å±ç»„ è¯­æ³•ï¼š chown [â€“R] å±ä¸»å æ–‡ä»¶å chown [-R] å±ä¸»åï¼šå±ç»„å æ–‡ä»¶å è¿›å…¥ /root ç›®å½•ï¼ˆ~ï¼‰å°†install.logçš„æ‹¥æœ‰è€…æ”¹ä¸ºbinè¿™ä¸ªè´¦å·ï¼š ä¾‹ï¼š chown root:root aa ##æ›´æ”¹aaçš„å±ä¸»ä¸å±ç»„ chmodï¼šæ›´æ”¹æ–‡ä»¶9ä¸ªå±æ€§ æ–‡ä»¶çš„æƒé™å­—ç¬¦ä¸ºï¼šã€-rwxrwxrwxã€ï¼Œ è¿™ä¹ä¸ªæƒé™æ˜¯ä¸‰ä¸ªä¸‰ä¸ªä¸€ç»„çš„ï¼å…¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°å­—æ¥ä»£è¡¨å„ä¸ªæƒé™ï¼Œå„æƒé™çš„åˆ†æ•°å¯¹ç…§è¡¨å¦‚ä¸‹ï¼š r:4 w:2 x:1 æ¯ç§èº«ä»½(owner/group/others)å„è‡ªçš„ä¸‰ä¸ªæƒé™(r/w/x)åˆ†æ•°æ˜¯éœ€è¦ç´¯åŠ çš„ï¼Œä¾‹å¦‚å½“æƒé™ä¸ºï¼š [-rwxrwxâ€”] åˆ†æ•°åˆ™æ˜¯ï¼š owner = rwx = 4+2+1 = 7 group = rwx = 4+2+1 = 7 others= â€” = 0+0+0 = 0 æ‰€ä»¥ç­‰ä¸€ä¸‹æˆ‘ä»¬è®¾å®šæƒé™çš„å˜æ›´æ—¶ï¼Œè¯¥æ–‡ä»¶çš„æƒé™æ•°å­—å°±æ˜¯770å•¦ï¼ å˜æ›´æƒé™çš„æŒ‡ä»¤chmodçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼š ä¿¡æ¯\r\r chmod [-R] xyz æ–‡ä»¶æˆ–ç›®å½• é€‰é¡¹ä¸å‚æ•°ï¼š xyz : å°±æ˜¯åˆšåˆšæåˆ°çš„æ•°å­—ç±»å‹çš„æƒé™å±æ€§ï¼Œä¸º rwx å±æ€§æ•°å€¼çš„ç›¸åŠ ã€‚ -R : è¿›è¡Œé€’å½’(recursive)çš„æŒç»­å˜æ›´ï¼Œäº¦å³è¿åŒæ¬¡ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šå˜æ›´ ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœè¦å°†.bashrcè¿™ä¸ªæ–‡ä»¶æ‰€æœ‰çš„æƒé™éƒ½è®¾å®šå¯ç”¨ï¼Œé‚£ä¹ˆå‘½ä»¤å¦‚ä¸‹ï¼š chmod +x aa ##æ›´æ”¹aaçš„å±æ€§,åŠ xæƒé™ chmod 777 aa ##æ›´æ”¹aaçš„å±æ€§ï¼Œä¸‰ç»„æƒé™éƒ½è®¾ç½®æˆ7 \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:4:1","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"æ–‡ä»¶ä¸ç›®å½•ç®¡ç†å‘½ä»¤ ä½¿ç”¨ man [å‘½ä»¤] æ¥æŸ¥çœ‹å„ä¸ªå‘½ä»¤çš„ä½¿ç”¨æ–‡æ¡£ï¼Œå¦‚ ï¼šman cp ä¿¡æ¯\r\rls: åˆ—å‡ºç›®å½• â€”ll cdï¼šåˆ‡æ¢ç›®å½• pwdï¼šæ˜¾ç¤ºç›®å‰çš„ç›®å½• mkdirï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½• rmdirï¼šåˆ é™¤ä¸€ä¸ªç©ºçš„ç›®å½• cp: å¤åˆ¶æ–‡ä»¶æˆ–ç›®å½• â€”â€“scpç½‘ç»œå¤åˆ¶ rm: ç§»é™¤æ–‡ä»¶æˆ–ç›®å½• mv: ç§»åŠ¨æ–‡ä»¶ä¸ç›®å½•ï¼Œæˆ–ä¿®æ”¹æ–‡ä»¶ä¸ç›®å½•çš„åç§°\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:4:2","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"ç¡¬é“¾æ¥ä¸è½¯é“¾æ¥ ç¡¬è¿æ¥ ä¿¡æ¯\r\rç¡¬è¿æ¥æŒ‡é€šè¿‡ç´¢å¼•èŠ‚ç‚¹æ¥è¿›è¡Œè¿æ¥ã€‚åœ¨ Linux çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¿å­˜åœ¨ç£ç›˜åˆ†åŒºä¸­çš„æ–‡ä»¶ä¸ç®¡æ˜¯ä»€ä¹ˆç±»å‹éƒ½ç»™å®ƒåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œç§°ä¸ºç´¢å¼•èŠ‚ç‚¹å·(Inode Index)ã€‚åœ¨ Linux ä¸­ï¼Œå¤šä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ç´¢å¼•èŠ‚ç‚¹æ˜¯å­˜åœ¨çš„ã€‚æ¯”å¦‚ï¼šA æ˜¯ B çš„ç¡¬é“¾æ¥ï¼ˆA å’Œ B éƒ½æ˜¯æ–‡ä»¶åï¼‰ï¼Œåˆ™ A çš„ç›®å½•é¡¹ä¸­çš„ inode èŠ‚ç‚¹å·ä¸ B çš„ç›®å½•é¡¹ä¸­çš„ inode èŠ‚ç‚¹å·ç›¸åŒï¼Œå³ä¸€ä¸ª inode èŠ‚ç‚¹å¯¹åº”ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶åï¼Œä¸¤ä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ï¼ŒA å’Œ B å¯¹æ–‡ä»¶ç³»ç»Ÿæ¥è¯´æ˜¯å®Œå…¨å¹³ç­‰çš„ã€‚åˆ é™¤å…¶ä¸­ä»»ä½•ä¸€ä¸ªéƒ½ä¸ä¼šå½±å“å¦å¤–ä¸€ä¸ªçš„è®¿é—®ã€‚ ç¡¬è¿æ¥çš„ä½œç”¨æ˜¯å…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªæœ‰æ•ˆè·¯å¾„åï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥å»ºç«‹ç¡¬è¿æ¥åˆ°é‡è¦æ–‡ä»¶ï¼Œä»¥é˜²æ­¢â€œè¯¯åˆ â€çš„åŠŸèƒ½ã€‚å…¶åŸå› å¦‚ä¸Šæ‰€è¿°ï¼Œå› ä¸ºå¯¹åº”è¯¥ç›®å½•çš„ç´¢å¼•èŠ‚ç‚¹æœ‰ä¸€ä¸ªä»¥ä¸Šçš„è¿æ¥ã€‚åªåˆ é™¤ä¸€ä¸ªè¿æ¥å¹¶ä¸å½±å“ç´¢å¼•èŠ‚ç‚¹æœ¬èº«å’Œå…¶å®ƒçš„è¿æ¥ï¼Œåªæœ‰å½“æœ€åä¸€ä¸ªè¿æ¥è¢«åˆ é™¤åï¼Œæ–‡ä»¶çš„æ•°æ®å—åŠç›®å½•çš„è¿æ¥æ‰ä¼šè¢«é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶çœŸæ­£åˆ é™¤çš„æ¡ä»¶æ˜¯ä¸ä¹‹ç›¸å…³çš„æ‰€æœ‰ç¡¬è¿æ¥æ–‡ä»¶å‡è¢«åˆ é™¤ã€‚\r\r è½¯è¿æ¥ ä¿¡æ¯\r\rå¦å¤–ä¸€ç§è¿æ¥ç§°ä¹‹ä¸ºç¬¦å·è¿æ¥ï¼ˆSymbolic Linkï¼‰ï¼Œä¹Ÿå«è½¯è¿æ¥ã€‚è½¯é“¾æ¥æ–‡ä»¶æœ‰ç±»ä¼¼äº Windows çš„å¿«æ·æ–¹å¼ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ã€‚åœ¨ç¬¦å·è¿æ¥ä¸­ï¼Œæ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«çš„æœ‰å¦ä¸€æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ã€‚æ¯”å¦‚ï¼šA æ˜¯ B çš„è½¯é“¾æ¥ï¼ˆA å’Œ B éƒ½æ˜¯æ–‡ä»¶åï¼‰ï¼ŒA çš„ç›®å½•é¡¹ä¸­çš„ inode èŠ‚ç‚¹å·ä¸ B çš„ç›®å½•é¡¹ä¸­çš„ inode èŠ‚ç‚¹å·ä¸ç›¸åŒï¼ŒA å’Œ B æŒ‡å‘çš„æ˜¯ä¸¤ä¸ªä¸åŒçš„ inodeï¼Œç»§è€ŒæŒ‡å‘ä¸¤å—ä¸åŒçš„æ•°æ®å—ã€‚ä½†æ˜¯ A çš„æ•°æ®å—ä¸­å­˜æ”¾çš„åªæ˜¯ B çš„è·¯å¾„åï¼ˆå¯ä»¥æ ¹æ®è¿™ä¸ªæ‰¾åˆ° B çš„ç›®å½•é¡¹ï¼‰ã€‚A å’Œ B ä¹‹é—´æ˜¯â€œä¸»ä»â€å…³ç³»ï¼Œå¦‚æœ B è¢«åˆ é™¤äº†ï¼ŒA ä»ç„¶å­˜åœ¨ï¼ˆå› ä¸ºä¸¤ä¸ªæ˜¯ä¸åŒçš„æ–‡ä»¶ï¼‰ï¼Œä½†æŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ— æ•ˆçš„é“¾æ¥ã€‚ ä¾‹ï¼š $touch a #åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶a $ ln a b #åˆ›å»ºaçš„ä¸€ä¸ªç¡¬è¿æ¥æ–‡ä»¶b â€“echo 123 \u003e a ##a,bçš„å†…å®¹åŒæ—¶å˜ä¸º123 $ ln -s a c #åˆ›å»ºaçš„ä¸€ä¸ªç¬¦å·è¿æ¥æ–‡ä»¶c $ ls -li # -iå‚æ•°æ˜¾ç¤ºæ–‡ä»¶çš„inodeèŠ‚ç‚¹ä¿¡æ¯ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:4:3","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"4. å®‰è£…ç¨‹åºrpm/yum ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:5:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"1. rpmæ–¹å¼ éœ€è¦å»ä¸‹è½½ç›¸åº”çš„rpmæ ¼å¼çš„å®‰è£…åŒ…xxxx.rpm ä¿¡æ¯\r\rrpm [å‚æ•°] rpmåŒ… -i å®‰è£… -U æ›´æ–°ï¼ˆå¾ˆå°‘ç”¨ï¼‰ -e å¸è½½ -v æ˜¾ç¤ºå®‰è£…ä¿¡æ¯ -h æ˜¾ç¤ºå®‰è£…è¿›åº¦ ä¾‹ï¼š rpm -ivh jdk-8u172-linux-x64.rpm å®‰è£…jdk8å¹¶æ˜¾ç¤ºå®‰è£…è¿›åº¦å’Œå®‰è£…ä¿¡æ¯ rpm -qa|grep jdkæŸ¥çœ‹jdkçš„å®‰è£…åŒ… rpm -e jdk1.8-1.8.0_221-fcs.x86_64 å¸è½½jdk8 ï¼Œåªé€‚ç”¨äºrpmåŒ…å®‰è£…çš„è½¯ä»¶\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:5:1","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"2. yumæ–¹å¼ yumï¼ˆ Yellow dog Updater, Modifiedï¼‰æ˜¯ä¸€ä¸ªåœ¨Fedoraå’ŒRedHatä»¥åŠSUSEä¸­çš„Shellå‰ç«¯è½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚ åŸºæ–¼RPMåŒ…ç®¡ç†ï¼Œèƒ½å¤Ÿä»æŒ‡å®šçš„æœåŠ¡å™¨è‡ªåŠ¨ä¸‹è½½RPMåŒ…å¹¶ä¸”å®‰è£…ï¼Œå¯ä»¥è‡ªåŠ¨å¤„ç†ä¾èµ–æ€§å…³ç³»ï¼Œå¹¶ä¸”ä¸€æ¬¡å®‰è£…æ‰€æœ‰ä¾èµ–çš„è½¯ä½“åŒ…ï¼Œæ— é¡»ç¹çåœ°ä¸€æ¬¡æ¬¡ä¸‹è½½ã€å®‰è£…ã€‚ yumæä¾›äº†æŸ¥æ‰¾ã€å®‰è£…ã€åˆ é™¤æŸä¸€ä¸ªã€ä¸€ç»„ç”šè‡³å…¨éƒ¨è½¯ä»¶åŒ…çš„å‘½ä»¤ï¼Œè€Œä¸”å‘½ä»¤ç®€æ´è€Œåˆå¥½è®°ã€‚ 2.1 yumè¯­æ³• ä¿¡æ¯\r\ryum [options] [command] [package â€¦] optionsï¼šå¯é€‰ï¼Œé€‰é¡¹åŒ…æ‹¬-hï¼ˆå¸®åŠ©ï¼‰ï¼Œ-yï¼ˆå½“å®‰è£…è¿‡ç¨‹æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º\"yes\"ï¼‰ï¼Œ-qï¼ˆä¸æ˜¾ç¤ºå®‰è£…çš„è¿‡ç¨‹ï¼‰ç­‰ç­‰ã€‚ commandï¼šè¦è¿›è¡Œçš„æ“ä½œã€‚ packageæ“ä½œçš„å¯¹è±¡ã€‚ ä¾‹ï¼š yum search jdk æœç´¢jdkå®‰è£…åŒ… yum install -y java-1.8.0-openjdk.x86_64 å®‰è£…openjdkï¼Œ-yè¡¨ç¤ºå®‰è£…è¿‡ç¨‹ä¸­çš„è¯¢é—®è‡ªåŠ¨é€‰y yum list installed ï½œgrep jdk åˆ—å‡ºå®‰è£…çš„jdkè½¯ä»¶åŒ… yum remove java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-headless.x86_64 å¸è½½jdk\r\r 2.2 yumå¸¸ç”¨å‘½ä»¤ ç¤ºä¾‹\r\r1.åˆ—å‡ºæ‰€æœ‰å¯æ›´æ–°çš„è½¯ä»¶æ¸…å•å‘½ä»¤ï¼šyum check-update 2.æ›´æ–°æ‰€æœ‰è½¯ä»¶å‘½ä»¤ï¼šyum update 3.ä»…å®‰è£…æŒ‡å®šçš„è½¯ä»¶å‘½ä»¤ï¼šyum install \u003cpackage_name\u003e 4.ä»…æ›´æ–°æŒ‡å®šçš„è½¯ä»¶å‘½ä»¤ï¼šyum update \u003cpackage_name\u003e 5.åˆ—å‡ºæ‰€æœ‰å¯å®‰è£çš„è½¯ä»¶æ¸…å•å‘½ä»¤ï¼šyum list 6.åˆ é™¤è½¯ä»¶åŒ…å‘½ä»¤ï¼šyum remove \u003cpackage_name\u003e 7.æŸ¥æ‰¾è½¯ä»¶åŒ… å‘½ä»¤ï¼šyum search 8.æ¸…é™¤ç¼“å­˜å‘½ä»¤: yum clean packages: æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹çš„è½¯ä»¶åŒ… yum clean headers: æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹çš„ headers yum clean oldheaders: æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹æ—§çš„ headers yum clean, yum clean all (= yum clean packages; yum clean oldheaders) :æ¸…é™¤ç¼“å­˜ç›®å½•ä¸‹çš„è½¯ä»¶åŒ…åŠæ—§çš„headers\r\r 2.3 yumæº å®˜æ–¹çš„yumæºåœ¨å›½å†…è®¿é—®æ•ˆæœä¸ä½³ã€‚éœ€è¦æ”¹ä¸ºå›½å†…æ¯”è¾ƒå¥½çš„é˜¿é‡Œäº‘æˆ–è€…ç½‘æ˜“çš„yumæº åœ¨/etc/yum..repos.d/ä¸‹è¿›è¡Œå¦‚ä¸‹æ“ä½œ(è¯·åšå¥½ç›¸åº”å¤‡ä»½)ï¼š ç¤ºä¾‹\r\rwget http://mirrors.163.com/.help/CentOS7-Base-163.repo mv CentOS7-Base-163.repo CentOS-Base.repo é‡å»ºç¼“å­˜ï¼š yum clean all yum makecache\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:5:2","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"3. é…ç½®ç¯å¢ƒå˜é‡ åœ¨Linuxç³»ç»Ÿä¸‹ï¼Œå®‰è£…åº”ç”¨ç¨‹åºåï¼Œåœ¨å®‰è£…ç›®å½•ä¹‹å¤–ï¼Œå¯èƒ½ä»ç„¶ä¼šå‡ºç° â€œcommand not found â€ã€‚ è¦è§£å†³æ‰€æœ‰åœ°æ–¹éƒ½èƒ½ä½¿ç”¨åº”ç”¨ç¨‹åºï¼Œå°±æ¶‰åŠåˆ°ç¯å¢ƒå˜é‡pathçš„è®¾ç½®é—®é¢˜ 3.1 é…ç½®ç¯å¢ƒå˜é‡ ç³»ç»Ÿç¯å¢ƒå˜é‡æ–‡ä»¶åœ¨/etcä¸‹çš„profileæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨vi profileå‘½ä»¤æ¥ç¼–è¾‘è¯¥æ–‡ä»¶ï¼Œå°†å˜é‡æ·»åŠ è¿›å» ä¸€èˆ¬éœ€è¦å°†å®‰è£…æ–‡ä»¶çš„binç›®å½•åŠ å…¥pathä¸­ï¼Œå¯åœ¨profileä¸­åŠ å…¥ä¸‹é¢ä¸€è¡Œä»£ç ï¼Œå¦‚ï¼š ç¤ºä¾‹\r\rvim /etc/profile # æœ«å°¾è¿½åŠ ä»¥ä¸‹å†…å®¹ export JAVA_HOME=/usr/java/default export PATH=$JAVA_HOME/bin:$PATH export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar\r\r 3.2 ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ source /etc/profile ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:5:3","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"5. shellè„šæœ¬ shellè¯­è¨€æ˜¯ä¸€é—¨linuxç³»ç»Ÿä¸‹çš„å·¥å…·è¯­è¨€ï¼Œä¸»è¦ç”¨äºå†™ä¸€äº›linuxç³»ç»Ÿä¸‹çš„æ“ä½œå‘½ä»¤ï¼Œå®é™…ä¸ŠShellæ˜¯ä¸€ä¸ªå‘½ä»¤è§£é‡Šå™¨ï¼Œå®ƒè§£é‡Šç”±ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å¹¶ä¸”æŠŠå®ƒä»¬é€åˆ°å†…æ ¸ã€‚æˆ–è€…ç›´æ¥ç†è§£ä¸ºshellå‘½ä»¤æ˜¯å¯ä»¥æ‰§è¡Œå¤šä¸ªlinuxå‘½ä»¤çš„è„šæœ¬ã€‚Shell ç§ç±»ä¼—å¤šï¼Œæœ‰ä»¥ä¸‹ç§ç±»ï¼ˆä¸€èˆ¬ä½¿ç”¨çš„ Bashï¼Œå°±æ˜¯ Bourne Again Shellï¼Œå®ƒæ˜¯å¤§å¤šæ•°Linux ç³»ç»Ÿé»˜è®¤çš„ Shellï¼‰ï¼š ç¤ºä¾‹\r\rBourne Shellï¼ˆ/usr/bin/shæˆ–/bin/shï¼‰ Bourne Again Shellï¼ˆ/bin/bashï¼‰ C Shellï¼ˆ/usr/bin/cshï¼‰ K Shellï¼ˆ/usr/bin/kshï¼‰ Shell for Rootï¼ˆ/sbin/shï¼‰\r\r shellå¹¶ä¸å¤æ‚ï¼Œæœ‰ç¼–ç¨‹åŸºç¡€çš„è¯ï¼Œç®€å•å…¥é—¨ä¸¤ä¸‰ä¸ªå°æ—¶å°±å¯ä»¥å…¥é—¨ï¼Œä¸»è¦æ˜¯æŠŠä¸€äº›é‡å¤æ“ä½œçš„linuxå‘½ä»¤å†™æˆshellè„šæœ¬æ¥æ‰§è¡Œä¸€ä¸‹ã€‚ä»¥ä¸‹åˆ—å‡ºshellå¸¸è§„çš„ä¸€äº›è¦ç´ ï¼š ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:6:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"1. è§£é‡Šå™¨ä¸æ‰§è¡Œshell ç¤ºä¾‹\r\rè§£é‡Šå™¨ #!/bin/sh Bourne shellç‰ˆæœ¬ #!/bin/bash Bourne Again Shell ç‰ˆæœ¬ æ‰§è¡Œshell chomd +x ./test.sh #ä½¿è„šæœ¬å…·æœ‰æ‰§è¡Œæƒé™ ./test.sh #æ‰§è¡Œè„šæœ¬ â€œ./â€è¡¨ç¤ºå½“å‰ç›®å½•ä¸‹\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:6:1","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"2. æ¼”ç¤º #!/bin/bash ##å£°æ˜bashè„šæœ¬ ##demo ##æ³¨é‡Š echo $PATH ##æ‰“å°PATHç¯å¢ƒå˜é‡ name=\"Peter\" ##å®šä¹‰å˜é‡name echo $name ##æ‰“å°nameå€¼ echo \"I am ${name}'s friend\" ##å­—ç¬¦ä¸²æ‹¼æ¥ echo \"\" name2=\"I am ${name}'s good friend\" ##å­—ç¬¦ä¸²æ‹¼æ¥ echo $name2 echo \"\" names=(\"Peter\" \"james\" \"deer\") ##å®šä¹‰æ•°ç»„ echo ${names[@]} ##éå†æ•°ç»„ echo \"I am ${names[1]}'s friend\" ##ç¬¬äºŒä¸ªå…ƒç´  echo \"I have ${#names[@]}friends\" ##æ•°ç»„é•¿åº¦ echo \"\" for var in ${names[@]}; ##å¾ªç¯æ•°ç»„ do if test $var = 'Peter' ##å­—ç¬¦ä¸²ç›¸ç­‰ then echo \"I am Peter\" else echo \"I am ${var}'s friend\" fi done echo \"\" if [ $(ps -ef | grep -c \"ssh\") -gt 1 ]; ##æŸ¥æ‰¾æ˜¯å¦æœ‰sshæœåŠ¡ then echo \"ssh service open\"; fi echo \"\" echo \"sh arg: $0$1\" ##shçš„ä¼ å‚ é‡å®šå‘ï¼š 1ã€test â€˜aaâ€™ -eq â€œbbâ€ \u003e out ##å‘½ä»¤è¾“å‡ºåˆ° outæ–‡ä»¶ï¼ŒæŠ¥é”™ä¿¡æ¯å¹¶ä¸ä¼šè¿›å…¥out 2ã€test â€˜aaâ€™ -eq â€œbbâ€ \u003e out 2\u003e\u00261 ##å°†stderråˆå¹¶åˆ°stdoutï¼Œåˆ™æŠ¥é”™ä¿¡æ¯è¿›å…¥äº†out ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:6:2","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6. å¸¸ç”¨å‘½ä»¤ ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:0","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.1 æœ€å¸¸ç”¨çš„æ˜¯cd å‘½ä»¤ ç¤ºä¾‹\r\rcd è¿›å…¥ç”¨æˆ·ä¸»ç›®å½•ï¼› cd ~ è¿›å…¥ç”¨æˆ·ä¸»ç›®å½•ï¼› cd - è¿”å›è¿›å…¥æ­¤ç›®å½•ä¹‹å‰æ‰€åœ¨çš„ç›®å½•ï¼› cd .. è¿”å›ä¸Šçº§ç›®å½•ï¼ˆè‹¥å½“å‰ç›®å½•ä¸ºâ€œ/â€œï¼Œåˆ™æ‰§è¡Œå®Œåè¿˜åœ¨â€œ/\"ï¼›\"..â€œä¸ºä¸Šçº§ç›®å½•çš„æ„æ€ï¼‰ï¼› cd ../.. è¿”å›ä¸Šä¸¤çº§ç›®å½•ï¼›\r\r lsï¼Œllï¼Œ wgetï¼Œ curlï¼Œ history ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:1","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.2 æ–°å»ºæ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼šmkdir touch ç¤ºä¾‹\r\rmkdir åˆ›å»ºæ–‡ä»¶å¤¹ mkdir dirname ç›´æ¥è·Ÿæ–‡ä»¶å¤¹åï¼Œå¯åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ mkdir /opt/lamp/dirname å¯è·Ÿè·¯å¾„ mkdir -p /opt/lam/dirname å‡å¦‚lamä¸å­˜åœ¨ï¼Œéœ€è¦ç”¨-pæ‰å¯ä»¥åˆ›å»ºè¯¥æ–‡ä»¶å¤¹ touch æ–°å»ºæ–‡ä»¶ touch dilename å¯ç›´æ¥è·Ÿæ–‡ä»¶ååœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æ–‡ä»¶ \r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:2","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.3 cat/less/more/tailç­‰æ–‡ä»¶æŸ¥çœ‹å‘½ä»¤ è¯¦ç»†\r\r-næˆ–-numberï¼šæœ‰1å¼€å§‹å¯¹æ‰€æœ‰è¾“å‡ºçš„è¡Œæ•°ç¼–å·ï¼› -bæˆ–â€“number-nonblankï¼šå’Œ-nç›¸ä¼¼ï¼Œåªä¸è¿‡å¯¹äºç©ºç™½è¡Œä¸ç¼–å·ï¼› -sæˆ–â€“squeeze-blankï¼šå½“é‡åˆ°æœ‰è¿ç»­ä¸¤è¡Œä»¥ä¸Šçš„ç©ºç™½è¡Œï¼Œå°±ä»£æ¢ä¸ºä¸€è¡Œçš„ç©ºç™½è¡Œï¼› -Aï¼šæ˜¾ç¤ºä¸å¯æ‰“å°å­—ç¬¦ï¼Œè¡Œå°¾æ˜¾ç¤ºâ€œ$â€ï¼› -eï¼šç­‰ä»·äº\"-vE\"é€‰é¡¹ï¼› -tï¼šç­‰ä»·äº\"-vT\"é€‰é¡¹ï¼› -eï¼šæ–‡ä»¶å†…å®¹æ˜¾ç¤ºå®Œæ¯•åï¼Œè‡ªåŠ¨é€€å‡ºï¼› -fï¼šå¼ºåˆ¶æ˜¾ç¤ºæ–‡ä»¶ï¼› -gï¼šä¸åŠ äº®æ˜¾ç¤ºæœç´¢åˆ°çš„æ‰€æœ‰å…³é”®è¯ï¼Œä»…æ˜¾ç¤ºå½“å‰æ˜¾ç¤ºçš„å…³é”®å­—ï¼Œä»¥æé«˜æ˜¾ç¤ºé€Ÿåº¦ï¼› -lï¼šæœç´¢æ—¶å¿½ç•¥å¤§å°å†™çš„å·®å¼‚ï¼› -Nï¼šæ¯ä¸€è¡Œè¡Œé¦–æ˜¾ç¤ºè¡Œå·ï¼› -sï¼šå°†è¿ç»­å¤šä¸ªç©ºè¡Œå‹ç¼©æˆä¸€è¡Œæ˜¾ç¤ºï¼› -Sï¼šåœ¨å•è¡Œæ˜¾ç¤ºè¾ƒé•¿çš„å†…å®¹ï¼Œè€Œä¸æ¢è¡Œæ˜¾ç¤ºï¼› -x\u003cæ•°å­—\u003eï¼šå°†TABå­—ç¬¦æ˜¾ç¤ºä¸ºæŒ‡å®šä¸ªæ•°çš„ç©ºæ ¼å­—ç¬¦ã€‚ -\u003cæ•°å­—\u003eï¼šæŒ‡å®šæ¯å±æ˜¾ç¤ºçš„è¡Œæ•°ï¼› -dï¼šæ˜¾ç¤ºâ€œ[press space to continue,â€˜qâ€™ to quit.]â€å’Œâ€œ[Press â€˜hâ€™ for instructions]â€ï¼› -cï¼šä¸è¿›è¡Œæ»šå±æ“ä½œã€‚æ¯æ¬¡åˆ·æ–°è¿™ä¸ªå±å¹•ï¼› -sï¼šå°†å¤šä¸ªç©ºè¡Œå‹ç¼©æˆä¸€è¡Œæ˜¾ç¤ºï¼› -uï¼šç¦æ­¢ä¸‹åˆ’çº¿ï¼› +\u003cæ•°å­—\u003eï¼šä»æŒ‡å®šæ•°å­—çš„è¡Œå¼€å§‹æ˜¾ç¤ºã€‚ æŒ‰Spaceé”®ï¼šæ˜¾ç¤ºæ–‡æœ¬çš„ä¸‹ä¸€å±å†…å®¹ã€‚ æŒ‰Enieré”®ï¼šåªæ˜¾ç¤ºæ–‡æœ¬çš„ä¸‹ä¸€è¡Œå†…å®¹ã€‚ æŒ‰æ–œçº¿ç¬¦|ï¼šæ¥ç€è¾“å…¥ä¸€ä¸ªæ¨¡å¼ï¼Œå¯ä»¥åœ¨æ–‡æœ¬ä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªç›¸åŒ¹é…çš„æ¨¡å¼ã€‚ æŒ‰Hé”®ï¼šæ˜¾ç¤ºå¸®åŠ©å±ï¼Œè¯¥å±ä¸Šæœ‰ç›¸å…³çš„å¸®åŠ©ä¿¡æ¯ã€‚ æŒ‰Bé”®ï¼šæ˜¾ç¤ºä¸Šä¸€å±å†…å®¹ã€‚ æŒ‰Qé”®ï¼šé€€å‡ºrnoreå‘½ä»¤ã€‚ â€“retryï¼šå³æ˜¯åœ¨tailå‘½ä»¤å¯åŠ¨æ—¶ï¼Œæ–‡ä»¶ä¸å¯è®¿é—®æˆ–è€…æ–‡ä»¶ç¨åå˜å¾—ä¸å¯è®¿é—®ï¼Œéƒ½å§‹ç»ˆå°è¯•æ‰“å¼€æ–‡ä»¶ã€‚ä½¿ç”¨æ­¤é€‰é¡¹æ—¶éœ€è¦ä¸é€‰é¡¹â€œâ€”â€”follow=nameâ€è¿ç”¨ï¼› -cæˆ–â€”â€”bytes=ï¼šè¾“å‡ºæ–‡ä»¶å°¾éƒ¨çš„Nï¼ˆNä¸ºæ•´æ•°ï¼‰ä¸ªå­—èŠ‚å†…å®¹ï¼› -fæˆ–ï¼›â€“followï¼šæ˜¾ç¤ºæ–‡ä»¶æœ€æ–°è¿½åŠ çš„å†…å®¹ã€‚â€œnameâ€è¡¨ç¤ºä»¥æ–‡ä»¶åçš„æ–¹å¼ç›‘è§†æ–‡ä»¶çš„å˜åŒ–ã€‚â€œ-fâ€ä¸â€œ-fdescriptorâ€ç­‰æ•ˆï¼› -Fï¼šä¸é€‰é¡¹â€œ-follow=nameâ€å’Œâ€œâ€“retry\"è¿ç”¨æ—¶åŠŸèƒ½ç›¸åŒï¼› -næˆ–â€”â€”line=ï¼šè¾“å‡ºæ–‡ä»¶çš„å°¾éƒ¨Nï¼ˆNä½æ•°å­—ï¼‰è¡Œå†…å®¹ã€‚ â€“pid=\u003cè¿›ç¨‹å·\u003eï¼šä¸â€œ-fâ€é€‰é¡¹è¿ç”¨ï¼Œå½“æŒ‡å®šçš„è¿›ç¨‹å·çš„è¿›ç¨‹ç»ˆæ­¢åï¼Œè‡ªåŠ¨é€€å‡ºtailå‘½ä»¤ï¼› -qæˆ–â€”â€”quietæˆ–â€”â€”silentï¼šå½“æœ‰å¤šä¸ªæ–‡ä»¶å‚æ•°æ—¶ï¼Œä¸è¾“å‡ºå„ä¸ªæ–‡ä»¶åï¼› -s\u003cç§’æ•°\u003eæˆ–â€”â€”sleep-interal=\u003cç§’æ•°\u003eï¼šä¸â€œ-fâ€é€‰é¡¹è¿ç”¨ï¼ŒæŒ‡å®šç›‘è§†æ–‡ä»¶å˜åŒ–æ—¶é—´éš”çš„ç§’æ•°ï¼› -væˆ–â€”â€”verboseï¼šå½“æœ‰å¤šä¸ªæ–‡ä»¶å‚æ•°æ—¶ï¼Œæ€»æ˜¯è¾“å‡ºå„ä¸ªæ–‡ä»¶åï¼› ä¸€èˆ¬tailå‘½ä»¤æœ€å¸¸ç”¨çš„-nå’Œ-fï¼Œä¾‹ï¼š tail filename è¯»å–filenameæœ€å10è¡Œå†…å®¹ tail -f filename å®æ—¶åŠ¨æ€è¯»å–filenameæœ€å10è¡Œå†…å®¹ tail -20f filename å®æ—¶åŠ¨æ€è¯»å–filenameæœ€å20è¡Œå†…å®¹ \r\r catå’ŒlessåŠmoreæŒ‡ä»¤ç›¸ä¼¼ï¼Œcatæ˜¯ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰å†…å®¹ï¼Œæ–‡ä»¶å†…å®¹è¾ƒå¤šæ—¶é€Ÿåº¦è¾ƒæ…¢ã€‚lessä¸moreçš„åŒºåˆ«åœ¨äºï¼šlesså¯ä»¥å‰åç¿»é¡µæŸ¥çœ‹ï¼Œmoreåªèƒ½å‘å‰ç¿»é¡µæŸ¥çœ‹ã€‚ tailåˆ™ç”¨äºå®æ—¶è·å–logä¿¡æ¯ï¼Œä»åå‘å‰è¯»å–å†…å®¹ ä¸Šè¿°å››ç§å‘½ä»¤å‡å¯è·Ÿgrepæ­é…ä½¿ç”¨cat/less/tail |grep mysql ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:3","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.4 æŸ¥çœ‹æ–‡ä»¶å¤§å°çš„å‘½ä»¤ du/df è¯¦ç»†\r\rdu -sh * æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„å¤§å° du -sh filename æ˜¾ç¤ºè¯¥æ–‡ä»¶å¤§å° du -sh æ˜¾ç¤ºå½“å‰ç›®å½•æ‰€å ç©ºé—´å¤§å° -sæˆ– ä»…æ˜¾ç¤ºæ€»è®¡ï¼Œåªåˆ—å‡ºæœ€ååŠ æ€»çš„å€¼ã€‚ -hæˆ– ä»¥Kï¼ŒMï¼ŒGä¸ºå•ä½ï¼Œæé«˜ä¿¡æ¯çš„å¯è¯»æ€§ã€‚ df æ˜¾ç¤ºç£ç›˜å ç”¨ä¿¡æ¯ ç›´æ¥dfé»˜è®¤ä¸€kä¸ºå•ä½ df -lh æ˜¾ç¤ºæœ¬åœ°ç³»ç»Ÿçš„å ç”¨ä¿¡æ¯ï¼Œä»¥Kï¼ŒMï¼ŒGä¸ºå•ä½\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:4","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.5 å¤§é‡ç‚¹â€“æ–‡æœ¬ç¼–è¾‘å™¨ vi è¯¦ç»†\r\rviå‘½ä»¤æ˜¯UNIXæ“ä½œç³»ç»Ÿå’Œç±»UNIXæ“ä½œç³»ç»Ÿä¸­æœ€é€šç”¨çš„å…¨å±å¹•çº¯æ–‡æœ¬ç¼–è¾‘å™¨ã€‚ Linuxä¸­çš„viç¼–è¾‘å™¨å«vimï¼Œå®ƒæ˜¯viçš„å¢å¼ºç‰ˆï¼ˆvi Improvedï¼‰ï¼Œä¸viç¼–è¾‘å™¨å®Œå…¨å…¼å®¹ï¼Œè€Œä¸”å®ç°äº†å¾ˆå¤šå¢å¼ºåŠŸèƒ½ã€‚ viç¼–è¾‘å™¨æ”¯æŒç¼–è¾‘æ¨¡å¼å’Œå‘½ä»¤æ¨¡å¼ï¼Œç¼–è¾‘æ¨¡å¼ä¸‹å¯ä»¥å®Œæˆæ–‡æœ¬çš„ç¼–è¾‘åŠŸèƒ½ï¼Œå‘½ä»¤æ¨¡å¼ä¸‹å¯ä»¥å®Œæˆå¯¹æ–‡ä»¶çš„æ“ä½œå‘½ä»¤ï¼Œè¦æ­£ç¡®ä½¿ç”¨viç¼–è¾‘å™¨å°±å¿…é¡»ç†Ÿç»ƒæŒæ¡ç€ä¸¤ç§æ¨¡å¼çš„åˆ‡æ¢ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰“å¼€viç¼–è¾‘å™¨åè‡ªåŠ¨è¿›å…¥å‘½ä»¤æ¨¡å¼ã€‚ä»ç¼–è¾‘æ¨¡å¼åˆ‡æ¢åˆ°å‘½ä»¤æ¨¡å¼ä½¿ç”¨â€œescâ€é”®ï¼Œä»å‘½ä»¤æ¨¡å¼åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ä½¿ç”¨â€œAâ€ã€â€œaâ€ã€â€œOâ€ã€â€œoâ€ã€â€œIâ€ã€â€œiâ€é”®ã€‚ viç¼–è¾‘å™¨æä¾›äº†ä¸°å¯Œçš„å†…ç½®å‘½ä»¤ï¼Œæœ‰äº›å†…ç½®å‘½ä»¤ä½¿ç”¨é”®ç›˜ç»„åˆé”®å³å¯å®Œæˆï¼Œæœ‰äº›å†…ç½®å‘½ä»¤åˆ™éœ€è¦ä»¥å†’å·â€œï¼šâ€å¼€å¤´è¾“å…¥ã€‚å¸¸ç”¨å†…ç½®å‘½ä»¤å¦‚ä¸‹ï¼š Ctrl+uï¼šå‘æ–‡ä»¶é¦–ç¿»åŠå±ï¼› 2 Ctrl+dï¼šå‘æ–‡ä»¶å°¾ç¿»åŠå±ï¼› 3 Ctrl+fï¼šå‘æ–‡ä»¶å°¾ç¿»ä¸€å±ï¼› 4 Ctrl+bï¼šå‘æ–‡ä»¶é¦–ç¿»ä¸€å±ï¼› 5 Escï¼šä»ç¼–è¾‘æ¨¡å¼åˆ‡æ¢åˆ°å‘½ä»¤æ¨¡å¼ï¼› 6 ZZï¼šå‘½ä»¤æ¨¡å¼ä¸‹ä¿å­˜å½“å‰æ–‡ä»¶æ‰€åšçš„ä¿®æ”¹åé€€å‡ºviï¼› 7 :è¡Œå·ï¼šå…‰æ ‡è·³è½¬åˆ°æŒ‡å®šè¡Œçš„è¡Œé¦–ï¼› 8 :$ï¼šå…‰æ ‡è·³è½¬åˆ°æœ€åä¸€è¡Œçš„è¡Œé¦–ï¼› 9 xæˆ–Xï¼šåˆ é™¤ä¸€ä¸ªå­—ç¬¦ï¼Œxåˆ é™¤å…‰æ ‡åçš„ï¼Œè€ŒXåˆ é™¤å…‰æ ‡å‰çš„ï¼› 10 Dï¼šåˆ é™¤ä»å½“å‰å…‰æ ‡åˆ°å…‰æ ‡æ‰€åœ¨è¡Œå°¾çš„å…¨éƒ¨å­—ç¬¦ï¼› 11 ddï¼šåˆ é™¤å…‰æ ‡è¡Œæ­£è¡Œå†…å®¹ï¼› 12 nddï¼šåˆ é™¤å½“å‰è¡ŒåŠå…¶ån-1è¡Œï¼› 13 nyyï¼šå°†å½“å‰è¡ŒåŠå…¶ä¸‹nè¡Œçš„å†…å®¹ä¿å­˜åˆ°å¯„å­˜å™¨?ä¸­ï¼Œå…¶ä¸­ï¼Ÿä¸ºä¸€ä¸ªå­—æ¯ï¼Œnä¸ºä¸€ä¸ªæ•°å­—ï¼› 14 pï¼šç²˜è´´æ–‡æœ¬æ“ä½œï¼Œç”¨äºå°†ç¼“å­˜åŒºçš„å†…å®¹ç²˜è´´åˆ°å½“å‰å…‰æ ‡æ‰€åœ¨ä½ç½®çš„ä¸‹æ–¹ï¼› 15 Pï¼šç²˜è´´æ–‡æœ¬æ“ä½œï¼Œç”¨äºå°†ç¼“å­˜åŒºçš„å†…å®¹ç²˜è´´åˆ°å½“å‰å…‰æ ‡æ‰€åœ¨ä½ç½®çš„ä¸Šæ–¹ï¼› 16 /å­—ç¬¦ä¸²ï¼šæ–‡æœ¬æŸ¥æ‰¾æ“ä½œï¼Œç”¨äºä»å½“å‰å…‰æ ‡æ‰€åœ¨ä½ç½®å¼€å§‹å‘æ–‡ä»¶å°¾éƒ¨æŸ¥æ‰¾æŒ‡å®šå­—ç¬¦ä¸²çš„å†…å®¹ï¼ŒæŸ¥æ‰¾çš„å­—ç¬¦ä¸²ä¼šè¢«åŠ äº®æ˜¾ç¤ºï¼› 17 ï¼Ÿnameï¼šæ–‡æœ¬æŸ¥æ‰¾æ“ä½œï¼Œç”¨äºä»å½“å‰å…‰æ ‡æ‰€åœ¨ä½ç½®å¼€å§‹å‘æ–‡ä»¶å¤´éƒ¨æŸ¥æ‰¾æŒ‡å®šå­—ç¬¦ä¸²çš„å†…å®¹ï¼ŒæŸ¥æ‰¾çš„å­—ç¬¦ä¸²ä¼šè¢«åŠ äº®æ˜¾ç¤ºï¼› 18 aï¼Œbs/F/Tï¼šæ›¿æ¢æ–‡æœ¬æ“ä½œï¼Œç”¨äºåœ¨ç¬¬aè¡Œåˆ°ç¬¬bè¡Œä¹‹é—´ï¼Œå°†Få­—ç¬¦ä¸²æ¢æˆTå­—ç¬¦ä¸²ã€‚å…¶ä¸­ï¼Œâ€œs/â€è¡¨ç¤ºè¿›è¡Œæ›¿æ¢æ“ä½œï¼› 19 aï¼šåœ¨å½“å‰å­—ç¬¦åæ·»åŠ æ–‡æœ¬ï¼› 20 Aï¼šåœ¨è¡Œæœ«æ·»åŠ æ–‡æœ¬ï¼› 21 iï¼šåœ¨å½“å‰å­—ç¬¦å‰æ’å…¥æ–‡æœ¬ï¼› 22 Iï¼šåœ¨è¡Œé¦–æ’å…¥æ–‡æœ¬ï¼› 23 oï¼šåœ¨å½“å‰è¡Œåé¢æ’å…¥ä¸€ç©ºè¡Œï¼› 24 Oï¼šåœ¨å½“å‰è¡Œå‰é¢æ’å…¥ä¸€ç©ºè¡Œï¼› 25 :wqï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œå­˜ç›˜é€€å‡ºæ“ä½œï¼› 26 :wï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œå­˜ç›˜æ“ä½œï¼› 27 :wï¼ï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œå¼ºåˆ¶å­˜ç›˜æ“ä½œï¼› 28 :qï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œé€€å‡ºviæ“ä½œï¼› 29 :qï¼ï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œå¼ºåˆ¶é€€å‡ºviæ“ä½œï¼› 30 :eæ–‡ä»¶åï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œæ‰“å¼€å¹¶ç¼–è¾‘æŒ‡å®šåç§°çš„æ–‡ä»¶ï¼› 31 :nï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œå¦‚æœåŒæ—¶æ‰“å¼€å¤šä¸ªæ–‡ä»¶ï¼Œåˆ™ç»§ç»­ç¼–è¾‘ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼› 32 :fï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œç”¨äºæ˜¾ç¤ºå½“å‰çš„æ–‡ä»¶åã€å…‰æ ‡æ‰€åœ¨è¡Œçš„è¡Œå·ä»¥åŠæ˜¾ç¤ºæ¯”ä¾‹ï¼› 33 :set nuï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œç”¨äºåœ¨æœ€å·¦ç«¯æ˜¾ç¤ºè¡Œå·ï¼› 34 :set nonuï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œç”¨äºåœ¨æœ€å·¦ç«¯ä¸æ˜¾ç¤ºè¡Œå·ï¼› 35 :1,3y å¤åˆ¶ç¬¬ä¸€è¡Œåˆ°ç¬¬ä¸‰è¡Œ 36 :1,3d åˆ é™¤ç¬¬ä¸€è¡Œåˆ°ç¬¬ä¸‰è¡Œ 37 :1,3s/str/str_new/g æ›¿æ¢ç¬¬ä¸€è¡Œåˆ°ç¬¬ä¸‰è¡Œä¸­çš„å­—ç¬¦ä¸² 38 :1,3s/str/str_new æ›¿æ¢ç¬¬ä¸€è¡Œåˆ°ç¬¬ä¸‰è¡Œä¸­çš„å­—ç¬¦ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦ 39 :1,3 g/str /d åˆ é™¤ç¬¬ä¸€è¡Œåˆ°ç¬¬ä¸‰è¡Œä¸­å«æœ‰è¿™ä¸ªå­—ç¬¦ä¸²çš„è¡Œ\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:5","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.6 é‡å®šå‘ \u003e è¾“å‡ºé‡å®šå‘ who \u003e bbb.txt å°†aaaçš„å†…å®¹å†™å…¥bbbä¸­ï¼Œè¦†ç›–å†™å…¥ cat bbb.txt Â» ccc.txt è®²aaaçš„å†…å®¹è¿½åŠ å†™å…¥bbbä¸­ï¼Œä¸è¦†ç›–åŸæ¥å†…å®¹ \u003e bbb.txt å°†bbbæ¸…ç©º è¾“å…¥é‡å®šå‘ grep 05:37:43.730 \u003c web.2019-07-22.0.log å¤§å¤šæ•° UNIX ç³»ç»Ÿå‘½ä»¤ä»ä½ çš„ç»ˆç«¯æ¥å—è¾“å…¥å¹¶å°†æ‰€äº§ç”Ÿçš„è¾“å‡ºå‘é€å›åˆ°æ‚¨çš„ç»ˆç«¯ã€‚ ä¸€ä¸ªå‘½ä»¤é€šå¸¸ä»ä¸€ä¸ªå«æ ‡å‡†è¾“å…¥çš„åœ°æ–¹è¯»å–è¾“å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ°å¥½æ˜¯ä½ çš„ç»ˆç«¯ã€‚ åŒæ ·ï¼Œä¸€ä¸ªå‘½ä»¤é€šå¸¸å°†å…¶è¾“å‡ºå†™å…¥åˆ°æ ‡å‡†è¾“å‡ºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ä½ çš„ç»ˆç«¯ã€‚ é‡å®šå‘æ·±å…¥ç†è§£ è¯¦ç»†\r\rä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Unix/Linux å‘½ä»¤è¿è¡Œæ—¶éƒ½ä¼šæ‰“å¼€ä¸‰ä¸ªæ–‡ä»¶ï¼š ï¬ æ ‡å‡†è¾“å…¥æ–‡ä»¶(stdin)ï¼šstdinçš„æ–‡ä»¶æè¿°ç¬¦ä¸º0ï¼ŒUnixç¨‹åºé»˜è®¤ä»stdinè¯»å–æ•°æ®ã€‚ ï¬ æ ‡å‡†è¾“å‡ºæ–‡ä»¶(stdout)ï¼šstdout çš„æ–‡ä»¶æè¿°ç¬¦ä¸º1ï¼ŒUnixç¨‹åºé»˜è®¤å‘stdoutè¾“å‡ºæ•°æ®ã€‚ ï¬ æ ‡å‡†é”™è¯¯æ–‡ä»¶(stderr)ï¼šstderrçš„æ–‡ä»¶æè¿°ç¬¦ä¸º2ï¼ŒUnixç¨‹åºä¼šå‘stderræµä¸­å†™å…¥é”™è¯¯ä¿¡æ¯ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œcommand \u003e file å°† stdout é‡å®šå‘åˆ° fileï¼Œcommand \u003c file å°†stdin é‡å®šå‘åˆ° fileã€‚\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:6","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.7 æŸ¥çœ‹æœåŠ¡ è¯¦ç»†\r\rnetstat -nlpt|grep 80 æŸ¥çœ‹è¯¥ç«¯å£å·æ˜¯å¦è¢«å ç”¨ free -m //æŸ¥çœ‹LINUXå†…å­˜å‰©ä½™å®¹é‡ pså¯ä»¥æŸ¥çœ‹å…·ä½“çš„è¿›ç¨‹ä¿¡æ¯ï¼Œä¸€èˆ¬ä¸ç®¡é“ç¬¦è¿æ¥å…¶ä»–å‘½ä»¤ä½¿ç”¨ï¼Œå¦‚ï¼šgrep pså¸¸ç”¨å‚æ•°-ef/-auxï¼Œä¸€èˆ¬æœ€å¸¸ç”¨è¿˜æ˜¯-efï¼Œä¾‹ï¼šps -ef|grep mysql æŸ¥è¯¢mysqlè¿›ç¨‹ topä¹Ÿå¯æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œè€Œä¸”æ˜¯åŠ¨æ€æ˜¾ç¤º whoami æŸ¥çœ‹å½“å‰ç™»é™†ç”¨æˆ· who æŸ¥çœ‹å¤šå°‘ç”¨æˆ·åœ¨ä½¿ç”¨ç³»ç»Ÿ dateæŸ¥çœ‹ç³»ç»Ÿæ—¶é—´ï¼Œå¯è·Ÿæ—¶é—´æ ¼å¼ä½¿ç”¨ calæŸ¥çœ‹æ—¥å†ï¼Œå¯è·Ÿå¹´ä»½ï¼ŒæŸ¥çœ‹æŒ‡å®šçš„å¹´ä»½ chkconfig â€“list #æŸ¥çœ‹ç³»ç»ŸæœåŠ¡å¯åŠ¨ chkconfig iptables on #å¼€æœºå¯åŠ¨è¯¥æœåŠ¡ chkconfig iptables off #å¼€æœºä¸å¯åŠ¨è¯¥æœåŠ¡ service iptables start #å¯åŠ¨è¯¥æœåŠ¡ service iptables restart #é‡å¯å¯è¯¥æœåŠ¡ ps -ef|grep mysql|grep -v grep|awk â€˜{print $2}â€˜ps -ef|grep mysql æ˜¯æŸ¥è¯¢mysqlæœåŠ¡çš„è¿›ç¨‹ |åçš„grep -v grep æ˜¯åŒ¹é…ä¸åŒ…å«grepçš„è¡Œ awkæ˜¯å–æŸ¥è¯¢ç»“æœçš„ç¬¬å‡ åˆ—ï¼Œawk â€˜{print $2}â€˜åˆ™æ˜¯å–ç¬¬äºŒåˆ—çš„å€¼ grep æ— å‚æ•°åˆ™æ˜¾ç¤ºåŒ¹é…çš„è¡Œ -c æ˜¾ç¤ºåŒ¹é…çš„è¡Œæ•° -v æ˜¾ç¤ºä¸åŒ¹é…çš„è¡Œ\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:7","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.8 æ€æ‰è¿›ç¨‹ killå‘½ä»¤ è¯¦ç»†\r\rkillæœ€å¸¸ç”¨çš„å‚æ•°æ˜¯-9ï¼Œç”¨æ³•ï¼škill -9 è¿›ç¨‹å· å³å¯å¼ºåˆ¶æ€æ‰è¯¥è¿›ç¨‹ ç»Ÿè®¡å‘½ä»¤ wc å¸¸ç”¨çš„å‚æ•°æ˜¯ -l ç”¨æ³•ï¼šwc -l ï¼Œä¾‹ï¼š ps -ef|grep mysql|wc -l ç»Ÿè®¡æŸ¥è¯¢å‡ºçš„mysqlè¿›ç¨‹çš„è¡Œæ•° æŸ¥æ‰¾å‘½ä»¤ find/locate/whereis/which find -name åè·Ÿæ–‡ä»¶åï¼Œå¯æŸ¥çœ‹æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå¯è·Ÿuserï¼ŒæŸ¥çœ‹å±äºuserçš„æ–‡ä»¶ find -name filename æŸ¥æ‰¾filenameæ‰€åœ¨ç›®å½• find -name name* æŸ¥æ‰¾å¼€å¤´ä¸ºnameçš„æ–‡ä»¶æ‰€åœ¨ç›®å½• find -name *name æŸ¥æ‰¾ç»“å°¾ä¸ºnameçš„æ–‡ä»¶æ‰€åœ¨ç›®å½• find -name *name* æŸ¥æ‰¾åŒ…å«nameå­—ç¬¦ä¸²çš„æ–‡ä»¶æ‰€åœ¨ç›®å½• find -user faith æŸ¥çœ‹ç”¨æˆ·faithçš„æ–‡ä»¶ locateç”¨æ³•ä¸findåŸºæœ¬ç›¸ä¼¼ï¼Œåªæ˜¯locateæœç´¢é€Ÿåº¦è¾ƒå¿«äº›ï¼Œlocateä¸€èˆ¬ç³»ç»Ÿä¸ä¼šè‡ªå¸¦ï¼Œéœ€è¦å®‰è£…ï¼Œå¯ç”¨yumå®‰è£… whereisåªèƒ½æœç´¢ç¨‹åºå whichåˆ™æ˜¯åªæŸ¥è¯¢pathä¸­çš„ç¯å¢ƒå˜é‡\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:8","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.9 å‹ç¼©å’Œè§£å‹å‘½ä»¤ gzip/guzip zip/unzip tar è¯¦ç»†\r\rgzipå’Œgunzipä¸€èˆ¬å¯ç”¨å‚æ•°æ˜¯-rï¼Œä¾‹: gzip test.txtã€€å‹ç¼©æ–‡ä»¶ gzip -r test å‹ç¼©æ‰€æœ‰testä¸‹çš„å­æ–‡ä»¶ gunzip test.gz è§£å‹æ–‡ä»¶ zipå’Œunzipå¯ç”¨å‚æ•°è¾ƒå¤šï¼Œä¾‹ï¼š zip test ä¸è·Ÿå‚æ•°ç›´æ¥ä½¿ç”¨ zip -r test é€’å½’å‹ç¼©testä¸‹æ‰€æœ‰æ–‡ä»¶ unzip test ä¸è·Ÿå‚æ•°ç›´æ¥ä½¿ç”¨ unzip -n è§£å‹æ—¶ä¸è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ unzip -o è§£å‹æ—¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ unzip -d å°†æ–‡ä»¶è§£å‹åˆ°ç›®å½•ä¸­å» tarä½¿ç”¨çš„è¾ƒä¸ºå¤šäº›ï¼Œç”¨æ³•ä¹Ÿå¤šï¼Œæœ€å¸¸ç”¨çš„æ˜¯zxcvfå‡ ä¸ªå‚æ•°ï¼Œä¾‹ï¼š -c åˆ›å»ºæ–°æ–‡æ¡£ï¼Œå°±æ˜¯ä»£è¡¨å‹ç¼©çš„æ„æ€ -x è§£å‹æ–‡æ¡£ -f ä½¿ç”¨å½’æ¡£æ–‡ä»¶ -z ä½¿ç”¨gzipè§£å‹ -v è¯¦ç»†è¾“å‡ºæ¨¡å¼ æœ€ä¸ºå¸¸ç”¨çš„ä½¿ç”¨æ–¹æ³•ï¼š tar -zcvf test.tar test å°†testå‹ç¼©ä¸ºtest.tarå¹¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯ tar -zxvf test.tar å°†test.tarè§£å‹ç¼©ï¼Œå¹¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯\r\r ","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:9","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["ç³»ç»Ÿ"],"content":"6.10 å®šæ—¶ä»»åŠ¡ crontab è¯¦ç»†\r\rcrontab [-u user] æ–‡ä»¶ crontab [-u user] {-r -e -l} ä¸åŠ -uçš„è¯é»˜è®¤å½“å‰ç”¨æˆ· ï¼eï¼šæ‰§è¡Œæ–‡å­—ç¼–è¾‘å™¨æ¥è®¾å®šæ—¶ç¨‹è¡¨ï¼Œå†…å®šçš„æ–‡å­—ç¼–è¾‘å™¨æ˜¯viã€‚ ï¼rï¼šåˆ é™¤ç›®å‰çš„æ—¶ç¨‹è¡¨ã€‚ ï¼lï¼šåˆ—å‡ºç›®å‰çš„æ—¶ç¨‹è¡¨ã€‚ crontab -e å°±å¯ä»¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç¼–è¾‘ crontabæ–‡ä»¶çš„æ ¼å¼ä¸ºâ€œM H D m d cmdâ€ï¼ŒMä¸ºåˆ†é’Ÿ1-59ï¼ŒHä¸ºå°æ—¶1-24ï¼ŒDä¸ºå¤©1-31ï¼Œmä¸ºæœˆ1-12ï¼Œdä¸ºå‘¨0-6ï¼ˆ0ä¸ºå‘¨æ—¥ï¼‰ã€‚cmdä»£è¡¨è¦æ‰§è¡Œçš„ç¨‹åºï¼Œ*ä»£è¡¨æ¯åˆ†é’Ÿéƒ½æ‰§è¡Œ * * * * * sh /opt/lampp/test.sh è¡¨ç¤ºæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡test.shè¿™ä¸ªè„šæœ¬ */5 * * * * sh /opt/lampp/test.sh è¡¨ç¤ºæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡test.shè¿™ä¸ªè„šæœ¬ 30 21 * * * /usr/local/apache/bin/apachectl restart è¡¨ç¤ºæ¯æ™šçš„21:30é‡å¯apache\r\r","date":"2020-11-18","objectID":"/posts/linux/linux-basics/:7:10","tags":["linux"],"title":"LinuxåŸºç¡€","uri":"/posts/linux/linux-basics/"},{"categories":["æ–‡æ¡£"],"content":"æ¯”è¾ƒä½¿ç”¨çš„å·¥å…·è½¯ä»¶/æ’ä»¶ã€‚ä¾‹ï¼šå¯†ç ç®¡ç†å™¨ã€è°·æ­Œæµè§ˆå™¨å¸¸ç”¨æ’ä»¶ç­‰ã€‚","date":"2020-11-18","objectID":"/posts/docs/software-tools/","tags":["å·¥å…·"],"title":"å·¥å…·è½¯ä»¶","uri":"/posts/docs/software-tools/"},{"categories":["æ–‡æ¡£"],"content":"å¸¸ç”¨çš„ ","date":"2020-11-18","objectID":"/posts/docs/software-tools/:1:0","tags":["å·¥å…·"],"title":"å·¥å…·è½¯ä»¶","uri":"/posts/docs/software-tools/"},{"categories":["æ–‡æ¡£"],"content":"å¯†ç ç®¡ç†å™¨ keepass 1 Password ","date":"2020-11-18","objectID":"/posts/docs/software-tools/:1:1","tags":["å·¥å…·"],"title":"å·¥å…·è½¯ä»¶","uri":"/posts/docs/software-tools/"},{"categories":["æ–‡æ¡£"],"content":"è°·æ­Œæµè§ˆå™¨æ’ä»¶ Video DownloadHelper ä¸€æ¬¾è§†é¢‘ä¸‹è½½æ’ä»¶ï¼Œç½‘é¡µä¸Šèƒ½çœ‹çš„è§†é¢‘å‡ ä¹éƒ½å¯ä»¥æ•æ‰ä¸‹è½½ GitHubåŠ é€Ÿ å›½å†…Githubä¸‹è½½å¾ˆæ…¢ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥æå‡ä¸‹è½½é€Ÿåº¦ è°·æ­Œè®¿é—®åŠ©æ‰‹ è§åçŸ¥æ„ã€æœ‰äº†å®ƒï¼Œè°·æ­Œå¯ä»¥è®¿é—®äº†ï¼Œè™½ç„¶ä¾æ—§é¾Ÿé€Ÿ æ²™æ‹‰æŸ¥è¯-èšåˆè¯å…¸åˆ’è¯ç¿»è¯‘ å¤šè¯­è¨€æ··åˆç½‘é¡µé˜…è¯»åˆ©å™¨ ","date":"2020-11-18","objectID":"/posts/docs/software-tools/:1:2","tags":["å·¥å…·"],"title":"å·¥å…·è½¯ä»¶","uri":"/posts/docs/software-tools/"},{"categories":["æ–‡æ¡£"],"content":"Rediså®¢æˆ·ç«¯å·¥å…· Another Redis Desktop Manager å¼€æºè½¯ä»¶ï¼Œç”¨ç€è¿˜å¯ä»¥ Redis Desktop Manager å®˜æ–¹å·¥å…·ï¼Œæ–°ç‰ˆéƒ¨åˆ†åŠŸèƒ½æ”¶è´¹ ","date":"2020-11-18","objectID":"/posts/docs/software-tools/:1:3","tags":["å·¥å…·"],"title":"å·¥å…·è½¯ä»¶","uri":"/posts/docs/software-tools/"},{"categories":["æ–‡æ¡£"],"content":"ä¸å¼€å‘æœ‰å…³çš„å¸¸ç”¨åœ¨çº¿å·¥å…·ã€‚å¦‚ï¼šjsonè§£æã€ç¨‹åºå‘˜åœ¨çº¿å·¥å…·ç®±ç­‰","date":"2020-11-18","objectID":"/posts/docs/online-tools/","tags":["å·¥å…·"],"title":"åœ¨çº¿å·¥å…·","uri":"/posts/docs/online-tools/"},{"categories":["æ–‡æ¡£"],"content":"Markdownåœ¨çº¿ç¼–è¾‘å™¨ JSONè§£æ ç¨‹åºå‘˜åœ¨çº¿å·¥å…·ç®± ç¨‹åºå‘˜åœ¨çº¿å·¥å…·ç®±2 ","date":"2020-11-18","objectID":"/posts/docs/online-tools/:0:0","tags":["å·¥å…·"],"title":"åœ¨çº¿å·¥å…·","uri":"/posts/docs/online-tools/"},{"categories":["æ–‡æ¡£"],"content":"å¸¸è§å®˜æ–¹ç½‘å€å¯¼èˆª","date":"2020-11-18","objectID":"/posts/docs/official-website-about-technology/","tags":["ç½‘ç«™"],"title":"å¸¸è§å®˜ç½‘","uri":"/posts/docs/official-website-about-technology/"},{"categories":["æ–‡æ¡£"],"content":"36 ","date":"2020-11-18","objectID":"/posts/docs/official-website-about-technology/:0:0","tags":["ç½‘ç«™"],"title":"å¸¸è§å®˜ç½‘","uri":"/posts/docs/official-website-about-technology/"},{"categories":["æ–‡æ¡£"],"content":"æŠ€æœ¯ç›¸å…³ Markdownä¸­æ–‡ç½‘ æ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™ w3cschool github HBuilder Data Structure Visualizations visualgo OSCHINA-ä¸­å›½å¼€æºæŠ€æœ¯äº¤æµç¤¾åŒº é˜¿é‡Œäº‘äº‘æ•ˆMaven Mavenä¸­å¤®ä»“åº“ SpringBootå®˜æ–¹æ–‡æ¡£ Nacoså®˜ç½‘ èœé¸Ÿæ•™ç¨‹ jekyllä¸»é¢˜ jekyllä¸­æ–‡æ–‡æ¡£ jekyllè‹±æ–‡æ–‡æ¡£ Hugoå®˜ç½‘ Hugoè‹±æ–‡æ–‡æ¡£ Hugoä¸­æ–‡æ–‡æ¡£ å›¾æ ‡ç½‘ é˜¿é‡Œå·´å·´çŸ¢é‡å›¾æ ‡åº“ Markdown ä¸­æ–‡ç½‘ LeanCloud valineæ–‡æ¡£ ä¸€å¥—ç»ä½³çš„å›¾æ ‡å­—ä½“åº“å’ŒCSSæ¡†æ¶ æ•°å®‰æ—¶ä»£-å…è´¹SSLè¯ä¹¦ Gravatar - å…¨çƒå…¬è®¤çš„å¤´åƒ ","date":"2020-11-18","objectID":"/posts/docs/official-website-about-technology/:1:0","tags":["ç½‘ç«™"],"title":"å¸¸è§å®˜ç½‘","uri":"/posts/docs/official-website-about-technology/"},{"categories":["æ–‡æ¡£"],"content":"å…¶ä»– keepass ","date":"2020-11-18","objectID":"/posts/docs/official-website-about-technology/:2:0","tags":["ç½‘ç«™"],"title":"å¸¸è§å®˜ç½‘","uri":"/posts/docs/official-website-about-technology/"},{"categories":["æ—¥å¿—"],"content":"logbackå¸¸è§é…ç½®","date":"2020-11-16","objectID":"/posts/technology-other/logback-configurature/","tags":["logback"],"title":"logbacké…ç½®","uri":"/posts/technology-other/logback-configurature/"},{"categories":["æ—¥å¿—"],"content":" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!-- æ—¥å¿—çº§åˆ«ä»ä½åˆ°é«˜åˆ†ä¸ºTRACE \u003c DEBUG \u003c INFO \u003c WARN \u003c ERROR \u003c FATALï¼Œå¦‚æœè®¾ç½®ä¸ºWARNï¼Œåˆ™ä½äºWARNçš„ä¿¡æ¯éƒ½ä¸ä¼šè¾“å‡º --\u003e \u003c!-- scan:å½“æ­¤å±æ€§è®¾ç½®ä¸ºtrueæ—¶ï¼Œé…ç½®æ–‡æ¡£å¦‚æœå‘ç”Ÿæ”¹å˜ï¼Œå°†ä¼šè¢«é‡æ–°åŠ è½½ï¼Œé»˜è®¤å€¼ä¸ºtrue --\u003e \u003c!-- scanPeriod:è®¾ç½®ç›‘æµ‹é…ç½®æ–‡æ¡£æ˜¯å¦æœ‰ä¿®æ”¹çš„æ—¶é—´é—´éš”ï¼Œå¦‚æœæ²¡æœ‰ç»™å‡ºæ—¶é—´å•ä½ï¼Œé»˜è®¤å•ä½æ˜¯æ¯«ç§’ã€‚ å½“scanä¸ºtrueæ—¶ï¼Œæ­¤å±æ€§ç”Ÿæ•ˆã€‚é»˜è®¤çš„æ—¶é—´é—´éš”ä¸º1åˆ†é’Ÿã€‚ --\u003e \u003c!-- debug:å½“æ­¤å±æ€§è®¾ç½®ä¸ºtrueæ—¶ï¼Œå°†æ‰“å°å‡ºlogbackå†…éƒ¨æ—¥å¿—ä¿¡æ¯ï¼Œå®æ—¶æŸ¥çœ‹logbackè¿è¡ŒçŠ¶æ€ã€‚é»˜è®¤å€¼ä¸ºfalseã€‚ --\u003e \u003cconfiguration scan=\"true\" scanPeriod=\"10 seconds\"\u003e \u003ccontextName\u003elogback\u003c/contextName\u003e \u003c!-- nameçš„å€¼æ˜¯å˜é‡çš„åç§°ï¼Œvalueçš„å€¼æ—¶å˜é‡å®šä¹‰çš„å€¼ã€‚é€šè¿‡å®šä¹‰çš„å€¼ä¼šè¢«æ’å…¥åˆ°loggerä¸Šä¸‹æ–‡ä¸­ã€‚å®šä¹‰åï¼Œå¯ä»¥ä½¿â€œ${}â€æ¥ä½¿ç”¨å˜é‡ã€‚ --\u003e \u003cproperty name=\"log.path\" value=\"logs\"/\u003e \u003cproperty name=\"project.name\" value=\"project-name\"/\u003e \u003c!--0. æ—¥å¿—æ ¼å¼å’Œé¢œè‰²æ¸²æŸ“ --\u003e \u003c!-- å½©è‰²æ—¥å¿—ä¾èµ–çš„æ¸²æŸ“ç±» --\u003e \u003cconversionRule conversionWord=\"clr\" converterClass=\"org.springframework.boot.logging.logback.ColorConverter\"/\u003e \u003cconversionRule conversionWord=\"wex\" converterClass=\"org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter\"/\u003e \u003cconversionRule conversionWord=\"wEx\" converterClass=\"org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter\"/\u003e \u003c!-- å½©è‰²æ—¥å¿—æ ¼å¼ --\u003e \u003cproperty name=\"CONSOLE_LOG_PATTERN\" value=\"${CONSOLE_LOG_PATTERN:-%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(%L:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}\"/\u003e \u003c!--1. è¾“å‡ºåˆ°æ§åˆ¶å°--\u003e \u003cappender name=\"CONSOLE\" class=\"ch.qos.logback.core.ConsoleAppender\"\u003e \u003c!--æ­¤æ—¥å¿—appenderæ˜¯ä¸ºå¼€å‘ä½¿ç”¨ï¼Œåªé…ç½®æœ€åº•çº§åˆ«ï¼Œæ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—çº§åˆ«æ˜¯å¤§äºæˆ–ç­‰äºæ­¤çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯--\u003e \u003cfilter class=\"ch.qos.logback.classic.filter.ThresholdFilter\"\u003e \u003clevel\u003edebug\u003c/level\u003e \u003c/filter\u003e \u003cencoder\u003e \u003cPattern\u003e${CONSOLE_LOG_PATTERN}\u003c/Pattern\u003e \u003c!-- è®¾ç½®å­—ç¬¦é›† --\u003e \u003ccharset\u003eUTF-8\u003c/charset\u003e \u003c/encoder\u003e \u003c/appender\u003e \u003c!--2. è¾“å‡ºåˆ°æ–‡æ¡£--\u003e \u003c!-- 2.1 levelä¸º DEBUG æ—¥å¿—ï¼Œæ—¶é—´æ»šåŠ¨è¾“å‡º --\u003e \u003cappender name=\"DEBUG_FILE\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\"\u003e \u003c!-- æ­£åœ¨è®°å½•çš„æ—¥å¿—æ–‡æ¡£çš„è·¯å¾„åŠæ–‡æ¡£å --\u003e \u003cfile\u003e${log.path}/${project.name}-debug.log\u003c/file\u003e \u003c!--æ—¥å¿—æ–‡æ¡£è¾“å‡ºæ ¼å¼--\u003e \u003cencoder\u003e \u003cpattern\u003e%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} %L - %msg%n\u003c/pattern\u003e \u003ccharset\u003eUTF-8\u003c/charset\u003e \u003c!-- è®¾ç½®å­—ç¬¦é›† --\u003e \u003c/encoder\u003e \u003c!-- æ—¥å¿—è®°å½•å™¨çš„æ»šåŠ¨ç­–ç•¥ï¼ŒæŒ‰æ—¥æœŸï¼ŒæŒ‰å¤§å°è®°å½• --\u003e \u003crollingPolicy class=\"ch.qos.logback.core.rolling.TimeBasedRollingPolicy\"\u003e \u003c!-- æ—¥å¿—å½’æ¡£ --\u003e \u003cfileNamePattern\u003e${log.path}/${project.name}-debug-%d{yyyy-MM-dd}.%i.log\u003c/fileNamePattern\u003e \u003ctimeBasedFileNamingAndTriggeringPolicy class=\"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP\"\u003e \u003cmaxFileSize\u003e10MB\u003c/maxFileSize\u003e \u003c/timeBasedFileNamingAndTriggeringPolicy\u003e \u003c!--æ—¥å¿—æ–‡æ¡£ä¿ç•™å¤©æ•°--\u003e \u003cmaxHistory\u003e15\u003c/maxHistory\u003e \u003c/rollingPolicy\u003e \u003c!-- æ­¤æ—¥å¿—æ–‡æ¡£åªè®°å½•debugçº§åˆ«çš„ --\u003e \u003cfilter class=\"ch.qos.logback.classic.filter.LevelFilter\"\u003e \u003clevel\u003edebug\u003c/level\u003e \u003conMatch\u003eACCEPT\u003c/onMatch\u003e \u003conMismatch\u003eDENY\u003c/onMismatch\u003e \u003c/filter\u003e \u003c/appender\u003e \u003c!-- 2.2 levelä¸º INFO æ—¥å¿—ï¼Œæ—¶é—´æ»šåŠ¨è¾“å‡º --\u003e \u003cappender name=\"INFO_FILE\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\"\u003e \u003c!-- æ­£åœ¨è®°å½•çš„æ—¥å¿—æ–‡æ¡£çš„è·¯å¾„åŠæ–‡æ¡£å --\u003e \u003cfile\u003e${log.path}/${project.name}-info.log\u003c/file\u003e \u003c!--æ—¥å¿—æ–‡æ¡£è¾“å‡ºæ ¼å¼--\u003e \u003cencoder\u003e \u003cpattern\u003e%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} %L - %msg%n\u003c/pattern\u003e \u003ccharset\u003eUTF-8\u003c/charset\u003e \u003c/encoder\u003e \u003c!-- æ—¥å¿—è®°å½•å™¨çš„æ»šåŠ¨ç­–ç•¥ï¼ŒæŒ‰æ—¥æœŸï¼ŒæŒ‰å¤§å°è®°å½• --\u003e \u003crollingPolicy class=\"ch.qos.logback.core.rolling.TimeBasedRollingPolicy\"\u003e \u003c!-- æ¯å¤©æ—¥å¿—å½’æ¡£è·¯å¾„ä»¥åŠæ ¼å¼ --\u003e \u003cfileNamePattern\u003e${log.path}/${project.name}-%d{yyyy-MM-dd}.%i.log\u003c/fileNamePattern\u003e \u003ctimeBasedFileNamingAndTriggeringPolicy class=\"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP\"\u003e \u003cmaxFileSize\u003e10MB\u003c/maxFileSize\u003e \u003c/timeBasedFileNamingAndTriggeringPolicy\u003e \u003c!--æ—¥å¿—æ–‡æ¡£ä¿ç•™å¤©æ•°--\u003e \u003cmaxHistory\u003e15\u003c/maxHistory\u003e \u003c/rollingPolicy\u003e \u003c!-- æ­¤æ—¥å¿—æ–‡æ¡£åªè®°å½•infoçº§åˆ«çš„ --\u003e \u003cfilter class=\"ch.qos.logback.classic.filter.LevelFilter\"\u003e \u003clevel\u003einfo\u003c/level\u003e \u003conMatch\u003eACCEPT\u003c/onMatch\u003e \u003conMismatch\u003eDENY\u003c/onMismatch\u003e \u003c/filter\u003e \u003c/appender\u003e \u003c!-- 2.3 levelä¸º WARN æ—¥å¿—ï¼Œæ—¶é—´æ»šåŠ¨è¾“å‡º --\u003e \u003cappender name=\"WARN_FILE\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\"\u003e \u003c!-- æ­£åœ¨è®°å½•çš„æ—¥å¿—æ–‡æ¡£çš„è·¯å¾„åŠæ–‡æ¡£å --\u003e \u003cfile\u003e${log.path}/${project.name}-warn.log\u003c/file\u003e \u003c!--æ—¥å¿—æ–‡æ¡£è¾“å‡ºæ ¼å¼--\u003e \u003cencoder\u003e \u003cpattern\u003e%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} %L - %msg%n\u003c/pattern\u003e \u003ccharse","date":"2020-11-16","objectID":"/posts/technology-other/logback-configurature/:0:0","tags":["logback"],"title":"logbacké…ç½®","uri":"/posts/technology-other/logback-configurature/"},{"categories":null,"content":"å…³äºæˆ‘ ç¨‹åºå‘˜ã€‚ æ›¾å–œæ¬¢ç©æ¸¸æˆ ï¼ˆğŸ® LOL S5 ç½‘ä¸€é’»äºŒã€16å¹´å¼€å§‹åŸºæœ¬ä¸ç©äº†ã€æ²¡æ—¶é—´ï¼‰ã€‚ çƒ­çˆ±æŠ€æœ¯ï¼Œå–œæ¬¢çå€’è…¾ã€‚ç”Ÿå‘½ä¸æ¯ã€æŠ˜è…¾ä¸æ­¢ï¼ˆä¾‹å¦‚è¿™ä¸ªåšå®¢ï¼‰ğŸ˜„ã€‚ ç°å±…äºä¸Šæµ·ã€‚ é‚®ç®±ï¼šwlizhicc@163.com ","date":"2020-11-16","objectID":"/about/:0:1","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"æŠ€æœ¯æ ˆ æ•°æ®åº“ï¼šmysqlã€redisã€mongoDBã€zookeeperç­‰ã€‚ æ¡†æ¶ï¼šspringã€mybatisã€springbootã€springcloudç³»åˆ—ï¼ˆeurekaã€hystrixã€ribbonã€feignã€zuulã€actuatorï¼‰ã€dubboç­‰ã€‚ javaï¼šå¹¶å‘ç¼–ç¨‹ã€JVMè°ƒä¼˜ã€nettyã€‚ å…¶ä»–ï¼štomcatã€nginxã€openrestyã€rabbitmqã€dockerã€docker-composeç­‰ã€‚ ","date":"2020-11-16","objectID":"/about/:0:2","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"åšå®¢ æœ€åˆä½¿ç”¨ jekyll ï¼Œæ„å»ºæœ‰ç‚¹æ…¢ï¼Œé…ç½®ç•¥å¾®å¤æ‚ã€‚ ç›®å‰ä½¿ç”¨ hugo ï¼Œéƒ¨ç½²äº é˜¿é‡Œäº‘ECS ï¼Œå¯¹è±¡å­˜å‚¨ é˜¿é‡Œäº‘OSS ã€‚ è‡ªåŠ¨å‘å¸ƒä½¿ç”¨ Gitee-WebHooks + è‡ªå†™è„šæœ¬ ã€‚æœ€åˆåœ¨ githubï¼Œç½‘ç»œåŸå› ï¼Œæœ€ç»ˆè¿ç§»åˆ° giteeã€‚ ","date":"2020-11-16","objectID":"/about/:0:3","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"ç½‘å€ https://wlizhi.cc https://wlz922.top https://wlizhi.github.io https://wlizhi.gitee.io ï¼ˆä¸ªäººç‰ˆï¼Œæ— è‡ªåŠ¨å‘å¸ƒï¼Œå¾ˆå°‘æ›´æ–°ï¼‰ ","date":"2020-11-16","objectID":"/about/:0:4","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"å‹æƒ…é“¾æ¥ Jackå¤§ä½¬ | å¶è‰¯è¾° ","date":"2020-11-16","objectID":"/about/:0:5","tags":null,"title":"å…³äº","uri":"/about/"}]